<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ไขรหัสวรรณคดี - The Literature Detective</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai+Looped:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        body {
            box-sizing: border-box;
            font-family: 'IBM Plex Sans Thai Looped', sans-serif;
            background: radial-gradient(circle at top left, #eef2ff 0%, rgba(238, 242, 255, 0) 45%),
                        radial-gradient(circle at bottom right, #fdf2f8 0%, rgba(253, 242, 248, 0) 45%),
                        linear-gradient(180deg, #f8fafc 0%, #ffffff 50%, #fdf2f8 100%);
            position: relative;
            min-height: 100vh;
            color: #111827;
            overflow-x: hidden;
            padding-bottom: 7rem;
        }

        body::before,
        body::after {
            content: '';
            position: fixed;
            width: 420px;
            height: 420px;
            border-radius: 9999px;
            filter: blur(110px);
            opacity: 0.35;
            z-index: -1;
        }

        body::before {
            top: -180px;
            left: -120px;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.7), rgba(236, 72, 153, 0.6));
        }

        body::after {
            bottom: -160px;
            right: -100px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.6), rgba(16, 185, 129, 0.55));
        }
        
        /* Landing page background */
        #landingPage {
            background-image: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(236, 233, 254, 0.04)), url('https://img2.pic.in.th/pic/742215688----.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            position: relative;
        }
        
        #landingPage::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.03), rgba(224, 231, 255, 0.01));
            z-index: 1;
            pointer-events: none;
            transition: background 0.3s ease;
        }

        #landingPage.user-logged-in::before {
            background: rgba(255, 255, 255, 0.45);
        }
        
        #landingPage > * {
            position: relative;
            z-index: 2;
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        .hero-title {
            font-weight: 800;
            line-height: 1.2;
            letter-spacing: -0.02em;
        }

        .hero-highlight {
            display: inline-block;
            background: linear-gradient(120deg, #7c3aed 0%, #ec4899 50%, #f59e0b 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            padding-left: 0.35rem;
            font-size: 0.9em;
        }

        .hero-subtitle {
            color: #4b5563;
            font-size: 1.05rem;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.65rem 1rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.3);
            font-weight: 600;
            color: #4338ca;
            box-shadow: 0 15px 25px -10px rgba(67, 56, 202, 0.35);
        }

        .stat-chip {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 0.25rem;
            padding: 1rem 0.75rem;
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(148, 163, 184, 0.35);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-chip:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px -12px rgba(59, 130, 246, 0.3);
        }

        .landing-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(18px);
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 35px 65px -25px rgba(30, 64, 175, 0.45);
            border-radius: 1.75rem;
        }

        .landing-card h3 {
            color: #1f2937;
        }

        .mission-card {
            background: rgba(255, 255, 255, 0.82);
            backdrop-filter: blur(16px);
            border-radius: 2rem;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 40px 70px -30px rgba(15, 23, 42, 0.45);
            position: relative;
            overflow: hidden;
        }

        .mission-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(236, 72, 153, 0.04));
            opacity: 0.5;
            z-index: 0;
        }

        .mission-card > * {
            position: relative;
            z-index: 1;
        }

        .mission-card .badge-modern {
            box-shadow: 0 12px 30px -12px rgba(124, 58, 237, 0.4);
        }

        .login-actions button {
            transform: translateY(0);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            box-shadow: 0 12px 24px -12px rgba(37, 99, 235, 0.4);
        }

        .login-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 32px -12px rgba(37, 99, 235, 0.45);
        }

        .landing-aurora {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }

        .landing-aurora::before,
        .landing-aurora::after {
            content: '';
            position: absolute;
            border-radius: 9999px;
            filter: blur(120px);
            opacity: 0.55;
        }

        .landing-aurora::before {
            width: 520px;
            height: 520px;
            top: -120px;
            right: -80px;
            background: linear-gradient(135deg, rgba(129, 140, 248, 0.8), rgba(192, 132, 252, 0.7));
            animation: auroraPulse 14s ease-in-out infinite;
        }

        .landing-aurora::after {
            width: 420px;
            height: 420px;
            bottom: -160px;
            left: -40px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.65), rgba(16, 185, 129, 0.6));
            animation: auroraPulse 16s ease-in-out infinite reverse;
        }

        @keyframes auroraPulse {
            0%, 100% {
                transform: translate3d(0, 0, 0) scale(1);
                opacity: 0.45;
            }
            50% {
                transform: translate3d(40px, -30px, 0) scale(1.1);
                opacity: 0.7;
            }
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .modern-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        .word-to-find {
            color: #3b82f6;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }

        .word-to-find:hover {
            color: #1d4ed8;
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
            transform: scale(1.05);
        }

        .poem-container.plain-poem .word-to-find,
        .poem-container.plain-poem .word-to-find:hover {
            color: inherit;
            cursor: default;
            text-shadow: none;
            transform: none;
            font-weight: 500;
        }
        
        .word-correct {
            color: #059669;
            font-weight: 700;
        }
        
        .word-incorrect {
            color: #dc2626;
            font-weight: 700;
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .poem-container {
            background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid rgba(148, 163, 184, 0.25);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        .poem-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899, #f59e0b);
        }

        .poem-container.plain-poem {
            background: transparent;
            border: none;
            box-shadow: none;
        }

        .poem-container.plain-poem::before {
            display: none;
        }
        
        .poem-text {
            font-size: 1.5rem;
            line-height: 1.8;
            font-weight: 400;
            font-family: 'IBM Plex Sans Thai Looped', sans-serif;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .poem-text .kloang-container {
            margin: 0 auto;
            text-align: left;
            max-width: 640px;
        }

        .teacher-detail-card {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 25px 45px -30px rgba(15, 23, 42, 0.35);
        }

        .teacher-rank-card {
            border-radius: 1.5rem;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 18px 35px -28px rgba(30, 64, 175, 0.35);
            padding: 1rem 1.1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 120px;
        }

        .teacher-rank-card .rank-tier {
            font-size: 1.25rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .teacher-rank-card .rank-meta {
            font-size: 0.8rem;
            color: #475569;
        }
        
        .kloang-container {
            line-height: 1.8;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1rem;
            overflow-x: auto;
        }

        .bart {
            display: flex;
            flex-wrap: nowrap;
            align-items: flex-start;
            margin-bottom: 0.8rem;
            white-space: nowrap;
            min-width: fit-content;
        }

        .wak-na {
            min-width: 280px; 
            max-width: 280px; 
            text-align: left;
            padding-right: 1.5rem;
            font-weight: 400;
            flex-shrink: 0;
            font-style: normal;
            white-space: nowrap;
            overflow: visible;
        }

        .wak-lang {
            padding-right: 0.5rem;
            padding-left: 1rem;
            font-weight: 400;
            font-style: normal;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .kam-sroi {
            font-style: normal;
            font-weight: 400;
            padding-left: 0.5rem;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .modern-button {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            font-weight: 600;
            border-radius: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
            border: none;
        }
        
        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.4);
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
        }
        
        .modern-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .modern-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 15px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .modern-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
            background: white;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            height: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            border-radius: 25px;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            font-weight: 600;
            z-index: 1000;
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification-success {
            background: rgba(16, 185, 129, 0.9);
            color: white;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .notification-error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .floating-elements {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        
        .floating-element {
            position: absolute;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg);
                opacity: 0.1;
            }
            50% { 
                transform: translateY(-20px) rotate(180deg);
                opacity: 0.3;
            }
        }
        
        .tooltip-modern {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .badge-modern {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3) translateY(-50px);
            }
            50% {
                opacity: 1;
                transform: scale(1.05) translateY(-10px);
            }
            70% {
                transform: scale(0.95) translateY(0);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .animate-bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .hero-text {
            text-shadow: 2px 2px 20px rgba(0,0,0,0.3);
        }
        
        .landing-feature {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .landing-feature:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        /* 📱 Responsive refinements */
        @media (max-width: 1024px) {
            #landingPage {
                background-attachment: scroll;
            }

            .teacher-dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

        }

        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.25rem;
            }

            .hero-subtitle {
                font-size: 1.05rem;
            }

            .hero-badge {
                font-size: 0.95rem;
                padding: 0.6rem 1.25rem;
            }

            .stat-chip {
                width: 100%;
                flex-direction: row;
                align-items: center;
                text-align: left;
                gap: 0.75rem;
            }

            .landing-card,
            .mission-card {
                padding: 1.5rem;
                border-radius: 1.5rem;
            }

            .mission-card img {
                max-height: 220px;
                width: 100%;
                object-fit: cover;
            }

            .teacher-summary-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .teacher-activity-list {
                gap: 1.5rem;
            }
        }

        @media (max-width: 640px) {
            body {
                font-size: 16px;
            }

            .hero-title {
                font-size: 1.875rem;
            }

            .hero-subtitle {
                font-size: 0.95rem;
            }

            .hero-badge {
                font-size: 0.85rem;
            }

            .stat-chip {
                padding: 1rem;
            }

            .teacher-summary-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .teacher-summary-card {
                padding: 1.25rem !important;
            }

            .teacher-table {
                border: none;
            }

            .teacher-table thead {
                display: none;
            }

            .teacher-table tbody tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid rgba(148, 163, 184, 0.25);
                border-radius: 1rem;
                overflow: hidden;
                background: rgba(255, 255, 255, 0.95);
            }

            .teacher-table tbody tr:last-child {
                margin-bottom: 0;
            }

            .teacher-table tbody td {
                display: flex;
                justify-content: space-between;
                gap: 1rem;
                padding: 0.85rem 1rem;
                border-bottom: 1px solid rgba(148, 163, 184, 0.15);
            }

            .teacher-table tbody td:last-child {
                border-bottom: none;
            }

            .teacher-table tbody td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #475569;
            }

            .teacher-dashboard-header button {
                width: 100%;
            }

        }
        /* Header Sticky Positioning */
        #header {
            position: sticky !important;
            top: 0px !important;
            z-index: 50 !important;
        }

        /* Main Content Proper Spacing */
        #mainContent {
            padding-top: 2rem !important;
            padding-bottom: 6rem !important;
            min-height: calc(100vh - 220px) !important;
        }

        .progress-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0;
            background: transparent;
            border: none;
            box-shadow: none;
        }

        .progress-track {
            flex: 1;
            height: 0.25rem;
            border-radius: 9999px;
            background: rgba(148, 163, 184, 0.45);
            overflow: hidden;
        }

        .progress-track-fill {
            height: 100%;
            border-radius: 9999px;
            background: linear-gradient(90deg, #f59e0b, #f97316, #ef4444);
            transition: width 0.4s ease;
        }

        .progress-percent {
            font-size: 0.75rem;
            font-weight: 600;
            color: #1f2937;
            min-width: 2.5rem;
            text-align: right;
        }

        #stepUtilityBar {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.28), rgba(191, 219, 254, 0.18));
            backdrop-filter: blur(18px);
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
            color: #1f2937;
        }

        .step-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.45rem 0.75rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(148, 163, 184, 0.35);
            color: #1f2937;
            font-weight: 600;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .step-chip span {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .step-chip-active {
            background: rgba(59, 130, 246, 0.12);
            border-color: rgba(59, 130, 246, 0.35);
            color: #1d4ed8;
            box-shadow: 0 15px 30px -18px rgba(15, 23, 42, 0.6);
        }

        .step-chip-completed {
            background: rgba(226, 232, 240, 0.95);
            border-color: rgba(148, 163, 184, 0.35);
            color: #475569;
        }

        #header {
            transition: all 0.3s ease;
        }

        #header.header-compact {
            padding-top: 0.5rem !important;
            padding-bottom: 0.75rem !important;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.95), rgba(76, 29, 149, 0.9));
            backdrop-filter: blur(16px);
        }

        #header.header-compact .step-chip {
            padding: 0.3rem 0.6rem;
            font-size: 0.7rem;
        }

        .step-subtitle {
            margin-top: 0.5rem;
            font-size: 1.05rem;
            color: #4b5563;
            font-weight: 400;
        }

        .cta-float {
            position: sticky;
            bottom: 1.5rem;
            margin-top: 4rem;
            animation: ctaPop 0.9s ease forwards;
            box-shadow: 0 25px 45px -18px rgba(59, 130, 246, 0.45);
            display: inline-flex;
            justify-content: center;
            margin-left: auto;
            margin-right: auto;
        }

        #floatingActionButtons {
            position: fixed;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            z-index: 60;
        }

        #floatingActionButtons.hidden {
            display: none !important;
            pointer-events: none !important;
        }

        #floatingActionButtons .floating-toggle {
            pointer-events: auto;
            background: rgba(15, 23, 42, 0.75);
            color: #f8fafc;
            border-radius: 9999px;
            width: 2.75rem;
            height: 2.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            border: 1px solid rgba(148, 163, 184, 0.45);
            box-shadow: 0 18px 35px -18px rgba(15, 23, 42, 0.55);
            transition: all 0.3s ease;
        }

        #floatingActionButtons .floating-toggle:hover,
        #floatingActionButtons .floating-toggle:focus {
            background: rgba(30, 64, 175, 0.85);
            transform: translateY(-2px);
        }

        #floatingActionButtons .floating-panel {
            pointer-events: none;
            display: none;
            margin-top: 0.75rem;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.4);
            border-radius: 1.5rem;
            padding: 0.85rem;
            box-shadow: 0 35px 65px -32px rgba(15, 23, 42, 0.5);
            width: 11rem;
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.35s ease;
        }

        #floatingActionButtons.show .floating-panel {
            pointer-events: auto;
            display: block;
            transform: translateX(0);
            opacity: 1;
        }

        .floating-action-button {
            width: 100%;
            border-radius: 0.875rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(59, 130, 246, 0.25));
            color: #1f2937;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.55rem 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.45);
            transition: all 0.25s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
        }

        .floating-action-button:hover,
        .floating-action-button:focus {
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.15), rgba(30, 64, 175, 0.35));
            border-color: rgba(59, 130, 246, 0.45);
            color: #1e3a8a;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            #floatingActionButtons {
                top: auto;
                right: 0.75rem;
                bottom: 1rem;
                transform: none;
            }

            #floatingActionButtons .floating-panel {
                width: auto;
                min-width: 12rem;
            }
        }

        .summary-action-bar {
            position: sticky;
            bottom: 4.5rem;
            z-index: 70;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 0;
            pointer-events: auto;
        }

        @media (min-width: 768px) {
            .summary-action-bar {
                flex-direction: row;
                justify-content: center;
                gap: 1.5rem;
            }
        }

        @keyframes ctaPop {
            0% {
                transform: translateY(60px) scale(0.6);
                opacity: 0;
            }
            60% {
                transform: translateY(-12px) scale(1.05);
                opacity: 1;
            }
            100% {
                transform: translateY(0) scale(1);
            }
        }

        .modal-card {
            width: min(100%, 960px);
            max-height: 95vh;
            min-height: min(90vh, 720px);
            display: flex;
            flex-direction: column;
        }

        .modal-card.scrollable {
            overflow-y: auto;
        }

        </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
    <!-- Floating Background Elements -->
    <div class="floating-elements">
        <div class="floating-element text-6xl" style="top: 10%; left: 10%; animation-delay: 0s;">📚</div>
        <div class="floating-element text-4xl" style="top: 20%; right: 15%; animation-delay: 1s;">✨</div>
        <div class="floating-element text-5xl" style="bottom: 20%; left: 20%; animation-delay: 2s;">🔍</div>
        <div class="floating-element text-3xl" style="bottom: 30%; right: 25%; animation-delay: 3s;">💭</div>
    </div>

    <!-- Teacher Portal Section -->
    <div id="teacherPortal" class="hidden bg-slate-100/90 min-h-screen py-10">
        <div class="w-full px-4 md:px-8 lg:px-12">
            <div class="mx-auto w-full max-w-screen-2xl space-y-10">
                <div class="teacher-dashboard-header bg-white/80 backdrop-blur border border-slate-200 rounded-3xl p-6 md:p-8 shadow-lg flex flex-col gap-6 md:flex-row md:items-center md:justify-between">
                    <div class="space-y-2">
                        <p class="text-sm uppercase tracking-widest text-blue-600/70">ThaiLit Backoffice</p>
                        <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900">แดชบอร์ดครูผู้สอน</h2>
                        <p class="text-sm md:text-base text-slate-600 max-w-2xl">ติดตามผลการเรียนรู้แบบเรียลไทม์ ดูคะแนน ทบทวนคำตอบ และวางแผนการสอนให้สอดคล้องกับความคืบหน้าของนักเรียนในแต่ละห้องเรียน</p>
                    </div>
                    <button onclick="closeTeacherPortal()" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-slate-900 text-white shadow hover:bg-slate-800 transition">⬅️ กลับสู่หน้าหลัก</button>
                </div>

                <div class="space-y-8">
                    <div id="teacherLoginPanel" class="space-y-6 bg-white/80 border border-slate-200 rounded-3xl p-6 md:p-8 shadow-lg">
                        <div>
                            <h3 class="text-2xl font-bold text-slate-900 mb-2">เข้าสู่ระบบสำหรับครู</h3>
                            <p class="text-sm text-slate-600">ใช้บัญชีที่ได้รับจากผู้ดูแลเพื่อเข้าถึงข้อมูลนักเรียนและบันทึกการเรียนรู้</p>
                        </div>
                        <form id="teacherLoginForm" class="space-y-4" onsubmit="submitTeacherLogin(event)">
                            <div>
                                <label for="teacherEmail" class="block text-sm font-semibold text-slate-700 mb-2">อีเมลครู</label>
                                <input id="teacherEmail" type="email" required class="w-full modern-input p-3" placeholder="teacher@school.ac.th">
                            </div>
                            <div>
                                <label for="teacherPassword" class="block text-sm font-semibold text-slate-700 mb-2">รหัสผ่าน</label>
                                <input id="teacherPassword" type="password" required class="w-full modern-input p-3" placeholder="••••••••">
                            </div>
                            <button type="submit" class="modern-button w-full py-3 text-base rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700">เข้าสู่ระบบครู</button>
                        </form>
                        <div class="text-xs text-slate-500 leading-relaxed space-y-2">
                            <p>เมื่อเข้าสู่ระบบ ครูจะสามารถดาวน์โหลดรายงานผลลัพธ์ แสดงคำตอบของนักเรียนแต่ละคน และดูไทม์ไลน์กิจกรรมล่าสุดได้</p>
                            <div class="rounded-2xl border border-slate-200 bg-slate-50/80 px-4 py-3 text-left text-slate-600">
                                <p class="font-semibold text-slate-700">บัญชีทดลองสำหรับทดสอบระบบ</p>
                                <p>อีเมล: <span class="font-medium text-slate-800">teacher@thailit.app</span></p>
                                <p>รหัสผ่าน: <span class="font-medium text-slate-800" data-demo-pass="teacher@thailit.app">••••••</span></p>
                            </div>
                        </div>
                    </div>

                    <div id="teacherDashboard" class="hidden space-y-8">
                        <div class="bg-white/80 border border-slate-200 rounded-3xl p-6 md:p-8 shadow-lg space-y-6">
                            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                                <div>
                                    <h3 class="text-2xl font-bold text-slate-900" id="teacherGreeting">สวัสดีคุณครู</h3>
                                    <p class="text-sm text-slate-600" id="teacherClasses">บัญชีครูภาษาไทย</p>
                                    <p class="text-xs text-slate-500" id="teacherEmailDisplay"></p>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="renderTeacherDashboard()" class="modern-button px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 flex items-center gap-2">
                                        🔄 รีเฟรชข้อมูล
                                    </button>
                                    <button onclick="logoutTeacher()" class="modern-button px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 flex items-center gap-2">
                                        🚪 ออกจากระบบครู
                                    </button>
                                </div>
                            </div>

                            <div id="teacherDashboardLoading" class="hidden">
                                <div class="bg-white border border-slate-200 rounded-2xl p-6 text-center shadow-sm">
                                    <div class="flex flex-col items-center gap-3">
                                        <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin"></div>
                                        <p class="text-sm text-slate-600">กำลังดึงข้อมูลนักเรียน...</p>
                                    </div>
                                </div>
                            </div>

                            <div id="teacherSummaryCards" class="teacher-summary-grid grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-5 gap-4"></div>

                            <div id="teacherEmptyState" class="hidden bg-white border border-dashed border-slate-300 rounded-2xl p-6 text-center text-slate-500">
                                <p class="font-semibold">ยังไม่มีข้อมูลนักเรียนในระบบ</p>
                                <p class="text-sm mt-2">เมื่อมีนักเรียนลงทะเบียนหรือเริ่มทำภารกิจ ข้อมูลจะปรากฏที่นี่อัตโนมัติ</p>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="px-6 py-4 border-b border-slate-200 flex flex-col gap-2 lg:flex-row lg:items-center lg:justify-between">
                                <h4 class="text-lg font-semibold text-slate-900">ภาพรวมคะแนนนักเรียน</h4>
                                <span class="text-xs text-slate-500" id="teacherTableMeta"></span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="teacher-table min-w-full divide-y divide-slate-200 text-sm">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left font-semibold text-slate-600">นักเรียน</th>
                                            <th class="px-4 py-3 text-left font-semibold text-slate-600">ชั้น/ห้อง</th>
                                            <th class="px-4 py-3 text-left font-semibold text-slate-600">ความคืบหน้า</th>
                                            <th class="px-4 py-3 text-left font-semibold text-slate-600">คะแนนรวม</th>
                                            <th class="px-4 py-3 text-left font-semibold text-slate-600">คะแนนเฉลี่ย</th>
                                            <th class="px-4 py-3 text-left font-semibold text-slate-600">อัปเดตล่าสุด</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teacherStudentTable" class="divide-y divide-slate-100 bg-white"></tbody>
                                </table>
                            </div>
                            <div class="border-t border-slate-200 bg-slate-50/60 px-6 py-4 space-y-3">
                                <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
                                    <h5 class="text-base font-semibold text-slate-900">ระบบอันดับนักสืบ</h5>
                                    <span class="text-xs text-slate-500" id="teacherRankingMeta"></span>
                                </div>
                                <div id="teacherRankingSummary" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-3 text-sm"></div>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-200 shadow-sm p-6">
                            <div class="flex flex-col gap-2 mb-4 lg:flex-row lg:items-center lg:justify-between">
                                <h4 class="text-lg font-semibold text-slate-900">กิจกรรมล่าสุด</h4>
                                <span class="text-xs text-slate-500" id="teacherTimelineMeta"></span>
                            </div>
                            <div id="teacherActivityTimeline" class="teacher-activity-list grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </div>

                        <div id="teacherStudentDetail" class="teacher-detail-card p-6 md:p-8 space-y-6">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div>
                                    <h4 class="text-lg font-semibold text-slate-900">รายงานนักเรียนรายบุคคล</h4>
                                    <p class="text-sm text-slate-500">คลิกชื่อนักเรียนจากตารางเพื่อเปิดหน้าต่างรายงาน</p>
                                </div>
                            </div>
                            <div id="teacherStudentDetailContent" class="text-sm text-slate-500 text-center">
                                คลิกชื่อนักเรียนจากตารางเพื่อเปิดหน้าต่างรายงาน
                            </div>
                        </div>

                        <div class="bg-white/90 backdrop-blur border border-slate-200 rounded-3xl p-6 md:p-8 space-y-6 shadow-lg">
                            <div class="space-y-2">
                                <p class="text-sm text-slate-500 uppercase tracking-wider">ภาพรวมระบบ</p>
                                <p class="text-lg md:text-xl font-semibold text-slate-900">ข้อมูลสำคัญ</p>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 text-sm">
                                <div class="rounded-2xl p-4 bg-slate-50 border border-slate-200 flex items-start gap-3">
                                    <div class="text-xl">🏅</div>
                                    <div>
                                        <p class="text-slate-500 text-sm">คะแนนรวมสะสม</p>
                                        <p class="text-2xl font-bold text-slate-900" id="teacherQuickTotal">-</p>
                                    </div>
                                </div>
                                <div class="rounded-2xl p-4 bg-slate-50 border border-slate-200 flex items-start gap-3">
                                    <div class="text-xl">📊</div>
                                    <div>
                                        <p class="text-slate-500 text-sm">คะแนนเฉลี่ย</p>
                                        <p class="text-2xl font-bold text-slate-900" id="teacherQuickAverage">-</p>
                                    </div>
                                </div>
                                <div class="rounded-2xl p-4 bg-slate-50 border border-slate-200 flex items-start gap-3">
                                    <div class="text-xl">👩‍🎓</div>
                                    <div>
                                        <p class="text-slate-500 text-sm">นักเรียนลงทะเบียน</p>
                                        <p class="text-2xl font-bold text-slate-900" id="teacherQuickStudents">-</p>
                                    </div>
                                </div>
                                <div class="rounded-2xl p-4 bg-slate-50 border border-slate-200 flex items-start gap-3">
                                    <div class="text-xl">✅</div>
                                    <div>
                                        <p class="text-slate-500 text-sm">ภารกิจสำเร็จ</p>
                                        <p class="text-2xl font-bold text-slate-900" id="teacherQuickCompleted">-</p>
                                    </div>
                                </div>
                                <div class="rounded-2xl p-4 bg-slate-50 border border-slate-200 flex items-start gap-3">
                                    <div class="text-xl">🕒</div>
                                    <div>
                                        <p class="text-slate-500 text-sm">เข้าสู่ระบบวันนี้</p>
                                        <p class="text-2xl font-bold text-slate-900" id="teacherQuickActive">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="text-xs text-slate-500 space-y-1">
                                <p class="uppercase tracking-wider">บัญชีทดลอง</p>
                                <p class="font-semibold text-slate-700">อีเมล: teacher@thailit.app • รหัสผ่าน: <span data-demo-pass="teacher@thailit.app">••••••</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Landing Page -->
    <div id="landingPage" class="min-h-screen bg-gray-50 flex items-center justify-center p-2 md:p-4 relative overflow-hidden">
        <div class="landing-aurora"></div>
        <div class="max-w-6xl mx-auto relative z-10 w-full">
            <!-- Main Content Grid -->
            <div class="grid lg:grid-cols-2 gap-4 md:gap-8 items-center min-h-screen py-4">
                <!-- Left Column - Hero Content -->
                <div class="text-center lg:text-left flex flex-col justify-center h-full py-8">
                    <div class="mb-8 space-y-6">
                        <div class="flex justify-center lg:justify-start">
                            <span class="hero-badge">
                                📚 ภารกิจ 01 • โคลงสี่สุภาพ
                            </span>
                        </div>

                        <h1 class="hero-title text-3xl md:text-4xl lg:text-5xl text-gray-900">
                            ไขรหัสวรรณคดี
                            <span class="hero-highlight">The Literature Detective</span>
                        </h1>

                        <p class="hero-subtitle text-base md:text-lg lg:text-xl">
                            ประสบการณ์เรียนรู้วรรณคดีไทยที่ผสานเกมการสืบสวน การตีความ และการจับคู่คำศัพท์ให้สนุกกว่าที่เคย
                        </p>

                        <!-- Login Section -->
                        <div id="loginSection" class="mb-6">
                            <div class="landing-card p-6 md:p-7 mb-6">
                                <div class="flex items-center justify-center gap-4 mb-4">
                                    <span class="text-2xl">👤</span>
                                    <h3 class="text-xl font-bold text-gray-900">เข้าสู่ระบบ</h3>
                                </div>
                                <p class="text-gray-600 text-center mb-6 leading-relaxed">เข้าสู่ระบบเพื่อบันทึกความคืบหน้า เชื่อมต่อคะแนน และรับคำแนะนำเฉพาะตัวในแต่ละภารกิจ</p>

                                <div id="loginButtons" class="space-y-3">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 login-actions">
                                        <button onclick="showStudentForm()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-2 rounded-xl transition-all duration-200 text-sm">
                                            📝 ลงทะเบียน
                                        </button>

                                        <button onclick="showLoginForm()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-2 rounded-xl transition-all duration-200 text-sm">
                                            🔑 เข้าสู่ระบบ
                                        </button>
                                    </div>
                                </div>

                                <div id="startButtonWrapper" class="mt-4">
                                    <button id="startGameBtn" onclick="startGame()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 rounded-xl transition-all duration-200 text-sm disabled:bg-gray-400 disabled:cursor-not-allowed disabled:opacity-50" disabled>
                                        ✨ เริ่มเลย
                                    </button>
                                    <p class="text-[11px] text-purple-700/70 mt-2" id="startButtonHint">เข้าสู่ระบบก่อนเพื่อเปิดภารกิจ</p>
                                </div>

                                <div id="teacherLoginCta" class="mt-4 text-xs text-blue-700/70 text-center sm:text-right space-y-1">
                                    <p class="font-semibold text-blue-900/80">สำหรับครูผู้สอน</p>
                                    <button onclick="openTeacherPortal()" class="inline-flex items-center gap-1 text-blue-600 hover:text-blue-800 font-semibold">
                                        👩‍🏫 พื้นที่ครู
                                        <span class="hidden sm:inline">(เข้าสู่ระบบเพื่อดูคะแนน)</span>
                                    </button>
                                    <p class="text-[11px] text-blue-600/70">เข้าสู่ระบบเพื่อดูคะแนนและความคืบหน้านักเรียน</p>
                                </div>

                                <!-- Student Registration Form -->
                                <div id="studentForm" class="hidden space-y-4">
                                    <div class="text-center mb-4">
                                        <h4 class="text-lg font-bold text-gray-900">📝 ข้อมูลนักเรียน</h4>
                                        <p class="text-sm text-gray-600">กรอกข้อมูลเพื่อบันทึกผลการเรียน</p>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">ชื่อ-นามสกุล *</label>
                                            <input type="text" id="studentName" class="w-full modern-input p-3" placeholder="ชื่อ นามสกุล" required>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">รหัสนักเรียน *</label>
                                            <input type="text" id="studentId" class="w-full modern-input p-3" placeholder="12345" required>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">ชั้น *</label>
                                            <select id="studentGrade" class="w-full modern-input p-3" required>
                                                <option value="">เลือกชั้น</option>
                                                <option value="ม.1">ม.1</option>
                                                <option value="ม.2">ม.2</option>
                                                <option value="ม.3">ม.3</option>
                                                <option value="ม.4">ม.4</option>
                                                <option value="ม.5">ม.5</option>
                                                <option value="ม.6">ม.6</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">ห้อง *</label>
                                            <input type="text" id="studentRoom" class="w-full modern-input p-3" placeholder="1" required>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">เลขที่ *</label>
                                            <input type="text" id="studentNumber" class="w-full modern-input p-3" placeholder="1" required>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-2">เบอร์โทรศัพท์ *</label>
                                        <input type="tel" id="studentPhone" class="w-full modern-input p-3" placeholder="0812345678" required>
                                        <p class="text-xs text-gray-500 mt-1">ใช้เป็นรหัสผ่านร่วมกับรหัสนักเรียน</p>
                                    </div>
                                    
                                    <div class="flex gap-3 mt-6">
                                        <button onclick="hideStudentForm()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                                            ยกเลิก
                                        </button>
                                        <button onclick="registerStudent()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                                            บันทึกข้อมูล
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Student Login Form -->
                                <div id="loginForm" class="hidden space-y-4">
                                    <div class="text-center mb-4">
                                        <h4 class="text-lg font-bold text-gray-900">🔑 เข้าสู่ระบบ</h4>
                                        <p class="text-sm text-gray-600">ใช้รหัสนักเรียนและเบอร์โทรศัพท์</p>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-2">รหัสนักเรียน</label>
                                        <input type="text" id="loginStudentId" class="w-full modern-input p-3" placeholder="12345">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-2">เบอร์โทรศัพท์</label>
                                        <input type="tel" id="loginPhone" class="w-full modern-input p-3" placeholder="0812345678">
                                    </div>
                                    
                                    <div class="flex gap-3 mt-6">
                                        <button onclick="hideLoginForm()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                                            ยกเลิก
                                        </button>
                                        <button onclick="loginStudent()" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                                            เข้าสู่ระบบ
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="userInfo" class="hidden text-center">
                                    <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4 mb-4">
                                        <div class="flex items-center justify-center gap-3 mb-3">
                                            <img id="userPhoto" src="" alt="Profile" class="w-12 h-12 rounded-full border-2 border-green-300">
                                            <div>
                                                <p class="font-bold text-green-900" id="userName"></p>
                                                <p class="text-sm text-green-700" id="userDetails"></p>
                                            </div>
                                        </div>
                                        <div class="text-xs text-green-600" id="userStats"></div>
                                    </div>
                                    <button onclick="signOutUser()" class="text-red-600 hover:text-red-700 font-semibold">
                                        ออกจากระบบ
                                    </button>
                                </div>
                            </div>
                        </div>
                        

                    </div>
                </div>
                
                <!-- Right Column - Mission Info -->
                <div class="mission-card rounded-3xl p-4 md:p-6 h-full overflow-y-auto">
                    <div class="mb-4">
                        <h2 class="text-xl md:text-2xl lg:text-3xl font-bold text-gray-900 mb-2">
                            โคลงสี่สุภาพ
                        </h2>
                        <p class="text-base md:text-lg lg:text-xl text-gray-600">พระราชพงศาวดาร - เรื่องสมเด็จพระสุริโยทัย</p>
                    </div>
                    
                    <div class="bg-white bg-opacity-70 border border-blue-200/60 rounded-2xl p-4 mb-6 backdrop-blur space-y-5">
                        <div class="relative mb-4 overflow-hidden rounded-xl border border-blue-200/50 shadow-lg">
                            <img src="https://img5.pic.in.th/file/secure-sv1/education-booksOK.jpg" alt="กองหนังสือเพื่อการเรียนรู้" class="w-full h-40 object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-blue-900/40 via-transparent to-transparent"></div>
                        </div>

                        <div class="space-y-3">
                            <div class="flex items-center gap-3 p-3 bg-white/70 backdrop-blur rounded-xl border border-slate-200/70">
                                <div class="text-2xl">🔍</div>
                                <div>
                                    <h4 class="font-bold text-gray-900 text-sm">สืบสอบคำศัพท์</h4>
                                    <p class="text-gray-600 text-xs">ค้นหาความหมายด้วยตนเอง พร้อมระบุแหล่งอ้างอิง</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-white/70 backdrop-blur rounded-xl border border-slate-200/70">
                                <div class="text-2xl">💭</div>
                                <div>
                                    <h4 class="font-bold text-gray-900 text-sm">ถอดความ</h4>
                                    <p class="text-gray-600 text-xs">ถอดเป็นเรียงความร้อยแก้วและใช้จินตนาการ</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-white/70 backdrop-blur rounded-xl border border-slate-200/70">
                                <div class="text-2xl">🖼️</div>
                                <div>
                                    <h4 class="font-bold text-gray-900 text-sm">เปิดภาพจริง</h4>
                                    <p class="text-gray-600 text-xs">เปรียบเทียบกับข้อมูลประวัติศาสตร์จริง</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white/80 backdrop-blur border border-yellow-200/70 rounded-2xl p-4 shadow-xl">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-2xl">🏆</span>
                                <h3 class="text-lg font-bold text-yellow-900">ระบบอันดับ</h3>
                            </div>

                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                <div class="bg-white bg-opacity-60 rounded-xl p-3 text-center">
                                    <div class="text-base mb-1">🥇</div>
                                    <div class="font-bold text-yellow-800 text-xs">นักสืบเซียน</div>
                                    <div class="text-xs text-yellow-700">1000+ แต้ม</div>
                                </div>
                                <div class="bg-white bg-opacity-60 rounded-xl p-3 text-center">
                                    <div class="text-base mb-1">🥈</div>
                                    <div class="font-bold text-gray-700 text-xs">นักสืบชำนาญ</div>
                                    <div class="text-xs text-gray-600">500+ แต้ม</div>
                                </div>
                                <div class="bg-white bg-opacity-60 rounded-xl p-3 text-center">
                                    <div class="text-base mb-1">🥉</div>
                                    <div class="font-bold text-orange-700 text-xs">นักสืบฝึกหัด</div>
                                    <div class="text-xs text-orange-600">200+ แต้ม</div>
                                </div>
                                <div class="bg-white bg-opacity-60 rounded-xl p-3 text-center">
                                    <div class="text-base mb-1">🌟</div>
                                    <div class="font-bold text-blue-700 text-xs">มือใหม่</div>
                                    <div class="text-xs text-blue-600">0+ แต้ม</div>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 mt-6 border-t border-blue-100/60 text-center text-[11px] leading-relaxed text-blue-900/80">
                            พัฒนาโดย : นัชนันท์ นครคง , นุสรา พึ่งบ้านเกาะ , ราม แสงมณี และสุทธิชา กะรัมย์ นิสิตภาควิชาหลักสูตรและการสอน (การสอนภาษาไทย) คณะครุศาสตร์ จุฬาลงกรณ์มหาวิทยาลัย
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Header Dashboard (Hidden initially) -->
    <header id="header" class="bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 shadow-lg border-b border-blue-300 px-3 md:px-4 py-2 md:py-3 hidden">
        <div class="max-w-6xl mx-auto">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div class="space-y-1 text-white">
                    <div class="flex items-center gap-2 text-xs uppercase tracking-[0.25em] text-blue-100/80">
                        <span class="text-base">📚</span>
                        <span>ไขรหัสวรรณคดี</span>
                    </div>
                    <h1 class="text-xl md:text-2xl font-semibold leading-snug">เรียนรู้วรรณคดีไทยแบบโต้ตอบ</h1>
                </div>

                <div class="flex flex-col md:flex-row items-start md:items-center gap-3 md:gap-4 w-full md:w-auto">
                    <div id="playerStatusBar" class="hidden w-full md:w-auto">
                        <div class="rounded-xl border border-slate-200 bg-white/90 px-3 py-2 text-slate-800 shadow-sm inline-flex flex-col gap-1 w-full">
                            <div id="headerUserName" class="hidden w-full">
                                <button type="button" class="toggle-user-dropdown v-btn v-btn--text theme--dark v-size--default px-0 text-left text-sm font-semibold text-slate-800 hover:text-slate-900 transition-colors duration-200" onclick="showUserMenu()">
                                    <span class="v-btn__content flex flex-col items-start gap-0.5">
                                        <span id="currentUserName">ผู้ใช้</span>
                                        <span id="currentUserRank" class="text-xs font-medium text-slate-500">ระดับ มือใหม่</span>
                                    </span>
                                </button>
                            </div>
                            <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-slate-600">
                                <span>คะแนนรวม <span id="playerExp">0</span></span>
                                <span class="hidden sm:inline-block w-1 h-1 rounded-full bg-slate-300"></span>
                                <span>อันดับ <span id="playerRank">มือใหม่</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="text-white text-xs md:text-sm opacity-90 md:text-right">
                        <p>ติดตามความคืบหน้าของคุณได้ที่แถบสถานะด้านล่าง</p>
                    </div>
                </div>
            </div>

        </div>
    </header>


    <div id="stepUtilityBar" class="hidden px-3 md:px-6 py-3">
        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-3">
            <div class="progress-wrapper">
                <span class="hidden sm:inline text-xs font-semibold text-slate-600 tracking-wide uppercase">ความคืบหน้า</span>
                <div class="progress-track">
                    <div id="mainProgressFill" class="progress-track-fill" style="width: 0%"></div>
                </div>
                <span id="progressText" class="progress-percent">0%</span>
            </div>
            <div id="stepIndicatorContainer" class="flex flex-wrap justify-center gap-2">
                <span class="step-chip step-chip-active" data-step="1"><span class="font-bold">1</span><span>📚 ประวัติศาสตร์</span></span>
                <span class="step-chip" data-step="2"><span class="font-bold">2</span><span>📖 แสดงโคลง &amp; คำศัพท์</span></span>
                <span class="step-chip" data-step="3"><span class="font-bold">3</span><span>✍️ ถอดความ</span></span>
                <span class="step-chip" data-step="4"><span class="font-bold">4</span><span>🖼️ เปิดภาพจริง</span></span>
                <span class="step-chip" data-step="5"><span class="font-bold">5</span><span>📝 ทบทวน</span></span>
                <span class="step-chip" data-step="6"><span class="font-bold">6</span><span>🏆 สรุปผล</span></span>
            </div>
        </div>
        <div class="md:hidden text-center text-slate-700 text-xs mt-2" id="currentStepLabel">📚 ประวัติศาสตร์</div>
    </div>

    <div id="floatingActionButtons" class="hidden">
        <button type="button" id="floatingActionsToggle" class="floating-toggle" aria-label="เปิดเมนูทางลัด">
            <span class="sr-only">เปิดเมนูทางลัด</span>
            <span>☰</span>
        </button>
        <div class="floating-panel">
            <div class="flex flex-col gap-2">
                <button id="backBtn" onclick="goBack()" class="floating-action-button hidden">
                    ← ย้อนกลับ
                </button>
                <button onclick="resetGame()" class="floating-action-button">
                    🔄 เริ่มใหม่
                </button>
                <button onclick="goToHome()" class="floating-action-button">
                    🏠 หน้าหลัก
                </button>
            </div>
        </div>
    </div>


    <!-- Main Content -->
    <main id="mainContent" class="max-w-6xl mx-auto p-3 md:p-6 pb-28 md:pb-32 hidden">
        <!-- Content will be dynamically rendered here -->
    </main>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <footer id="siteFooter" class="bg-slate-900 text-white text-[10px] sm:text-xs text-center py-2.5 px-3 hidden fixed bottom-0 inset-x-0 z-40 shadow-lg">
        พัฒนาโดย : นัชนันท์ นครคง , นุสรา พึ่งบ้านเกาะ , ราม แสงมณี และสุทธิชา กะรัมย์ นิสิตภาควิชาหลักสูตรและการสอน (การสอนภาษาไทย) คณะครุศาสตร์ จุฬาลงกรณ์มหาวิทยาลัย
    </footer>

    <script>
        function parseJsonSafely(rawValue) {
            if (!rawValue) return null;
            try {
                return JSON.parse(rawValue);
            } catch (error) {
                console.warn('Unable to parse JSON value', error);
                return null;
            }
        }

        function resolveFirebaseConfig() {
            if (typeof window !== 'undefined') {
                if (window.FIREBASE_CONFIG && window.FIREBASE_CONFIG.apiKey) {
                    return window.FIREBASE_CONFIG;
                }
                if (window.__FIREBASE_CONFIG__ && window.__FIREBASE_CONFIG__.apiKey) {
                    return window.__FIREBASE_CONFIG__;
                }
            }

            const embeddedScript = document.getElementById('firebase-config');
            if (embeddedScript && embeddedScript.textContent?.trim()) {
                const parsed = parseJsonSafely(embeddedScript.textContent.trim());
                if (parsed && parsed.apiKey) {
                    return parsed;
                }
            }

            const metaTag = document.querySelector('meta[name="firebase-config"]');
            if (metaTag) {
                const parsed = parseJsonSafely(metaTag.getAttribute('content'));
                if (parsed && parsed.apiKey) {
                    return parsed;
                }
            }

            return null;
        }

        function getElement(id) {
            return document.getElementById(id);
        }

        function updateText(id, value) {
            const el = getElement(id);
            if (el) {
                el.textContent = value;
            }
        }

        // Firebase Configuration - ปรับค่าได้จาก window.FIREBASE_CONFIG หรือแท็กฝังในเอกสาร
        const firebaseConfig = resolveFirebaseConfig();

        // Initialize Firebase
        let db = null;
        let auth = null;
        let analytics = null;
        
        if (firebaseConfig && firebaseConfig.apiKey) {
            try {
                // Initialize Firebase App
                firebase.initializeApp(firebaseConfig);

                // Initialize services
                db = firebase.firestore();
                auth = firebase.auth();

                // Initialize Analytics (optional)
                if (typeof firebase.analytics === 'function') {
                    analytics = firebase.analytics();
                    console.log('Firebase Analytics initialized');
                }

                // Configure Firestore settings
                db.settings({
                    cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
                });

                // Enable offline persistence
                db.enablePersistence({ synchronizeTabs: true })
                    .then(() => {
                        console.log('Firestore offline persistence enabled');
                    })
                    .catch((err) => {
                        console.log('Firestore offline persistence failed:', err);
                    });

                console.log('🔥 Firebase initialized successfully with real database!');
                showNotification('เชื่อมต่อฐานข้อมูลสำเร็จ! 🔥', 'success');

            } catch (error) {
                console.error('Firebase initialization error:', error);
                showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล กำลังใช้ระบบสำรอง', 'error');
            }
        } else {
            console.warn('Firebase configuration not provided. Running in offline mode.');
        }

        // Game State Management
        const gameState = {
            currentStep: 1,
            maxStepReached: 1,
            translatedWords: {},
            incorrectWords: {},
            wordAttempts: {}, // Track number of incorrect attempts per word
            imaginationText: '',
            interpretationText: '',
            comprehensionScore: 0,
            startTime: Date.now(),
            selectedWord: null,
            userId: null,
            gameId: null,
            stepHistory: []
        };

        const playerProfile = {
            exp: 0,
            rank: 'มือใหม่',
            totalGamesPlayed: 0,
            bestScore: 0,
            level: 1,
            expToNextLevel: 100
        };

        const DEFAULT_AVATAR = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><circle cx="20" cy="20" r="20" fill="%233b82f6"/><circle cx="20" cy="15" r="8" fill="%23ffffff"/><path d="M20 24c-6 0-12 3.2-12 9h24c0-5.8-6-9-12-9z" fill="%23ffffff"/></svg>';
        let floatingActionsDocHandler = null;
        let floatingActionsInitialized = false;
        let stepChipEventsInitialized = false;

        const DEFAULT_TEACHER_ACCOUNTS = {
            "teacher@thailit.app": {
                passcodeSegments: ['lit', 'pass', '123'],
                name: "ครูอารีย์ วิชิต",
                department: "กลุ่มสาระภาษาไทย",
                classes: ["ม.4/1", "ม.4/2"],
                role: "หัวหน้ากลุ่มสาระ",
                demo: true
            },
            "headteacher@thailit.app": {
                passcodeSegments: ['th', 'ail', 'it', '789'],
                name: "ครูวราภรณ์ มั่นคง",
                department: "กลุ่มสาระภาษาไทย",
                classes: ["ม.5/1", "ม.5/3", "ชมรมวรรณศิลป์"],
                role: "ครูพี่เลี้ยง",
                demo: true
            }
        };

        const teacherCredentials = (() => {
            if (typeof window !== 'undefined' && window.TEACHER_ACCOUNTS) {
                return window.TEACHER_ACCOUNTS;
            }
            return DEFAULT_TEACHER_ACCOUNTS;
        })();

        let currentTeacher = null;
        const teacherDashboardState = {
            rows: [],
            sessions: []
        };

        const RANK_TIERS = [
            { id: 'legend', label: 'นักสืบเซียน', icon: '🥇', minScore: 1000, description: '1000+ แต้ม' },
            { id: 'pro', label: 'นักสืบชำนาญ', icon: '🥈', minScore: 500, description: '500+ แต้ม' },
            { id: 'adept', label: 'นักสืบฝึกหัด', icon: '🥉', minScore: 200, description: '200+ แต้ม' },
            { id: 'rookie', label: 'มือใหม่', icon: '🌟', minScore: 0, description: '0+ แต้ม' }
        ];

        const SORTED_RANK_TIERS = [...RANK_TIERS].sort((a, b) => b.minScore - a.minScore);

        function determineRankTier(score = 0) {
            return SORTED_RANK_TIERS.find(tier => score >= tier.minScore) || SORTED_RANK_TIERS[SORTED_RANK_TIERS.length - 1];
        }

        const STEP_LABELS = {
            1: '📚 ประวัติศาสตร์',
            2: '📖 แสดงโคลง & เกมคำศัพท์',
            3: '📝 ถอดความ',
            4: '🖼️ เปิดภาพจริง',
            5: '📝 ทบทวน',
            6: '🏆 สรุปผล'
        };

        function getStepLabel(step) {
            if (step === undefined || step === null) {
                return 'ยังไม่เริ่ม';
            }
            if (step === 2.5) {
                return STEP_LABELS[2];
            }
            return STEP_LABELS[step] || `ขั้นที่ ${step}`;
        }

        function reconstructPasscode(credential) {
            if (!credential) return '';
            if (Array.isArray(credential.passcodeSegments)) {
                return credential.passcodeSegments.join('');
            }
            if (typeof credential.passcode === 'string') {
                return credential.passcode;
            }
            return '';
        }

        async function hashPasscode(passcode) {
            if (!passcode) return '';
            try {
                if (window.crypto?.subtle?.digest) {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(passcode);
                    const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
                    return Array.from(new Uint8Array(hashBuffer))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join('');
                }
            } catch (error) {
                console.warn('Secure hashing unavailable, falling back to lightweight hash.', error);
            }

            let hash = 0;
            for (let i = 0; i < passcode.length; i++) {
                hash = ((hash << 5) - hash) + passcode.charCodeAt(i);
                hash |= 0;
            }
            return hash.toString(16);
        }

        function shouldShowPassHint(credential) {
            return Boolean(credential && (credential.demo === true || credential.showHint === true));
        }

        function populateDemoTeacherHints() {
            const hintElements = document.querySelectorAll('[data-demo-pass]');
            hintElements.forEach(element => {
                const email = element.dataset.demoPass;
                const credential = teacherCredentials[email];
                if (!credential || !shouldShowPassHint(credential)) {
                    element.textContent = 'กรุณาใช้รหัสผ่านที่ได้รับจากคุณครู';
                    return;
                }

                const passcode = reconstructPasscode(credential);
                element.textContent = passcode || 'ใช้รหัสผ่านที่ได้รับจากคุณครู';
            });
        }

        function refreshTeacherViewIfNeeded() {
            if (currentTeacher) {
                renderTeacherDashboard().catch(error => console.error('Teacher dashboard refresh failed:', error));
            }
        }

        // Mission Data
        const MISSION_DATA = {
            MISSION_01: {
                title: "โคลงสี่สุภาพ - พระราชพงศาวดาร",
                historicalBackground: {
                    title: "ประวัติศาสตร์: สมเด็จพระสุริโยทัย",
                    content: `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <article class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-200 rounded-2xl p-6 h-full">
                                <h4 class="text-xl font-bold text-amber-900 mb-4">👑 สมเด็จพระสุริโยทัย</h4>
                                <p class="text-amber-800 leading-relaxed">
                                    สมเด็จพระสุริโยทัย เป็นพระมเหสีของสมเด็จพระมหาจักรพรรดิ (พระราเมศวร) แห่งกรุงศรีอยุธยา
                                    ทรงเป็นบุคคลสำคัญในประวัติศาสตร์ไทย ที่ทรงแสดงความกล้าหาญในการปกป้องแผ่นดิน
                                </p>
                            </article>

                            <article class="bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-200 rounded-2xl p-6 h-full">
                                <h4 class="text-xl font-bold text-red-900 mb-4">⚔️ สงครามกับพม่า (พ.ศ. 2091)</h4>
                                <p class="text-red-800 leading-relaxed">
                                    เมื่อพระเจ้าแปร (พระเจ้าตะบิงชเวตี) แห่งพม่ายกทัพมาตีกรุงศรีอยุธยา
                                    สมเด็จพระสุริโยทัยทรงแต่งกายเป็นทหาร ขี่ช้างออกรบเพื่อช่วยเหลือพระราชสามี
                                </p>
                            </article>

                            <article class="bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-2xl p-6 h-full">
                                <h4 class="text-xl font-bold text-purple-900 mb-4">🐘 การสิ้นพระชนม์อย่างกล้าหาญ</h4>
                                <p class="text-purple-800 leading-relaxed">
                                    ในระหว่างการรบ สมเด็จพระสุริโยทัยทรงขี่ช้างเข้าไปช่วยเหลือพระราชสามีที่ตกอยู่ในอันตราย
                                    แต่ทรงถูกพระเจ้าแปรใช้ง้าวฟันจนสิ้นพระชนม์บนหลังช้าง เป็นการเสียสละเพื่อแผ่นดิน
                                </p>
                            </article>

                            <article class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl p-6 h-full">
                                <h4 class="text-xl font-bold text-green-900 mb-4">📜 บันทึกในพระราชพงศาวดาร</h4>
                                <p class="text-green-800 leading-relaxed">
                                    เหตุการณ์นี้ได้รับการบันทึกไว้ในพระราชพงศาวดารกรุงศรีอยุธยา
                                    และได้รับการประพันธ์เป็นโคลงสี่สุภาพ เพื่อสรรเสริญพระเกียรติคุณและความกล้าหาญ
                                </p>
                            </article>
                        </div>
                    `
                },
                poem: `<div class="kloang-container">
                    <!-- บาทที่ ๑: วรรคหน้า 5 คำ + วรรคหลัง 2 คำ -->
                    <div class="bart">
                        <span class="wak-na">๏ <span class="word-to-find" data-word="นงคราญ">นงคราญ</span>องค์เอกแก้ว</span>
                        <span class="wak-lang">กระษัตรีย์</span>
                    </div>

                    <!-- บาทที่ ๒: วรรคหน้า 5 คำ + วรรคหลัง 2 คำ -->
                    <div class="bart">
                        <span class="wak-na"><span class="word-to-find" data-word="มาน">มาน</span>มนัส<span class="word-to-find" data-word="กัตเวที">กัตเวที</span></span>
                        <span class="wak-lang">ยิ่งล้ำ</span>
                    </div>

                    <!-- บาทที่ ๓: วรรคหน้า 5 คำ + วรรคหลัง 2 คำ + คำสร้อย 2 คำ -->
                    <div class="bart">
                        <span class="wak-na">เกรงพระราชสามี</span>
                        <span class="wak-lang"><span class="word-to-find" data-word="มลาย">มลาย</span>พระ</span>
                        <span class="kam-sroi">ชนม์เฮย</span>
                    </div>

                    <!-- บาทที่ ๔: วรรคหน้า 5 คำ + วรรคหลัง 4 คำ -->
                    <div class="bart">
                        <span class="wak-na">ขับ<span class="word-to-find" data-word="คเชนทร">คเชนทร</span>เข่นค้ำ</span>
                        <span class="wak-lang">สะอึกสู้<span class="word-to-find" data-word="ดัสกร">ดัสกร</span></span>
                    </div>

                    <!-- บาทที่ ๕: วรรคหน้า 5 คำ + วรรคหลัง 2 คำ -->
                    <div class="bart">
                        <span class="wak-na"> ๏ ขุนมอญร่อน<span class="word-to-find" data-word="ง้าว">ง้าว</span>ฟาด</span>
                        <span class="wak-lang">ฉาดฉะ</span>
                    </div>

                    <!-- บาทที่ ๖: วรรคหน้า 5 คำ + วรรคหลัง 2 คำ -->
                    <div class="bart">
                        <span class="wak-na">ขาด<span class="word-to-find" data-word="แล่ง">แล่ง</span>ตราบ<span class="word-to-find" data-word="อุระ">อุระ</span></span>
                        <span class="wak-lang"><span class="word-to-find" data-word="หรุบ">หรุบ</span>ดิ้น</span>
                    </div>

                    <!-- บาทที่ ๗: วรรคหน้า 5 คำ + วรรคหลัง 2 คำ + คำสร้อย 2 คำ -->
                    <div class="bart">
                        <span class="wak-na">โอรสรีบกันพระ</span>
                        <span class="wak-lang">ศพสู่</span>
                        <span class="kam-sroi">นครแฮ</span>
                    </div>

                    <!-- บาทที่ ๘: วรรคหน้า 5 คำ + วรรคหลัง 4 คำ -->
                    <div class="bart">
                        <span class="wak-na">สูญชีพ<span class="word-to-find" data-word="ไป่">ไป่</span>สูญสิ้น</span>
                        <span class="wak-lang"><span class="word-to-find" data-word="พจน์">พจน์</span>ผู้สรรเสริญ</span>
                    </div>
                </div>`,
                hardWords: {
                    "นงคราญ": { meaning: "นางงาม, สาวงาม, หญิงสาวที่มีความงาม, พระนาง", points: 15 },
                    "มาน": { meaning: "หัวใจ, จิตใจ, ความรู้สึก, อารมณ์", points: 15 },
                    "กัตเวที": { meaning: "ตอบแทนคุณ, รู้คุณ, กตัญญู, สำนึกในพระคุณ", points: 20 },
                    "มลาย": { meaning: "ตาย, สิ้นชีวิต, เสียชีวิต, สวรรคต", points: 18 },
                    "คเชนทร": { meaning: "ช้าง, ช้างเผือก, พาหนะ, สัตว์ใหญ่", points: 20 },
                    "ดัสกร": { meaning: "ข้าศึก, ศัตรู, คู่อริ, ผู้ร้าย", points: 18 },
                    "ง้าว": { meaning: "ดาบด้ามยาว, ทวน, อาวุธ, หอก, ใส", points: 15 },
                    "แล่ง": { meaning: "ผ่า, แยก, ฟัน, ตัด", points: 15 },
                    "อุระ": { meaning: "อก, หน้าอก, ทรวงอก, ส่วนหน้าของร่างกาย", points: 12 },
                    "หรุบ": { meaning: "ร่วง, ตก, ล้ม, หล่น", points: 15 },
                    "ไป่": { meaning: "ไม่, มิ, หา...ไม่, ปฏิเสธ", points: 10 },
                    "พจน์": { meaning: "พูด, กล่าว, คำพูด, วาจา", points: 15 }
                },
                correctInterpretation: "สมเด็จพระสุริโยทัยเกรงว่าพระสวามีจะสิ้นพระชนม์จึงได้ขับช้างเข้าขวางพระเจ้าแปรและต่อสู้กับพระเจ้าแปรแทน พระเจ้าแปรเอาง้าวฟันพระสุริโยทัย ผ่าตรงอกสิ้นพระชนม์บนคอช้าง สองพระโอรสคือ พระราเมศวร และมหินทราได้กันพระศพแล้วนำเข้าสู่เมือง สมเด็จพระสุริโยทัยสิ้นพระชนม์ไปแล้ว จึงเหลือแต่คำสรรเสริญเยินยอ",
                correctInterpretationKeywords: [
                    "สมเด็จพระสุริโยทัย", "กระษัตรีย์", "ตอบแทนคุณ", "พระราชสามี", "ตาย", 
                    "ช้าง", "ข้าศึก", "ขุนมอญ", "ง้าว", "ผ่า", "อก", "ร่วง", "โอรส", "พระศพ", "นคร", "คำพูด", "สรรเสริญ"
                ],
                officialImageURL: "https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_y6eb9wy6eb9wy6eb.png",
                officialImageDescription: "ภาพการต่อสู้ของสมเด็จพระสุริโยทัยบนหลังช้าง แสดงให้เห็นถึงความกล้าหาญในการปกป้องแผ่นดินและพระราชสามี",
                comprehensionQuestions: [
                    {
                        question: "จากการถอดความ สมเด็จพระสุริโยทัยทรงมีความรู้สึกอย่างไรต่อพระราชสามี",
                        options: ["เกรงกลัว", "เกรงใจและห่วงใย", "โกรธแค้น", "เฉยเมย"],
                        correct: 1
                    },
                    {
                        question: "เหตุใดสมเด็จพระสุริโยทัยจึงตัดสินใจขับช้างเข้าสู่การรบ",
                        options: ["เพื่อแสดงความกล้าหาญ", "เพื่อช่วยเหลือพระราชสามี", "เพื่อต่อสู้กับศัตรู", "เพื่อปกป้องแผ่นดิน"],
                        correct: 1
                    },
                    {
                        question: "คำว่า 'ขาดแล่งตราบอุระ หรุบดิ้น' สื่อความหมายว่าอย่างไร",
                        options: ["ถูกฟันที่แขน", "ถูกผ่าที่อกและล้มลง", "ถูกแทงที่ท้อง", "ถูกตีที่หลัง"],
                        correct: 1
                    },
                    {
                        question: "ความรู้สึกหลักที่โคลงนี้ต้องการสื่อคืออะไร",
                        options: ["ความเศร้าโศก", "ความกล้าหาญและการเสียสละ", "ความโกรธแค้น", "ความหวาดกลัว"],
                        correct: 1
                    },
                    {
                        question: "จากโคลง 'สูญชีพไป่สูญสิ้น พจน์ผู้สรรเสริญ' มีความหมายว่าอย่างไร",
                        options: ["ชีวิตจบลงแต่ชื่อเสียงยังคงอยู่", "ทุกอย่างหายไปหมด", "ไม่มีใครจำได้", "เหลือแต่ความทรงจำ"],
                        correct: 0
                    }
                ]
            }
        };

        // Database Functions
        async function saveUserData(userData) {
            try {
                if (db && gameState.userId) {
                    // Save to Firebase User collection
                    await db.collection('User').doc(gameState.userId).set(userData, { merge: true });
                    console.log('User data saved to Firebase User collection');
                } else {
                    // Fallback to localStorage
                    localStorage.setItem(`student_${gameState.userId}`, JSON.stringify(userData));
                    console.log('User data saved to localStorage');
                }
                refreshTeacherViewIfNeeded();
                return true;
            } catch (error) {
                console.error('Error saving user data:', error);
                // Fallback to localStorage
                localStorage.setItem(`student_${gameState.userId}`, JSON.stringify(userData));
                refreshTeacherViewIfNeeded();
                return false;
            }
        }

        async function loadUserData(userId) {
            try {
                if (db) {
                    // Try Firebase User collection first
                    const doc = await db.collection('User').doc(userId).get();
                    if (doc.exists) {
                        console.log('User data loaded from Firebase User collection');
                        return doc.data();
                    }
                }
                
                // Fallback to localStorage
                const localData = localStorage.getItem(`student_${userId}`);
                if (localData) {
                    console.log('User data loaded from localStorage');
                    return JSON.parse(localData);
                }
                
                return null;
            } catch (error) {
                console.error('Error loading user data:', error);
                // Fallback to localStorage
                const localData = localStorage.getItem(`student_${userId}`);
                return localData ? JSON.parse(localData) : null;
            }
        }

        async function saveGameSession(gameDataOverride) {
            try {
                const sessionTimestamp = new Date().toISOString();

                const fallbackGameData = (typeof window !== 'undefined' && typeof window.gameData === 'object' && window.gameData)
                    ? window.gameData
                    : {};
                const safeGameData = (typeof gameDataOverride === 'object' && gameDataOverride)
                    ? gameDataOverride
                    : fallbackGameData;
                const safeUser = (typeof gameState === 'object' && gameState?.currentUser)
                    ? gameState.currentUser
                    : {};

                const sessionData = {
                    ...safeGameData,
                    userId: gameState?.userId || safeUser.uid || '',
                    userName: safeUser.name || safeUser.displayName || 'Unknown',
                    userEmail: safeUser.email || '',
                    studentId: safeUser.studentId || '',
                    currentStep: Number(gameState?.currentStep ?? 0),
                    completed: gameState?.currentStep === 6 || !!gameState?.completed,
                    comprehensionScore: Number(gameState?.comprehensionScore ?? 0),
                    matchingScore: Number(gameState?.matchingScore ?? 0),
                    matchedPairs: Number(gameState?.matchedPairs ?? 0),
                    lastUpdated: sessionTimestamp,
                    timestamp: sessionTimestamp,
                };

                const generatedId = `${sessionData.userId || 'anon'}_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
                const sessionId = gameState?.gameId || generatedId;
                if (!gameState?.gameId) {
                    gameState.gameId = sessionId;
                }

                let savedRemotely = false;

                if (typeof db !== 'undefined' && db) {
                    try {
                        await db.collection('GameSession').doc(sessionId).set(sessionData);
                        savedRemotely = true;
                    } catch (primaryError) {
                        console.warn('Primary GameSession collection write failed, trying legacy collection', primaryError);
                        try {
                            await db.collection('gameSessions').doc(sessionId).set(sessionData);
                            savedRemotely = true;
                        } catch (legacyError) {
                            console.error('Legacy gameSessions collection write failed', legacyError);
                        }
                    }

                    if (savedRemotely) {
                        console.log('GameSession saved to Firestore:', sessionId);
                    }
                }

                if (!savedRemotely) {
                    const KEY = 'GameSessionCache';
                    const cache = JSON.parse(localStorage.getItem(KEY) || '[]');
                    const filtered = cache.filter(entry => entry.id !== sessionId);
                    filtered.push({ id: sessionId, ...sessionData });
                    localStorage.setItem(KEY, JSON.stringify(filtered));
                    console.log('GameSession saved to localStorage:', sessionId);
                }

                if (typeof refreshTeacherViewIfNeeded === 'function') {
                    refreshTeacherViewIfNeeded();
                }

                return { ok: true, id: sessionId, data: sessionData };
            } catch (err) {
                console.error('Error saveGameSession:', err);
                return { ok: false, error: String(err?.message || err) };
            }
        }

        // Save all user answers to Firebase UserAnswer collection
        async function saveAllUserAnswers() {
            try {
                const now = new Date().toISOString();
                const safeUser = (typeof gameState === 'object' && gameState?.currentUser) ? gameState.currentUser : {};

                const safeTranslatedWords = (typeof gameState?.translatedWords === 'object' && gameState.translatedWords)
                    ? gameState.translatedWords
                    : {};
                const safeIncorrectWords = (typeof gameState?.incorrectWords === 'object' && gameState.incorrectWords)
                    ? gameState.incorrectWords
                    : {};

                const answersData = {
                    userId: gameState?.userId || safeUser.uid || '',
                    userName: safeUser.name || safeUser.displayName || 'Unknown',
                    userEmail: safeUser.email || '',
                    studentId: safeUser.studentId || '',

                    gameId: gameState?.gameId || null,
                    currentStep: Number(gameState?.currentStep ?? 0),

                    comprehensionAnswers: Array.isArray(gameState?.comprehensionAnswers)
                        ? gameState.comprehensionAnswers
                        : [],
                    comprehensionScore: Number(gameState?.comprehensionScore ?? 0),

                    translatedWords: safeTranslatedWords,
                    incorrectWords: safeIncorrectWords,
                    wordAttempts: (typeof gameState?.wordAttempts === 'object' && gameState.wordAttempts)
                        ? gameState.wordAttempts
                        : {},

                    imaginationText: gameState?.imaginationText || '',
                    interpretationText: gameState?.interpretationText || '',

                    matchingScore: Number(gameState?.matchingScore ?? 0),
                    matchedPairs: Number(gameState?.matchedPairs ?? 0),

                    vocabularyAnswers: Object.keys(safeTranslatedWords).map(wordKey => ({
                        word: wordKey,
                        userAnswer: safeTranslatedWords[wordKey]?.translation || '',
                        correctAnswer: MISSION_DATA?.MISSION_01?.hardWords?.[wordKey]?.meaning || '',
                        reference: safeTranslatedWords[wordKey]?.reference || '',
                        points: Number(safeTranslatedWords[wordKey]?.points ?? 0),
                        timestamp: safeTranslatedWords[wordKey]?.timestamp || now,
                        isCorrect: true,
                    })),
                    incorrectAttempts: Object.keys(safeIncorrectWords).map(wordKey => ({
                        word: wordKey,
                        userAnswer: safeIncorrectWords[wordKey]?.translation || '',
                        correctAnswer: MISSION_DATA?.MISSION_01?.hardWords?.[wordKey]?.meaning || '',
                        reference: safeIncorrectWords[wordKey]?.reference || '',
                        timestamp: safeIncorrectWords[wordKey]?.timestamp || now,
                        isCorrect: false,
                    })),

                    missionId: 'MISSION_01',
                    missionTitle: 'โคลงสี่สุภาพ - พระราชพงศาวดาร',

                    timestamp: now,
                    lastUpdated: now,
                };

                const answersDocId = `${answersData.userId || 'anon'}_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;

                if (!answersData.userId) {
                    console.warn('saveAllUserAnswers: missing userId, storing locally');
                }

                if (typeof db !== 'undefined' && db && answersData.userId) {
                    await db.collection('UserAnswer').doc(answersDocId).set(answersData);
                    console.log('All user answers saved to Firestore:', answersDocId);
                } else {
                    const KEY = 'UserAnswerCache';
                    const cache = JSON.parse(localStorage.getItem(KEY) || '[]');
                    cache.push({ id: answersDocId, ...answersData });
                    localStorage.setItem(KEY, JSON.stringify(cache));
                    console.log('All user answers saved to localStorage:', answersDocId);
                }

                if (typeof refreshTeacherViewIfNeeded === 'function') {
                    refreshTeacherViewIfNeeded();
                }

                return { ok: true, id: answersDocId, data: answersData };
            } catch (error) {
                console.error('Error saving user answers:', error);
                return { ok: false, error: String(error?.message || error) };
            }
        }

            // Some steps use 2.5 as special UI marker, normalize for logic
            const logicalStep = stepValue === 2.5 ? 2 : stepValue;
            const currentLogical = gameState.currentStep === 2.5 ? 2 : gameState.currentStep;

            // Prevent jumping ahead
            if (logicalStep > (gameState.maxStepReached || 1)) return;
            if (logicalStep === currentLogical) return;

        // Authentication Functions
        async function signInWithGoogle() {
            try {
                if (auth) {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    const result = await auth.signInWithPopup(provider);
                    const user = result.user;
                    
                    gameState.userId = user.uid;
                    gameState.currentUser = {
                        name: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        isGoogle: true
                    };
                    
                    // Load or create user profile
                    let userData = await loadUserData(user.uid);
                    if (!userData) {
                        userData = {
                            name: user.displayName,
                            email: user.email,
                            photoURL: user.photoURL,
                            registeredAt: new Date().toISOString(),
                            exp: 0,
                            rank: 'มือใหม่',
                            level: 1,
                            totalGamesPlayed: 0,
                            bestScore: 0,
                            isGoogle: true
                        };
                        await saveUserData(userData);
                    }
                    
                    // Update player profile
                    playerProfile.exp = userData.exp || 0;
                    playerProfile.rank = userData.rank || 'มือใหม่';
                    playerProfile.level = userData.level || 1;
                    playerProfile.totalGamesPlayed = userData.totalGamesPlayed || 0;
                    playerProfile.bestScore = userData.bestScore || 0;
                    
                    updateLoginUI({
                        displayName: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        isGoogle: true,
                        userData: userData
                    });
                    
                    updateUserNameDisplay();
                    showNotification(`ยินดีต้อนรับ ${user.displayName}!`, 'success');
                } else {
                    showNotification('ระบบล็อกอิน Google ไม่พร้อมใช้งานในสภาพแวดล้อมนี้', 'error');
                }
            } catch (error) {
                console.error('Google sign-in error:', error);
                showNotification('เกิดข้อผิดพลาดในการเข้าสู่ระบบ', 'error');
            }
        }
        
        async function signOutUser() {
            try {
                // Save current game state before signing out
                if (gameState.gameId && gameState.userId) {
                    await saveCurrentGameState();
                    await saveAllUserAnswers();
                }
                
                // Clear user data
                gameState.userId = null;
                gameState.currentUser = null;
                localStorage.removeItem('lastStudentId');
                
                // Reset game state
                gameState.currentStep = 1;
                gameState.maxStepReached = 1;
                gameState.translatedWords = {};
                gameState.incorrectWords = {};
                gameState.imaginationText = '';
                gameState.interpretationText = '';
                gameState.comprehensionScore = 0;
                gameState.startTime = Date.now();
                gameState.selectedWord = null;
                gameState.stepHistory = [];
                gameState.comprehensionAnswers = [];
                gameState.gameId = null;
                
                // Update UI
                updateLoginUI(null);
                showNotification('ออกจากระบบเรียบร้อย', 'success');
                
            } catch (error) {
                console.error('Error signing out:', error);
                // Still proceed with sign out even if save fails
                gameState.userId = null;
                gameState.currentUser = null;
                localStorage.removeItem('lastStudentId');
                updateLoginUI(null);
                showNotification('ออกจากระบบเรียบร้อย', 'success');
            }
        }
        
        // Student Management Functions
        function showStudentForm() {
            document.getElementById('loginButtons').classList.add('hidden');
            document.getElementById('studentForm').classList.remove('hidden');
            const startWrapper = document.getElementById('startButtonWrapper');
            if (startWrapper) startWrapper.classList.add('hidden');
        }

        function hideStudentForm() {
            document.getElementById('loginButtons').classList.remove('hidden');
            document.getElementById('studentForm').classList.add('hidden');
            const startWrapper = document.getElementById('startButtonWrapper');
            if (startWrapper) startWrapper.classList.remove('hidden');
            clearStudentForm();
        }

        function showLoginForm() {
            document.getElementById('loginButtons').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            const startWrapper = document.getElementById('startButtonWrapper');
            if (startWrapper) startWrapper.classList.add('hidden');
        }

        function hideLoginForm() {
            document.getElementById('loginButtons').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            const startWrapper = document.getElementById('startButtonWrapper');
            if (startWrapper) startWrapper.classList.remove('hidden');
            clearLoginForm();
        }
        
        function clearStudentForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentId').value = '';
            document.getElementById('studentGrade').value = '';
            document.getElementById('studentRoom').value = '';
            document.getElementById('studentNumber').value = '';
            document.getElementById('studentPhone').value = '';
        }
        
        function clearLoginForm() {
            document.getElementById('loginStudentId').value = '';
            document.getElementById('loginPhone').value = '';
        }
        
        async function registerStudent() {
            const name = document.getElementById('studentName').value.trim();
            const studentId = document.getElementById('studentId').value.trim();
            const grade = document.getElementById('studentGrade').value;
            const room = document.getElementById('studentRoom').value.trim();
            const number = document.getElementById('studentNumber').value.trim();
            const phone = document.getElementById('studentPhone').value.trim();
            
            // Validation
            if (!name || !studentId || !grade || !room || !number || !phone) {
                showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
                return;
            }
            
            if (phone.length < 10) {
                showNotification('กรุณากรอกเบอร์โทรศัพท์ให้ถูกต้อง', 'error');
                return;
            }
            
            const studentData = {
                name: name,
                studentId: studentId,
                grade: grade,
                room: room,
                number: number,
                phone: phone,
                registeredAt: new Date().toISOString(),
                exp: 0,
                rank: 'มือใหม่',
                level: 1,
                totalGamesPlayed: 0,
                bestScore: 0,
                isStudent: true
            };
            
            try {
                // Set current user
                gameState.userId = studentId;
                gameState.currentUser = studentData;
                
                // Save to database
                await saveUserData(studentData);
                
                // Save last student ID for auto-login
                localStorage.setItem('lastStudentId', studentId);
                
                // Update player profile
                playerProfile.exp = studentData.exp;
                playerProfile.rank = studentData.rank;
                playerProfile.level = studentData.level;
                playerProfile.totalGamesPlayed = studentData.totalGamesPlayed;
                playerProfile.bestScore = studentData.bestScore;
                
                // Update UI
                updateLoginUI({
                    displayName: name,
                    email: `${grade}/${room} เลขที่ ${number}`,
                    photoURL: '',
                    isStudent: true,
                    studentData: studentData
                });
                
                updateUserNameDisplay();
                showNotification('บันทึกข้อมูลเรียบร้อย!', 'success');
                hideStudentForm();
                
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
            }
        }
        
        async function loginStudent() {
            const studentId = document.getElementById('loginStudentId').value.trim();
            const phone = document.getElementById('loginPhone').value.trim();
            
            if (!studentId || !phone) {
                showNotification('กรุณากรอกรหัสนักเรียนและเบอร์โทรศัพท์', 'error');
                return;
            }
            
            try {
                // Try to load from database first
                let studentData = await loadUserData(studentId);
                
                if (!studentData) {
                    showNotification('ไม่พบข้อมูลนักเรียน', 'error');
                    return;
                }
                
                // Verify phone number
                if (studentData.phone !== phone) {
                    showNotification('เบอร์โทรศัพท์ไม่ถูกต้อง', 'error');
                    return;
                }
                
                // Set current user
                gameState.userId = studentId;
                gameState.currentUser = studentData;
                
                // Save last student ID for auto-login
                localStorage.setItem('lastStudentId', studentId);
                
                // Update player profile
                playerProfile.exp = studentData.exp || 0;
                playerProfile.rank = studentData.rank || 'มือใหม่';
                playerProfile.level = studentData.level || 1;
                playerProfile.totalGamesPlayed = studentData.totalGamesPlayed || 0;
                playerProfile.bestScore = studentData.bestScore || 0;
                
                // Update UI
                updateLoginUI({
                    displayName: studentData.name,
                    email: `${studentData.grade}/${studentData.room} เลขที่ ${studentData.number}`,
                    photoURL: '',
                    isStudent: true,
                    studentData: studentData
                });
                
                showNotification(`ยินดีต้อนรับ ${studentData.name}!`, 'success');
                hideLoginForm();
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification('เกิดข้อผิดพลาดในการเข้าสู่ระบบ', 'error');
            }
        }
        
        function updateLoginUI(user) {
            const loginButtons = document.getElementById('loginButtons');
            const studentForm = document.getElementById('studentForm');
            const loginForm = document.getElementById('loginForm');
            const userInfo = document.getElementById('userInfo');
            const startGameBtn = document.getElementById('startGameBtn');
            const startWrapper = document.getElementById('startButtonWrapper');
            const startHint = document.getElementById('startButtonHint');
            const landingPage = document.getElementById('landingPage');
            const teacherCta = document.getElementById('teacherLoginCta');
            const footer = document.getElementById('siteFooter');

            if (user) {
                // Hide all forms
                if (loginButtons) loginButtons.classList.add('hidden');
                if (studentForm) studentForm.classList.add('hidden');
                if (loginForm) loginForm.classList.add('hidden');
                if (userInfo) userInfo.classList.remove('hidden');
                if (startGameBtn) startGameBtn.disabled = false;
                if (startWrapper) startWrapper.classList.remove('hidden');
                if (startHint) {
                    startHint.textContent = 'พร้อมเริ่มภารกิจได้เลย';
                    startHint.classList.remove('text-purple-700/70');
                    startHint.classList.add('text-emerald-700/80');
                }
                if (teacherCta) teacherCta.classList.add('hidden');
                if (footer) footer.classList.remove('hidden');

                // Add class to make background more transparent when logged in
                if (landingPage) landingPage.classList.add('user-logged-in');
                
                // Update user info
                const userName = document.getElementById('userName');
                const userDetails = document.getElementById('userDetails');
                const userStats = document.getElementById('userStats');
                const userPhoto = document.getElementById('userPhoto');
                
                if (userName) userName.textContent = user.displayName;
                if (userDetails) userDetails.textContent = user.email;
                if (userStats) userStats.textContent = `EXP: ${playerProfile.exp} | เกม: ${playerProfile.totalGamesPlayed}`;
                
                // Set student avatar
                if (userPhoto) {
                    userPhoto.src = DEFAULT_AVATAR;
                }
                
                gameState.userId = gameState.userId;
            } else {
                // Show login options
                if (loginButtons) loginButtons.classList.remove('hidden');
                if (studentForm) studentForm.classList.add('hidden');
                if (loginForm) loginForm.classList.add('hidden');
                if (userInfo) userInfo.classList.add('hidden');
                if (startGameBtn) startGameBtn.disabled = true;
                if (startWrapper) startWrapper.classList.remove('hidden');
                if (startHint) {
                    startHint.textContent = 'เข้าสู่ระบบก่อนเพื่อเปิดภารกิจ';
                    startHint.classList.remove('text-emerald-700/80');
                    startHint.classList.add('text-purple-700/70');
                }
                if (teacherCta) teacherCta.classList.remove('hidden');
                if (footer) footer.classList.add('hidden');

                // Remove class to show background clearly when not logged in
                if (landingPage) landingPage.classList.remove('user-logged-in');
                
                gameState.userId = null;
                gameState.currentUser = null;
            }
        }

        function openTeacherPortal() {
            const portal = document.getElementById('teacherPortal');
            const landing = document.getElementById('landingPage');
            const footer = document.getElementById('siteFooter');
            const stepBar = document.getElementById('stepUtilityBar');
            const playerBar = document.getElementById('playerStatusBar');
            const floatingActions = document.getElementById('floatingActionButtons');
            if (!portal) return;

            portal.classList.remove('hidden');
            if (landing) landing.classList.add('hidden');
            if (footer) footer.classList.remove('hidden');
            if (stepBar) stepBar.classList.add('hidden');
            if (playerBar) playerBar.classList.add('hidden');
            if (floatingActions) {
                floatingActions.classList.add('hidden');
                floatingActions.classList.remove('show');
                floatingActions.setAttribute('aria-hidden', 'true');
            }
            closeTeacherStudentModal();
            window.scrollTo({ top: 0, behavior: 'smooth' });

            const loginPanel = document.getElementById('teacherLoginPanel');
            const dashboard = document.getElementById('teacherDashboard');

            if (currentTeacher) {
                if (loginPanel) loginPanel.classList.add('hidden');
                if (dashboard) dashboard.classList.remove('hidden');
                renderTeacherDashboard();
            } else {
                if (loginPanel) loginPanel.classList.remove('hidden');
                if (dashboard) dashboard.classList.add('hidden');
                resetTeacherLoginForm();
            }
        }

        function closeTeacherPortal() {
            const portal = document.getElementById('teacherPortal');
            const landing = document.getElementById('landingPage');
            const footer = document.getElementById('siteFooter');
            const stepBar = document.getElementById('stepUtilityBar');
            const playerBar = document.getElementById('playerStatusBar');
            const floatingActions = document.getElementById('floatingActionButtons');
            if (!portal) return;

            portal.classList.add('hidden');
            if (landing) landing.classList.remove('hidden');
            if (footer) {
                if (gameState.userId) {
                    footer.classList.remove('hidden');
                } else {
                    footer.classList.add('hidden');
                }
            }
            closeTeacherStudentModal();
            if (stepBar || playerBar) {
                const landingVisible = landing ? !landing.classList.contains('hidden') : false;
                const shouldShowPlayer = gameState.userId && !landingVisible;
                if (stepBar) stepBar.classList.toggle('hidden', !shouldShowPlayer);
                if (playerBar) playerBar.classList.toggle('hidden', !shouldShowPlayer);
                if (floatingActions) {
                    floatingActions.classList.toggle('hidden', !shouldShowPlayer);
                    if (!shouldShowPlayer) {
                        floatingActions.classList.remove('show');
                    }
                    floatingActions.setAttribute('aria-hidden', (!shouldShowPlayer).toString());
                }
            }
        }

        function resetTeacherLoginForm() {
            const emailInput = document.getElementById('teacherEmail');
            const passwordInput = document.getElementById('teacherPassword');
            if (emailInput) emailInput.value = '';
            if (passwordInput) passwordInput.value = '';
        }

        async function submitTeacherLogin(event) {
            event.preventDefault();

            const emailInput = document.getElementById('teacherEmail');
            const passwordInput = document.getElementById('teacherPassword');

            const email = emailInput?.value.trim().toLowerCase();
            const password = passwordInput?.value.trim();

            if (!email || !password) {
                showNotification('กรุณากรอกอีเมลและรหัสผ่านของคุณครู', 'error');
                return;
            }

            const credential = teacherCredentials[email];
            if (!credential) {
                showNotification('อีเมลหรือรหัสผ่านไม่ถูกต้อง', 'error');
                if (passwordInput) passwordInput.value = '';
                return;
            }

            const inputHash = await hashPasscode(password);
            const expectedPasscode = reconstructPasscode(credential);
            let isValid = false;

            if (expectedPasscode) {
                const expectedHash = await hashPasscode(expectedPasscode);
                isValid = expectedHash === inputHash;
            } else if (typeof credential.passcodeHash === 'string' && credential.passcodeHash.length > 0) {
                isValid = credential.passcodeHash === inputHash;
            }

            if (!isValid) {
                showNotification('อีเมลหรือรหัสผ่านไม่ถูกต้อง', 'error');
                if (passwordInput) passwordInput.value = '';
                return;
            }

            const { passcodeSegments, passcode, passcodeHash, ...safeCredential } = credential;
            currentTeacher = {
                email,
                ...safeCredential
            };

            const loginPanel = document.getElementById('teacherLoginPanel');
            const dashboard = document.getElementById('teacherDashboard');

            if (loginPanel) loginPanel.classList.add('hidden');
            if (dashboard) dashboard.classList.remove('hidden');

            showNotification(`ยินดีต้อนรับ ${credential.name}`, 'success');
            await renderTeacherDashboard();
        }

        function logoutTeacher() {
            currentTeacher = null;
            const loginPanel = document.getElementById('teacherLoginPanel');
            const dashboard = document.getElementById('teacherDashboard');
            if (loginPanel) loginPanel.classList.remove('hidden');
            if (dashboard) dashboard.classList.add('hidden');
            resetTeacherLoginForm();
            showNotification('ออกจากระบบครูเรียบร้อย', 'success');
        }


        async function renderTeacherDashboard() {
            const loading = document.getElementById('teacherDashboardLoading');
            const summary = document.getElementById('teacherSummaryCards');
            const tableBody = document.getElementById('teacherStudentTable');
            const timeline = document.getElementById('teacherActivityTimeline');
            const emptyState = document.getElementById('teacherEmptyState');
            const tableMeta = document.getElementById('teacherTableMeta');
            const timelineMeta = document.getElementById('teacherTimelineMeta');
            const rankingContainer = document.getElementById('teacherRankingSummary');
            const rankingMeta = document.getElementById('teacherRankingMeta');
            const quickTotal = document.getElementById('teacherQuickTotal');
            const quickAverage = document.getElementById('teacherQuickAverage');
            const quickStudents = document.getElementById('teacherQuickStudents');
            const quickCompleted = document.getElementById('teacherQuickCompleted');
            const quickActive = document.getElementById('teacherQuickActive');
            const greeting = document.getElementById('teacherGreeting');
            const classesEl = document.getElementById('teacherClasses');
            const emailEl = document.getElementById('teacherEmailDisplay');

            try {
                if (currentTeacher) {
                    if (greeting) greeting.textContent = `ยินดีต้อนรับ ${currentTeacher.name}`;
                    if (classesEl) classesEl.textContent = currentTeacher.classes?.length ? `ดูแล: ${currentTeacher.classes.join(', ')}` : 'บัญชีครูภาษาไทย';
                    if (emailEl) emailEl.textContent = `${currentTeacher.role || 'ครูผู้สอน'} • ${currentTeacher.email}`;
                }

                if (summary) summary.innerHTML = '';
                if (tableBody) tableBody.innerHTML = '';
                if (timeline) timeline.innerHTML = '';
                if (tableMeta) tableMeta.textContent = '';
                if (timelineMeta) timelineMeta.textContent = '';
                if (emptyState) emptyState.classList.add('hidden');

                if (loading) loading.classList.remove('hidden');

                const { students, sessions } = await fetchTeacherData();

                if (loading) loading.classList.add('hidden');

                const studentRows = buildStudentRows(students, sessions);
                const completedSessions = sessions.filter(session => session.completed);
                const totalScore = sessions.reduce((sum, session) => sum + (Number(session.totalScore) || 0), 0);
                const averageScore = sessions.length ? Math.round(totalScore / sessions.length) : 0;
                const activeToday = sessions.filter(session => {
                    const activityDate = session.lastUpdatedAt || session.timestampAt || session.lastUpdated || session.timestamp;
                    const parsed = parseDate(activityDate);
                    if (!parsed) return false;
                    const now = new Date();
                    return parsed.getFullYear() === now.getFullYear() && parsed.getMonth() === now.getMonth() && parsed.getDate() === now.getDate();
                });

                if (quickTotal) quickTotal.textContent = totalScore ? totalScore.toLocaleString('th-TH') : '0';
                if (quickAverage) quickAverage.textContent = sessions.length ? `${averageScore}` : '0';
                if (quickCompleted) quickCompleted.textContent = completedSessions.length.toString();
                if (quickActive) quickActive.textContent = activeToday.length.toString();
                if (quickStudents) quickStudents.textContent = studentRows.length.toString();

                if (studentRows.length === 0 && sessions.length === 0) {
                    if (emptyState) emptyState.classList.remove('hidden');
                    return;
                }

                const sortedStudentRows = [...studentRows].sort((a, b) => {
                    const totalDiff = (b.totalScore || 0) - (a.totalScore || 0);
                    if (totalDiff !== 0) return totalDiff;
                    const scoreDiff = (b.averageScore || 0) - (a.averageScore || 0);
                    if (scoreDiff !== 0) return scoreDiff;

                    const aDate = parseDate(a.latestSession?.lastUpdatedAt || a.latestSession?.timestampAt || a.latestSession?.lastUpdated || a.latestSession?.timestamp);
                    const bDate = parseDate(b.latestSession?.lastUpdatedAt || b.latestSession?.timestampAt || b.latestSession?.lastUpdated || b.latestSession?.timestamp);
                    return (bDate?.getTime() || 0) - (aDate?.getTime() || 0);
                });

                teacherDashboardState.sessions = sessions;
                teacherDashboardState.rows = sortedStudentRows;
                resetTeacherStudentDetail();

                if (summary) {
                    const inProgress = sessions.length - completedSessions.length;
                    const summaryData = [
                        {
                            label: 'คะแนนรวมทั้งหมด',
                            value: totalScore ? totalScore.toLocaleString('th-TH') : '0',
                            description: 'รวมคะแนนจากทุกกิจกรรมที่บันทึก',
                            gradient: 'from-amber-500 to-orange-500',
                            icon: '🏅'
                        },
                        {
                            label: 'นักเรียนที่ลงทะเบียน',
                            value: studentRows.length,
                            description: 'มีโปรไฟล์หรือบันทึกคะแนนในระบบ',
                            gradient: 'from-blue-500 to-indigo-500',
                            icon: '👨‍🎓'
                        },
                        {
                            label: 'ภารกิจที่เสร็จสมบูรณ์',
                            value: completedSessions.length,
                            description: 'ปิดจบครบทุกขั้น',
                            gradient: 'from-emerald-500 to-teal-500',
                            icon: '🏆'
                        },
                        {
                            label: 'กำลังทำอยู่',
                            value: Math.max(inProgress, 0),
                            description: 'อยู่ระหว่างภารกิจ',
                            gradient: 'from-sky-500 to-indigo-500',
                            icon: '⏳'
                        },
                        {
                            label: 'คะแนนเฉลี่ยรวม',
                            value: sessions.length ? `${averageScore}` : '0',
                            description: 'จากทุกเกมที่บันทึก',
                            gradient: 'from-purple-500 to-pink-500',
                            icon: '📊'
                        }
                    ];

                    summary.innerHTML = summaryData.map(card => `
                        <div class="teacher-summary-card bg-white border border-slate-200 rounded-3xl p-5 flex flex-col gap-3 shadow-sm">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">${card.icon}</span>
                                <div>
                                    <p class="text-xs uppercase tracking-wide text-slate-500">${card.label}</p>
                                    <p class="text-2xl font-bold text-slate-900">${card.value}</p>
                                </div>
                            </div>
                            <div class="mt-auto">
                                <div class="h-1.5 rounded-full bg-slate-200 overflow-hidden">
                                    <div class="h-full bg-gradient-to-r ${card.gradient}"></div>
                                </div>
                                <p class="text-xs text-slate-500 mt-2">${card.description}</p>
                            </div>
                        </div>
                    `).join('');
                }

                if (tableBody) {
                    tableBody.innerHTML = sortedStudentRows.map(row => {
                        const gradeRoom = row.grade ? `${row.grade}${row.room ? `/${row.room}` : ''}` : '-';
                        const progressPercent = Math.min(100, Math.round(((row.latestSession?.currentStep || 1) / 6) * 100));
                        const studentTotalScore = row.totalScore ? Math.round(row.totalScore) : 0;
                        const latestScore = row.latestSession ? Math.round(Number(row.latestSession.totalScore) || Number(row.latestSession.comprehensionScore) || 0) : 0;
                        const updatedAt = row.latestSession ? formatDateTime(row.latestSession.lastUpdatedAt || row.latestSession.timestampAt || row.latestSession.lastUpdated || row.latestSession.timestamp) : '-';
                        const completionBadge = row.completionCount > 0 ? `<span class="px-2 py-1 rounded-full text-xs bg-emerald-100 text-emerald-700">เสร็จ ${row.completionCount} ครั้ง</span>` : `<span class="px-2 py-1 rounded-full text-xs bg-amber-100 text-amber-700">กำลังทำ</span>`;

                        return `
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-4 py-3" data-label="นักเรียน">
                                    <div class="flex flex-col">
                                        <button type="button" data-student-key="${row.key || row.studentId}" class="teacher-student-link text-left font-semibold text-slate-900 hover:text-blue-600 focus:outline-none focus:text-blue-700 transition">
                                            ${row.name || 'ไม่ระบุชื่อ'}
                                        </button>
                                        <span class="text-xs text-slate-500">${row.studentId || '-'}</span>
                                        <span class="inline-flex items-center gap-1 text-xs font-semibold text-blue-600">
                                            ${row.rankTier?.icon || '🌟'} ${row.rankTier?.label || 'มือใหม่'}
                                        </span>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-slate-600" data-label="ชั้น/ห้อง">
                                    <div class="flex flex-col gap-1">
                                        <span>${gradeRoom}</span>
                                        <span class="text-xs text-slate-500">เลขที่ ${row.number || '-'}</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3" data-label="ความคืบหน้า">
                                    <div class="flex flex-col gap-1">
                                        <div class="h-2.5 rounded-full bg-slate-200">
                                            <div class="h-full rounded-full bg-gradient-to-r from-blue-500 to-indigo-500" style="width: ${progressPercent}%"></div>
                                        </div>
                                        <div class="flex items-center justify-between text-xs text-slate-500">
                                            <span>${progressPercent}%</span>
                                            ${completionBadge}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-slate-600" data-label="คะแนนรวม">
                                    <div class="flex flex-col gap-1">
                                        <span class="font-semibold text-slate-900">${studentTotalScore.toLocaleString('th-TH')}</span>
                                        <span class="text-xs text-slate-500">จาก ${row.sessions.length} ภารกิจ</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-slate-600" data-label="คะแนนเฉลี่ย">
                                    <div class="flex flex-col gap-1">
                                        <span class="font-semibold text-slate-900">${(row.averageScore || latestScore).toLocaleString('th-TH')}</span>
                                        <span class="text-xs text-slate-500">ล่าสุด ${latestScore.toLocaleString('th-TH')}</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-slate-600 text-sm" data-label="อัปเดตล่าสุด">${updatedAt}</td>
                            </tr>
                        `;
                    }).join('');

                    tableBody.querySelectorAll('.teacher-student-link').forEach(button => {
                        button.addEventListener('click', () => {
                            const key = button.getAttribute('data-student-key');
                            showTeacherStudentDetail(key);
                        });
                    });
                }

                if (tableMeta) {
                    const totalRecordedScore = totalScore ? totalScore.toLocaleString('th-TH') : '0';
                    tableMeta.textContent = `${sortedStudentRows.length} รายการ • คะแนนรวม ${totalRecordedScore} • อัปเดต ${formatDateTime(new Date())}`;
                }

                if (rankingContainer) {
                    const tierStats = RANK_TIERS.map(tier => {
                        const members = sortedStudentRows.filter(row => row.rankTier?.id === tier.id);
                        const topMember = members.length
                            ? [...members].sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0))[0]
                            : null;
                        return { tier, count: members.length, topMember };
                    });

                    rankingContainer.innerHTML = tierStats.map(({ tier, count, topMember }) => {
                        const topLabel = topMember
                            ? ` • สูงสุด ${topMember.name || 'ไม่ระบุชื่อ'} (${Math.round(topMember.totalScore || 0).toLocaleString('th-TH')} แต้ม)`
                            : '';
                        return `
                            <div class="teacher-rank-card">
                                <div class="rank-tier">${tier.icon} ${tier.label}</div>
                                <div class="text-2xl font-bold text-slate-900">${count.toLocaleString('th-TH')}</div>
                                <div class="rank-meta">${tier.description}${topLabel}</div>
                            </div>
                        `;
                    }).join('');
                }

                if (rankingMeta) {
                    rankingMeta.textContent = `${sortedStudentRows.length} รายชื่อ • อัปเดต ${formatDateTime(new Date())}`;
                }

                if (timeline) {
                    const recentActivities = [...sessions]
                        .sort((a, b) => {
                            const aDate = parseDate(a.lastUpdatedAt || a.timestampAt || a.lastUpdated || a.timestamp);
                            const bDate = parseDate(b.lastUpdatedAt || b.timestampAt || b.lastUpdated || b.timestamp);
                            return (bDate?.getTime() || 0) - (aDate?.getTime() || 0);
                        })
                        .slice(0, 6);

                    if (recentActivities.length === 0) {
                        timeline.innerHTML = '<p class="text-sm text-slate-500 text-center">ยังไม่มีกิจกรรมล่าสุด</p>';
                    } else {
                        timeline.innerHTML = recentActivities.map(activity => {
                            const activityTime = formatDateTime(activity.lastUpdatedAt || activity.timestampAt || activity.lastUpdated || activity.timestamp);
                            const status = activity.completed ? 'เสร็จสิ้นภารกิจ' : `อยู่ที่ขั้นตอน ${activity.currentStep || '-'}`;
                            const total = Math.round(Number(activity.totalScore) || Number(activity.comprehensionScore) || 0);
                            const initials = activity.userName ? activity.userName.trim().charAt(0) : 'น';

                            return `
                                <div class="flex gap-4 p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                                    <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl">${initials}</div>
                                    <div class="flex-1">
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                            <div>
                                                <p class="font-semibold text-slate-900">${activity.userName || 'นักเรียนไม่ระบุชื่อ'}</p>
                                                <p class="text-xs text-slate-500">${status}</p>
                                            </div>
                                            <div class="text-xs text-slate-500">${activityTime}</div>
                                        </div>
                                        <div class="mt-2 text-sm text-slate-600">คะแนนรวม ${total.toLocaleString('th-TH')} แต้ม</div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }

                if (timelineMeta) {
                    timelineMeta.textContent = `${sessions.length} บันทึกกิจกรรม`;
                }

            } catch (error) {
                console.error('Teacher dashboard render failed:', error);
                if (loading) loading.classList.add('hidden');
                if (summary) summary.innerHTML = '';
                if (tableBody) tableBody.innerHTML = '';
                if (timeline) timeline.innerHTML = '';
                if (tableMeta) tableMeta.textContent = '';
                if (timelineMeta) timelineMeta.textContent = '';
                if (rankingContainer) rankingContainer.innerHTML = '';
                if (rankingMeta) rankingMeta.textContent = '';
                if (emptyState) {
                    emptyState.classList.remove('hidden');
                    emptyState.innerHTML = `
                        <div class="space-y-2">
                            <p class="font-semibold text-slate-700">ไม่สามารถโหลดข้อมูลครูได้ในขณะนี้</p>
                            <p class="text-sm text-slate-500">กรุณาลองรีเฟรชหรือตรวจสอบการเชื่อมต่ออีกครั้ง</p>
                        </div>
                    `;
                }
                resetTeacherStudentDetail();
                showNotification('ไม่สามารถโหลดแดชบอร์ดครูได้ กรุณาลองใหม่อีกครั้ง', 'error');
            }
        }

        function resetTeacherStudentDetail() {
            const container = document.getElementById('teacherStudentDetailContent');
            if (!container) return;
            container.classList.add('text-center');
            container.innerHTML = '<p class="text-sm text-slate-500">คลิกชื่อนักเรียนจากตารางเพื่อเปิดหน้าต่างรายงาน</p>';
            closeTeacherStudentModal();
        }

        function showTeacherStudentDetail(studentKey) {
            const container = document.getElementById('teacherStudentDetailContent');
            if (!container || !studentKey) {
                resetTeacherStudentDetail();
                return;
            }

            const studentRow = teacherDashboardState.rows.find(row => row.key === studentKey || row.studentId === studentKey);
            if (!studentRow) {
                resetTeacherStudentDetail();
                return;
            }

            const sessions = [...(studentRow.sessions || [])].sort((a, b) => {
                const aDate = parseDate(a.lastUpdatedAt || a.timestampAt || a.lastUpdated || a.timestamp);
                const bDate = parseDate(b.lastUpdatedAt || b.timestampAt || b.lastUpdated || b.timestamp);
                return (bDate?.getTime() || 0) - (aDate?.getTime() || 0);
            });

            const latestSession = sessions[0] || null;
            const latestScore = latestSession ? Math.round(Number(latestSession.totalScore) || Number(latestSession.comprehensionScore) || 0) : 0;
            const currentStep = latestSession ? latestSession.currentStep : null;
            const gradeRoom = studentRow.grade ? `${studentRow.grade}${studentRow.room ? `/${studentRow.room}` : ''}` : '-';
            const studentTotalScore = studentRow.totalScore ? Math.round(studentRow.totalScore) : 0;
            const averageScore = studentRow.averageScore ? Math.round(studentRow.averageScore) : (studentRow.sessions.length ? Math.round(studentTotalScore / studentRow.sessions.length) : 0);
            const lastActivity = latestSession ? formatDateTime(latestSession.lastUpdatedAt || latestSession.timestampAt || latestSession.lastUpdated || latestSession.timestamp) : '-';

            const today = new Date();
            const todaySessions = sessions.filter(session => {
                const sessionDate = parseDate(session.lastUpdatedAt || session.timestampAt || session.lastUpdated || session.timestamp);
                return sessionDate ? isSameDay(sessionDate, today) : false;
            });

            const todayScore = todaySessions.reduce((sum, session) => sum + (Number(session.totalScore) || Number(session.comprehensionScore) || 0), 0);
            const todayCompleted = todaySessions.filter(session => session.completed).length;

            const headerStats = [
                { label: 'คะแนนสะสม', value: studentTotalScore.toLocaleString('th-TH'), icon: '🎯' },
                { label: 'คะแนนเฉลี่ย', value: averageScore.toLocaleString('th-TH'), icon: '📊' },
                { label: 'คะแนนล่าสุด', value: latestScore.toLocaleString('th-TH'), icon: '📈' },
                { label: 'ภารกิจสำเร็จ', value: studentRow.completionCount || 0, icon: '🏆' },
                { label: 'ขั้นปัจจุบัน', value: getStepLabel(currentStep), icon: '🧭' }
            ];

            const recentActivities = sessions.slice(0, 5);

            const activityCards = recentActivities.length
                ? recentActivities.map(activity => {
                    const activityDate = formatDateTime(activity.lastUpdatedAt || activity.timestampAt || activity.lastUpdated || activity.timestamp);
                    const activityScore = Math.round(Number(activity.totalScore) || Number(activity.comprehensionScore) || 0);
                    const stepLabel = getStepLabel(activity.currentStep);
                    const status = activity.completed ? 'เสร็จสิ้นภารกิจ' : `กำลังเรียนรู้: ${stepLabel}`;
                    return `
                        <div class="rounded-2xl border border-slate-200 bg-white/90 p-4 flex flex-col gap-2 shadow-sm">
                            <div class="flex items-start justify-between gap-3">
                                <div class="font-semibold text-slate-900 leading-tight">${activity.userName || studentRow.name}</div>
                                <span class="text-xs text-slate-500 whitespace-nowrap">${activityDate}</span>
                            </div>
                            <p class="text-sm text-slate-600">${status}</p>
                            <div class="text-sm font-semibold text-blue-700">คะแนน ${activityScore.toLocaleString('th-TH')} แต้ม</div>
                        </div>
                    `;
                }).join('')
                : '<p class="text-sm text-slate-500">ยังไม่มีบันทึกกิจกรรมของนักเรียนคนนี้</p>';

            const todaySummary = [
                { label: 'กิจกรรมที่บันทึกวันนี้', value: todaySessions.length || 0, icon: '🗓️' },
                { label: 'คะแนนที่ได้วันนี้', value: todayScore ? todayScore.toLocaleString('th-TH') : '0', icon: '⭐' },
                { label: 'ภารกิจสำเร็จวันนี้', value: todayCompleted || 0, icon: '✅' },
                { label: 'อัปเดตล่าสุด', value: lastActivity, icon: '⏱️' }
            ];

            const detailHtml = `
                <div class="space-y-6 text-left">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                        <div>
                            <p class="text-xs uppercase tracking-wide text-slate-500">นักเรียน</p>
                            <h5 class="text-2xl font-bold text-slate-900">${studentRow.name || 'ไม่ระบุชื่อ'}</h5>
                            <p class="text-sm text-slate-500">${gradeRoom} • เลขที่ ${studentRow.number || '-'}</p>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
                            ${headerStats.map(stat => `
                                <div class="rounded-2xl border border-slate-200 bg-slate-50/80 p-4">
                                    <div class="text-lg">${stat.icon}</div>
                                    <p class="text-xs text-slate-500 mt-1">${stat.label}</p>
                                    <p class="text-lg font-semibold text-slate-900">${stat.value}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <h5 class="text-base font-semibold text-slate-900">กิจกรรมล่าสุด</h5>
                            <span class="text-xs text-slate-500">ทั้งหมด ${studentRow.sessions.length} กิจกรรม</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
                            ${activityCards}
                        </div>
                    </div>

                    <div class="space-y-3">
                        <h5 class="text-base font-semibold text-slate-900">ข้อมูลสำคัญ</h5>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                            ${todaySummary.map(stat => `
                                <div class="rounded-2xl border border-slate-200 bg-white/90 p-4">
                                    <div class="text-lg">${stat.icon}</div>
                                    <p class="text-xs text-slate-500 mt-1">${stat.label}</p>
                                    <p class="text-lg font-semibold text-slate-900">${stat.value}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            container.classList.remove('text-center');
            container.innerHTML = detailHtml;
            openTeacherStudentModal(detailHtml);
        }

        function closeTeacherStudentModal() {
            const existing = document.getElementById('teacherStudentModal');
            if (existing) {
                existing.remove();
                document.body.classList.remove('overflow-hidden');
            }
        }

        function openTeacherStudentModal(content) {
            closeTeacherStudentModal();

            const modal = document.createElement('div');
            modal.id = 'teacherStudentModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="modal-card scrollable bg-white rounded-3xl p-6 md:p-8 shadow-2xl relative">
                    <button type="button" class="absolute top-4 right-4 text-slate-500 hover:text-slate-700" aria-label="ปิดรายงาน" onclick="closeTeacherStudentModal()">✕</button>
                    <div class="space-y-6">${content}</div>
                </div>
            `;

            modal.addEventListener('click', event => {
                if (event.target === modal) {
                    closeTeacherStudentModal();
                }
            });

            document.body.appendChild(modal);
            document.body.classList.add('overflow-hidden');
        }

        function parseDate(value) {
            if (!value) return null;
            if (value instanceof Date) {
                return isNaN(value.getTime()) ? null : value;
            }
            if (typeof value === 'number') {
                const numberDate = new Date(value);
                return isNaN(numberDate.getTime()) ? null : numberDate;
            }
            if (typeof value === 'string') {
                const stringDate = new Date(value);
                return isNaN(stringDate.getTime()) ? null : stringDate;
            }
            if (value && typeof value.toDate === 'function') {
                const viaToDate = value.toDate();
                return viaToDate instanceof Date && !isNaN(viaToDate.getTime()) ? viaToDate : null;
            }
            if (value && typeof value === 'object' && typeof value.seconds === 'number') {
                const ms = value.seconds * 1000 + (value.nanoseconds || 0) / 1e6;
                const timestampDate = new Date(ms);
                return isNaN(timestampDate.getTime()) ? null : timestampDate;
            }
            return null;
        }

        function normalizeFirestoreValue(value) {
            if (value === null || value === undefined) return value;
            if (Array.isArray(value)) {
                return value.map(item => normalizeFirestoreValue(item));
            }
            if (typeof value === 'object') {
                const asDate = parseDate(value);
                if (asDate) {
                    return asDate.toISOString();
                }
                const normalized = {};
                Object.entries(value).forEach(([key, val]) => {
                    normalized[key] = normalizeFirestoreValue(val);
                });
                return normalized;
            }
            return value;
        }

        function normalizeStudentRecord(rawStudent = {}) {
            const student = normalizeFirestoreValue(rawStudent) || {};
            const key = student.studentId || student.id || student.uid || student.userId || student.email || student.name || '';
            return {
                ...student,
                key,
                studentId: student.studentId || student.id || student.uid || student.userId || key,
                name: student.name || student.displayName || 'นักเรียนไม่ระบุชื่อ',
                grade: student.grade || student.gradeLevel || student.classLevel || student.level || '-',
                room: student.room || student.classroom || student.class || student.section || '-',
                number: student.number || student.studentNumber || student.no || student.index || '-',
            };
        }

        function calculateVocabularyScore(translatedWords = {}) {
            return Object.values(translatedWords).reduce((sum, entry) => {
                if (!entry || typeof entry !== 'object') return sum;
                return sum + (Number(entry.points) || 0);
            }, 0);
        }

        function normalizeSessionRecord(rawSession = {}, keyOverride) {
            try {
                const session = normalizeFirestoreValue(rawSession) || {};
                const key = keyOverride
                    || session.studentId
                    || session.userId
                    || session.userEmail
                    || session.userName
                    || session.id
                    || '';

                const lastUpdatedAt = parseDate(session.lastUpdated || session.updatedAt || session.finishedAt || session.completedAt);
                const timestampAt = parseDate(session.timestamp || session.createdAt || session.startedAt || lastUpdatedAt);
                const vocabScore = calculateVocabularyScore(session.translatedWords);
                const comprehensionScore = Number(session.comprehensionScore ?? 0);
                const matchingScore = Number(session.matchingScore ?? 0);
                const currentStep = Number(session.currentStep ?? session.step ?? 1);
                const totalScore = typeof session.totalScore === 'number'
                    ? Number(session.totalScore) || 0
                    : vocabScore + comprehensionScore + matchingScore;

                return {
                    ...session,
                    key,
                    studentId: session.studentId || session.userId || key,
                    userId: session.userId || session.studentId || key,
                    userName: session.userName || session.displayName || session.studentName || 'นักเรียนไม่ระบุชื่อ',
                    userEmail: session.userEmail || session.email || '',
                    grade: session.grade || session.gradeLevel || session.classLevel || '-',
                    room: session.room || session.classroom || session.class || '-',
                    number: session.number || session.studentNumber || session.no || '-',
                    currentStep,
                    totalScore,
                    comprehensionScore,
                    matchingScore,
                    vocabScore,
                    completed: Boolean(session.completed || currentStep === 6),
                    lastUpdatedAt,
                    timestampAt,
                };
            } catch (err) {
                console.error('Error normalizeSessionRecord:', err);
                return { key: keyOverride, userName: 'Unknown', error: String(err?.message || err) };
            }
        }

        function formatDateTime(value) {
            const date = parseDate(value);
            if (!date) return '-';
            try {
                return date.toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' });
            } catch (error) {
                return date.toLocaleString();
            }
        }

        function isSameDay(dateA, dateB) {
            if (!dateA || !dateB) return false;
            return dateA.getFullYear() === dateB.getFullYear() &&
                dateA.getMonth() === dateB.getMonth() &&
                dateA.getDate() === dateB.getDate();
        }

        function buildStudentRows(students = [], sessions = []) {
            const studentMap = new Map();
            students.forEach(student => {
                if (!student || !student.key) return;
                studentMap.set(student.key, student);
            });

            const rows = new Map();

            sessions.forEach(session => {
                if (!session || !session.key) return;
                if (!rows.has(session.key)) {
                    const baseStudent = studentMap.get(session.key);
                    rows.set(session.key, {
                        key: session.key,
                        name: session.userName || baseStudent?.name || 'นักเรียนไม่ระบุชื่อ',
                        grade: session.grade || baseStudent?.grade || '-',
                        room: session.room || baseStudent?.room || '-',
                        number: session.number || baseStudent?.number || '-',
                        studentId: session.studentId || baseStudent?.studentId || session.key,
                        totalScore: 0,
                        averageScore: 0,
                        latestSession: null,
                        completionCount: 0,
                        sessions: [],
                    });
                }
                const entry = rows.get(session.key);
                entry.sessions.push(session);
                entry.totalScore += Number(session.totalScore) || 0;
                if (session.completed) {
                    entry.completionCount += 1;
                }
                if (!entry.latestSession) {
                    entry.latestSession = session;
                } else {
                    const existingDate = entry.latestSession.lastUpdatedAt || entry.latestSession.timestampAt;
                    const incomingDate = session.lastUpdatedAt || session.timestampAt;
                    if (incomingDate && (!existingDate || incomingDate > existingDate)) {
                        entry.latestSession = session;
                    }
                }
            });

            rows.forEach(entry => {
                if (entry.sessions.length > 0) {
                    entry.averageScore = Math.round(entry.totalScore / entry.sessions.length);
                }
                entry.rankTier = determineRankTier(entry.totalScore || 0);
            });

            students.forEach(student => {
                if (!student || !student.key) return;
                if (!rows.has(student.key)) {
                    rows.set(student.key, {
                        key: student.key,
                        name: student.name || 'นักเรียนไม่ระบุชื่อ',
                        grade: student.grade || '-',
                        room: student.room || '-',
                        number: student.number || '-',
                        studentId: student.studentId || student.key,
                        totalScore: 0,
                        averageScore: 0,
                        latestSession: null,
                        completionCount: 0,
                        sessions: [],
                    });
                } else {
                    const entry = rows.get(student.key);
                    entry.name = student.name || entry.name;
                    entry.grade = student.grade || entry.grade;
                    entry.room = student.room || entry.room;
                    entry.number = student.number || entry.number;
                    entry.studentId = student.studentId || entry.studentId;
                }
            });

            return Array.from(rows.values());
        }

        const sampleStudents = [
            {
                studentId: 'ST1001',
                name: 'กชมน ศรีวิชัย',
                grade: 'ม.5',
                room: '2',
                number: '12'
            },
            {
                studentId: 'ST1002',
                name: 'ชยุต วัฒนะชัย',
                grade: 'ม.5',
                room: '2',
                number: '7'
            },
            {
                studentId: 'ST1003',
                name: 'ณัฐวดี อินทรา',
                grade: 'ม.5',
                room: '2',
                number: '18'
            }
        ];

        const sampleSessions = [
            {
                id: 'GS-001',
                studentId: 'ST1001',
                userName: 'กชมน ศรีวิชัย',
                grade: 'ม.5',
                room: '2',
                number: '12',
                totalScore: 1240,
                comprehensionScore: 1240,
                completed: true,
                step: 6,
                lastUpdated: new Date(Date.now() - 1000 * 60 * 45).toISOString(),
                timestamp: new Date(Date.now() - 1000 * 60 * 90).toISOString()
            },
            {
                id: 'GS-002',
                studentId: 'ST1002',
                userName: 'ชยุต วัฒนะชัย',
                grade: 'ม.5',
                room: '2',
                number: '7',
                totalScore: 865,
                comprehensionScore: 865,
                completed: false,
                step: 4,
                lastUpdated: new Date(Date.now() - 1000 * 60 * 15).toISOString(),
                timestamp: new Date(Date.now() - 1000 * 60 * 55).toISOString()
            },
            {
                id: 'GS-003',
                studentId: 'ST1003',
                userName: 'ณัฐวดี อินทรา',
                grade: 'ม.5',
                room: '2',
                number: '18',
                totalScore: 540,
                comprehensionScore: 540,
                completed: true,
                step: 6,
                lastUpdated: new Date(Date.now() - 1000 * 60 * 180).toISOString(),
                timestamp: new Date(Date.now() - 1000 * 60 * 240).toISOString()
            }
        ];
        async function fetchTeacherData() {
            let students = [];
            let sessions = [];
            const fallbackStudents = sampleStudents.map(student => ({ ...student }));
            const fallbackSessions = sampleSessions.map(session => ({ ...session }));

            try {
                if (db) {
                    const [studentSnapshot, sessionSnapshot] = await Promise.all([
                        db.collection('User').where('isStudent', '==', true).get().catch(() => null),
                        db.collection('gameSessions').get().catch(() => null)
                    ]);

                    if (studentSnapshot) {
                        studentSnapshot.forEach(doc => {
                            students.push({ id: doc.id, ...doc.data() });
                        });
                    }

                    if (sessionSnapshot) {
                        sessionSnapshot.forEach(doc => {
                            sessions.push({ id: doc.id, ...doc.data() });
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading data from Firebase for teacher portal:', error);
            }

            if (sessions.length === 0 || students.length === 0) {
                try {
                    const response = await fetch('/gameSessions');
                    if (response.ok) {
                        const data = await response.json();
                        if (Array.isArray(data)) {
                            sessions = sessions.length === 0 ? data : sessions;
                        } else {
                            if (Array.isArray(data.sessions) && sessions.length === 0) {
                                sessions = data.sessions;
                            }
                            if (Array.isArray(data.students) && students.length === 0) {
                                students = data.students;
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Fallback fetch to /gameSessions failed:', error);
                }
            }

            if (students.length === 0) {
                students = loadLocalStudents();
            }

            if (sessions.length === 0) {
                sessions = loadLocalSessions();
            }

            if (students.length === 0 && sessions.length === 0) {
                students = fallbackStudents;
                sessions = fallbackSessions;
            } else if (students.length === 0 && sessions.length > 0) {
                const synthesizedStudents = new Map();
                sessions.forEach(session => {
                    const normalizedSession = normalizeSessionRecord(session);
                    const key = normalizedSession.key;
                    if (!key || synthesizedStudents.has(key)) return;
                    synthesizedStudents.set(key, {
                        studentId: normalizedSession.studentId || key,
                        name: normalizedSession.userName || 'นักเรียนไม่ระบุชื่อ',
                        grade: normalizedSession.grade || '-',
                        room: normalizedSession.room || '-',
                        number: normalizedSession.number || '-',
                    });
                });
                students = Array.from(synthesizedStudents.values());
            }

            let normalizedStudents = students
                .map(student => normalizeStudentRecord(student))
                .filter(student => student && student.key);

            let normalizedSessions = sessions
                .map(session => normalizeSessionRecord(session))
                .filter(session => session && session.key);

            if (normalizedSessions.length === 0) {
                normalizedSessions = fallbackSessions
                    .map(session => normalizeSessionRecord(session))
                    .filter(session => session && session.key);
            }

            if (normalizedStudents.length === 0) {
                if (normalizedSessions.length) {
                    const synthesized = buildStudentRows([], normalizedSessions).map(row => ({
                        studentId: row.studentId,
                        name: row.name,
                        grade: row.grade,
                        room: row.room,
                        number: row.number
                    }));
                    normalizedStudents = synthesized
                        .map(student => normalizeStudentRecord(student))
                        .filter(student => student && student.key);
                }

                if (normalizedStudents.length === 0) {
                    normalizedStudents = fallbackStudents
                        .map(student => normalizeStudentRecord(student))
                        .filter(student => student && student.key);
                }
            }

            return { students: normalizedStudents, sessions: normalizedSessions };
        }

        function loadLocalStudents() {
            const result = [];
            if (typeof localStorage === 'undefined') return result;

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('student_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data) result.push(data);
                    } catch (error) {
                        console.error('Failed to parse local student data', error);
                    }
                }
            }
            return result;
        }

        function loadLocalSessions() {
            const result = [];
            if (typeof localStorage === 'undefined') return result;

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('gameSession_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data) result.push(data);
                    } catch (error) {
                        console.error('Failed to parse local session data', error);
                    }
                }
            }
            return result;
        }

        // Check for existing student login on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                populateDemoTeacherHints();
                // Try to restore previous student session
                const lastStudentId = localStorage.getItem('lastStudentId');
                if (lastStudentId) {
                    try {
                        // Try to load from database first
                        let userData = await loadUserData(lastStudentId);

                        if (userData) {
                            gameState.userId = lastStudentId;
                            gameState.currentUser = userData;

                            // Update player profile
                            playerProfile.exp = userData.exp || 0;
                            playerProfile.rank = userData.rank || 'มือใหม่';
                            playerProfile.level = userData.level || 1;
                            playerProfile.totalGamesPlayed = userData.totalGamesPlayed || 0;
                            playerProfile.bestScore = userData.bestScore || 0;

                            // Update UI
                            if (userData.isGoogle) {
                                updateLoginUI({
                                    displayName: userData.name,
                                    email: userData.email,
                                    photoURL: userData.photoURL,
                                    isGoogle: true,
                                    userData: userData
                                });
                            } else {
                                updateLoginUI({
                                    displayName: userData.name,
                                    email: `${userData.grade}/${userData.room} เลขที่ ${userData.number}`,
                                    photoURL: '',
                                    isStudent: true,
                                    studentData: userData
                                });
                            }

                            console.log('User session restored successfully');
                        }
                    } catch (error) {
                        console.log('Error restoring user session:', error);
                        localStorage.removeItem('lastStudentId');
                    }
                }

                refreshHeaderCompactState();
                initializeStepChipEvents();
                initializeFloatingActions();
            } catch (error) {
                console.error('Initialisation failed', error);
                showNotification('ไม่สามารถเริ่มต้นระบบได้', 'error');
            }

            refreshHeaderCompactState();
            initializeStepChipEvents();
            initializeFloatingActions();
        });

        // Navigation Functions
        async function goBack() {
            try {
                // Save current state before going back
                await saveCurrentGameState();
                await saveAllUserAnswers();
                
                if (gameState.stepHistory.length > 0) {
                    const previousStep = gameState.stepHistory.pop();
                    await loadStepData(previousStep);
                    await renderStep(previousStep);
                } else if (gameState.currentStep > 1) {
                    const newStep = gameState.currentStep - 1;
                    await loadStepData(newStep);
                    await renderStep(newStep);
                }
                
                showNotification('ย้อนกลับเรียบร้อย', 'success');
            } catch (error) {
                console.error('Error going back:', error);
                showNotification('เกิดข้อผิดพลาดในการย้อนกลับ', 'error');
            }
        }

        async function goToHome() {
            if (confirm('คุณต้องการกลับไปหน้าหลักหรือไม่? ความคืบหน้าจะถูกบันทึกไว้')) {
                try {
                    // Save current game state with all user data
                    await saveCurrentGameState();
                    await saveAllUserAnswers();
                    
                    // Hide game UI and show landing page
                    showLandingPage();
                    
                    showNotification('กลับสู่หน้าหลักเรียบร้อย ความคืบหน้าถูกบันทึกไว้แล้ว', 'success');
                } catch (error) {
                    console.error('Error going to home:', error);
                    showNotification('เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
                }
            }
        }

        async function resetGame() {
            if (confirm('คุณต้องการเริ่มเกมใหม่หรือไม่? ความคืบหน้าปัจจุบันจะหายไป')) {
                try {
                    // Clear saved game data first
                    if (gameState.gameId) {
                        await clearGameSession(gameState.gameId);
                    }
                    
                    // Reset game state completely
                    gameState.currentStep = 1;
                    gameState.maxStepReached = 1;
                    gameState.translatedWords = {};
                    gameState.incorrectWords = {};
                    gameState.wordAttempts = {};
                    gameState.imaginationText = '';
                    gameState.interpretationText = '';
                    gameState.comprehensionScore = 0;
                    gameState.startTime = Date.now();
                    gameState.selectedWord = null;
                    gameState.stepHistory = [];
                    gameState.comprehensionAnswers = [];
                    gameState.gameId = generateGameId();
                    
                    // Hide game UI and show landing page
                    showLandingPage();
                    
                    showNotification('เกมถูกรีเซ็ตแล้ว พร้อมเริ่มเกมใหม่!', 'success');
                } catch (error) {
                    console.error('Error resetting game:', error);
                    showNotification('เกิดข้อผิดพลาดในการรีเซ็ตเกม', 'error');
                }
            }
        }

        function showLandingPage() {
            const landingPage = document.getElementById('landingPage');
            const header = document.getElementById('header');
            const mainContent = document.getElementById('mainContent');
            const footer = document.getElementById('siteFooter');
            const stepBar = document.getElementById('stepUtilityBar');
            const playerBar = document.getElementById('playerStatusBar');
            const floatingActions = document.getElementById('floatingActionButtons');

            if (landingPage) landingPage.classList.remove('hidden');
            if (header) {
                header.classList.add('hidden');
                header.classList.remove('header-compact');
            }
            if (mainContent) mainContent.classList.add('hidden');
            if (stepBar) stepBar.classList.add('hidden');
            if (playerBar) playerBar.classList.add('hidden');
            if (floatingActions) {
                floatingActions.classList.add('hidden');
                floatingActions.classList.remove('show');
                floatingActions.setAttribute('aria-hidden', 'true');
            }
            if (footer) {
                if (gameState.userId) {
                    footer.classList.remove('hidden');
                } else {
                    footer.classList.add('hidden');
                }
            }

            // Update background transparency based on login status
            if (landingPage) {
                if (gameState.userId) {
                    landingPage.classList.add('user-logged-in');
                } else {
                    landingPage.classList.remove('user-logged-in');
                }
            }
            
            // Make sure start button is enabled if user is logged in
            const startGameBtn = document.getElementById('startGameBtn');
            const startWrapper = document.getElementById('startButtonWrapper');
            const startHint = document.getElementById('startButtonHint');
            if (startGameBtn && gameState.userId) {
                startGameBtn.disabled = false;
                if (startWrapper) startWrapper.classList.remove('hidden');
                if (startHint) {
                    startHint.textContent = 'พร้อมเริ่มภารกิจได้เลย';
                    startHint.classList.remove('text-purple-700/70');
                    startHint.classList.add('text-emerald-700/80');
                }
            } else if (startGameBtn) {
                startGameBtn.disabled = true;
                if (startWrapper) startWrapper.classList.remove('hidden');
                if (startHint) {
                    startHint.textContent = 'เข้าสู่ระบบก่อนเพื่อเปิดภารกิจ';
                    startHint.classList.remove('text-emerald-700/80');
                    startHint.classList.add('text-purple-700/70');
                }
            }
        }

        function generateGameId() {
            return `game_${gameState.userId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        async function saveCurrentGameState() {
            const currentGameData = {
                currentStep: gameState.currentStep,
                translatedWords: gameState.translatedWords,
                incorrectWords: gameState.incorrectWords,
                wordAttempts: gameState.wordAttempts,
                imaginationText: gameState.imaginationText,
                interpretationText: gameState.interpretationText,
                comprehensionScore: gameState.comprehensionScore,
                startTime: gameState.startTime,
                stepHistory: gameState.stepHistory,
                comprehensionAnswers: gameState.comprehensionAnswers || [],
                matchingScore: gameState.matchingScore || 0,
                matchedPairs: gameState.matchedPairs || 0
            };
            
            await saveGameSession(currentGameData);
        }

        async function loadStepData(step) {
            try {
                if (gameState.gameId) {
                    const savedData = await loadGameSession(gameState.gameId);
                    if (savedData) {
                        // Restore data without changing current step
                        gameState.translatedWords = savedData.translatedWords || {};
                        gameState.incorrectWords = savedData.incorrectWords || {};
                        gameState.wordAttempts = savedData.wordAttempts || {};
                        gameState.imaginationText = savedData.imaginationText || '';
                        gameState.interpretationText = savedData.interpretationText || '';
                        gameState.comprehensionScore = savedData.comprehensionScore || 0;
                        gameState.comprehensionAnswers = savedData.comprehensionAnswers || [];
                        gameState.startTime = savedData.startTime || Date.now();
                        gameState.matchingScore = savedData.matchingScore || 0;
                        gameState.matchedPairs = savedData.matchedPairs || 0;
                        
                        // Update UI to reflect loaded data
                        setTimeout(() => {
                            updateWordStatesFromData();
                            updateWordCounts();
                            
                            // Update matching game UI if on matching step
                            if (step === 2.5 && gameState.matchingScore !== undefined) {
                                const scoreElement = document.getElementById('matchingScore');
                                if (scoreElement) {
                                    scoreElement.textContent = gameState.matchingScore;
                                }
                            }
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Error loading step data:', error);
            }
        }

        // Update word states from loaded data
        function updateWordStatesFromData() {
            // Update correct words
            Object.keys(gameState.translatedWords).forEach(word => {
                const wordElement = document.querySelector(`[data-word="${word}"]`);
                if (wordElement) {
                    wordElement.className = 'word-correct';
                }
            });
            
            // Update incorrect words and show hint images if needed
            Object.keys(gameState.incorrectWords).forEach(word => {
                const wordElement = document.querySelector(`[data-word="${word}"]`);
                if (wordElement) {
                    wordElement.className = 'word-incorrect';
                    
                    // Show hint image if attempted 2+ times
                    const attempts = gameState.wordAttempts[word] || 0;
                    if (attempts >= 2 && !wordElement.parentElement.querySelector('.hint-image')) {
                        const hintImageContainer = document.createElement('div');
                        hintImageContainer.className = 'absolute z-10 hint-image';
                        hintImageContainer.style.cssText = `
                            top: -80px;
                            left: 50%;
                            transform: translateX(-50%);
                            pointer-events: none;
                        `;
                        hintImageContainer.innerHTML = `
                            <div class="relative">
                                <img src="${getWordImage(word)}" alt="ใบ้สำหรับ ${word}" 
                                     class="w-16 h-16 md:w-20 md:h-20 rounded-xl border-4 border-yellow-400 object-cover shadow-2xl animate-pulse bg-white p-1">
                                <div class="absolute -top-2 -right-2 w-6 h-6 bg-yellow-400 rounded-full flex items-center justify-center text-xs font-bold text-yellow-900">💡</div>
                            </div>
                        `;
                        wordElement.parentElement.style.position = 'relative';
                        wordElement.parentElement.appendChild(hintImageContainer);
                    }
                }
            });
        }

        async function clearGameSession(gameId) {
            if (!gameId) {
                return;
            }
            try {
                if (db) {
                    await db.collection('gameSessions').doc(gameId).delete();
                } else {
                    localStorage.removeItem(`gameSession_${gameId}`);
                }
            } catch (error) {
                console.error('Error clearing game session:', error);
                localStorage.removeItem(`gameSession_${gameId}`);
            }
        }

        // Start Game Function
        async function startGame() {
            // Check if user is logged in
            if (!gameState.userId || !gameState.currentUser) {
                showNotification('กรุณาลงทะเบียนหรือเข้าสู่ระบบก่อนเริ่มเกม', 'error');
                return;
            }
            
            // Try to load the most recent game session for this user
            try {
                // Look for existing game sessions
                let savedGame = null;
                
                if (db) {
                    // Query Firebase for the most recent game session
                    const gamesQuery = await db.collection('gameSessions')
                        .where('userId', '==', gameState.userId)
                        .orderBy('lastUpdated', 'desc')
                        .limit(1)
                        .get();
                    
                    if (!gamesQuery.empty) {
                        const gameDoc = gamesQuery.docs[0];
                        savedGame = gameDoc.data();
                        gameState.gameId = gameDoc.id;
                        console.log('Found saved game in Firebase:', gameDoc.id);
                    }
                } else {
                    // Fallback: check localStorage for saved games
                    const keys = Object.keys(localStorage);
                    const gameKeys = keys.filter(key => key.startsWith('gameSession_') && key.includes(gameState.userId));
                    
                    if (gameKeys.length > 0) {
                        // Get the most recent game
                        const mostRecentKey = gameKeys.sort().pop();
                        savedGame = JSON.parse(localStorage.getItem(mostRecentKey));
                        gameState.gameId = mostRecentKey.replace('gameSession_', '');
                        console.log('Found saved game in localStorage:', mostRecentKey);
                    }
                }
                
                if (savedGame && savedGame.currentStep > 1) {
                    // Restore saved game state
                    gameState.currentStep = savedGame.currentStep;
                    gameState.maxStepReached = Math.max(1, Math.floor(savedGame.currentStep === 2.5 ? 2 : savedGame.currentStep));
                    gameState.translatedWords = savedGame.translatedWords || {};
                    gameState.incorrectWords = savedGame.incorrectWords || {};
                    gameState.wordAttempts = savedGame.wordAttempts || {};
                    gameState.imaginationText = savedGame.imaginationText || '';
                    gameState.interpretationText = savedGame.interpretationText || '';
                    gameState.comprehensionScore = savedGame.comprehensionScore || 0;
                    gameState.comprehensionAnswers = savedGame.comprehensionAnswers || [];
                    gameState.startTime = savedGame.startTime || Date.now();
                    gameState.stepHistory = savedGame.stepHistory || [];
                    gameState.matchingScore = savedGame.matchingScore || 0;
                    gameState.matchedPairs = savedGame.matchedPairs || 0;
                    
                    showNotification(`โหลดเกมที่บันทึกไว้เรียบร้อย! (ขั้นตอนที่ ${savedGame.currentStep})`, 'success');
                } else {
                    // Start fresh game
                    gameState.gameId = generateGameId();
                    gameState.currentStep = 1;
                    gameState.maxStepReached = 1;
                    gameState.startTime = Date.now();
                    showNotification('เริ่มเกมใหม่!', 'success');
                }

            } catch (error) {
                console.error('Error loading saved game:', error);
                // Start fresh if loading fails
                gameState.gameId = generateGameId();
                gameState.currentStep = 1;
                gameState.maxStepReached = 1;
                gameState.startTime = Date.now();
                showNotification('เริ่มเกมใหม่!', 'success');
            }
            
            document.getElementById('landingPage').classList.add('hidden');
            const headerEl = document.getElementById('header');
            const stepBar = document.getElementById('stepUtilityBar');
            const playerBar = document.getElementById('playerStatusBar');
            const floatingActions = document.getElementById('floatingActionButtons');
            if (headerEl) {
                headerEl.classList.remove('hidden');
                refreshHeaderCompactState();
            }
            if (stepBar) {
                stepBar.classList.remove('hidden');
            }
            if (playerBar) {
                playerBar.classList.remove('hidden');
            }
            if (floatingActions) {
                floatingActions.classList.remove('hidden');
                floatingActions.classList.remove('show');
                floatingActions.setAttribute('aria-hidden', 'false');
            }
            document.getElementById('mainContent').classList.remove('hidden');
            const footer = document.getElementById('siteFooter');
            if (footer) footer.classList.remove('hidden');

            updatePlayerProfile();
            updateProgress();
            updateUserNameDisplay();
            await renderStep(gameState.currentStep);
        }

        // Update Progress
        function updateProgress() {
            const totalSteps = 6;
            const logicalStep = gameState.currentStep === 2.5 ? 2 : gameState.currentStep;
            const currentProgress = ((logicalStep - 1) / (totalSteps - 1)) * 100;

            const progressFill = getElement('mainProgressFill');
            if (progressFill) {
                progressFill.style.width = `${currentProgress}%`;
            }

            updateText('progressText', `${Math.round(currentProgress)}%`);
        }

        // Calculate Level and EXP
        function calculateLevel(exp) {
            const level = Math.floor(exp / 100) + 1;
            const expInCurrentLevel = exp % 100;
            const expToNextLevel = 100 - expInCurrentLevel;
            
            return {
                level: level,
                expInCurrentLevel: expInCurrentLevel,
                expToNextLevel: expToNextLevel
            };
        }

        // Update Player Profile Display
        function updatePlayerProfile() {
            updateText('playerExp', playerProfile.exp);
            updateText('playerRank', playerProfile.rank);
            
            // Calculate level
            const levelInfo = calculateLevel(playerProfile.exp);
            playerProfile.level = levelInfo.level;
            playerProfile.expToNextLevel = levelInfo.expToNextLevel;
            
            // Update rank based on EXP and level
            if (playerProfile.level >= 10) playerProfile.rank = 'นักสืบเซียน';
            else if (playerProfile.level >= 5) playerProfile.rank = 'นักสืบชำนาญ';
            else if (playerProfile.level >= 2) playerProfile.rank = 'นักสืบฝึกหัด';
            else playerProfile.rank = 'มือใหม่';

            saveUserDataAsync();
            updateUserNameDisplay();
        }

        // Save User Data (Async)
        async function saveUserDataAsync() {
            if (gameState.currentUser && gameState.userId) {
                const updatedUserData = {
                    ...gameState.currentUser,
                    exp: playerProfile.exp,
                    rank: playerProfile.rank,
                    level: playerProfile.level,
                    totalGamesPlayed: playerProfile.totalGamesPlayed,
                    bestScore: playerProfile.bestScore,
                    lastPlayed: new Date().toISOString()
                };
                
                await saveUserData(updatedUserData);
                gameState.currentUser = updatedUserData;
            }
        }

        // Render Step Content
        async function renderStep(step) {
            try {
                        // Save current step to history (except when going back)
                        if (step > gameState.currentStep) {
                            gameState.stepHistory.push(gameState.currentStep);
                        }

                        gameState.currentStep = step;
                        const logicalStep = step === 2.5 ? 2 : step;
                        gameState.maxStepReached = Math.max(gameState.maxStepReached || 1, logicalStep);
                        updateStepIndicators();
                        updateProgress();
                        updateBackButton();

                        const floatingActions = document.getElementById('floatingActionButtons');
                        if (floatingActions) {
                            if (step === 6) {
                                floatingActions.classList.add('hidden');
                                floatingActions.classList.remove('show');
                                floatingActions.setAttribute('aria-hidden', 'true');
                            } else {
                                floatingActions.classList.remove('hidden');
                                floatingActions.setAttribute('aria-hidden', 'false');
                            }
                        }
            
                        // Auto-save progress
                        saveCurrentGameState();
            
                        const mainContent = document.getElementById('mainContent');
                        const mission = MISSION_DATA.MISSION_01;
            
                        switch(step) {
                            case 1:
                                mainContent.innerHTML = `
                                    <div class="modern-card rounded-3xl p-6 md:p-8">
                                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                            <div>
                                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                                    📚 ${mission.historicalBackground.title}
                                                </h2>
                                                <p class="step-subtitle">หน้านี้เป็นการศึกษาประวัติศาสตร์เบื้องหลังของโคลงสี่สุภาพ เพื่อให้เข้าใจบริบทและความสำคัญของเหตุการณ์ก่อนเข้าสู่การศึกษาโคลง</p>
                                            </div>
                                        </div>
                            
                                        <div class="mb-8">
                                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-2xl p-6 mb-6">
                                                <div class="flex items-center gap-3 mb-4">
                                                    <span class="text-3xl">📖</span>
                                                    <h3 class="text-xl font-bold text-blue-900">ความรู้พื้นฐาน</h3>
                                                </div>
                                                <p class="text-blue-800 text-lg">อ่านประวัติศาสตร์เพื่อเตรียมความพร้อมก่อนศึกษาโคลง</p>
                                            </div>
                                
                                            ${mission.historicalBackground.content}
                                        </div>
                            
                                        <div class="text-center">
                                            <button id="proceedToPoem" class="modern-button px-8 py-4 text-xl rounded-2xl">
                                                ➡️ ไปดูโคลงสี่สุภาพ
                                            </button>
                                        </div>
                                    </div>
                                `;
                    
                                const proceedButton = document.getElementById('proceedToPoem');
                                if (proceedButton) {
                                    proceedButton.addEventListener('click', async () => {
                                        await renderStep(2);
                                    });
                                } else {
                                    console.warn('Proceed button not found when rendering step 1');
                                }
                                break;
                    
                            case 2.5:
                                // Matching Game Step
                                mainContent.innerHTML = `
                                    <div class="modern-card rounded-3xl p-6 md:p-10 mt-4 md:mt-8 w-full max-w-6xl mx-auto">
                                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 gap-4">
                                            <div>
                                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                                    🎯 จับคู่คำศัพท์
                                                </h2>
                                                <p class="step-subtitle">เกมจับคู่คำศัพท์กับความหมาย เพื่อทบทวนและเสริมสร้างความจำ</p>
                                            </div>
                                        </div>

                                        <!-- Instructions -->
                                        <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-200 p-4 rounded-xl mb-6">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="text-xl">📋</span>
                                                <h4 class="font-bold text-yellow-900">วิธีเล่น</h4>
                                            </div>
                                            <p class="text-yellow-800">ลากคำศัพท์จากด้านซ้ายไปวางบนความหมายที่ถูกต้องด้านขวา หรือคลิกคำศัพท์แล้วคลิกความหมาย</p>
                                        </div>

                                        <!-- Matching Game -->
                                        <div class="grid gap-6 lg:grid-cols-2 mb-8">
                                            <!-- Words Column -->
                                            <div class="bg-gradient-to-br from-red-50 to-pink-50 border-2 border-red-200 p-5 rounded-xl h-full">
                                                <h3 class="text-lg font-bold text-red-900 mb-4 text-center">🔤 คำศัพท์</h3>
                                                <div id="wordsColumn" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                                    ${Object.keys(MISSION_DATA.MISSION_01.hardWords).map((word, index) => `
                                                        <div class="word-item bg-gradient-to-r from-red-400 to-red-500 text-white border-2 border-red-600 p-3 rounded-xl cursor-pointer hover:from-red-500 hover:to-red-600 transition-all duration-200 text-center font-bold shadow-lg"
                                                             data-word="${word}" draggable="true">
                                                            <div class="flex flex-col items-center justify-center gap-2">
                                                                <img src="${getWordImage(word)}" alt="${word}" class="w-16 h-16 md:w-20 md:h-20 rounded-lg border-2 border-white object-cover shadow-md">
                                                                <span class="text-sm">${word}</span>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>

                                            <!-- Meanings Column -->
                                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 p-5 rounded-xl h-full">
                                                <h3 class="text-lg font-bold text-green-900 mb-4 text-center">💭 ความหมาย</h3>
                                                <div id="meaningsColumn" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                                    ${Object.entries(MISSION_DATA.MISSION_01.hardWords).sort(() => Math.random() - 0.5).map(([word, data]) => `
                                                        <div class="meaning-item bg-white border-2 border-green-300 p-3 rounded-xl min-h-[80px] flex items-center justify-center text-center text-green-800 border-dashed hover:bg-green-50 transition-all duration-200"
                                                             data-word="${word}">
                                                            <span class="font-semibold text-sm">${data.meaning.split(',')[0].trim()}</span>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        </div>

                                        <div class="flex flex-col md:flex-row justify-center gap-4 mt-4 md:mt-6">
                                            <button onclick="goBack()" class="modern-button px-6 md:px-8 py-3 md:py-4 text-lg md:text-xl rounded-2xl bg-gray-500 hover:bg-gray-600 w-full md:w-auto">
                                                ← ย้อนกลับ
                                            </button>
                                            <button id="resetMatching" class="modern-button px-6 md:px-8 py-3 md:py-4 text-lg md:text-xl rounded-2xl bg-orange-500 hover:bg-orange-600 w-full md:w-auto">
                                                🔄 เริ่มใหม่
                                            </button>
                                            <button id="finishMatching" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl w-full md:w-auto" disabled>
                                                ➡️ ไปขั้นตอนถัดไป
                                            </button>
                                        </div>

                                        <!-- Score Display -->
                                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-4 rounded-xl mt-8 text-center">
                                            <h3 class="text-lg font-bold text-blue-900 mb-2">คะแนน</h3>
                                            <div class="text-3xl font-bold text-blue-600" id="matchingScore">0</div>
                                            <div class="text-sm text-blue-700">จาก ${Object.keys(MISSION_DATA.MISSION_01.hardWords).length} คู่</div>
                                        </div>
                                    </div>
                                `;
                                setupMatchingGame();
                                break;
                    
                            case 2:
                                mainContent.innerHTML = `
                                    <div class="modern-card rounded-3xl p-6 md:p-8">
                                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                            <div>
                                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                                    📜 โคลงสี่สุภาพ - พระราชพงศาวดาร
                                                </h2>
                                                <p class="step-subtitle">หน้านี้เป็นการศึกษาโคลงสี่สุภาพและค้นหาความหมายของคำศัพท์ยาก เพื่อฝึกทักษะการสืบค้นข้อมูลและเข้าใจความหมายของวรรณคดี</p>
                                            </div>
                                        </div>

                                        <div class="bg-white/85 border border-blue-200 rounded-2xl p-4 mb-6 shadow-sm">
                                            <h3 class="text-base font-semibold text-blue-900 mb-1">🎯 คำสั่ง</h3>
                                            <p class="text-sm text-blue-700">คลิกคำศัพท์สีน้ำเงินในโคลง แล้วค้นหาความหมายให้ครบทั้ง ${Object.keys(mission.hardWords).length} คำ พร้อมบันทึกแหล่งอ้างอิง</p>
                                        </div>

                                        <div class="mb-4 text-center">
                                            <span class="badge-modern inline-flex items-center justify-center">โคลงสี่สุภาพ</span>
                                        </div>
                                        <div class="poem-container p-6 mb-6 mx-auto max-w-3xl">
                                            <div class="poem-text text-gray-800">
                                                ${mission.poem}
                                            </div>
                                        </div>

                                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-2xl p-6 mb-6">
                                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                                <div class="flex items-center gap-3">
                                                    <span class="text-3xl">🧭</span>
                                                    <div>
                                                        <h3 class="text-lg font-bold text-blue-900">แนวทางการสืบค้น</h3>
                                                        <p class="text-blue-800 text-sm md:text-base">รวบรวมคำศัพท์สำคัญ ตรวจสอบแหล่งข้อมูล และบันทึกความหมายพร้อมอ้างอิง</p>
                                                    </div>
                                                </div>
                                                <div class="flex gap-3">
                                                    <div class="px-4 py-2 rounded-xl bg-white border border-blue-200 text-center">
                                                        <p class="text-xs text-blue-500">คำศัพท์ทั้งหมด</p>
                                                        <p class="text-lg font-semibold text-blue-700">${Object.keys(mission.hardWords).length} คำ</p>
                                                    </div>
                                                    <div class="px-4 py-2 rounded-xl bg-white border border-indigo-200 text-center">
                                                        <p class="text-xs text-indigo-500">อ้างอิงที่แนะนำ</p>
                                                        <p class="text-lg font-semibold text-indigo-700">พจนานุกรมราชบัณฑิตฯ</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Progress Cards -->
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                            <div class="modern-card rounded-xl p-4 text-center">
                                                <p class="text-gray-600 text-sm mb-2">เป้าหมาย</p>
                                                <p class="text-xl font-bold text-blue-600">${Object.keys(mission.hardWords).length} คำ</p>
                                                <div class="progress-bar mt-3 bg-gray-200 h-3">
                                                    <div id="wordProgress" class="progress-fill h-3" style="width: 0%"></div>
                                                </div>
                                            </div>
                                            <div class="modern-card rounded-xl p-4 text-center">
                                                <p class="text-gray-600 text-sm mb-2">ค้นพบแล้ว</p>
                                                <p class="text-xl font-bold text-green-600"><span id="foundWords">0</span> คำ</p>
                                            </div>
                                            <div class="modern-card rounded-xl p-4 text-center">
                                                <p class="text-gray-600 text-sm mb-2">คำตอบผิด</p>
                                                <p class="text-xl font-bold text-red-600"><span id="incorrectWords">0</span> คำ</p>
                                            </div>
                                        </div>
                            
                                        <!-- Dictionary Tools -->
                                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-2xl p-6 mb-6">
                                            <div class="text-center">
                                                <div class="text-5xl mb-4">📚</div>
                                                <h3 class="text-xl font-bold text-blue-900 mb-4">เครื่องมือค้นหาความหมาย</h3>
                                                <p class="text-blue-800 text-center mb-6">เลือกเครื่องมือที่ต้องการใช้ค้นหาความหมายคำศัพท์</p>

                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <button onclick="openDictionaryNewTab()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center justify-center gap-3">
                                                        <span class="text-2xl">📖</span>
                                                        <span>พจนานุกรมราชบัณฑิตยสถาน</span>
                                                    </button>
                                                    <button onclick="showKloangInfo()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center justify-center gap-3">
                                                        <span class="text-2xl">📋</span>
                                                        <span>ฉันทลักษณ์โคลงสี่สุภาพ</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                            
                                        <!-- Next Button (Hidden initially) -->
                                        <div class="text-center space-y-4">
                                            <button id="nextToMatching" class="modern-button cta-float px-8 py-4 text-xl rounded-2xl hidden" onclick="showMatchingGame()">
                                                🎯 ไปจับคู่คำศัพท์
                                            </button>
                                        </div>
                                    </div>
                                `;
                                attachWordClickHandlers();
                                // Load saved data and update UI
                                setTimeout(() => {
                                    updateWordStatesFromData();
                                    updateWordCounts();
                                    checkAllWordsFound();
                                }, 100);
                                break;
                    
                            case 3:
                                mainContent.innerHTML = `
                                    <div class="modern-card rounded-3xl p-4 md:p-8 space-y-6">
                                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                            <div>
                                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                                    📝 ถอดความและจินตนาการ
                                                </h2>
                                                <p class="step-subtitle">ฝึกถอดความโคลงและใช้จินตนาการเพื่อสื่อสารความเข้าใจด้วยภาษาของตนเอง</p>
                                            </div>
                                        </div>

                                        <div class="mb-2 text-center lg:text-left">
                                            <span class="badge-modern inline-flex items-center justify-center">โคลงสี่สุภาพ - อ้างอิง</span>
                                        </div>

                                        <div class="grid gap-6 lg:grid-cols-2 items-start">
                                            <div class="space-y-4">
                                                <div class="poem-container plain-poem h-full mx-auto lg:mx-0">
                                                    <div class="poem-text text-gray-800 text-base md:text-lg">
                                                        ${mission.poem}
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 p-6 rounded-2xl h-full flex flex-col">
                                                <h3 class="text-xl font-bold text-green-900 mb-4">📝 ถอดความ</h3>
                                                <p class="text-green-800 mb-4">ถอดความโคลงเป็นร้อยแก้วด้วยภาษาของคุณเอง</p>
                                                <textarea id="interpretationInput" class="w-full min-h-[14rem] lg:min-h-[18rem] modern-input p-4 text-base resize-none flex-1" placeholder="บันทึกความหมายของโคลงในรูปแบบร้อยแก้วด้วยคำของคุณ"></textarea>
                                            </div>
                                        </div>

                                        <div class="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 p-6 rounded-2xl">
                                            <h3 class="text-xl font-bold text-purple-900 mb-4">🎨 จินตนาการภาพ</h3>
                                            <p class="text-purple-800 mb-4">บรรยายภาพที่เกิดขึ้นในจินตนาการของคุณจากโคลงนี้</p>
                                            <textarea id="imaginationInput" class="w-full h-40 modern-input p-4 text-base resize-none" placeholder="🖼️ วาดภาพด้วยคำพูด บอกเล่าภาพที่ปรากฏในใจของคุณ"></textarea>
                                        </div>

                                        <div class="text-center space-y-4">
                                            <div class="flex flex-col md:flex-row justify-center gap-4">
                                                <button onclick="goBack()" class="modern-button px-6 py-3 text-lg rounded-2xl bg-gray-500 hover:bg-gray-600 w-full md:w-auto">
                                                    ← ย้อนกลับ
                                                </button>
                                                <button id="nextStep3" class="modern-button px-8 py-3 text-lg disabled:opacity-50 disabled:cursor-not-allowed rounded-2xl w-full md:w-auto" disabled>
                                                    ➡️ ไปขั้นตอนถัดไป
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                setupStep3Handlers();
                                break;
                    
                            case 4:
                                mainContent.innerHTML = `
                                    <div class="modern-card rounded-3xl p-6 md:p-8">
                                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                            <div>
                                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                                    🖼️ เปิดเผยภาพจริง
                                                </h2>
                                                <p class="step-subtitle">เปรียบเทียบจินตนาการกับหลักฐานประวัติศาสตร์ เพื่อยืนยันความเข้าใจในเนื้อเรื่อง</p>
                                            </div>
                                        </div>

                                        <!-- Historical Image -->
                                        <div class="text-center mb-8">
                                            <h3 class="text-xl font-bold text-blue-900 mb-6">ภาพจริงจากประวัติศาสตร์</h3>
                                            <div class="relative max-w-4xl mx-auto">
                                                <div class="relative cursor-pointer" id="imageContainer">
                                                    <img id="historicalImage" src="${mission.officialImageURL}" alt="ภาพการต่อสู้ของสมเด็จพระสุริโยทัย" class="w-full aspect-video object-cover rounded-2xl border-2 border-gray-300 shadow-xl blur-lg transition-all duration-1000" onerror="this.src=''; this.alt='ไม่สามารถโหลดภาพได้'; this.style.display='none';">
                                                    <div id="imageOverlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded-2xl transition-opacity duration-1000">
                                                        <div class="text-white text-center">
                                                            <div class="text-4xl mb-2 animate-bounce">👆</div>
                                                            <p class="text-lg font-bold">คลิกหรือลูบเพื่อเปิดเผยภาพ</p>
                                                            <p class="text-sm mt-2 opacity-75">ลากเมาส์หรือนิ้วบนภาพ</p>
                                                        </div>
                                                    </div>
                                                    <canvas id="revealCanvas" class="absolute inset-0 w-full h-full rounded-2xl pointer-events-none opacity-0"></canvas>
                                                </div>
                                            </div>
                                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 p-6 rounded-2xl mt-6 max-w-4xl mx-auto">
                                                <p class="text-blue-800 text-lg italic">${mission.officialImageDescription}</p>
                                            </div>
                                        </div>
                            
                                        <!-- Comparison Button -->
                                        <div class="text-center mb-8">
                                            <button id="showComparison" class="modern-button px-8 py-4 text-xl rounded-2xl bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600">
                                                💡 ความจริงก็คือ...
                                            </button>
                                        </div>
                            
                                        <!-- Comparison Section (Hidden initially) -->
                                        <div id="comparisonSection" class="hidden mb-8">
                                            <h3 class="text-xl font-bold text-purple-900 mb-6">เทียบภาพกับความจริง</h3>
                                
                                            <div class="space-y-6">
                                                <div class="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 p-6 rounded-2xl">
                                                    <h4 class="font-bold text-purple-800 mb-4 text-lg">🎨 ที่คุณจินตนาการไว้:</h4>
                                                    <p class="text-purple-700 text-lg leading-relaxed">${gameState.imaginationText}</p>
                                                </div>
                                    
                                                <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 p-6 rounded-2xl">
                                                    <h4 class="font-bold text-green-800 mb-4 text-lg">📝 ที่คุณถอดความได้:</h4>
                                                    <p class="text-green-700 text-lg leading-relaxed">${gameState.interpretationText}</p>
                                                </div>
                                    
                                                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 p-6 rounded-2xl">
                                                    <h4 class="font-bold text-blue-800 mb-4 text-lg">📚 ถอดความที่ถูกต้อง:</h4>
                                                    <p class="text-blue-700 text-lg leading-relaxed">${mission.correctInterpretation}</p>
                                                </div>
                                            </div>
                                        </div>
                            
                                        <div class="text-center space-y-4">
                                            <div class="flex flex-col md:flex-row justify-center gap-4">
                                                <button onclick="goBack()" class="modern-button px-6 py-3 text-lg rounded-2xl bg-gray-500 hover:bg-gray-600 w-full md:w-auto">
                                                    ← ย้อนกลับ
                                                </button>
                                                <button id="nextStep4" class="modern-button px-8 py-3 text-lg rounded-2xl w-full md:w-auto">
                                                    ➡️ ไปขั้นตอนทบทวน
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                setupStep4Handlers();
                                // Setup image reveal effect
                                setTimeout(setupImageReveal, 100);
                                break;
                    
                            case 5:
                                mainContent.innerHTML = `
                                    <div class="modern-card rounded-3xl p-4 md:p-10 mt-4 md:mt-8">
                                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 gap-4">
                                            <div>
                                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                                    📝 ทบทวนความรู้
                                                </h2>
                                                <p class="step-subtitle">ทดสอบความเข้าใจเกี่ยวกับคำศัพท์และเนื้อหาเพื่อสรุปผลการเรียนรู้</p>
                                            </div>
                                        </div>

                                        <!-- Score Display -->
                                        <div class="bg-gradient-to-r from-blue-50 to-green-50 border-2 border-blue-200 p-4 rounded-xl mb-6 text-center">
                                            <h3 class="text-lg font-bold text-blue-900 mb-2">คะแนน</h3>
                                            <div class="text-3xl font-bold text-blue-600" id="quizScore">0</div>
                                            <div class="text-sm text-blue-700">จาก ${mission.comprehensionQuestions.length} ข้อ</div>
                                        </div>
                            
                                        <!-- Quiz Questions -->
                                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                            ${mission.comprehensionQuestions.map((q, index) => `
                                                <div class="bg-gradient-to-br from-white to-gray-50 border-2 border-gray-200 p-4 rounded-xl">
                                                    <h4 class="font-bold text-gray-900 mb-3">ข้อ ${index + 1}. ${q.question}</h4>
                                                    <div class="space-y-2">
                                                        ${q.options.map((option, optIndex) => `
                                                            <label class="flex items-center p-2 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors duration-200">
                                                                <input type="radio" name="question_${index}" value="${optIndex}" class="mr-3 text-blue-600">
                                                                <span class="text-gray-700">${option}</span>
                                                            </label>
                                                        `).join('')}
                                                    </div>
                                                    <div id="result_${index}" class="mt-3 hidden"></div>
                                                </div>
                                            `).join('')}
                                        </div>
                            
                                        <div class="flex flex-col md:flex-row justify-center gap-4 mt-6 md:mt-10">
                                            <button onclick="goBack()" class="modern-button px-6 md:px-8 py-3 md:py-4 text-lg md:text-xl rounded-2xl bg-gray-500 hover:bg-gray-600 w-full md:w-auto">
                                                ← ย้อนกลับ
                                            </button>
                                            <button id="checkAnswers" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl w-full md:w-auto" onclick="checkQuizAnswers()">
                                                ✅ ตรวจคำตอบ
                                            </button>
                                            <button id="retryQuiz" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl w-full md:w-auto bg-orange-500 hover:bg-orange-600 hidden" onclick="retryQuiz()">
                                                🔄 ทำใหม่
                                            </button>
                                            <button id="finishQuiz" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl w-full md:w-auto hidden" onclick="finishQuiz()">
                                                ➡️ เสร็จสิ้น
                                            </button>
                                        </div>
                                    </div>
                                `;
                                setupQuiz();
                                break;
                    
                            case 6:
                                const finalScore = await calculateFinalScore();
                                updatePlayerProfile();
                                const praiseMessage = finalScore.total >= 900
                                    ? 'ยอดเยี่ยม! คุณรักษามาตรฐานระดับนักสืบเซียนได้อย่างมั่นคง'
                                    : finalScore.total >= 600
                                        ? 'ทำได้ดีมาก การวิเคราะห์ของคุณมีความแม่นยำและครบถ้วน'
                                        : 'ยังคงมีพัฒนาการที่ดีต่อเนื่อง ขอให้เพิ่มการทบทวนอีกเล็กน้อย';
                                const focusMessage = finalScore.comprehension >= finalScore.vocabulary
                                    ? 'เน้นย้ำการสืบค้นคำศัพท์เพิ่มเติมเพื่อเพิ่มความหลากหลายของแหล่งอ้างอิง'
                                    : 'เสริมการวิเคราะห์เชิงลึกในส่วนถอดความเพื่อยกระดับความเข้าใจเชิงโครงสร้าง';

                                mainContent.innerHTML = `
                                    <div class="modern-card rounded-3xl p-4 md:p-10 mt-4 md:mt-8 space-y-10">
                                        <div class="text-center space-y-3">
                                            <div class="text-6xl md:text-7xl">🏅</div>
                                            <h2 class="text-3xl md:text-4xl font-bold text-gray-900">รายงานสรุปผลการเรียนรู้</h2>
                                            <p class="text-base md:text-lg text-gray-600">ผู้เรียนได้ผ่านกิจกรรม “ไขรหัสวรรณคดี” ครบถ้วนและได้รับการประเมินตามเกณฑ์ของหลักสูตร</p>
                                            <p class="text-sm text-indigo-600 font-semibold">${praiseMessage}</p>
                                        </div>

                                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                            <div class="lg:col-span-2 bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200 p-6 rounded-2xl">
                                                <h3 class="text-xl font-bold text-blue-900 mb-4">สรุปคะแนน</h3>
                                                <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                                                    <div>
                                                        <p class="text-sm text-blue-700">คะแนนรวมสะสม</p>
                                                        <p class="text-4xl font-extrabold text-blue-600">${finalScore.total} คะแนน</p>
                                                    </div>
                                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 flex-1">
                                                        <div class="rounded-xl bg-white/90 border border-blue-100 p-3 text-center">
                                                            <p class="text-xs text-slate-500">สืบค้นคำศัพท์</p>
                                                            <p class="text-lg font-semibold text-blue-700">+${finalScore.vocabulary}</p>
                                                        </div>
                                                        <div class="rounded-xl bg-white/90 border border-blue-100 p-3 text-center">
                                                            <p class="text-xs text-slate-500">ความเข้าใจเนื้อหา</p>
                                                            <p class="text-lg font-semibold text-blue-700">+${finalScore.comprehension}</p>
                                                        </div>
                                                        <div class="rounded-xl bg-white/90 border border-blue-100 p-3 text-center">
                                                            <p class="text-xs text-slate-500">โบนัสเวลา</p>
                                                            <p class="text-lg font-semibold text-blue-700">+${finalScore.timeBonus}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="bg-gradient-to-br from-emerald-50 to-amber-50 border-2 border-emerald-200 p-6 rounded-2xl space-y-3">
                                                <h3 class="text-xl font-bold text-emerald-900">ข้อมูลผู้เรียน</h3>
                                                <p class="text-sm text-gray-600 leading-relaxed">${gameState.currentUser?.name || 'ผู้เรียน'} (${playerProfile.rank})<br>EXP สะสม ${playerProfile.exp} | ระดับชั้น ${gameState.currentUser?.grade || '-'} / เลขที่ ${gameState.currentUser?.number || '-'} </p>
                                                <div class="grid grid-cols-2 gap-3 text-sm">
                                                    <div class="rounded-lg bg-white/90 border border-emerald-200 p-3">
                                                        <p class="text-xs text-emerald-600 uppercase tracking-wide">เลเวล</p>
                                                        <p class="text-xl font-bold text-emerald-700">Lv.${playerProfile.level}</p>
                                                    </div>
                                                    <div class="rounded-lg bg-white/90 border border-emerald-200 p-3">
                                                        <p class="text-xs text-emerald-600 uppercase tracking-wide">เวลาที่ใช้</p>
                                                        <p class="text-lg font-semibold text-emerald-700">${finalScore.duration} นาที</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-white/85 border border-indigo-100 rounded-2xl p-6 space-y-3">
                                            <h3 class="text-lg font-bold text-indigo-900">วิเคราะห์ผู้เรียน</h3>
                                            <p class="text-sm text-gray-700 leading-relaxed">${focusMessage}</p>
                                            <ul class="list-disc list-inside text-sm text-slate-600 space-y-1">
                                                <li>ผลงานเด่น: การสืบค้นคำศัพท์ได้ ${Object.keys(gameState.translatedWords || {}).length} คำ พร้อมอ้างอิงครบถ้วน</li>
                                                <li>การถอดความ: ${gameState.interpretationText?.length > 0 ? 'มีการอธิบายสาระสำคัญครบถ้วน' : 'ควรเพิ่มเติมการขยายความให้ชัดเจน'}</li>
                                                <li>การใช้จินตนาการ: ${gameState.imaginationText?.length > 0 ? 'บรรยายภาพได้เชื่อมโยงกับประวัติศาสตร์' : 'แนะนำให้เพิ่มรายละเอียดเชิงภาพเพื่อเสริมมิติการตีความ'}</li>
                                            </ul>
                                        </div>

                                        <div class="bg-gradient-to-r from-slate-900 to-indigo-900 rounded-2xl p-6 text-white space-y-2">
                                            <h3 class="text-lg font-semibold">คำชื่นชม</h3>
                                            <p class="text-sm leading-relaxed">ขอชื่นชมความตั้งใจและความสม่ำเสมอในการเรียนรู้วรรณคดีไทย คุณสามารถเชื่อมโยงข้อมูลจากหลายแหล่งและถ่ายทอดออกมาได้อย่างเป็นระบบ</p>
                                        </div>

                                        <div class="summary-action-bar">
                                            <button type="button" onclick="playAgain()" class="modern-button px-6 md:px-10 py-3 md:py-4 text-lg md:text-xl rounded-2xl">
                                                🔁 เล่นอีกครั้ง
                                            </button>
                                            <button type="button" onclick="showCertificate()" class="modern-button px-6 md:px-10 py-3 md:py-4 text-lg md:text-xl rounded-2xl bg-gradient-to-r from-yellow-400 via-amber-500 to-orange-500 hover:from-yellow-500 hover:to-orange-600">
                                                🏆 รับเกียรติบัตร
                                            </button>
                                        </div>
                                    </div>
                                `;
                                break;
                        }
            } catch (error) {
                console.error('Failed to render step', error);
                showNotification('ไม่สามารถแสดงขั้นตอนนี้ได้', 'error');
                if (error && typeof error === 'object') {
                    error.silent = true;
                }
                throw error;
            }
        }

        // Update Back Button
        function updateBackButton() {
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                if (gameState.currentStep > 1 || gameState.stepHistory.length > 0) {
                    backBtn.classList.remove('hidden');
                } else {
                    backBtn.classList.add('hidden');
                }
            }
        }

        // Update Step Indicators
        function updateStepIndicators() {
            const rawStep = Number(gameState.currentStep || 1);
            const chips = document.querySelectorAll('#stepIndicatorContainer .step-chip');
            const normalizedStep = rawStep === 2.5 ? 2 : rawStep;
            const effectiveStep = Number.isFinite(normalizedStep) ? normalizedStep : 1;

            chips.forEach(chip => {
                const chipStep = parseFloat(chip.dataset.step || '0');
                chip.classList.remove('step-chip-active', 'step-chip-completed');

                if (Math.abs(chipStep - effectiveStep) < 0.01) {
                    chip.classList.add('step-chip-active');
                } else if (chipStep < effectiveStep) {
                    chip.classList.add('step-chip-completed');
                }
            });

            const currentStepLabel = document.getElementById('currentStepLabel');
            if (currentStepLabel) {
                currentStepLabel.textContent = getStepLabel(rawStep);
            }
        }

        function initializeStepChipEvents() {
            const container = document.getElementById('stepIndicatorContainer');
            if (!container || stepChipEventsInitialized) return;

            container.querySelectorAll('.step-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    const stepValue = parseFloat(chip.dataset.step || '0');
                    if (!Number.isFinite(stepValue)) return;
                    const logicalStep = stepValue === 2.5 ? 2 : stepValue;
                    const currentLogical = gameState.currentStep === 2.5 ? 2 : gameState.currentStep;

                    if (logicalStep > (gameState.maxStepReached || 1)) return;
                    if (logicalStep === currentLogical) return;

                    goToStep(stepValue).catch(error => {
                        console.error('Failed to navigate via step chip:', error);
                        showNotification('ไม่สามารถเปิดขั้นตอนนี้ได้', 'error');
                    });
                });
            });
            stepChipEventsInitialized = true;
        }

        function initializeFloatingActions() {
            const floatingActions = document.getElementById('floatingActionButtons');
            const toggleButton = document.getElementById('floatingActionsToggle');
            if (!floatingActions || !toggleButton || floatingActionsInitialized) return;

            const panel = floatingActions.querySelector('.floating-panel');
            const closePanel = () => floatingActions.classList.remove('show');

            toggleButton.addEventListener('click', (event) => {
                event.preventDefault();
                floatingActions.classList.toggle('show');
            });

            if (panel) {
                panel.addEventListener('mouseleave', closePanel);
            }
        }

        function initializeStepChipEvents() {
            const container = document.getElementById('stepIndicatorContainer');
            if (!container || stepChipEventsInitialized) return;

            container.querySelectorAll('.step-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    const stepValue = parseFloat(chip.dataset.step || '0');
                    if (!Number.isFinite(stepValue)) return;
                    const logicalStep = stepValue === 2.5 ? 2 : stepValue;
                    const currentLogical = gameState.currentStep === 2.5 ? 2 : gameState.currentStep;

                    if (logicalStep > (gameState.maxStepReached || 1)) return;
                    if (logicalStep === currentLogical) return;

                    goToStep(stepValue).catch(error => {
                        console.error('Failed to navigate via step chip:', error);
                        showNotification('ไม่สามารถเปิดขั้นตอนนี้ได้', 'error');
                    });
                });
            });
            stepChipEventsInitialized = true;
        }

        function initializeFloatingActions() {
            const floatingActions = document.getElementById('floatingActionButtons');
            const toggleButton = document.getElementById('floatingActionsToggle');
            if (!floatingActions || !toggleButton || floatingActionsInitialized) return;

            const panel = floatingActions.querySelector('.floating-panel');
            const closePanel = () => floatingActions.classList.remove('show');

            toggleButton.addEventListener('click', (event) => {
                event.preventDefault();
                floatingActions.classList.toggle('show');
            });

            if (panel) {
                panel.addEventListener('mouseleave', closePanel);
            }

            floatingActions.querySelectorAll('.floating-action-button').forEach(button => {
                button.addEventListener('click', () => {
                    setTimeout(closePanel, 150);
                });
            });

            if (floatingActionsDocHandler) {
                document.removeEventListener('click', floatingActionsDocHandler);
            }

            floatingActionsDocHandler = (event) => {
                if (!floatingActions.contains(event.target)) {
                    closePanel();
                }
            };

            document.addEventListener('click', floatingActionsDocHandler);
            floatingActionsInitialized = true;
        }

            floatingActions.querySelectorAll('.floating-action-button').forEach(button => {
                button.addEventListener('click', () => {
                    setTimeout(closePanel, 150);
                });
            });

            if (floatingActionsDocHandler) {
                document.removeEventListener('click', floatingActionsDocHandler);
            }

            floatingActionsDocHandler = (event) => {
                if (!floatingActions.contains(event.target)) {
                    closePanel();
                }
            };

            document.addEventListener('click', floatingActionsDocHandler);
            floatingActionsInitialized = true;
        }

        function refreshHeaderCompactState() {
            const header = document.getElementById('header');
            if (!header || header.classList.contains('hidden')) return;
            if (window.scrollY > 120) {
                header.classList.add('header-compact');
            } else {
                header.classList.remove('header-compact');
            }
        }

        window.addEventListener('scroll', () => {
            window.requestAnimationFrame(refreshHeaderCompactState);
        }, { passive: true });

        // Attach Word Click Handlers
        function attachWordClickHandlers() {
            const words = document.querySelectorAll('.word-to-find');
            words.forEach(word => {
                word.addEventListener('click', (event) => handleWordClick(word.dataset.word, event));
            });
        }

        // Handle Word Click
        function handleWordClick(word, event) {
            gameState.selectedWord = word;
            const mission = MISSION_DATA.MISSION_01;
            
            // Remove any existing tooltips
            const existingTooltip = document.getElementById('wordTooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }
            
            // Get the clicked element position
            const clickedElement = event.target;
            const rect = clickedElement.getBoundingClientRect();
            
            // Create floating tooltip
            const tooltip = document.createElement('div');
            tooltip.id = 'wordTooltip';
            tooltip.className = 'fixed z-50 tooltip-modern p-4 md:p-8 max-w-sm md:max-w-lg animate-bounce-in';
            
            // Always position in center for better UX
            tooltip.style.cssText = `
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                max-width: 90vw;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            tooltip.innerHTML = `
                <div class="relative">
                    <button onclick="closeTooltip()" class="absolute -top-2 -right-2 w-8 h-8 md:w-10 md:h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold transition-all duration-200 shadow-lg text-sm md:text-base">
                        ×
                    </button>
                    
                    <div class="mb-4 md:mb-6">
                        <div class="flex items-center gap-3 mb-3 md:mb-4">
                            <span class="text-2xl md:text-3xl">🔍</span>
                            <h3 class="text-lg md:text-xl font-bold text-gray-900">ค้นหาความหมาย</h3>
                        </div>
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-3 md:p-4 rounded-xl text-center">
                            <p class="text-xl md:text-2xl font-bold text-blue-600">"${word}"</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4 md:space-y-6">
                        <div>
                            <label class="block text-gray-700 mb-2 md:mb-3 font-semibold text-sm md:text-base">💭 ความหมาย</label>
                            <input type="text" id="wordTranslation" class="w-full modern-input p-3 md:p-4 text-sm md:text-base" placeholder="กรอกความหมายที่คุณค้นพบ...">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2 md:mb-3 font-semibold text-sm md:text-base">📚 แหล่งอ้างอิง</label>
                            <select id="referenceType" class="w-full modern-input p-3 md:p-4 text-sm md:text-base mb-3" onchange="toggleReferenceInput()">
                                <option value="">เลือกแหล่งอ้างอิง</option>
                                <option value="รู้อยู่แล้ว">รู้อยู่แล้ว</option>
                                <option value="ค้นหามา">ค้นหามา</option>
                            </select>
                            <input type="text" id="wordReference" class="w-full modern-input p-3 md:p-4 text-sm md:text-base hidden" placeholder="ระบุแหล่งที่มา เช่น พจนานุกรม ราชบัณฑิตยสถาน, เว็บไซต์, หนังสือ">
                        </div>
                    </div>
                    
                    <div class="flex gap-3 md:gap-4 mt-6 md:mt-8">
                        <button onclick="closeTooltip()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-semibold transition-all duration-200 text-sm md:text-base">
                            ยกเลิก
                        </button>
                        <button onclick="validateWord()" class="flex-1 modern-button px-4 md:px-6 py-2 md:py-3 rounded-xl text-sm md:text-base">
                            ส่งคำตอบ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(tooltip);
            
            // Adjust position if tooltip goes off screen (desktop only)
            if (window.innerWidth > 768) {
                setTimeout(() => {
                    const tooltipRect = tooltip.getBoundingClientRect();
                    if (tooltipRect.right > window.innerWidth) {
                        tooltip.style.left = (rect.left - tooltipRect.width - 15) + 'px';
                    }
                    if (tooltipRect.bottom > window.innerHeight) {
                        tooltip.style.top = (rect.bottom - tooltipRect.height) + 'px';
                    }
                    if (tooltipRect.top < 0) {
                        tooltip.style.top = '10px';
                    }
                }, 10);
            }
        }

        // Toggle Reference Input
        function toggleReferenceInput() {
            const referenceType = document.getElementById('referenceType').value;
            const referenceInput = document.getElementById('wordReference');
            
            if (referenceType === 'ค้นหามา') {
                referenceInput.classList.remove('hidden');
                referenceInput.required = true;
            } else {
                referenceInput.classList.add('hidden');
                referenceInput.required = false;
                referenceInput.value = '';
            }
        }

        // Validate Word Translation
        async function validateWord() {
            try {
                const translation = document.getElementById('wordTranslation').value.trim();
                const referenceType = document.getElementById('referenceType').value;
                const referenceInput = document.getElementById('wordReference').value.trim();
                const mission = MISSION_DATA.MISSION_01;
                const correctMeaning = mission.hardWords[gameState.selectedWord].meaning;
                
                // Validation checks
                if (!translation || translation.length < 2) {
                    showNotification('กรุณากรอกความหมายของคำศัพท์', 'error');
                    return;
                }
                
                if (!referenceType) {
                    showNotification('กรุณาเลือกแหล่งอ้างอิง', 'error');
                    return;
                }
                
                if (referenceType === 'ค้นหามา' && (!referenceInput || referenceInput.trim() === '')) {
                    showNotification('กรุณาระบุแหล่งที่มาของการค้นหา', 'error');
                    return;
                }
                
                const finalReference = referenceType === 'รู้อยู่แล้ว' ? 'รู้อยู่แล้ว' : referenceInput;
                
                // Check if translation contains key concepts (more flexible matching)
                const correctMeanings = mission.hardWords[gameState.selectedWord].meaning.split(',').map(m => m.trim());
                const hasKeyword = correctMeanings.some(meaning => {
                    const keywords = meaning.split(' ');
                    return keywords.some(keyword => 
                        translation.toLowerCase().includes(keyword.toLowerCase()) ||
                        keyword.toLowerCase().includes(translation.toLowerCase()) ||
                        translation.toLowerCase() === meaning.toLowerCase()
                    );
                });
                
                const wordElement = document.querySelector(`[data-word="${gameState.selectedWord}"]`);
                
                if (!hasKeyword) {
                    // Track incorrect attempts
                    if (!gameState.wordAttempts[gameState.selectedWord]) {
                        gameState.wordAttempts[gameState.selectedWord] = 0;
                    }
                    gameState.wordAttempts[gameState.selectedWord]++;
                    
                    // Mark as incorrect
                    gameState.incorrectWords[gameState.selectedWord] = {
                        translation: translation,
                        reference: finalReference,
                        timestamp: new Date().toISOString(),
                        correctMeaning: correctMeaning,
                        attempts: gameState.wordAttempts[gameState.selectedWord]
                    };
                    
                    if (wordElement) {
                        wordElement.className = 'word-incorrect';
                    }
                    
                    // Save immediately to database
                    await saveCurrentGameState();
                    await saveAllUserAnswers();
                    
                    // Show hint image after 2 incorrect attempts
                    let hintMessage = `คำแปลยังไม่ถูกต้อง ลองดูใบ้ประกอบ`;
                    if (gameState.wordAttempts[gameState.selectedWord] >= 2) {
                        hintMessage += ` (ดูรูปภาพใบ้ที่ปรากฏ)`;
                        
                        // Add floating hint image to the word in the poem
                        const hintImageContainer = document.createElement('div');
                        hintImageContainer.className = 'absolute z-10 hint-image';
                        hintImageContainer.style.cssText = `
                            top: -80px;
                            left: 50%;
                            transform: translateX(-50%);
                            pointer-events: none;
                        `;
                        hintImageContainer.innerHTML = `
                            <div class="relative">
                                <img src="${getWordImage(gameState.selectedWord)}" alt="ใบ้สำหรับ ${gameState.selectedWord}" 
                                     class="w-16 h-16 md:w-20 md:h-20 rounded-xl border-4 border-yellow-400 object-cover shadow-2xl animate-pulse bg-white p-1">
                                <div class="absolute -top-2 -right-2 w-6 h-6 bg-yellow-400 rounded-full flex items-center justify-center text-xs font-bold text-yellow-900">💡</div>
                            </div>
                        `;
                        
                        // Insert hint image as floating element
                        if (wordElement && !wordElement.parentElement.querySelector('.hint-image')) {
                            wordElement.parentElement.style.position = 'relative';
                            wordElement.parentElement.appendChild(hintImageContainer);
                        }
                    }
                    
                    showNotification(hintMessage, 'error');
                    updateWordCounts();
                    closeTooltip();
                    return;
                }
                
                // Mark word as translated correctly
                gameState.translatedWords[gameState.selectedWord] = {
                    translation: translation,
                    reference: finalReference,
                    points: mission.hardWords[gameState.selectedWord].points,
                    timestamp: new Date().toISOString(),
                    correctMeaning: correctMeaning
                };
                
                // Remove from incorrect if it was there
                delete gameState.incorrectWords[gameState.selectedWord];
                
                // Update UI
                if (wordElement) {
                    wordElement.className = 'word-correct';
                }
                
                // Save immediately to database
                await saveCurrentGameState();
                await saveAllUserAnswers();
                
                updateWordCounts();
                showNotification(`🎉 ถูกต้อง! +${mission.hardWords[gameState.selectedWord].points} คะแนน`, 'success');
                closeTooltip();
                
                // Check if all words are translated
                const foundWordsCount = Object.keys(gameState.translatedWords).length;
                const totalWords = Object.keys(mission.hardWords).length;
                
                if (foundWordsCount === totalWords) {
                    setTimeout(() => {
                        showNotification('🚀 ค้นพบครบทุกคำแล้ว!', 'success');
                        checkAllWordsFound();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error validating word:', error);
                showNotification('เกิดข้อผิดพลาดในการตรวจสอบคำตอบ', 'error');
            }
        }

        // Update Word Counts
        function updateWordCounts() {
            const mission = MISSION_DATA.MISSION_01;
            const foundWordsCount = Object.keys(gameState.translatedWords).length;
            const incorrectWordsCount = Object.keys(gameState.incorrectWords).length;
            const totalWords = Object.keys(mission.hardWords).length;
            const progressPercent = (foundWordsCount / totalWords) * 100;
            
            const foundWordsElement = document.getElementById('foundWords');
            const incorrectWordsElement = document.getElementById('incorrectWords');
            const progressFill = document.getElementById('wordProgress');
            
            if (foundWordsElement) {
                foundWordsElement.textContent = foundWordsCount;
            }
            if (incorrectWordsElement) {
                incorrectWordsElement.textContent = incorrectWordsCount;
            }
            if (progressFill) {
                progressFill.style.width = progressPercent + '%';
            }
        }

        // Check if all words are found
        function checkAllWordsFound() {
            const mission = MISSION_DATA.MISSION_01;
            const foundWordsCount = Object.keys(gameState.translatedWords).length;
            const totalWords = Object.keys(mission.hardWords).length;
            
            const nextButton = document.getElementById('nextToMatching');
            if (nextButton && foundWordsCount === totalWords) {
                nextButton.classList.remove('hidden');
                nextButton.classList.add('animate-bounce');
                setTimeout(() => nextButton.classList.remove('animate-bounce'), 1200);
                showNotification('🎉 ค้นพบครบทุกคำแล้ว! พร้อมไปจับคู่คำศัพท์', 'success');
            }
        }

        // Show Matching Game
        async function showMatchingGame() {
            await renderStep(2.5); // New step for matching game
        }

        // Show User Menu
        function showUserMenu() {
            const modal = document.createElement('div');
            modal.id = 'userMenuModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 md:p-8 max-w-md w-full animate-bounce-in">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4">👤</div>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-2">ข้อมูลผู้ใช้</h2>
                        <p class="text-gray-600">${gameState.currentUser?.name || 'ผู้ใช้'}</p>
                        ${gameState.currentUser?.studentId ? `<p class="text-sm text-gray-500">${gameState.currentUser.grade}/${gameState.currentUser.room} เลขที่ ${gameState.currentUser.number}</p>` : ''}
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-4 rounded-xl">
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <div class="text-2xl font-bold text-blue-600">${playerProfile.exp}</div>
                                    <div class="text-sm text-gray-600">คะแนนรวม</div>
                                </div>
                                <div>
                                    <div class="text-xl font-bold text-purple-600">${playerProfile.rank}</div>
                                    <div class="text-sm text-gray-600">อันดับ</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="userMenuGoHome()" class="flex-1 modern-button px-4 py-3 rounded-xl bg-blue-500 hover:bg-blue-600">
                                🏠 หน้าหลัก
                            </button>
                            <button onclick="userMenuSignOut()" class="flex-1 modern-button px-4 py-3 rounded-xl bg-red-500 hover:bg-red-600">
                                🚪 ออกจากระบบ
                            </button>
                        </div>
                        
                        <button onclick="closeUserMenu()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                            ปิด
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close User Menu
        function closeUserMenu() {
            const modal = document.getElementById('userMenuModal');
            if (modal) {
                modal.remove();
            }
        }

        // User Menu Functions
        async function userMenuGoHome() {
            closeUserMenu();
            await goToHome();
        }

        async function userMenuSignOut() {
            closeUserMenu();
            await signOutUser();
            showLandingPage();
        }

        // Evaluate Creative Writing with Real-time AI-like Scoring
        function evaluateCreativeWriting(text, type) {
            const keywords = {
                imagination: [
                    'ช้าง', 'สมเด็จพระสุริโยทัย', 'พระเจ้าแปร', 'ง้าว', 'สงคราม', 'รบ', 'ต่อสู้',
                    'อก', 'เลือด', 'ตาย', 'กล้าหาญ', 'เสียสละ', 'ปกป้อง', 'พระราชสามี',
                    'ศัตรู', 'พม่า', 'กรุงศรีอยุธยา', 'โอรส', 'พระศพ', 'ความรัก', 'ความภักดี',
                    'นงคราญ', 'กระษัตรีย์', 'มาน', 'กัตเวที', 'มลาย', 'คเชนทร', 'ดัสกร', 'แล่ง', 'อุระ', 'หรุบ', 'พจน์'
                ],
                interpretation: [
                    // Core semantic lexicon for interpretation evaluation
                    'สมเด็จ', 'พระสุริโยทัย', 'เกรง', 'พระสวามี', 'พระราชสามี', 'สิ้นพระชนม์', 'ตาย', 'สวรรคต',
                    'ขับ', 'ช้าง', 'คช', 'หัตถี', 'เข้า', 'ขวาง', 'พระเจ้าแปร', 'แปร', 'มอญ', 'พม่า', 'ต่อสู้', 'รบ',
                    'ง้าว', 'ฟัน', 'ผ่า', 'อก', 'อุระ', 'ทรวง', 'บน', 'คอ', 'โอรส', 'พระราชโอรส', 'บุตร',
                    'พระราเมศวร', 'มหินทรา', 'กัน', 'พระศพ', 'นำ', 'เมือง', 'นคร', 'สรรเสริญ', 'เยินยอ',
                    'กล้าหาญ', 'เสียสละ', 'ปกป้อง', 'วีรกรรม', 'ความรัก', 'ความภักดี'
                ]
            };
            
            const relevantKeywords = keywords[type] || [];
            const textLower = text.toLowerCase();
            let score = 0;
            let foundKeywords = 0;
            let keywordDetails = [];
            
            // Advanced keyword matching with context
            relevantKeywords.forEach(keyword => {
                if (textLower.includes(keyword.toLowerCase())) {
                    foundKeywords++;
                    let points = 5;
                    
                    // Bonus points for important keywords
                    if (['สมเด็จพระสุริโยทัย', 'พระเจ้าแปร', 'ง้าว', 'ช้าง'].includes(keyword)) {
                        points = 8;
                    }
                    
                    score += points;
                    keywordDetails.push({ keyword, points });
                }
            });
            
            // Length and structure analysis
            const wordCount = text.trim().split(/\s+/).length;
            const sentences = text.split(/[.!?]/).filter(s => s.trim().length > 0).length;
            
            // Length scoring with better scaling
            if (wordCount >= 100) score += 30;
            else if (wordCount >= 80) score += 25;
            else if (wordCount >= 60) score += 20;
            else if (wordCount >= 40) score += 15;
            else if (wordCount >= 20) score += 10;
            else if (wordCount >= 10) score += 5;
            
            // Structure bonus
            if (sentences >= 3) score += 10;
            else if (sentences >= 2) score += 5;
            
            // Content quality analysis
            const qualityWords = [
                'สวยงาม', 'น่าเกรงขาม', 'ยิ่งใหญ่', 'น่าสงสาร', 'น่าชื่นชม', 'เศร้าโศก', 'ภาคภูมิใจ',
                'วีรกรรม', 'เสียสละ', 'กล้าหาญ', 'ความรัก', 'ความภักดี', 'น่าประทับใจ', 'สะเทือนใจ',
                'ความงาม', 'ความแกร่ง', 'ความเข้มแข็ง', 'ความอ่อนโยน', 'ความรุนแรง', 'ความเศร้าโศก'
            ];
            
            let qualityScore = 0;
            qualityWords.forEach(word => {
                if (textLower.includes(word.toLowerCase())) {
                    qualityScore += 3;
                }
            });
            score += Math.min(qualityScore, 15); // Cap quality bonus
            
            // Creativity and originality bonus
            const creativeElements = [
                'เสียงดัง', 'แสงแวบ', 'ฝุ่นฟุ้ง', 'เลือดไหล', 'น้ำตา', 'เสียงร้อง',
                'ความมืด', 'แสงแดด', 'ลมแรง', 'ฟ้าร้อง', 'เมฆดำ', 'ดาวดวง'
            ];
            
            let creativityScore = 0;
            creativeElements.forEach(element => {
                if (textLower.includes(element.toLowerCase())) {
                    creativityScore += 2;
                }
            });
            score += Math.min(creativityScore, 10); // Cap creativity bonus
            
            // Penalty for too short content
            if (wordCount < 10) {
                score = Math.max(0, score - 20);
            }
            
            // Final score calculation with realistic scaling
            const finalScore = Math.min(Math.max(score, 0), 100);
            
            return {
                score: finalScore,
                foundKeywords: foundKeywords,
                wordCount: wordCount,
                sentences: sentences,
                keywordDetails: keywordDetails,
                feedback: generateAdvancedFeedback(finalScore, foundKeywords, wordCount, sentences, type)
            };
        }
        
        function generateAdvancedFeedback(score, keywords, wordCount, sentences, type) {
            let feedback = '';
            let suggestions = [];
            
            // Score-based feedback
            if (score >= 90) {
                feedback = '🌟 เยี่ยมยอด! ';
            } else if (score >= 80) {
                feedback = '🎉 ยอดเยี่ยม! ';
            } else if (score >= 70) {
                feedback = '👍 ดีมาก! ';
            } else if (score >= 60) {
                feedback = '😊 ดี! ';
            } else if (score >= 50) {
                feedback = '👌 พอใช้! ';
            } else {
                feedback = '💪 ต้องปรับปรุง! ';
            }
            
            // Content analysis
            if (type === 'imagination') {
                feedback += `คุณใช้คำสำคัญ ${keywords} คำ เขียน ${wordCount} คำ ใน ${sentences} ประโยค `;
                
                if (keywords >= 8) {
                    feedback += 'แสดงความเข้าใจเนื้อหาอย่างลึกซึ้ง ';
                } else if (keywords >= 5) {
                    feedback += 'แสดงความเข้าใจเนื้อหาดี ';
                    suggestions.push('ลองเพิ่มรายละเอียดเกี่ยวกับอารมณ์และความรู้สึก');
                } else if (keywords >= 3) {
                    feedback += 'เข้าใจเนื้อหาพอสมควร ';
                    suggestions.push('ลองเพิ่มคำศัพท์จากโคลงมากขึ้น');
                } else {
                    suggestions.push('ควรใช้คำศัพท์จากโคลงให้มากขึ้น');
                    suggestions.push('อธิบายตัวละครและเหตุการณ์ให้ชัดเจน');
                }
                
                if (wordCount < 30) {
                    suggestions.push('ลองขยายความคิดให้ยาวขึ้น อธิบายภาพที่เห็นในใจให้ละเอียด');
                }
                
            } else { // interpretation
                feedback += `คุณใช้คำสำคัญ ${keywords} คำ เขียน ${wordCount} คำ ใน ${sentences} ประโยค `;
                
                if (keywords >= 10) {
                    feedback += 'ถอดความได้ครบถ้วนและถูกต้อง ';
                } else if (keywords >= 7) {
                    feedback += 'ถอดความได้ดี ';
                    suggestions.push('ลองเพิ่มรายละเอียดเกี่ยวกับผลลัพธ์');
                } else if (keywords >= 5) {
                    feedback += 'ถอดความได้พอสมควร ';
                    suggestions.push('ลองเพิ่มเหตุการณ์สำคัญที่ยังขาด');
                } else {
                    suggestions.push('ควรใช้คำศัพท์จากโคลงมากขึ้น');
                    suggestions.push('อธิบายลำดับเหตุการณ์ให้ชัดเจน');
                }
                
                if (wordCount < 40) {
                    suggestions.push('ลองขยายความให้ยาวขึ้น เล่าเหตุการณ์ให้ครบถ้วน');
                }
            }
            
            // Add suggestions to feedback
            if (suggestions.length > 0) {
                feedback += '\n💡 คำแนะนำ: ' + suggestions.join(' • ');
            }
            
            return feedback;
        }

        // Setup Step 3 Handlers
        function setupStep3Handlers() {
            const imaginationInput = document.getElementById('imaginationInput');
            const interpretationInput = document.getElementById('interpretationInput');
            const nextBtn = document.getElementById('nextStep3');
            
            // Load saved data
            if (gameState.imaginationText) {
                imaginationInput.value = gameState.imaginationText;
            }
            if (gameState.interpretationText) {
                interpretationInput.value = gameState.interpretationText;
            }
            
            function updateButtonState() {
                const imaginationLength = imaginationInput.value.trim().length;
                const interpretationLength = interpretationInput.value.trim().length;
                
                nextBtn.disabled = imaginationLength < 10 || interpretationLength < 10;
            }
            
            // Initial button state check
            updateButtonState();
            
            imaginationInput.addEventListener('input', async () => {
                gameState.imaginationText = imaginationInput.value;
                updateButtonState();
                
                // ไม่ให้คะแนนจินตนาการแล้ว - เก็บข้อมูลเท่านั้น
                
                await saveCurrentGameState();
                await saveAllUserAnswers();
            });
            
            interpretationInput.addEventListener('input', async () => {
                gameState.interpretationText = interpretationInput.value;
                updateButtonState();
                
                // Real-time evaluation
                if (interpretationInput.value.trim().length > 20) {
                    const evaluation = evaluateCreativeWriting(interpretationInput.value, 'interpretation');
                    showWritingFeedback('interpretation', evaluation);
                }
                
                await saveCurrentGameState();
                await saveAllUserAnswers();
            });
            
            nextBtn.addEventListener('click', async () => {
                try {
                    gameState.imaginationText = imaginationInput.value;
                    gameState.interpretationText = interpretationInput.value;
                    
                    // Final evaluation - ไม่ให้คะแนนจินตนาการ
                    const interpretationEval = evaluateCreativeWriting(gameState.interpretationText, 'interpretation');
                    
                    gameState.imaginationScore = 0; // ไม่ให้คะแนน
                    gameState.interpretationScore = interpretationEval.score;
                    
                    await saveCurrentGameState();
                    await saveAllUserAnswers();
                    
                    showNotification(`บันทึกเรียบร้อย! คะแนนถอดความ: ${interpretationEval.score}`, 'success');
                    await renderStep(4);
                } catch (error) {
                    console.error('Error saving step 3 data:', error);
                    showNotification('เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
                }
            });
        }
        
        function showWritingFeedback(type, evaluation) {
            const containerId = type === 'imagination' ? 'imaginationFeedback' : 'interpretationFeedback';
            let container = document.getElementById(containerId);
            
            if (!container) {
                const inputElement = document.getElementById(type === 'imagination' ? 'imaginationInput' : 'interpretationInput');
                container = document.createElement('div');
                container.id = containerId;
                container.className = 'mt-3 p-4 bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-xl';
                inputElement.parentNode.appendChild(container);
            }
            
            // Determine color based on score
            let scoreColor = 'text-red-600';
            let barColor = 'bg-red-500';
            if (evaluation.score >= 80) {
                scoreColor = 'text-green-600';
                barColor = 'bg-green-500';
            } else if (evaluation.score >= 60) {
                scoreColor = 'text-blue-600';
                barColor = 'bg-blue-500';
            } else if (evaluation.score >= 40) {
                scoreColor = 'text-yellow-600';
                barColor = 'bg-yellow-500';
            }
            
            // Split feedback into main text and suggestions
            const feedbackParts = evaluation.feedback.split('\n💡 คำแนะนำ: ');
            const mainFeedback = feedbackParts[0];
            const suggestions = feedbackParts[1];
            
            container.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <span class="font-bold ${scoreColor} text-lg">คะแนน: ${evaluation.score}/100</span>
                    <div class="w-32 h-3 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full ${barColor} rounded-full transition-all duration-500 ease-out" style="width: ${evaluation.score}%"></div>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <p class="text-sm font-semibold text-blue-800">${mainFeedback}</p>
                    
                    ${evaluation.keywordDetails && evaluation.keywordDetails.length > 0 ? `
                        <div class="text-xs text-gray-600 flex flex-wrap items-center gap-2 gap-y-1">
                            <span class="font-semibold">คำสำคัญที่พบ:</span>
                            ${evaluation.keywordDetails.map(kw => `<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full">${kw.keyword} (+${kw.points})</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    ${suggestions ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mt-2">
                            <div class="flex items-start gap-2">
                                <span class="text-yellow-600 text-lg">💡</span>
                                <div class="text-xs text-yellow-800">
                                    <span class="font-semibold">คำแนะนำ:</span><br>
                                    ${suggestions.split(' • ').map(s => `• ${s}`).join('<br>')}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Reveal Image Function with Dust Wiping Effect
        function setupImageReveal() {
            const container = document.getElementById('imageContainer');
            const img = document.getElementById('historicalImage');
            const overlay = document.getElementById('imageOverlay');
            const canvas = document.getElementById('revealCanvas');
            
            if (!container || !img || !overlay || !canvas) return;
            
            const ctx = canvas.getContext('2d');
            let isRevealing = false;
            let revealProgress = 0;
            
            // Set canvas size
            function resizeCanvas() {
                const rect = img.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                
                // Create thicker dusty/foggy overlay effect (ทำให้หนาขึ้น)
                const gradient = ctx.createRadialGradient(
                    canvas.width / 2, canvas.height / 2, 0,
                    canvas.width / 2, canvas.height / 2, Math.max(canvas.width, canvas.height) / 2
                );
                gradient.addColorStop(0, 'rgba(160, 160, 160, 0.95)'); // เพิ่มความทึบ
                gradient.addColorStop(0.5, 'rgba(120, 120, 120, 0.9)'); // เพิ่มความทึบ
                gradient.addColorStop(1, 'rgba(80, 80, 80, 0.85)'); // เพิ่มความทึบ
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Add more dust particles effect (เพิ่มฝุ่นให้มากขึ้น)
                for (let i = 0; i < 200; i++) { // เพิ่มจาก 100 เป็น 200
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const size = Math.random() * 4 + 1; // เพิ่มขนาดฝุ่น
                    
                    ctx.fillStyle = `rgba(140, 140, 140, ${Math.random() * 0.7 + 0.4})`; // เพิ่มความทึบ
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // Add extra dust layer (เพิ่มชั้นฝุ่นพิเศษ)
                for (let i = 0; i < 50; i++) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const size = Math.random() * 8 + 3;
                    
                    ctx.fillStyle = `rgba(100, 100, 100, ${Math.random() * 0.4 + 0.2})`;
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // Initialize canvas
            img.onload = resizeCanvas;
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            // Update overlay text for dust wiping effect
            overlay.innerHTML = `
                <div class="text-white text-center">
                    <div class="text-4xl mb-2 animate-bounce">🧹</div>
                    <p class="text-lg font-bold">ปัดฝุ่นเพื่อเปิดเผยภาพ</p>
                    <p class="text-sm mt-2 opacity-75">ลากเมาส์หรือนิ้วเพื่อเช็ดฝุ่น</p>
                </div>
            `;
            
            function startRevealing(e) {
                isRevealing = true;
                canvas.style.opacity = '1';
                canvas.style.pointerEvents = 'auto';
                reveal(e);
                
                // Change cursor to indicate wiping
                container.style.cursor = 'grab';
            }
            
            function reveal(e) {
                if (!isRevealing) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                
                // Create wiping effect with smaller brush (ทำให้ยากขึ้น)
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(x, y, 25, 0, Math.PI * 2); // ลดขนาดจาก 40 เป็น 25
                ctx.fill();
                
                // Add wiping trail effect with smaller brush
                if (reveal.lastX !== undefined && reveal.lastY !== undefined) {
                    ctx.lineWidth = 50; // ลดขนาดจาก 80 เป็น 50
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(reveal.lastX, reveal.lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                }
                
                reveal.lastX = x;
                reveal.lastY = y;
                
                // Check reveal progress every 30 strokes (เพิ่มจาก 20 เป็น 30)
                revealProgress += 1;
                if (revealProgress % 30 === 0) {
                    // Check if enough area has been revealed
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const pixels = imageData.data;
                    let transparentPixels = 0;
                    
                    for (let i = 3; i < pixels.length; i += 4) {
                        if (pixels[i] < 128) { // Alpha channel less than 50%
                            transparentPixels++;
                        }
                    }
                    
                    const revealPercentage = (transparentPixels / (pixels.length / 4)) * 100;
                    
                    // เพิ่มเงื่อนไขให้ยากขึ้น - ต้องปัดให้ได้ 70% แทน 50%
                    if (revealPercentage >= 70) {
                        completeReveal();
                    }
                }
            }
            
            function stopRevealing() {
                isRevealing = false;
                reveal.lastX = undefined;
                reveal.lastY = undefined;
                container.style.cursor = 'pointer';
            }
            
            function completeReveal() {
                img.classList.remove('blur-lg');
                overlay.style.opacity = '0';
                canvas.style.opacity = '0';
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                    canvas.style.pointerEvents = 'none';
                }, 1000);
                
                showNotification('🖼️ ปัดฝุ่นเสร็จแล้ว! ภาพถูกเปิดเผย', 'success');
            }
            
            // Mouse events
            container.addEventListener('mousedown', startRevealing);
            container.addEventListener('mousemove', reveal);
            container.addEventListener('mouseup', stopRevealing);
            container.addEventListener('mouseleave', stopRevealing);
            
            // Touch events
            container.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startRevealing(e);
            });
            container.addEventListener('touchmove', (e) => {
                e.preventDefault();
                reveal(e);
            });
            container.addEventListener('touchend', stopRevealing);
            
            // Click to complete reveal
            container.addEventListener('click', completeReveal);
        }

        // Setup Step 4 Handlers
        function setupStep4Handlers() {
            // Check if user has completed step 3 (imagination and interpretation)
            const hasRequiredData = gameState.imaginationText && gameState.interpretationText && 
                                  gameState.imaginationText.trim().length >= 10 && 
                                  gameState.interpretationText.trim().length >= 10;
            
            if (!hasRequiredData) {
                // Disable image reveal if no step 3 data
                const imageContainer = document.getElementById('imageContainer');
                const overlay = document.getElementById('imageOverlay');
                
                if (imageContainer && overlay) {
                    imageContainer.style.pointerEvents = 'none';
                    overlay.innerHTML = `
                        <div class="text-white text-center">
                            <div class="text-4xl mb-2">🔒</div>
                            <p class="text-lg font-bold">ต้องทำหน้าจินตนาการ & ถอดความก่อน</p>
                            <p class="text-sm mt-2 opacity-75">กลับไปขั้นถอดความและจินตนาการเพื่อกรอกข้อมูลให้ครบ</p>
                            <button onclick="goToStep(3)" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl">
                                ไปหน้าจินตนาการ & ถอดความ
                            </button>
                        </div>
                    `;
                }
                
                showNotification('กรุณาทำหน้าจินตนาการ & ถอดความให้เสร็จก่อน', 'error');
                return;
            }
            
            const showComparisonButton = document.getElementById('showComparison');
            if (showComparisonButton) {
                showComparisonButton.addEventListener('click', () => {
                    const comparisonSection = document.getElementById('comparisonSection');
                    if (comparisonSection) {
                        comparisonSection.classList.remove('hidden');
                        comparisonSection.classList.add('animate-bounce-in');
                    }

                    showComparisonButton.style.display = 'none';
                    showNotification('เปรียบเทียบความคิดของคุณกับข้อมูลจริง!', 'success');
                });
            } else {
                console.warn('Show comparison button missing for step 4');
            }

            const nextStepButton = document.getElementById('nextStep4');
            if (nextStepButton) {
                nextStepButton.addEventListener('click', async () => {
                    await renderStep(5);
                });
            } else {
                console.warn('Next step button missing for step 4');
            }
        }

        // Get Word Emoji
        function getWordEmoji(word) {
            const emojiMap = {
                'นงคราญ': '👸',
                'มาน': '💖',
                'กัตเวที': '🙏',
                'มลาย': '💀',
                'คเชนทร': '🐘',
                'ดัสกร': '⚔️',
                'แล่ง': '🔪',
                'อุระ': '👤',
                'หรุบ': '⬇️',
                'ไป่': '❌',
                'พจน์': '💬'
            };
            return emojiMap[word] || '📝';
        }

        // Get Word Image
        function getWordImage(word) {
            const imageMap = {
                'นงคราญ': 'https://img2.pic.in.th/pic/Gemini_Generated_Image_obzx9bobzx9bobzx.png',
                'มาน': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_xvra5axvra5axvra.png',
                'กัตเวที': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_npiozbnpiozbnpioc4686b30823835e2.png',
                'มลาย': 'https://img2.pic.in.th/pic/Gemini_Generated_Image_5dg3t75dg3t75dg3084de5b3dbf1da5a.png',
                'คเชนทร': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_2w0xpa2w0xpa2w0x6d96eebaef1428c5.png',
                'ดัสกร': 'https://img2.pic.in.th/pic/Gemini_Generated_Image_m7s5sjm7s5sjm7s5.png',
                'ง้าว': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_wwh7v4wwh7v4wwh7.png',
                'แล่ง': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_nofldgnofldgnofl.png',
                'อุระ': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_1tpy7b1tpy7b1tpy.png',
                'หรุบ': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_n464d3n464d3n464.png',
                'ไป่': 'https://img2.pic.in.th/pic/Gemini_Generated_Image_jij2fajij2fajij2.png',
                'พจน์': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_o6l06zo6l06zo6l0.png'
            };
            return imageMap[word] || '';
        }

        // Setup Quiz
        function setupQuiz() {
            // Load saved quiz answers if available
            if (gameState.comprehensionAnswers && gameState.comprehensionAnswers.length > 0) {
                gameState.comprehensionAnswers.forEach((answer, index) => {
                    const radio = document.querySelector(`input[name="question_${index}"][value="${answer}"]`);
                    if (radio) {
                        radio.checked = true;
                    }
                });
                
                // Show score if already checked
                if (gameState.comprehensionScore !== undefined) {
                    document.getElementById('quizScore').textContent = gameState.comprehensionScore;
                    document.getElementById('checkAnswers').classList.add('hidden');
                    document.getElementById('finishQuiz').classList.remove('hidden');
                }
            }
        }

        // Check Quiz Answers
        function checkQuizAnswers() {
            const mission = MISSION_DATA.MISSION_01;
            let score = 0;
            const answers = [];
            
            mission.comprehensionQuestions.forEach((q, index) => {
                const selectedRadio = document.querySelector(`input[name="question_${index}"]:checked`);
                const resultDiv = document.getElementById(`result_${index}`);
                
                if (selectedRadio) {
                    const selectedValue = parseInt(selectedRadio.value);
                    answers.push(selectedValue);
                    
                    if (selectedValue === q.correct) {
                        score++;
                        resultDiv.innerHTML = '<div class="text-green-600 font-semibold">✅ ถูกต้อง!</div>';
                        resultDiv.classList.remove('hidden');
                        selectedRadio.parentElement.classList.add('bg-green-100', 'border-green-300');
                    } else {
                        resultDiv.innerHTML = `<div class="text-red-600 font-semibold">❌ ผิด! คำตอบที่ถูก: ${q.options[q.correct]}</div>`;
                        resultDiv.classList.remove('hidden');
                        selectedRadio.parentElement.classList.add('bg-red-100', 'border-red-300');
                        
                        // Highlight correct answer
                        const correctRadio = document.querySelector(`input[name="question_${index}"][value="${q.correct}"]`);
                        if (correctRadio) {
                            correctRadio.parentElement.classList.add('bg-green-100', 'border-green-300');
                        }
                    }
                } else {
                    answers.push(-1);
                    resultDiv.innerHTML = '<div class="text-orange-600 font-semibold">⚠️ ไม่ได้เลือกคำตอบ</div>';
                    resultDiv.classList.remove('hidden');
                }
            });
            
            // Save answers and score
            gameState.comprehensionAnswers = answers;
            gameState.comprehensionScore = score;
            
            // Update UI
            document.getElementById('quizScore').textContent = score;
            document.getElementById('checkAnswers').classList.add('hidden');
            
            // Check if score is less than half
            const halfScore = Math.ceil(mission.comprehensionQuestions.length / 2);
            if (score < halfScore) {
                // Show retry button for low scores
                document.getElementById('retryQuiz').classList.remove('hidden');
                showNotification(`คะแนน: ${score}/${mission.comprehensionQuestions.length} ข้อ - คะแนนต่ำกว่าครึ่ง กรุณาทำใหม่หรือย้อนกลับไปทบทวน`, 'error');
            } else {
                // Show finish button for good scores
                document.getElementById('finishQuiz').classList.remove('hidden');
                showNotification(`คะแนน: ${score}/${mission.comprehensionQuestions.length} ข้อ - ผ่านเกณฑ์!`, 'success');
            }
            
            // Disable all radio buttons
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.disabled = true;
            });
            
            // Save to database
            saveCurrentGameState();
            saveAllUserAnswers();
        }

        // Retry Quiz
        function retryQuiz() {
            // Clear all selections and results
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
                radio.disabled = false;
                radio.parentElement.classList.remove('bg-green-100', 'border-green-300', 'bg-red-100', 'border-red-300');
            });
            
            // Hide all result divs
            document.querySelectorAll('[id^="result_"]').forEach(resultDiv => {
                resultDiv.classList.add('hidden');
                resultDiv.innerHTML = '';
            });
            
            // Reset UI buttons
            document.getElementById('checkAnswers').classList.remove('hidden');
            document.getElementById('retryQuiz').classList.add('hidden');
            document.getElementById('finishQuiz').classList.add('hidden');
            
            // Reset score display
            document.getElementById('quizScore').textContent = '0';
            
            // Clear saved answers
            gameState.comprehensionAnswers = [];
            gameState.comprehensionScore = 0;
            
            showNotification('เริ่มทำแบบทดสอบใหม่!', 'success');
        }

        // Finish Quiz
        async function finishQuiz() {
            await renderStep(6);
        }

        // Setup Matching Game
        function setupMatchingGame() {
            let selectedWord = null;
            let matchedPairs = 0;
            let score = 0;
            const mission = MISSION_DATA.MISSION_01;
            const totalPairs = Object.keys(mission.hardWords).length;
            const scoreDisplay = document.getElementById('matchingScore');
            const finishBtn = document.getElementById('finishMatching');
            const resetBtn = document.getElementById('resetMatching');

            if (!scoreDisplay || !finishBtn || !resetBtn) {
                console.warn('Matching game elements missing; skipping setup.');
                return;
            }

            // Load saved matching state if available
            if (gameState.matchingScore !== undefined) {
                score = gameState.matchingScore;
                matchedPairs = gameState.matchedPairs || 0;
                updateMatchingScore();
            }

            function updateMatchingScore() {
                if (scoreDisplay) {
                    scoreDisplay.textContent = score;
                }

                // Enable finish button when all pairs are matched
                if (matchedPairs >= totalPairs) {
                    finishBtn.disabled = false;
                    finishBtn.textContent = '➡️ ไปขั้นตอนถัดไป';
                    showNotification('🎉 จับคู่ครบทุกคำแล้ว!', 'success');
                }
            }
            
            // Word click handler
            document.querySelectorAll('.word-item').forEach(wordEl => {
                wordEl.addEventListener('click', () => {
                    // Remove previous selection
                    document.querySelectorAll('.word-item').forEach(el => {
                        el.classList.remove('bg-purple-200', 'border-purple-500');
                    });
                    
                    // Select current word
                    wordEl.classList.add('bg-purple-200', 'border-purple-500');
                    selectedWord = wordEl.dataset.word;
                });
            });
            
            // Meaning click handler
            document.querySelectorAll('.meaning-item').forEach(meaningEl => {
                meaningEl.addEventListener('click', () => {
                    if (!selectedWord) {
                        showNotification('กรุณาเลือกคำศัพท์ก่อน', 'error');
                        return;
                    }
                    
                    const correctWord = meaningEl.dataset.word;
                    
                    if (selectedWord === correctWord) {
                        // Correct match
                        const wordEl = document.querySelector(`[data-word="${selectedWord}"]`);
                        
                        // Update UI for correct match
                        meaningEl.classList.remove('border-dashed', 'border-green-300');
                        meaningEl.classList.add('bg-green-200', 'border-green-500', 'border-solid');
                        meaningEl.innerHTML = `
                            <div class="flex flex-col items-center justify-center gap-2">
                                <img src="${getWordImage(selectedWord)}" alt="${selectedWord}" class="w-16 h-16 md:w-20 md:h-20 rounded-lg border-2 border-green-600 object-cover shadow-md">
                                <span class="font-bold text-green-800 text-lg">${selectedWord}</span>
                                <span class="text-green-700 text-sm">${mission.hardWords[selectedWord].meaning}</span>
                            </div>
                        `;
                        
                        // Remove word from left column
                        wordEl.style.opacity = '0.3';
                        wordEl.style.pointerEvents = 'none';
                        wordEl.classList.remove('bg-gradient-to-r', 'from-red-400', 'to-red-500', 'hover:from-red-500', 'hover:to-red-600');
                        wordEl.classList.add('bg-gray-400', 'text-gray-600');
                        
                        matchedPairs++;
                        score += mission.hardWords[selectedWord].points;
                        
                        // Save progress
                        gameState.matchingScore = score;
                        gameState.matchedPairs = matchedPairs;
                        saveCurrentGameState();
                        
                        showNotification(`✅ ถูกต้อง! +${mission.hardWords[selectedWord].points} คะแนน`, 'success');
                        updateMatchingScore();
                        
                    } else {
                        // Incorrect match
                        meaningEl.classList.add('bg-red-100', 'border-red-400');
                        setTimeout(() => {
                            meaningEl.classList.remove('bg-red-100', 'border-red-400');
                        }, 1000);
                        
                        showNotification('❌ ไม่ถูกต้อง ลองใหม่อีกครั้ง', 'error');
                    }
                    
                    // Clear selection
                    selectedWord = null;
                    document.querySelectorAll('.word-item').forEach(el => {
                        el.classList.remove('bg-purple-200', 'border-purple-500');
                    });
                });
            });
            
            // Drag and drop handlers
            document.querySelectorAll('.word-item').forEach(wordEl => {
                wordEl.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', wordEl.dataset.word);
                    wordEl.classList.add('opacity-50');
                });
                
                wordEl.addEventListener('dragend', () => {
                    wordEl.classList.remove('opacity-50');
                });
            });
            
            document.querySelectorAll('.meaning-item').forEach(meaningEl => {
                meaningEl.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    meaningEl.classList.add('bg-green-100', 'border-green-400');
                });
                
                meaningEl.addEventListener('dragleave', () => {
                    meaningEl.classList.remove('bg-green-100', 'border-green-400');
                });
                
                meaningEl.addEventListener('drop', (e) => {
                    e.preventDefault();
                    meaningEl.classList.remove('bg-green-100', 'border-green-400');
                    
                    const draggedWord = e.dataTransfer.getData('text/plain');
                    const correctWord = meaningEl.dataset.word;
                    
                    if (draggedWord === correctWord) {
                        // Same logic as click handler for correct match
                        const wordEl = document.querySelector(`[data-word="${draggedWord}"]`);
                        
                        meaningEl.classList.remove('border-dashed', 'border-green-300');
                        meaningEl.classList.add('bg-green-200', 'border-green-500', 'border-solid');
                        meaningEl.innerHTML = `
                            <div class="flex flex-col items-center justify-center gap-2">
                                <img src="${getWordImage(draggedWord)}" alt="${draggedWord}" class="w-16 h-16 md:w-20 md:h-20 rounded-lg border-2 border-green-600 object-cover shadow-md">
                                <span class="font-bold text-green-800 text-lg">${draggedWord}</span>
                                <span class="text-green-700 text-sm">${mission.hardWords[draggedWord].meaning}</span>
                            </div>
                        `;
                        
                        wordEl.style.opacity = '0.3';
                        wordEl.style.pointerEvents = 'none';
                        wordEl.classList.remove('bg-gradient-to-r', 'from-red-400', 'to-red-500', 'hover:from-red-500', 'hover:to-red-600');
                        wordEl.classList.add('bg-gray-400', 'text-gray-600');
                        
                        matchedPairs++;
                        score += mission.hardWords[draggedWord].points;
                        
                        gameState.matchingScore = score;
                        gameState.matchedPairs = matchedPairs;
                        saveCurrentGameState();
                        
                        showNotification(`✅ ถูกต้อง! +${mission.hardWords[draggedWord].points} คะแนน`, 'success');
                        updateMatchingScore();
                        
                    } else {
                        meaningEl.classList.add('bg-red-100', 'border-red-400');
                        setTimeout(() => {
                            meaningEl.classList.remove('bg-red-100', 'border-red-400');
                        }, 1000);
                        
                        showNotification('❌ ไม่ถูกต้อง ลองใหม่อีกครั้ง', 'error');
                    }
                });
            });

            // Reset button
            resetBtn.addEventListener('click', () => {
                if (confirm('คุณต้องการเริ่มเกมจับคู่ใหม่หรือไม่?')) {
                    location.reload(); // Simple reset by reloading
                }
            });

            // Finish button
            finishBtn.addEventListener('click', async () => {
                gameState.matchingScore = score;
                await saveCurrentGameState();
                await saveAllUserAnswers();

                showNotification('เสร็จสิ้นการจับคู่คำศัพท์!', 'success');
                await renderStep(3); // Go to next step
            });
            
            // Initial score update
            updateMatchingScore();
        }

        // Go to specific step
        async function goToStep(step) {
            await renderStep(step);
        }

        // Update user name display
        function updateUserNameDisplay() {
            const headerUserName = getElement('headerUserName');
            const currentUserName = getElement('currentUserName');
            const currentUserRank = getElement('currentUserRank');

            if (gameState.currentUser && headerUserName && currentUserName) {
                headerUserName.classList.remove('hidden');
                currentUserName.textContent = gameState.currentUser.name || 'ผู้ใช้';
                if (currentUserRank) {
                    const rankLabel = playerProfile.rank || 'มือใหม่';
                    currentUserRank.textContent = `ระดับ ${rankLabel}`;
                }
            } else if (headerUserName) {
                headerUserName.classList.add('hidden');
                if (currentUserRank) {
                    currentUserRank.textContent = 'ระดับ มือใหม่';
                }
            }
        }

        // Certificate Generation
        async function generateCertificate() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = 3508; // A4 landscape at 300 DPI
            canvas.height = 2480;

            const loadImage = (src) => new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = () => resolve(null);
                img.src = src;
            });

            const [bannerImg, logoImg] = await Promise.all([
                loadImage('https://img2.pic.in.th/pic/f1e59dc192445ebe83f800a0476d10eb.png'),
                loadImage('https://img5.pic.in.th/file/secure-sv1/Logo_of_Chulalongkorn_University.svgfa0a44b11e315dd9.png')
            ]);

            // Background
            ctx.fillStyle = '#fdf9f3';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Border
            ctx.strokeStyle = '#b08968';
            ctx.lineWidth = 18;
            ctx.strokeRect(90, 90, canvas.width - 180, canvas.height - 180);
            ctx.strokeStyle = '#e6ccb2';
            ctx.lineWidth = 6;
            ctx.strokeRect(140, 140, canvas.width - 280, canvas.height - 280);

            ctx.textAlign = 'center';
            ctx.fillStyle = '#2f2f2f';

            // Images
            if (bannerImg) {
                const bannerWidth = 900;
                const bannerHeight = (bannerImg.height / bannerImg.width) * bannerWidth;
                ctx.drawImage(bannerImg, canvas.width / 2 - bannerWidth / 2, 210, bannerWidth, bannerHeight);
            }

            if (logoImg) {
                const logoWidth = 260;
                const logoHeight = (logoImg.height / logoImg.width) * logoWidth;
                ctx.drawImage(logoImg, canvas.width / 2 - logoWidth / 2, 160, logoWidth, logoHeight);
            }

            const headerFont = 'bold 120px "Sarabun", "TH Sarabun New", "IBM Plex Sans Thai Looped", sans-serif';
            const subHeaderFont = 'bold 90px "Sarabun", "TH Sarabun New", "IBM Plex Sans Thai Looped", sans-serif';
            const bodyFont = '70px "Sarabun", "TH Sarabun New", "IBM Plex Sans Thai Looped", sans-serif';
            const emphasisFont = 'bold 80px "Sarabun", "TH Sarabun New", "IBM Plex Sans Thai Looped", sans-serif';

            ctx.font = headerFont;
            ctx.fillText('จุฬาลงกรณ์มหาวิทยาลัยคณะครุศาสตร์', canvas.width / 2, 520);

            ctx.font = subHeaderFont;
            ctx.fillText('เกียรติบัตร', canvas.width / 2, 640);

            ctx.font = bodyFont;
            ctx.fillText('มอบให้ไว้เพื่อแสดงว่า', canvas.width / 2, 760);

            const studentName = gameState.currentUser?.name || '..............................................';
            ctx.font = emphasisFont;
            ctx.fillText(studentName, canvas.width / 2, 880);

            ctx.font = bodyFont;
            ctx.fillText('ได้ผ่านการทดสอบกิจกรรม', canvas.width / 2, 1000);
            ctx.font = emphasisFont;
            ctx.fillText('“ไขรหัสวรรณคดี”', canvas.width / 2, 1080);

            ctx.font = bodyFont;
            const lines = [
                'โดยหลักสูตรและการสอน (การสอนภาษาไทย)',
                'คณะครุศาสตร์ จุฬาลงกรณ์มหาวิทยาลัย',
                'เพื่อส่งเสริมความรู้ ความเข้าใจ และความรักในวรรณคดีไทย',
                'รวมทั้งพัฒนาทักษะการอ่าน วิเคราะห์ และตีความวรรณศิลป์อย่างสร้างสรรค์'
            ];
            lines.forEach((line, index) => {
                ctx.fillText(line, canvas.width / 2, 1180 + index * 80);
            });

            ctx.fillText('ขอให้รักษาความมุ่งมั่นและความเพียรพยายามนี้ไว้', canvas.width / 2, 1520);
            ctx.fillText('เพื่อก้าวสู่ความสำเร็จในการเรียนรู้ต่อไป', canvas.width / 2, 1600);

            const currentDate = new Date().toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            ctx.font = '60px "Sarabun", "TH Sarabun New", "IBM Plex Sans Thai Looped", sans-serif';
            ctx.fillText(`ลงวันที่ ${currentDate}`, canvas.width / 2, 1720);

            // Signature
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2 - 500, 1950);
            ctx.lineTo(canvas.width / 2 + 500, 1950);
            ctx.strokeStyle = '#a68a64';
            ctx.lineWidth = 4;
            ctx.stroke();

            ctx.font = emphasisFont;
            ctx.fillText('ลงชื่อ .................................................................', canvas.width / 2, 1890);
            ctx.font = bodyFont;
            ctx.fillText('(นายมงคล แก้วไทย)', canvas.width / 2, 2020);
            ctx.fillText('คณบดีคณะครุศาสตร์', canvas.width / 2, 2100);
            ctx.fillText('จุฬาลงกรณ์มหาวิทยาลัย', canvas.width / 2, 2180);

            return canvas;
        }

        // Play Again Function
        async function playAgain() {
            let hasError = false;

            try {
                await saveAllUserAnswers();
            } catch (error) {
                hasError = true;
                console.error('Error saving answers before restart:', error);
            }

            try {
                if (gameState.gameId) {
                    await clearGameSession(gameState.gameId);
                }
            } catch (error) {
                hasError = true;
                console.error('Error clearing previous game session:', error);
            }

            // Reset game state completely
            gameState.currentStep = 1;
            gameState.maxStepReached = 1;
            gameState.translatedWords = {};
            gameState.incorrectWords = {};
            gameState.wordAttempts = {};
            gameState.imaginationText = '';
            gameState.interpretationText = '';
            gameState.comprehensionScore = 0;
            gameState.startTime = Date.now();
            gameState.selectedWord = null;
            gameState.stepHistory = [];
            gameState.comprehensionAnswers = [];
            gameState.gameId = generateGameId();

            // Show landing page with start button
            showLandingPage();

            if (hasError) {
                showNotification('เริ่มเกมใหม่แล้ว (มีบางข้อมูลบันทึกไม่สำเร็จ)', 'error');
            } else {
                showNotification('พร้อมเล่นใหม่แล้ว! กดปุ่มเริ่มเกมเพื่อเริ่มต้น', 'success');
            }
        }

        // Show Certificate Modal
        function showCertificate() {
            const modal = document.createElement('div');
            modal.id = 'certificateModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            
            const studentName = gameState.currentUser?.name || 'ผู้เล่น';
            const studentDetails = gameState.currentUser?.studentId ? 
                `รหัสนักเรียน: ${gameState.currentUser.studentId} | ชั้น: ${gameState.currentUser.grade}/${gameState.currentUser.room} เลขที่: ${gameState.currentUser.number}` : 
                'ผู้เรียนออนไลน์';
            
            const currentDate = new Date().toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            modal.innerHTML = `
                <div class="modal-card scrollable bg-white rounded-3xl p-6 md:p-10 max-w-4xl w-full animate-bounce-in relative">
                    <button onclick="closeCertificateModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold transition-all duration-200 shadow-lg text-lg z-10">
                        ×
                    </button>

                    <div class="border-8 border-amber-200 rounded-[32px] bg-[#fdf9f3] p-6 md:p-12 space-y-8">
                        <div class="flex flex-wrap items-center justify-between gap-4">
                            <img src="https://img2.pic.in.th/pic/f1e59dc192445ebe83f800a0476d10eb.png" alt="แถบเกียรติบัตร" class="w-36 md:w-48 object-contain" />
                            <div class="flex-1 text-center min-w-[200px]">
                                <p class="text-xs md:text-sm text-amber-700 tracking-[0.35em] uppercase">จุฬาลงกรณ์มหาวิทยาลัยคณะครุศาสตร์</p>
                                <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 mt-2">เกียรติบัตร</h1>
                            </div>
                            <img src="https://img5.pic.in.th/file/secure-sv1/Logo_of_Chulalongkorn_University.svgfa0a44b11e315dd9.png" alt="ตราจุฬาฯ" class="w-20 md:w-28 object-contain" />
                        </div>

                        <div class="text-center space-y-3">
                            <p class="text-base md:text-lg text-slate-700">มอบให้ไว้เพื่อแสดงว่า</p>
                            <p class="text-2xl md:text-3xl font-semibold text-indigo-700">${studentName}</p>
                            <p class="text-xs md:text-sm text-slate-500">${studentDetails}</p>
                        </div>

                        <div class="text-center text-sm md:text-base text-slate-700 leading-relaxed space-y-3">
                            <p>ได้ผ่านการทดสอบกิจกรรม “ไขรหัสวรรณคดี”</p>
                            <p>โดยหลักสูตรและการสอน (การสอนภาษาไทย) คณะครุศาสตร์ จุฬาลงกรณ์มหาวิทยาลัย</p>
                            <p>เพื่อส่งเสริมความรู้ ความเข้าใจ และความรักในวรรณคดีไทย รวมทั้งพัฒนาทักษะการอ่าน วิเคราะห์ และตีความวรรณศิลป์อย่างสร้างสรรค์</p>
                            <p>ขอให้รักษาความมุ่งมั่นและความเพียรพยายามนี้ไว้ เพื่อก้าวสู่ความสำเร็จในการเรียนรู้ต่อไป</p>
                        </div>

                        <div class="text-center text-sm md:text-base text-slate-600">
                            <p>ลงวันที่ ${currentDate}</p>
                        </div>

                        <div class="pt-6 border-t border-amber-200 text-center space-y-2">
                            <p class="text-sm md:text-base text-slate-600">ลงชื่อ .................................................................</p>
                            <p class="text-base md:text-lg font-semibold text-slate-800">(นายมงคล แก้วไทย)</p>
                            <p class="text-sm text-slate-600">คณบดีคณะครุศาสตร์ จุฬาลงกรณ์มหาวิทยาลัย</p>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 mt-6 justify-center">
                        <button onclick="downloadCertificateImage()" class="modern-button px-6 py-3 text-lg rounded-2xl bg-gradient-to-r from-amber-500 to-rose-500 hover:from-amber-600 hover:to-rose-600">
                            💾 บันทึกเป็นรูปภาพ
                        </button>
                        <button onclick="closeCertificateModal()" class="modern-button px-6 py-3 text-lg rounded-2xl bg-gray-500 hover:bg-gray-600">
                            ปิด
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close Certificate Modal
        function closeCertificateModal() {
            const modal = document.getElementById('certificateModal');
            if (modal) {
                modal.remove();
            }
        }

        // Download Certificate as Image
        async function downloadCertificateImage() {
            try {
                const canvas = await generateCertificate();

                // Convert to blob and download
                canvas.toBlob((blob) => {
                    if (!blob) {
                        showNotification('ไม่สามารถสร้างไฟล์ภาพได้', 'error');
                        return;
                    }
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;

                    const studentName = gameState.currentUser?.name || 'ผู้เล่น';
                    const studentId = gameState.currentUser?.studentId || 'unknown';
                    const date = new Date().toLocaleDateString('th-TH').replace(/\//g, '-');
                    
                    a.download = `เกียรติบัตร_${studentName}_${studentId}_${date}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showNotification('ดาวน์โหลดเกียรติบัตรเรียบร้อย! 🎉', 'success');
                }, 'image/png', 0.95);

            } catch (error) {
                console.error('Error generating certificate:', error);
                showNotification('เกิดข้อผิดพลาดในการสร้างเกียรติบัตร', 'error');
            }
        }

        // Calculate Final Score
        async function calculateFinalScore() {
            try {
                const mission = MISSION_DATA.MISSION_01;
                let vocabularyScore = 0;
                
                // Calculate vocabulary points
                Object.values(gameState.translatedWords).forEach(word => {
                    vocabularyScore += word.points;
                });
                
                // Comprehension bonus
                const comprehensionScore = gameState.comprehensionScore * 20;
                
                // Time bonus (max 50 points, decreases over time)
                const timeElapsed = (Date.now() - gameState.startTime) / 1000 / 60; // minutes
                const timeBonus = Math.max(0, Math.floor(50 - timeElapsed * 2));
                
                const total = vocabularyScore + comprehensionScore + timeBonus;
                
                // Update player profile
                playerProfile.exp += total;
                playerProfile.totalGamesPlayed += 1;
                if (total > playerProfile.bestScore) {
                    playerProfile.bestScore = total;
                }
                
                // Save updated player profile
                await saveUserDataAsync();
                
                // Save final game completion data
                await saveAllUserAnswers();
                
                const finalScore = {
                    vocabulary: vocabularyScore,
                    comprehension: comprehensionScore,
                    timeBonus: timeBonus,
                    total: total
                };
                
                return finalScore;
                
            } catch (error) {
                console.error('Error calculating final score:', error);
                return {
                    vocabulary: 0,
                    comprehension: 0,
                    timeBonus: 0,
                    total: 0
                };
            }
        }



        // Handle iframe load
        function handleIframeLoad() {
            const iframe = document.getElementById('dictionaryIframe');
            const fallback = document.getElementById('dictionaryFallback');
            
            if (iframe && fallback) {
                try {
                    // Try to access iframe content to check if it loaded properly
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc && iframeDoc.body && iframeDoc.body.innerHTML.trim() !== '') {
                        // iframe loaded successfully, hide fallback
                        fallback.style.display = 'none';
                        iframe.style.display = 'block';
                    } else {
                        // iframe didn't load properly, show fallback
                        showDictionaryFallback();
                    }
                } catch (e) {
                    // Cross-origin error means the site is blocking iframe
                    showDictionaryFallback();
                }
            }
        }

        // Show dictionary fallback
        function showDictionaryFallback() {
            const iframe = document.getElementById('dictionaryIframe');
            const fallback = document.getElementById('dictionaryFallback');
            
            if (iframe && fallback) {
                iframe.style.display = 'none';
                fallback.style.display = 'flex';
            }
        }

        // Auto-detect iframe blocking after 3 seconds
        setTimeout(() => {
            const iframe = document.getElementById('dictionaryIframe');
            if (iframe) {
                try {
                    // Try to access iframe content
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (!iframeDoc || !iframeDoc.body || iframeDoc.body.innerHTML.trim() === '') {
                        showDictionaryFallback();
                    }
                } catch (e) {
                    showDictionaryFallback();
                }
            }
        }, 3000);

        // Open Dictionary in New Tab
        function openDictionaryNewTab() {
            window.open('https://dictionary.orst.go.th/index.php', '_blank', 'noopener,noreferrer');
            showNotification('เปิดพจนานุกรมในแท็บใหม่แล้ว! 📖', 'success');
        }

        // Show Quick Search Modal
        function showQuickSearch() {
            const modal = document.createElement('div');
            modal.id = 'quickSearchModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 max-w-2xl w-full animate-bounce-in relative">
                    <button onclick="closeQuickSearchModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold">×</button>
                    
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">🔍 ค้นหาด่วน</h2>
                        <p class="text-gray-600">ค้นหาความหมายคำศัพท์จากแหล่งต่างๆ</p>
                    </div>
                    
                    <div class="mb-6">
                        <input type="text" id="quickSearchInput" class="w-full modern-input p-4 text-lg" placeholder="พิมพ์คำที่ต้องการค้นหา..." autofocus>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="searchInDictionary()" class="bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-3">
                            <span class="text-2xl">📖</span>
                            <div class="text-left">
                                <div class="font-bold">พจนานุกรมราชบัณฑิตยสถาน</div>
                                <div class="text-sm opacity-90">ค้นหาในพจนานุกรมอย่างเป็นทางการ</div>
                            </div>
                        </button>
                        
                        <button onclick="searchInGoogle()" class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-3">
                            <span class="text-2xl">🔍</span>
                            <div class="text-left">
                                <div class="font-bold">Google Search</div>
                                <div class="text-sm opacity-90">ค้นหาความหมายใน Google</div>
                            </div>
                        </button>
                        
                        <button onclick="searchInWikipedia()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-3">
                            <span class="text-2xl">🌐</span>
                            <div class="text-left">
                                <div class="font-bold">วิกิพีเดีย</div>
                                <div class="text-sm opacity-90">ค้นหาในสารานุกรมออนไลน์</div>
                            </div>
                        </button>
                        
                        <button onclick="searchInSanook()" class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-3">
                            <span class="text-2xl">📚</span>
                            <div class="text-left">
                                <div class="font-bold">พจนานุกรมสนุก</div>
                                <div class="text-sm opacity-90">ค้นหาในพจนานุกรมออนไลน์</div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="closeQuickSearchModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">
                            ปิด
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add enter key listener
            const quickSearchInput = getElement('quickSearchInput');
            if (quickSearchInput) {
                quickSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchInDictionary();
                    }
                });
            }
        }

        // Close Quick Search Modal
        function closeQuickSearchModal() {
            const modal = getElement('quickSearchModal');
            if (modal) {
                modal.remove();
            }
        }

        // Search functions
        function searchInDictionary() {
            const input = getElement('quickSearchInput');
            const searchTerm = input ? input.value.trim() : '';
            if (searchTerm) {
                window.open(`https://dictionary.orst.go.th/search.php?search=${encodeURIComponent(searchTerm)}`, '_blank', 'noopener,noreferrer');
                closeQuickSearchModal();
                showNotification(`ค้นหา "${searchTerm}" ในพจนานุกรมราชบัณฑิตยสถาน`, 'success');
            } else {
                showNotification('กรุณาพิมพ์คำที่ต้องการค้นหา', 'error');
            }
        }

        function searchInGoogle() {
            const input = getElement('quickSearchInput');
            const searchTerm = input ? input.value.trim() : '';
            if (searchTerm) {
                window.open(`https://www.google.com/search?q=${encodeURIComponent(searchTerm + ' ความหมาย')}`, '_blank', 'noopener,noreferrer');
                closeQuickSearchModal();
                showNotification(`ค้นหา "${searchTerm}" ใน Google`, 'success');
            } else {
                showNotification('กรุณาพิมพ์คำที่ต้องการค้นหา', 'error');
            }
        }

        function searchInWikipedia() {
            const input = getElement('quickSearchInput');
            const searchTerm = input ? input.value.trim() : '';
            if (searchTerm) {
                window.open(`https://th.wikipedia.org/wiki/${encodeURIComponent(searchTerm)}`, '_blank', 'noopener,noreferrer');
                closeQuickSearchModal();
                showNotification(`ค้นหา "${searchTerm}" ในวิกิพีเดีย`, 'success');
            } else {
                showNotification('กรุณาพิมพ์คำที่ต้องการค้นหา', 'error');
            }
        }

        function searchInSanook() {
            const input = getElement('quickSearchInput');
            const searchTerm = input ? input.value.trim() : '';
            if (searchTerm) {
                window.open(`https://www.sanook.com/dict/search/${encodeURIComponent(searchTerm)}`, '_blank', 'noopener,noreferrer');
                closeQuickSearchModal();
                showNotification(`ค้นหา "${searchTerm}" ในพจนานุกรมสนุก`, 'success');
            } else {
                showNotification('กรุณาพิมพ์คำที่ต้องการค้นหา', 'error');
            }
        }

        // Show Alternative Dictionaries
        function showAlternativeDictionaries() {
            const modal = document.createElement('div');
            modal.id = 'alternativeDictionariesModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 max-w-2xl w-full animate-bounce-in relative">
                    <button onclick="closeAlternativeDictionariesModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold">×</button>
                    
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">📚 พจนานุกรมและแหล่งข้อมูล</h2>
                        <p class="text-gray-600">เลือกแหล่งข้อมูลที่ต้องการใช้ค้นหาความหมายคำศัพท์</p>
                    </div>
                    
                    <div class="space-y-4">
                        <button onclick="openLink('https://dictionary.orst.go.th/')" class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-4">
                            <span class="text-2xl">📖</span>
                            <div class="text-left">
                                <div class="font-bold">พจนานุกรมราชบัณฑิตยสถาน</div>
                                <div class="text-sm opacity-90">พจนานุกรมภาษาไทยอย่างเป็นทางการ</div>
                            </div>
                        </button>
                        
                        <button onclick="openLink('https://th.wikipedia.org/')" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-4">
                            <span class="text-2xl">🌐</span>
                            <div class="text-left">
                                <div class="font-bold">วิกิพีเดียภาษาไทย</div>
                                <div class="text-sm opacity-90">สารานุกรมออนไลน์</div>
                            </div>
                        </button>
                        
                        <button onclick="openLink('https://www.google.com/search?q=')" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-4">
                            <span class="text-2xl">🔍</span>
                            <div class="text-left">
                                <div class="font-bold">Google Search</div>
                                <div class="text-sm opacity-90">ค้นหาข้อมูลทั่วไป</div>
                            </div>
                        </button>
                        
                        <button onclick="openLink('https://www.sanook.com/dict/')" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-4">
                            <span class="text-2xl">📚</span>
                            <div class="text-left">
                                <div class="font-bold">พจนานุกรมสนุก</div>
                                <div class="text-sm opacity-90">พจนานุกรมออนไลน์</div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="closeAlternativeDictionariesModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">
                            ปิด
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close Alternative Dictionaries Modal
        function closeAlternativeDictionariesModal() {
            const modal = document.getElementById('alternativeDictionariesModal');
            if (modal) {
                modal.remove();
            }
        }

        // Open Link in New Tab
        function openLink(url) {
            window.open(url, '_blank', 'noopener,noreferrer');
            closeAlternativeDictionariesModal();
            showNotification('เปิดลิงก์ในแท็บใหม่แล้ว! 🔗', 'success');
        }

        // Show Word Hints
        function showWordHints() {
            const modal = document.createElement('div');
            modal.id = 'wordHintsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            const mission = MISSION_DATA.MISSION_01;
            const wordsArray = Object.entries(mission.hardWords);
            
            modal.innerHTML = `
                <div class="modal-card scrollable bg-white rounded-3xl p-6 max-w-4xl w-full animate-bounce-in relative">
                    <button onclick="closeWordHintsModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold">×</button>
                    
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">💡 ใบ้คำศัพท์</h2>
                        <p class="text-gray-600">ดูภาพใบ้เพื่อช่วยในการค้นหาความหมาย</p>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        ${wordsArray.map(([word, data]) => `
                            <div class="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200 p-4 rounded-xl text-center hover:shadow-lg transition-all duration-200">
                                <img src="${getWordImage(word)}" alt="ใบ้สำหรับ ${word}" class="w-20 h-20 mx-auto rounded-lg border-2 border-blue-300 object-cover mb-3 shadow-md">
                                <div class="font-bold text-blue-900 text-lg mb-1">${word}</div>
                                <div class="text-xs text-blue-700">${data.points} คะแนน</div>
                                <div class="text-xs text-gray-600 mt-2">คลิกคำในโคลงเพื่อตอบ</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="closeWordHintsModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">
                            ปิด
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close Word Hints Modal
        function closeWordHintsModal() {
            const modal = document.getElementById('wordHintsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Open Dictionary (Legacy function - now redirects to new tab)
        function openDictionary() {
            openDictionaryNewTab();
        }

        // Close Dictionary Modal
        function closeDictionaryModal() {
            const modal = document.getElementById('dictionaryModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show Kloang Info
        function showKloangInfo() {
            const modal = document.createElement('div');
            modal.id = 'kloangModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="modal-card scrollable bg-white rounded-3xl p-6 max-w-4xl w-full animate-bounce-in relative">
                    <button onclick="closeKloangModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold">×</button>
                    
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">📋 ฉันทลักษณ์โคลงสี่สุภาพ</h2>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-blue-900 mb-4">คณะ</h3>
                            <div class="space-y-2 text-blue-800">
                                <p>• โคลงสี่สุภาพ 1 บทมี 4 บาท โดย 1 บรรทัดคือ 1 บาท แต่ละบาทมี 2 วรรค</p>
                                <p>• บาทที่ 1 บาทที่ 2 และบาทที่ 3 มีจำนวนคำเท่ากัน คือ วรรคหน้ามี 5 คำ ส่วนวรรคหลังมี 2 คำ</p>
                                <p>• บาทที่ 4 วรรคหน้ามี 5 คำเช่นกัน แต่วรรคหลังจะมี 4 คำ</p>
                                <p>• รวมทั้งสิ้น 1 บทจะมี 30 คำ</p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-orange-900 mb-4 text-center">รูปฉันทลักษณ์โคลงสี่สุภาพ</h3>
                            <div class="text-center">
                                <img src="https://img5.pic.in.th/file/secure-sv1/Screenshot-2025-10-19-234603.png" alt="รูปฉันทลักษณ์โคลงสี่สุภาพ" class="w-full max-w-3xl mx-auto rounded-xl border-2 border-orange-300 shadow-lg" onerror="this.src=''; this.alt='ไม่สามารถโหลดภาพได้'; this.style.display='none';">
                                <p class="text-orange-700 text-sm mt-3">รูปแบบฉันทลักษณ์โคลงสี่สุภาพ แสดงตำแหน่งวรรณยุกต์เอก (●) โท (●) และตำแหน่งอิสระ (○)</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="closeKloangModal()" class="modern-button px-6 py-3 rounded-xl bg-gray-500 hover:bg-gray-600">ปิด</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }



        // Close Kloang Modal
        function closeKloangModal() {
            const modal = document.getElementById('kloangModal');
            if (modal) {
                modal.remove();
            }
        }

    // Close the panel when clicking outside
    document.addEventListener('click', (event) => {
        if (!floatingActions.contains(event.target)) {
            closePanel();
        }
    });

        // Show Notification
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;

            container.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        window.addEventListener('error', (event) => {
            console.error('Global error captured:', event.error || event.message);
            if (event.error && event.error.silent) return;
            showNotification('เกิดข้อผิดพลาดที่ไม่คาดคิดในระบบ', 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            if (event.reason && event.reason.silent) return;
            showNotification('ไม่สามารถดำเนินการได้ กรุณาลองใหม่อีกครั้ง', 'error');
        });
    </script>
</body>
</html>
