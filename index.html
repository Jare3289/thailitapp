<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ไขรหัสวรรณคดี - The Literature Detective</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai+Looped:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            box-sizing: border-box;
            font-family: 'IBM Plex Sans Thai Looped', sans-serif;
            background: radial-gradient(circle at top left, #eef2ff 0%, rgba(238, 242, 255, 0) 45%),
                        radial-gradient(circle at bottom right, #fdf2f8 0%, rgba(253, 242, 248, 0) 45%),
                        linear-gradient(180deg, #f8fafc 0%, #ffffff 50%, #fdf2f8 100%);
            position: relative;
            min-height: 100vh;
            color: #111827;
            overflow-x: hidden;
        }

        body::before,
        body::after {
            content: '';
            position: fixed;
            width: 420px;
            height: 420px;
            border-radius: 9999px;
            filter: blur(120px);
            opacity: 0.45;
            z-index: -1;
        }

        body::before {
            top: -180px;
            left: -120px;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.7), rgba(236, 72, 153, 0.6));
        }

        body::after {
            bottom: -160px;
            right: -100px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.6), rgba(16, 185, 129, 0.55));
        }
        
        /* Landing page background */
        #landingPage {
            background-image: linear-gradient(135deg, rgba(255, 255, 255, 0.88), rgba(236, 233, 254, 0.72)), url('https://img2.pic.in.th/pic/742215688----.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            position: relative;
        }
        
        #landingPage::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.6), rgba(224, 231, 255, 0.3));
            z-index: 1;
            pointer-events: none;
            transition: background 0.3s ease;
        }
        
        #landingPage.user-logged-in::before {
            background: rgba(255, 255, 255, 0.85);
        }
        
        #landingPage > * {
            position: relative;
            z-index: 2;
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        .hero-title {
            font-weight: 800;
            line-height: 1.2;
            letter-spacing: -0.02em;
        }

        .hero-highlight {
            display: inline-block;
            background: linear-gradient(120deg, #7c3aed 0%, #ec4899 50%, #f59e0b 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            padding-left: 0.35rem;
            font-size: 0.9em;
        }

        .hero-subtitle {
            color: #4b5563;
            font-size: 1.05rem;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.65rem 1rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.3);
            font-weight: 600;
            color: #4338ca;
            box-shadow: 0 15px 25px -10px rgba(67, 56, 202, 0.35);
        }

        .stat-chip {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 0.25rem;
            padding: 1rem 0.75rem;
            border-radius: 1rem;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(148, 163, 184, 0.35);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-chip:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px -12px rgba(59, 130, 246, 0.3);
        }

        .landing-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(18px);
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 35px 65px -25px rgba(30, 64, 175, 0.45);
            border-radius: 1.75rem;
        }

        .landing-card h3 {
            color: #1f2937;
        }

        .mission-card {
            background: rgba(255, 255, 255, 0.82);
            backdrop-filter: blur(16px);
            border-radius: 2rem;
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 40px 70px -30px rgba(15, 23, 42, 0.45);
            position: relative;
            overflow: hidden;
        }

        .mission-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(236, 72, 153, 0.08));
            opacity: 0.9;
            z-index: 0;
        }

        .mission-card > * {
            position: relative;
            z-index: 1;
        }

        .mission-card .badge-modern {
            box-shadow: 0 12px 30px -12px rgba(124, 58, 237, 0.4);
        }

        .login-actions button {
            transform: translateY(0);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            box-shadow: 0 12px 24px -12px rgba(37, 99, 235, 0.4);
        }

        .login-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 32px -12px rgba(37, 99, 235, 0.45);
        }

        .landing-aurora {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }

        .landing-aurora::before,
        .landing-aurora::after {
            content: '';
            position: absolute;
            border-radius: 9999px;
            filter: blur(120px);
            opacity: 0.55;
        }

        .landing-aurora::before {
            width: 520px;
            height: 520px;
            top: -120px;
            right: -80px;
            background: linear-gradient(135deg, rgba(129, 140, 248, 0.8), rgba(192, 132, 252, 0.7));
            animation: auroraPulse 14s ease-in-out infinite;
        }

        .landing-aurora::after {
            width: 420px;
            height: 420px;
            bottom: -160px;
            left: -40px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.65), rgba(16, 185, 129, 0.6));
            animation: auroraPulse 16s ease-in-out infinite reverse;
        }

        @keyframes auroraPulse {
            0%, 100% {
                transform: translate3d(0, 0, 0) scale(1);
                opacity: 0.45;
            }
            50% {
                transform: translate3d(40px, -30px, 0) scale(1.1);
                opacity: 0.7;
            }
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .modern-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        .word-to-find {
            color: #3b82f6;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
        }
        
        .word-to-find:hover {
            color: #1d4ed8;
            text-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
            transform: scale(1.05);
        }
        
        .word-correct {
            color: #059669;
            font-weight: 700;
        }
        
        .word-incorrect {
            color: #dc2626;
            font-weight: 700;
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .poem-container {
            background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .poem-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899, #f59e0b);
        }
        
        .poem-text {
            font-size: 1.5rem;
            line-height: 1.8;
            font-weight: 400;
            font-family: 'IBM Plex Sans Thai Looped', sans-serif;
        }
        
        .kloang-container {
            line-height: 1.8;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1rem;
            overflow-x: auto;
        }

        .bart {
            display: flex;
            flex-wrap: nowrap;
            align-items: flex-start;
            margin-bottom: 0.8rem;
            white-space: nowrap;
            min-width: fit-content;
        }

        .wak-na {
            min-width: 280px; 
            max-width: 280px; 
            text-align: left;
            padding-right: 1.5rem;
            font-weight: 400;
            flex-shrink: 0;
            font-style: normal;
            white-space: nowrap;
            overflow: visible;
        }

        .wak-lang {
            padding-right: 0.5rem;
            padding-left: 1rem;
            font-weight: 400;
            font-style: normal;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .kam-sroi {
            font-style: normal;
            font-weight: 400;
            padding-left: 0.5rem;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .modern-button {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            font-weight: 600;
            border-radius: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3);
            border: none;
        }
        
        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.4);
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
        }
        
        .modern-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .modern-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(148, 163, 184, 0.3);
            border-radius: 15px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .modern-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
            background: white;
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            height: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            border-radius: 25px;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .step-indicator {
            background: rgba(59, 130, 246, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1rem;
        }
        
        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .step-active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 8px 15px -3px rgba(59, 130, 246, 0.4);
            transform: scale(1.1);
        }
        
        .step-completed {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 8px 15px -3px rgba(16, 185, 129, 0.4);
        }
        
        .step-inactive {
            background: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.7);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            font-weight: 600;
            z-index: 1000;
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification-success {
            background: rgba(16, 185, 129, 0.9);
            color: white;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .notification-error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .floating-elements {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
        }
        
        .floating-element {
            position: absolute;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg);
                opacity: 0.1;
            }
            50% { 
                transform: translateY(-20px) rotate(180deg);
                opacity: 0.3;
            }
        }
        
        .tooltip-modern {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .badge-modern {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3) translateY(-50px);
            }
            50% {
                opacity: 1;
                transform: scale(1.05) translateY(-10px);
            }
            70% {
                transform: scale(0.95) translateY(0);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .animate-bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .hero-text {
            text-shadow: 2px 2px 20px rgba(0,0,0,0.3);
        }
        
        .landing-feature {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .landing-feature:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        /* 📱 Responsive refinements */
        @media (max-width: 1024px) {
            #landingPage {
                background-attachment: scroll;
            }

            .teacher-dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .teacher-portal-grid {
                gap: 2rem;
            }
        }

        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.25rem;
            }

            .hero-subtitle {
                font-size: 1.05rem;
            }

            .hero-badge {
                font-size: 0.95rem;
                padding: 0.6rem 1.25rem;
            }

            .stat-chip {
                width: 100%;
                flex-direction: row;
                align-items: center;
                text-align: left;
                gap: 0.75rem;
            }

            .landing-card,
            .mission-card {
                padding: 1.5rem;
                border-radius: 1.5rem;
            }

            .mission-card img {
                max-height: 220px;
                width: 100%;
                object-fit: cover;
            }

            .teacher-sidebar {
                border-radius: 2rem;
            }

            .teacher-summary-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .teacher-activity-list {
                gap: 1.5rem;
            }
        }

        @media (max-width: 640px) {
            body {
                font-size: 16px;
            }

            .hero-title {
                font-size: 1.875rem;
            }

            .hero-subtitle {
                font-size: 0.95rem;
            }

            .hero-badge {
                font-size: 0.85rem;
            }

            .stat-chip {
                padding: 1rem;
            }

            .teacher-summary-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .teacher-summary-card {
                padding: 1.25rem !important;
            }

            .teacher-table {
                border: none;
            }

            .teacher-table thead {
                display: none;
            }

            .teacher-table tbody tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid rgba(148, 163, 184, 0.25);
                border-radius: 1rem;
                overflow: hidden;
                background: rgba(255, 255, 255, 0.95);
            }

            .teacher-table tbody tr:last-child {
                margin-bottom: 0;
            }

            .teacher-table tbody td {
                display: flex;
                justify-content: space-between;
                gap: 1rem;
                padding: 0.85rem 1rem;
                border-bottom: 1px solid rgba(148, 163, 184, 0.15);
            }

            .teacher-table tbody td:last-child {
                border-bottom: none;
            }

            .teacher-table tbody td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #475569;
            }

            .teacher-dashboard-header button {
                width: 100%;
            }

            .teacher-portal-grid {
                gap: 1.5rem;
            }
        }
        /* Header Sticky Positioning */
        #header {
            position: sticky !important;
            top: 0px !important;
            z-index: 50 !important;
        }

        /* Main Content Proper Spacing */
        #mainContent {
            padding-top: 2rem !important;
            min-height: calc(100vh - 200px) !important;
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
    <!-- Floating Background Elements -->
    <div class="floating-elements">
        <div class="floating-element text-6xl" style="top: 10%; left: 10%; animation-delay: 0s;">📚</div>
        <div class="floating-element text-4xl" style="top: 20%; right: 15%; animation-delay: 1s;">✨</div>
        <div class="floating-element text-5xl" style="bottom: 20%; left: 20%; animation-delay: 2s;">🔍</div>
        <div class="floating-element text-3xl" style="bottom: 30%; right: 25%; animation-delay: 3s;">💭</div>
    </div>

    <!-- Teacher Portal Section -->
    <div id="teacherPortal" class="hidden bg-slate-50/70 min-h-screen py-12">
        <div class="max-w-6xl mx-auto px-4 md:px-6 lg:px-8 space-y-10">
            <div class="teacher-dashboard-header flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <p class="text-sm uppercase tracking-widest text-blue-600/70">ThaiLit Backoffice</p>
                    <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900">แดชบอร์ดครูผู้สอน</h2>
                    <p class="text-sm md:text-base text-slate-600 mt-2 max-w-2xl">ติดตามผลการเรียนรู้แบบเรียลไทม์ ดูคะแนน ทบทวนคำตอบ และวางแผนการสอนให้สอดคล้องกับความคืบหน้าของนักเรียนในแต่ละห้องเรียน</p>
                </div>
                <button onclick="closeTeacherPortal()" class="self-start md:self-center inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white text-slate-700 border border-slate-200 shadow-sm hover:bg-slate-100 transition">⬅️ กลับสู่หน้าหลัก</button>
            </div>

            <div class="teacher-portal-grid grid lg:grid-cols-5 gap-6">
                <aside class="teacher-sidebar order-2 lg:order-1 lg:col-span-2 bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 text-white rounded-3xl p-6 md:p-8 space-y-6 shadow-xl">
                    <div class="space-y-2">
                        <p class="text-sm text-white/80">ภาพรวมระบบ</p>
                        <p class="text-lg md:text-xl font-semibold text-white/90">ข้อมูลสำคัญของวันนี้</p>
                    </div>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-white/10 rounded-2xl p-3 backdrop-blur border border-white/10">
                            <p class="text-white/70">ภาพรวมคะแนน</p>
                            <p class="text-2xl font-bold" id="teacherQuickAverage">-</p>
                        </div>
                        <div class="bg-white/10 rounded-2xl p-3 backdrop-blur border border-white/10">
                            <p class="text-white/70">นักเรียนลงทะเบียน</p>
                            <p class="text-2xl font-bold" id="teacherQuickStudents">-</p>
                        </div>
                        <div class="bg-white/10 rounded-2xl p-3 backdrop-blur border border-white/10">
                            <p class="text-white/70">ภารกิจสำเร็จ</p>
                            <p class="text-2xl font-bold" id="teacherQuickCompleted">-</p>
                        </div>
                        <div class="bg-white/10 rounded-2xl p-3 backdrop-blur border border-white/10">
                            <p class="text-white/70">เข้าสู่ระบบวันนี้</p>
                            <p class="text-2xl font-bold" id="teacherQuickActive">-</p>
                        </div>
                    </div>
                    <div class="text-xs text-white/70 space-y-1">
                        <p>บัญชีทดลอง</p>
                        <p class="font-semibold">อีเมล: teacher@thailit.app • รหัสผ่าน: litpass123</p>
                    </div>
                </aside>

                <section class="order-1 lg:order-2 lg:col-span-3 space-y-6">
                    <div id="teacherLoginPanel" class="space-y-6 bg-white/80 border border-slate-200 rounded-3xl p-6 md:p-8 shadow-lg">
                        <div>
                            <h3 class="text-2xl font-bold text-slate-900 mb-2">เข้าสู่ระบบสำหรับครู</h3>
                            <p class="text-sm text-slate-600">ใช้บัญชีที่ได้รับจากผู้ดูแลเพื่อเข้าถึงข้อมูลนักเรียนและบันทึกการเรียนรู้</p>
                        </div>
                        <form id="teacherLoginForm" class="space-y-4" onsubmit="submitTeacherLogin(event)">
                            <div>
                                <label for="teacherEmail" class="block text-sm font-semibold text-slate-700 mb-2">อีเมลครู</label>
                                <input id="teacherEmail" type="email" required class="w-full modern-input p-3" placeholder="teacher@school.ac.th">
                            </div>
                            <div>
                                <label for="teacherPassword" class="block text-sm font-semibold text-slate-700 mb-2">รหัสผ่าน</label>
                                <input id="teacherPassword" type="password" required class="w-full modern-input p-3" placeholder="••••••••">
                            </div>
                            <button type="submit" class="modern-button w-full py-3 text-base rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700">เข้าสู่ระบบครู</button>
                        </form>
                        <div class="text-xs text-slate-500 leading-relaxed">
                            <p>เมื่อเข้าสู่ระบบ ครูจะสามารถดาวน์โหลดรายงานผลลัพธ์ แสดงคำตอบของนักเรียนแต่ละคน และดูไทม์ไลน์กิจกรรมล่าสุดได้</p>
                        </div>
                    </div>

                    <div id="teacherDashboard" class="hidden space-y-6">
                        <div class="bg-white/80 border border-slate-200 rounded-3xl p-6 md:p-8 shadow-lg space-y-6">
                            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                                <div>
                                    <h3 class="text-2xl font-bold text-slate-900" id="teacherGreeting">สวัสดีคุณครู</h3>
                                    <p class="text-sm text-slate-600" id="teacherClasses">บัญชีครูภาษาไทย</p>
                                    <p class="text-xs text-slate-500" id="teacherEmailDisplay"></p>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="renderTeacherDashboard()" class="modern-button px-4 py-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 flex items-center gap-2">
                                        🔄 รีเฟรชข้อมูล
                                    </button>
                                    <button onclick="logoutTeacher()" class="modern-button px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 flex items-center gap-2">
                                        🚪 ออกจากระบบครู
                                    </button>
                                </div>
                            </div>

                            <div id="teacherDashboardLoading" class="hidden">
                                <div class="bg-white border border-slate-200 rounded-2xl p-6 text-center shadow-sm">
                                    <div class="flex flex-col items-center gap-3">
                                        <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin"></div>
                                        <p class="text-sm text-slate-600">กำลังดึงข้อมูลนักเรียน...</p>
                                    </div>
                                </div>
                            </div>

                            <div id="teacherSummaryCards" class="teacher-summary-grid grid grid-cols-1 sm:grid-cols-2 gap-4"></div>

                            <div id="teacherEmptyState" class="hidden bg-white border border-dashed border-slate-300 rounded-2xl p-6 text-center text-slate-500">
                                <p class="font-semibold">ยังไม่มีข้อมูลนักเรียนในระบบ</p>
                                <p class="text-sm mt-2">เมื่อมีนักเรียนลงทะเบียนหรือเริ่มทำภารกิจ ข้อมูลจะปรากฏที่นี่อัตโนมัติ</p>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between">
                                <h4 class="text-lg font-semibold text-slate-900">ภาพรวมคะแนนนักเรียน</h4>
                                <span class="text-xs text-slate-500" id="teacherTableMeta"></span>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="teacher-table min-w-full divide-y divide-slate-200 text-sm">
                                    <thead class="bg-slate-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left font-semibold text-slate-600">นักเรียน</th>
                                            <th class="px-4 py-3 text-left font-semibold text-slate-600">ชั้น/ห้อง</th>
                                            <th class="px-4 py-3 text-left font-semibold text-slate-600">ความคืบหน้า</th>
                                            <th class="px-4 py-3 text-left font-semibold text-slate-600">คะแนนเฉลี่ย</th>
                                            <th class="px-4 py-3 text-left font-semibold text-slate-600">อัปเดตล่าสุด</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teacherStudentTable" class="divide-y divide-slate-100 bg-white"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-200 shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-semibold text-slate-900">กิจกรรมล่าสุด</h4>
                                <span class="text-xs text-slate-500" id="teacherTimelineMeta"></span>
                            </div>
                            <div id="teacherActivityTimeline" class="teacher-activity-list space-y-4"></div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Landing Page -->
    <div id="landingPage" class="min-h-screen bg-gray-50 flex items-center justify-center p-2 md:p-4 relative overflow-hidden">
        <div class="landing-aurora"></div>
        <div class="max-w-6xl mx-auto relative z-10 w-full">
            <!-- Main Content Grid -->
            <div class="grid lg:grid-cols-2 gap-4 md:gap-8 items-center min-h-screen py-4">
                <!-- Left Column - Hero Content -->
                <div class="text-center lg:text-left flex flex-col justify-center h-full py-8">
                    <div class="mb-8 space-y-6">
                        <div class="flex justify-center lg:justify-start">
                            <span class="hero-badge">
                                📚 ภารกิจ 01 • โคลงสี่สุภาพ
                            </span>
                        </div>

                        <h1 class="hero-title text-3xl md:text-4xl lg:text-5xl text-gray-900">
                            ไขรหัสวรรณคดี
                            <span class="hero-highlight">The Literature Detective</span>
                        </h1>

                        <p class="hero-subtitle text-base md:text-lg lg:text-xl">
                            ประสบการณ์เรียนรู้วรรณคดีไทยที่ผสานเกมการสืบสวน การตีความ และการจับคู่คำศัพท์ให้สนุกกว่าที่เคย
                        </p>

                        <!-- Feature Highlights -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-base">
                            <div class="stat-chip">
                                <span class="text-2xl">🔍</span>
                                <p class="font-semibold text-blue-700">สืบค้นคำศัพท์</p>
                                <p class="text-xs text-gray-500">พร้อมแหล่งอ้างอิง</p>
                            </div>
                            <div class="stat-chip">
                                <span class="text-2xl">💭</span>
                                <p class="font-semibold text-purple-700">จินตนาการเรื่องราว</p>
                                <p class="text-xs text-gray-500">ถอดความแบบสร้างสรรค์</p>
                            </div>
                            <div class="stat-chip">
                                <span class="text-2xl">🎯</span>
                                <p class="font-semibold text-emerald-700">สะสมคะแนน</p>
                                <p class="text-xs text-gray-500">ปลดล็อกภารกิจใหม่</p>
                            </div>
                        </div>
                        
                        <!-- Login Section -->
                        <div id="loginSection" class="mb-6">
                            <div class="landing-card p-6 md:p-7 mb-6">
                                <div class="flex items-center justify-center gap-4 mb-4">
                                    <span class="text-2xl">👤</span>
                                    <h3 class="text-xl font-bold text-gray-900">เข้าสู่ระบบ</h3>
                                </div>
                                <p class="text-gray-600 text-center mb-6 leading-relaxed">เข้าสู่ระบบเพื่อบันทึกความคืบหน้า เชื่อมต่อคะแนน และรับคำแนะนำเฉพาะตัวในแต่ละภารกิจ</p>

                                <div id="loginButtons" class="space-y-4">
                                    <div class="grid grid-cols-3 gap-2 login-actions">
                                        <button onclick="showStudentForm()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-2 rounded-xl transition-all duration-200 text-sm">
                                            📝 ลงทะเบียน
                                        </button>

                                        <button onclick="showLoginForm()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-2 rounded-xl transition-all duration-200 text-sm">
                                            🔑 เข้าสู่ระบบ
                                        </button>

                                        <button id="startGameBtn" onclick="startGame()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 px-2 rounded-xl transition-all duration-200 text-sm disabled:bg-gray-400 disabled:cursor-not-allowed disabled:opacity-50 transform hover:scale-105 enabled:shadow-2xl enabled:animate-pulse" disabled>
                                            ✨ เริ่มเลย
                                        </button>
                                    </div>

                                    <div class="p-4 rounded-2xl bg-gradient-to-r from-blue-50/80 via-indigo-50/80 to-purple-50/80 border border-blue-100/70">
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                            <div class="text-left">
                                                <p class="text-sm font-semibold text-blue-900">สำหรับครูผู้สอน</p>
                                                <p class="text-xs text-blue-600">เข้าสู่ระบบเพื่อดูคะแนนและความคืบหน้านักเรียน</p>
                                            </div>
                                            <button onclick="openTeacherPortal()" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-4 rounded-xl transition-all duration-200 shadow-lg flex items-center justify-center gap-2">
                                                👩‍🏫 พื้นที่ครู
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Student Registration Form -->
                                <div id="studentForm" class="hidden space-y-4">
                                    <div class="text-center mb-4">
                                        <h4 class="text-lg font-bold text-gray-900">📝 ข้อมูลนักเรียน</h4>
                                        <p class="text-sm text-gray-600">กรอกข้อมูลเพื่อบันทึกผลการเรียน</p>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">ชื่อ-นามสกุล *</label>
                                            <input type="text" id="studentName" class="w-full modern-input p-3" placeholder="ชื่อ นามสกุล" required>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">รหัสนักเรียน *</label>
                                            <input type="text" id="studentId" class="w-full modern-input p-3" placeholder="12345" required>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-3 gap-4">
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">ชั้น *</label>
                                            <select id="studentGrade" class="w-full modern-input p-3" required>
                                                <option value="">เลือกชั้น</option>
                                                <option value="ม.1">ม.1</option>
                                                <option value="ม.2">ม.2</option>
                                                <option value="ม.3">ม.3</option>
                                                <option value="ม.4">ม.4</option>
                                                <option value="ม.5">ม.5</option>
                                                <option value="ม.6">ม.6</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">ห้อง *</label>
                                            <input type="text" id="studentRoom" class="w-full modern-input p-3" placeholder="1" required>
                                        </div>
                                        <div>
                                            <label class="block text-gray-700 text-sm font-semibold mb-2">เลขที่ *</label>
                                            <input type="text" id="studentNumber" class="w-full modern-input p-3" placeholder="1" required>
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-2">เบอร์โทรศัพท์ *</label>
                                        <input type="tel" id="studentPhone" class="w-full modern-input p-3" placeholder="0812345678" required>
                                        <p class="text-xs text-gray-500 mt-1">ใช้เป็นรหัสผ่านร่วมกับรหัสนักเรียน</p>
                                    </div>
                                    
                                    <div class="flex gap-3 mt-6">
                                        <button onclick="hideStudentForm()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                                            ยกเลิก
                                        </button>
                                        <button onclick="registerStudent()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                                            บันทึกข้อมูล
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Student Login Form -->
                                <div id="loginForm" class="hidden space-y-4">
                                    <div class="text-center mb-4">
                                        <h4 class="text-lg font-bold text-gray-900">🔑 เข้าสู่ระบบ</h4>
                                        <p class="text-sm text-gray-600">ใช้รหัสนักเรียนและเบอร์โทรศัพท์</p>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-2">รหัสนักเรียน</label>
                                        <input type="text" id="loginStudentId" class="w-full modern-input p-3" placeholder="12345">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-gray-700 text-sm font-semibold mb-2">เบอร์โทรศัพท์</label>
                                        <input type="tel" id="loginPhone" class="w-full modern-input p-3" placeholder="0812345678">
                                    </div>
                                    
                                    <div class="flex gap-3 mt-6">
                                        <button onclick="hideLoginForm()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                                            ยกเลิก
                                        </button>
                                        <button onclick="loginStudent()" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                                            เข้าสู่ระบบ
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="userInfo" class="hidden text-center">
                                    <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4 mb-4">
                                        <div class="flex items-center justify-center gap-3 mb-3">
                                            <img id="userPhoto" src="" alt="Profile" class="w-12 h-12 rounded-full border-2 border-green-300">
                                            <div>
                                                <p class="font-bold text-green-900" id="userName"></p>
                                                <p class="text-sm text-green-700" id="userDetails"></p>
                                            </div>
                                        </div>
                                        <div class="text-xs text-green-600" id="userStats"></div>
                                    </div>
                                    <button onclick="signOutUser()" class="text-red-600 hover:text-red-700 font-semibold">
                                        ออกจากระบบ
                                    </button>
                                </div>
                            </div>
                        </div>
                        

                    </div>
                </div>
                
                <!-- Right Column - Mission Info -->
                <div class="mission-card rounded-3xl p-4 md:p-6 h-full overflow-y-auto">
                    <div class="mb-4">
                        <h2 class="text-xl md:text-2xl lg:text-3xl font-bold text-gray-900 mb-2">
                            โคลงสี่สุภาพ
                        </h2>
                        <p class="text-base md:text-lg lg:text-xl text-gray-600">พระราชพงศาวดาร - เรื่องสมเด็จพระสุริโยทัย</p>
                    </div>
                    
                    <div class="bg-white bg-opacity-70 border border-blue-200/60 rounded-2xl p-4 mb-6 backdrop-blur">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="text-3xl">🎯</span>
                            <div>
                                <h3 class="text-lg font-bold text-blue-900">ภารกิจ</h3>
                                <p class="text-blue-800 text-sm">ค้นหาความหมายคำศัพท์ยาก 5 คำ</p>
                            </div>
                        </div>

                        <div class="relative mb-4 overflow-hidden rounded-xl border border-blue-200/50 shadow-lg">
                            <img src="https://img5.pic.in.th/file/secure-sv1/education-booksOK.jpg" alt="กองหนังสือเพื่อการเรียนรู้" class="w-full h-40 object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-blue-900/40 via-transparent to-transparent"></div>
                        </div>

                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div class="stat-chip">
                                <div class="text-xl font-bold text-blue-600">5</div>
                                <div class="text-blue-700 text-xs">คำศัพท์</div>
                            </div>
                            <div class="stat-chip">
                                <div class="text-xl font-bold text-green-600">100+</div>
                                <div class="text-green-700 text-xs">คะแนน</div>
                            </div>
                            <div class="stat-chip">
                                <div class="text-xl font-bold text-purple-600">5</div>
                                <div class="text-purple-700 text-xs">ขั้นตอน</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Features List -->
                    <div class="space-y-3 mb-6">
                        <div class="flex items-center gap-3 p-3 bg-white/70 backdrop-blur rounded-xl border border-slate-200/70">
                            <div class="text-2xl">🔍</div>
                            <div>
                                <h4 class="font-bold text-gray-900 text-sm">สืบสอบคำศัพท์</h4>
                                <p class="text-gray-600 text-xs">ค้นหาความหมายด้วยตนเอง พร้อมระบุแหล่งอ้างอิง</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-white/70 backdrop-blur rounded-xl border border-slate-200/70">
                            <div class="text-2xl">💭</div>
                            <div>
                                <h4 class="font-bold text-gray-900 text-sm">จินตนาการ & ถอดความ</h4>
                                <p class="text-gray-600 text-xs">วาดภาพในใจและถอดความเป็นร้อยแก้วสมัยใหม่</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-white/70 backdrop-blur rounded-xl border border-slate-200/70">
                            <div class="text-2xl">🧠</div>
                            <div>
                                <h4 class="font-bold text-gray-900 text-sm">วิเคราะห์เชิงวรรณศิลป์</h4>
                                <p class="text-gray-600 text-xs">สังเกตรูปแบบฉันทลักษณ์และเทคนิคการประพันธ์</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-white/70 backdrop-blur rounded-xl border border-slate-200/70">
                            <div class="text-2xl">🖼️</div>
                            <div>
                                <h4 class="font-bold text-gray-900 text-sm">เปิดภาพจริง</h4>
                                <p class="text-gray-600 text-xs">เปรียบเทียบกับข้อมูลประวัติศาสตร์จริง</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ranking System -->
                    <div class="bg-white/80 backdrop-blur border border-yellow-200/70 rounded-2xl p-4 shadow-xl">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">🏆</span>
                            <h3 class="text-lg font-bold text-yellow-900">ระบบอันดับ</h3>
                        </div>
                        
                        <div class="grid grid-cols-4 gap-2">
                            <div class="bg-white bg-opacity-60 rounded-xl p-2 text-center">
                                <div class="text-base mb-1">🥇</div>
                                <div class="font-bold text-yellow-800 text-xs">นักสืบเซียน</div>
                                <div class="text-xs text-yellow-700">1000+ แต้ม</div>
                            </div>
                            <div class="bg-white bg-opacity-60 rounded-xl p-2 text-center">
                                <div class="text-base mb-1">🥈</div>
                                <div class="font-bold text-gray-700 text-xs">นักสืบชำนาญ</div>
                                <div class="text-xs text-gray-600">500+ แต้ม</div>
                            </div>
                            <div class="bg-white bg-opacity-60 rounded-xl p-2 text-center">
                                <div class="text-base mb-1">🥉</div>
                                <div class="font-bold text-orange-700 text-xs">นักสืบฝึกหัด</div>
                                <div class="text-xs text-orange-600">200+ แต้ม</div>
                            </div>
                            <div class="bg-white bg-opacity-60 rounded-xl p-2 text-center">
                                <div class="text-base mb-1">🌟</div>
                                <div class="font-bold text-blue-700 text-xs">มือใหม่</div>
                                <div class="text-xs text-blue-600">0+ แต้ม</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Header Dashboard (Hidden initially) -->
    <header id="header" class="bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500 shadow-lg border-b border-blue-300 p-2 md:p-3 hidden overflow-hidden">
        <!-- Background decoration -->
        <div class="absolute inset-0 opacity-10">
            <div class="absolute top-2 left-2 text-2xl animate-pulse">📚</div>
            <div class="absolute top-2 right-2 text-2xl animate-pulse" style="animation-delay: 1s;">✨</div>
            <div class="absolute bottom-2 left-2 text-2xl animate-pulse" style="animation-delay: 2s;">🔍</div>
            <div class="absolute bottom-2 right-2 text-2xl animate-pulse" style="animation-delay: 3s;">💭</div>
        </div>
        
        <div class="max-w-6xl mx-auto relative z-10">
            <!-- Top Row: Title and Controls -->
            <div class="flex flex-col lg:flex-row justify-between items-center gap-2 md:gap-3 mb-2">
                <div class="text-center lg:text-left">
                    <h1 class="text-xl md:text-2xl font-bold text-white mb-1">
                        📚 ไขรหัสวรรณคดี
                    </h1>
                    <p class="text-white text-sm md:text-base opacity-90">แอปพลิเคชันเรียนรู้วรรณคดีไทยแบบโต้ตอบ</p>
                    <div id="headerUserName" class="mt-1 text-xs text-slate-200 font-semibold hidden cursor-pointer hover:text-slate-100 transition-colors duration-200" onclick="showUserMenu()">
                        👤 <span id="currentUserName">ผู้ใช้</span> ▼
                    </div>
                </div>
                
                <!-- Player Profile -->
                <div class="flex items-center gap-2 md:gap-4">
                    <div class="bg-white bg-opacity-20 rounded-xl px-3 md:px-4 py-2 md:py-3 border border-white border-opacity-30">
                        <div class="flex items-center gap-2 md:gap-4">
                            <div class="text-center">
                                <p class="text-slate-100 font-bold text-lg md:text-xl"><span id="playerExp">0</span> แต้ม</p>
                                <p class="text-xs text-white opacity-75">คะแนนสะสม</p>
                            </div>
                            <div class="w-px h-6 md:h-8 bg-white bg-opacity-30"></div>
                            <div class="text-center">
                                <p class="bg-gradient-to-r from-blue-400 to-indigo-400 text-white px-2 py-1 rounded-full font-bold text-xs"><span id="playerRank">มือใหม่</span></p>
                                <p class="text-xs text-white opacity-75 mt-1">ระดับ</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Game Menu -->
                    <div class="flex gap-1">
                        <button id="backBtn" onclick="goBack()" class="bg-white bg-opacity-20 px-2 md:px-3 py-1 md:py-2 text-xs text-white hover:bg-white hover:bg-opacity-30 rounded-lg hidden transition-all duration-200">
                            ← ย้อนกลับ
                        </button>
                        <button onclick="showLandingPage()" class="bg-white bg-opacity-20 px-2 md:px-3 py-1 md:py-2 text-xs text-white hover:bg-white hover:bg-opacity-30 rounded-lg transition-all duration-200 border border-white border-opacity-30">
                            🔄 เริ่มใหม่
                        </button>
                        <button onclick="showLandingPage()" class="bg-white bg-opacity-20 px-2 md:px-3 py-1 md:py-2 text-xs text-white hover:bg-white hover:bg-opacity-30 rounded-lg transition-all duration-200 border border-white border-opacity-30">
                            🏠 หน้าหลัก
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="mb-2">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-white font-semibold text-xs md:text-sm">ความคืบหน้า</span>
                    <span id="progressText" class="text-white font-bold text-xs md:text-sm">0%</span>
                </div>
                <div class="bg-white bg-opacity-30 rounded-full h-2 overflow-hidden">
                    <div id="mainProgressFill" class="bg-gradient-to-r from-yellow-400 to-orange-400 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>
        
        <!-- Step Indicators -->
        <div class="max-w-6xl mx-auto mt-2 md:mt-3">
            <div class="glass-card rounded-2xl p-2 border border-white border-opacity-30">
                <div class="flex justify-center items-center gap-1 md:gap-2 mb-2">
                    <div id="step-1" class="step-circle step-active">1</div>
                    <div class="w-2 md:w-4 h-1 bg-gradient-to-r from-white to-transparent bg-opacity-40 rounded-full"></div>
                    <div id="step-2" class="step-circle step-inactive">2</div>
                    <div class="w-2 md:w-4 h-1 bg-gradient-to-r from-white to-transparent bg-opacity-40 rounded-full"></div>
                    <div id="step-3" class="step-circle step-inactive">3</div>
                    <div class="w-2 md:w-4 h-1 bg-gradient-to-r from-white to-transparent bg-opacity-40 rounded-full"></div>
                    <div id="step-4" class="step-circle step-inactive">4</div>
                    <div class="w-2 md:w-4 h-1 bg-gradient-to-r from-white to-transparent bg-opacity-40 rounded-full"></div>
                    <div id="step-5" class="step-circle step-inactive">5</div>
                    <div class="w-2 md:w-4 h-1 bg-gradient-to-r from-white to-transparent bg-opacity-40 rounded-full"></div>
                    <div id="step-6" class="step-circle step-inactive">6</div>
                </div>
                <div class="hidden md:flex justify-center items-center gap-2 text-white font-semibold text-xs opacity-90">
                    <span>📚 ประวัติศาสตร์</span>
                    <span>📖 แสดงโคลง</span>
                    <span>✍️ จินตนาการ & ถอดความ</span>
                    <span>🖼️ เปิดภาพจริง</span>
                    <span>📝 ทบทวน</span>
                    <span>🏆 สรุปผล</span>
                </div>
                <div class="md:hidden text-center text-white font-semibold text-xs opacity-90">
                    <span id="currentStepText">📚 ประวัติศาสตร์</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="mainContent" class="max-w-6xl mx-auto p-3 md:p-6 hidden">
        <!-- Content will be dynamically rendered here -->
    </main>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script>
        // Firebase Configuration - ข้อมูลจริงของคุณ
        const firebaseConfig = {
            apiKey: "AIzaSyCgIPCTpBY4Wwtk7kF4oViRVwJ7IAT77N0",
            authDomain: "thailit-d1633.firebaseapp.com",
            projectId: "thailit-d1633",
            storageBucket: "thailit-d1633.firebasestorage.app",
            messagingSenderId: "769056016001",
            appId: "1:769056016001:web:1e0d2eb6118a405120af80",
            measurementId: "G-XR94B0EBD6"
        };

        // Initialize Firebase
        let db = null;
        let auth = null;
        let analytics = null;
        
        try {
            // Initialize Firebase App
            firebase.initializeApp(firebaseConfig);
            
            // Initialize services
            db = firebase.firestore();
            auth = firebase.auth();
            
            // Initialize Analytics (optional)
            if (typeof firebase.analytics === 'function') {
                analytics = firebase.analytics();
                console.log('Firebase Analytics initialized');
            }
            
            // Configure Firestore settings
            db.settings({
                cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED
            });
            
            // Enable offline persistence
            db.enablePersistence({ synchronizeTabs: true })
                .then(() => {
                    console.log('Firestore offline persistence enabled');
                })
                .catch((err) => {
                    console.log('Firestore offline persistence failed:', err);
                });
            
            console.log('🔥 Firebase initialized successfully with real database!');
            showNotification('เชื่อมต่อฐานข้อมูลสำเร็จ! 🔥', 'success');
            
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showNotification('เกิดข้อผิดพลาดในการเชื่อมต่อฐานข้อมูล กำลังใช้ระบบสำรอง', 'error');
        }

        // Game State Management
        const gameState = {
            currentStep: 1,
            translatedWords: {},
            incorrectWords: {},
            wordAttempts: {}, // Track number of incorrect attempts per word
            imaginationText: '',
            interpretationText: '',
            comprehensionScore: 0,
            startTime: Date.now(),
            selectedWord: null,
            userId: null,
            gameId: null,
            stepHistory: []
        };

        const playerProfile = {
            exp: 0,
            rank: 'มือใหม่',
            totalGamesPlayed: 0,
            bestScore: 0,
            level: 1,
            expToNextLevel: 100
        };

        const teacherCredentials = {
            "teacher@thailit.app": {
                password: "litpass123",
                name: "ครูอารีย์ วิชิต",
                department: "กลุ่มสาระภาษาไทย",
                classes: ["ม.4/1", "ม.4/2"],
                role: "หัวหน้ากลุ่มสาระ"
            },
            "headteacher@thailit.app": {
                password: "thailit789",
                name: "ครูวราภรณ์ มั่นคง",
                department: "กลุ่มสาระภาษาไทย",
                classes: ["ม.5/1", "ม.5/3", "ชมรมวรรณศิลป์"],
                role: "ครูพี่เลี้ยง"
            }
        };

        let currentTeacher = null;

        function refreshTeacherViewIfNeeded() {
            if (currentTeacher) {
                renderTeacherDashboard().catch(error => console.error('Teacher dashboard refresh failed:', error));
            }
        }

        // Mission Data
        const MISSION_DATA = {
            MISSION_01: {
                title: "โคลงสี่สุภาพ - พระราชพงศาวดาร",
                historicalBackground: {
                    title: "ประวัติศาสตร์: สมเด็จพระสุริโยทัย",
                    content: `
                        <div class="space-y-6">
                            <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-200 rounded-2xl p-6">
                                <h4 class="text-xl font-bold text-amber-900 mb-4">👑 สมเด็จพระสุริโยทัย</h4>
                                <p class="text-amber-800 leading-relaxed">
                                    สมเด็จพระสุริโยทัย เป็นพระมเหสีของสมเด็จพระมหาจักรพรรดิ (พระราเมศวร) แห่งกรุงศรีอยุธยา 
                                    ทรงเป็นบุคคลสำคัญในประวัติศาสตร์ไทย ที่ทรงแสดงความกล้าหาญในการปกป้องแผ่นดิน
                                </p>
                            </div>
                            
                            <div class="bg-gradient-to-r from-red-50 to-pink-50 border-2 border-red-200 rounded-2xl p-6">
                                <h4 class="text-xl font-bold text-red-900 mb-4">⚔️ สงครามกับพม่า (พ.ศ. 2091)</h4>
                                <p class="text-red-800 leading-relaxed">
                                    เมื่อพระเจ้าแปร (พระเจ้าตะบิงชเวตี) แห่งพม่ายกทัพมาตีกรุงศรีอยุธยา 
                                    สมเด็จพระสุริโยทัยทรงแต่งกายเป็นทหาร ขี่ช้างออกรบเพื่อช่วยเหลือพระราชสามี
                                </p>
                            </div>
                            
                            <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-2xl p-6">
                                <h4 class="text-xl font-bold text-purple-900 mb-4">🐘 การสิ้นพระชนม์อย่างกล้าหาญ</h4>
                                <p class="text-purple-800 leading-relaxed">
                                    ในระหว่างการรบ สมเด็จพระสุริโยทัยทรงขี่ช้างเข้าไปช่วยเหลือพระราชสามีที่ตกอยู่ในอันตราย 
                                    แต่ทรงถูกพระเจ้าแปรใช้ง้าวฟันจนสิ้นพระชนม์บนหลังช้าง เป็นการเสียสละเพื่อแผ่นดิน
                                </p>
                            </div>
                            
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-2xl p-6">
                                <h4 class="text-xl font-bold text-green-900 mb-4">📜 บันทึกในพระราชพงศาวดาร</h4>
                                <p class="text-green-800 leading-relaxed">
                                    เหตุการณ์นี้ได้รับการบันทึกไว้ในพระราชพงศาวดารกรุงศรีอยุธยา 
                                    และได้รับการประพันธ์เป็นโคลงสี่สุภาพ เพื่อสรรเสริญพระเกียรติคุณและความกล้าหาญ
                                </p>
                            </div>
                        </div>
                    `
                },
                poem: `<div class="kloang-container">
                    <!-- บาทที่ ๑: วรรคหน้า 5 คำ + วรรคหลัง 2 คำ -->
                    <div class="bart">
                        <span class="wak-na">๏ <span class="word-to-find" data-word="นงคราญ">นงคราญ</span>องค์เอกแก้ว</span>
                        <span class="wak-lang">กระษัตรีย์</span>
                    </div>

                    <!-- บาทที่ ๒: วรรคหน้า 5 คำ + วรรคหลัง 2 คำ -->
                    <div class="bart">
                        <span class="wak-na"><span class="word-to-find" data-word="มาน">มาน</span>มนัส<span class="word-to-find" data-word="กัตเวที">กัตเวที</span></span>
                        <span class="wak-lang">ยิ่งล้ำ</span>
                    </div>

                    <!-- บาทที่ ๓: วรรคหน้า 5 คำ + วรรคหลัง 2 คำ + คำสร้อย 2 คำ -->
                    <div class="bart">
                        <span class="wak-na">เกรงพระราชสามี</span>
                        <span class="wak-lang"><span class="word-to-find" data-word="มลาย">มลาย</span>พระ</span>
                        <span class="kam-sroi">ชนม์เฮย</span>
                    </div>

                    <!-- บาทที่ ๔: วรรคหน้า 5 คำ + วรรคหลัง 4 คำ -->
                    <div class="bart">
                        <span class="wak-na">ขับ<span class="word-to-find" data-word="คเชนทร">คเชนทร</span>เข่นค้ำ</span>
                        <span class="wak-lang">สะอึกสู้<span class="word-to-find" data-word="ดัสกร">ดัสกร</span></span>
                    </div>

                    <!-- บาทที่ ๕: วรรคหน้า 5 คำ + วรรคหลัง 2 คำ -->
                    <div class="bart">
                        <span class="wak-na"> ๏ ขุนมอญร่อน<span class="word-to-find" data-word="ง้าว">ง้าว</span>ฟาด</span>
                        <span class="wak-lang">ฉาดฉะ</span>
                    </div>

                    <!-- บาทที่ ๖: วรรคหน้า 5 คำ + วรรคหลัง 2 คำ -->
                    <div class="bart">
                        <span class="wak-na">ขาด<span class="word-to-find" data-word="แล่ง">แล่ง</span>ตราบ<span class="word-to-find" data-word="อุระ">อุระ</span></span>
                        <span class="wak-lang"><span class="word-to-find" data-word="หรุบ">หรุบ</span>ดิ้น</span>
                    </div>

                    <!-- บาทที่ ๗: วรรคหน้า 5 คำ + วรรคหลัง 2 คำ + คำสร้อย 2 คำ -->
                    <div class="bart">
                        <span class="wak-na">โอรสรีบกันพระ</span>
                        <span class="wak-lang">ศพสู่</span>
                        <span class="kam-sroi">นครแฮ</span>
                    </div>

                    <!-- บาทที่ ๘: วรรคหน้า 5 คำ + วรรคหลัง 4 คำ -->
                    <div class="bart">
                        <span class="wak-na">สูญชีพ<span class="word-to-find" data-word="ไป่">ไป่</span>สูญสิ้น</span>
                        <span class="wak-lang"><span class="word-to-find" data-word="พจน์">พจน์</span>ผู้สรรเสริญ</span>
                    </div>
                </div>`,
                hardWords: {
                    "นงคราญ": { meaning: "นางงาม, สาวงาม, หญิงสาวที่มีความงาม, พระนาง", points: 15 },
                    "มาน": { meaning: "หัวใจ, จิตใจ, ความรู้สึก, อารมณ์", points: 15 },
                    "กัตเวที": { meaning: "ตอบแทนคุณ, รู้คุณ, กตัญญู, สำนึกในพระคุณ", points: 20 },
                    "มลาย": { meaning: "ตาย, สิ้นชีวิต, เสียชีวิต, สวรรคต", points: 18 },
                    "คเชนทร": { meaning: "ช้าง, ช้างเผือก, พาหนะ, สัตว์ใหญ่", points: 20 },
                    "ดัสกร": { meaning: "ข้าศึก, ศัตรู, คู่อริ, ผู้ร้าย", points: 18 },
                    "ง้าว": { meaning: "ดาบด้ามยาว, ทวน, อาวุธ, หอก, ใส", points: 15 },
                    "แล่ง": { meaning: "ผ่า, แยก, ฟัน, ตัด", points: 15 },
                    "อุระ": { meaning: "อก, หน้าอก, ทรวงอก, ส่วนหน้าของร่างกาย", points: 12 },
                    "หรุบ": { meaning: "ร่วง, ตก, ล้ม, หล่น", points: 15 },
                    "ไป่": { meaning: "ไม่, มิ, หา...ไม่, ปฏิเสธ", points: 10 },
                    "พจน์": { meaning: "พูด, กล่าว, คำพูด, วาจา", points: 15 }
                },
                correctInterpretation: "สมเด็จพระสุริโยทัยเกรงว่าพระสวามีจะสิ้นพระชนม์จึงได้ขับช้างเข้าขวางพระเจ้าแปรและต่อสู้กับพระเจ้าแปรแทน พระเจ้าแปรเอาง้าวฟันพระสุริโยทัย ผ่าตรงอกสิ้นพระชนม์บนคอช้าง สองพระโอรสคือ พระราเมศวร และมหินทราได้กันพระศพแล้วนำเข้าสู่เมือง สมเด็จพระสุริโยทัยสิ้นพระชนม์ไปแล้ว จึงเหลือแต่คำสรรเสริญเยินยอ",
                correctInterpretationKeywords: [
                    "สมเด็จพระสุริโยทัย", "กระษัตรีย์", "ตอบแทนคุณ", "พระราชสามี", "ตาย", 
                    "ช้าง", "ข้าศึก", "ขุนมอญ", "ง้าว", "ผ่า", "อก", "ร่วง", "โอรส", "พระศพ", "นคร", "คำพูด", "สรรเสริญ"
                ],
                officialImageURL: "https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_y6eb9wy6eb9wy6eb.png",
                officialImageDescription: "ภาพการต่อสู้ของสมเด็จพระสุริโยทัยบนหลังช้าง แสดงให้เห็นถึงความกล้าหาญในการปกป้องแผ่นดินและพระราชสามี",
                comprehensionQuestions: [
                    {
                        question: "จากการถอดความ สมเด็จพระสุริโยทัยทรงมีความรู้สึกอย่างไรต่อพระราชสามี",
                        options: ["เกรงกลัว", "เกรงใจและห่วงใย", "โกรธแค้น", "เฉยเมย"],
                        correct: 1
                    },
                    {
                        question: "เหตุใดสมเด็จพระสุริโยทัยจึงตัดสินใจขับช้างเข้าสู่การรบ",
                        options: ["เพื่อแสดงความกล้าหาญ", "เพื่อช่วยเหลือพระราชสามี", "เพื่อต่อสู้กับศัตรู", "เพื่อปกป้องแผ่นดิน"],
                        correct: 1
                    },
                    {
                        question: "คำว่า 'ขาดแล่งตราบอุระ หรุบดิ้น' สื่อความหมายว่าอย่างไร",
                        options: ["ถูกฟันที่แขน", "ถูกผ่าที่อกและล้มลง", "ถูกแทงที่ท้อง", "ถูกตีที่หลัง"],
                        correct: 1
                    },
                    {
                        question: "ความรู้สึกหลักที่โคลงนี้ต้องการสื่อคืออะไร",
                        options: ["ความเศร้าโศก", "ความกล้าหาญและการเสียสละ", "ความโกรธแค้น", "ความหวาดกลัว"],
                        correct: 1
                    },
                    {
                        question: "จากโคลง 'สูญชีพไป่สูญสิ้น พจน์ผู้สรรเสริญ' มีความหมายว่าอย่างไร",
                        options: ["ชีวิตจบลงแต่ชื่อเสียงยังคงอยู่", "ทุกอย่างหายไปหมด", "ไม่มีใครจำได้", "เหลือแต่ความทรงจำ"],
                        correct: 0
                    }
                ]
            }
        };

        // Database Functions
        async function saveUserData(userData) {
            try {
                if (db && gameState.userId) {
                    // Save to Firebase User collection
                    await db.collection('User').doc(gameState.userId).set(userData, { merge: true });
                    console.log('User data saved to Firebase User collection');
                } else {
                    // Fallback to localStorage
                    localStorage.setItem(`student_${gameState.userId}`, JSON.stringify(userData));
                    console.log('User data saved to localStorage');
                }
                refreshTeacherViewIfNeeded();
                return true;
            } catch (error) {
                console.error('Error saving user data:', error);
                // Fallback to localStorage
                localStorage.setItem(`student_${gameState.userId}`, JSON.stringify(userData));
                refreshTeacherViewIfNeeded();
                return false;
            }
        }

        async function loadUserData(userId) {
            try {
                if (db) {
                    // Try Firebase User collection first
                    const doc = await db.collection('User').doc(userId).get();
                    if (doc.exists) {
                        console.log('User data loaded from Firebase User collection');
                        return doc.data();
                    }
                }
                
                // Fallback to localStorage
                const localData = localStorage.getItem(`student_${userId}`);
                if (localData) {
                    console.log('User data loaded from localStorage');
                    return JSON.parse(localData);
                }
                
                return null;
            } catch (error) {
                console.error('Error loading user data:', error);
                // Fallback to localStorage
                const localData = localStorage.getItem(`student_${userId}`);
                return localData ? JSON.parse(localData) : null;
            }
        }

        async function saveGameSession(gameData) {
            try {
                const sessionData = {
                    ...gameData,
                    userId: gameState.userId,
                    userName: gameState.currentUser?.name || 'Unknown',
                    userEmail: gameState.currentUser?.email || '',
                    studentId: gameState.currentUser?.studentId || '',
                    timestamp: new Date().toISOString(),
                    completed: gameState.currentStep === 6,
                    lastUpdated: new Date().toISOString()
                };

                if (db && gameState.gameId) {
                    // Save to Firebase (keeping gameSessions for temporary data)
                    await db.collection('gameSessions').doc(gameState.gameId).set(sessionData, { merge: true });
                    console.log('Game session saved to Firebase:', gameState.gameId);
                } else {
                    // Fallback to localStorage
                    localStorage.setItem(`gameSession_${gameState.gameId}`, JSON.stringify(sessionData));
                    console.log('Game session saved to localStorage');
                }
                refreshTeacherViewIfNeeded();
                return true;
            } catch (error) {
                console.error('Error saving game session:', error);
                localStorage.setItem(`gameSession_${gameState.gameId}`, JSON.stringify(sessionData));
                refreshTeacherViewIfNeeded();
                return false;
            }
        }

        // Save all user answers to Firebase UserAnswer collection
        async function saveAllUserAnswers() {
            try {
                if (!gameState.userId || !db) {
                    console.log('No userId or db connection, skipping UserAnswer save');
                    return false;
                }

                const answersData = {
                    userId: gameState.userId,
                    gameId: gameState.gameId,
                    userName: gameState.currentUser?.name || 'Unknown',
                    studentId: gameState.currentUser?.studentId || '',
                    userEmail: gameState.currentUser?.email || '',
                    grade: gameState.currentUser?.grade || '',
                    room: gameState.currentUser?.room || '',
                    number: gameState.currentUser?.number || '',
                    
                    // Vocabulary answers (correct ones)
                    vocabularyAnswers: Object.keys(gameState.translatedWords).map(word => ({
                        word: word,
                        userAnswer: gameState.translatedWords[word].translation,
                        correctAnswer: MISSION_DATA.MISSION_01.hardWords[word].meaning,
                        reference: gameState.translatedWords[word].reference,
                        points: gameState.translatedWords[word].points,
                        timestamp: gameState.translatedWords[word].timestamp,
                        isCorrect: true
                    })),
                    
                    // Incorrect vocabulary attempts
                    incorrectAttempts: Object.keys(gameState.incorrectWords).map(word => ({
                        word: word,
                        userAnswer: gameState.incorrectWords[word].translation,
                        correctAnswer: MISSION_DATA.MISSION_01.hardWords[word].meaning,
                        reference: gameState.incorrectWords[word].reference,
                        timestamp: gameState.incorrectWords[word].timestamp,
                        isCorrect: false
                    })),
                    
                    // Creative writing answers
                    imaginationText: gameState.imaginationText || '',
                    interpretationText: gameState.interpretationText || '',
                    
                    // Comprehension quiz answers
                    comprehensionAnswers: (gameState.comprehensionAnswers || []).map((answer, index) => ({
                        questionIndex: index,
                        question: MISSION_DATA.MISSION_01.comprehensionQuestions[index]?.question || '',
                        userAnswer: answer >= 0 ? MISSION_DATA.MISSION_01.comprehensionQuestions[index]?.options[answer] || '' : 'ไม่ได้ตอบ',
                        correctAnswer: MISSION_DATA.MISSION_01.comprehensionQuestions[index]?.options[MISSION_DATA.MISSION_01.comprehensionQuestions[index]?.correct] || '',
                        isCorrect: answer === MISSION_DATA.MISSION_01.comprehensionQuestions[index]?.correct,
                        timestamp: new Date().toISOString()
                    })),
                    comprehensionScore: gameState.comprehensionScore || 0,
                    
                    // Matching game data
                    matchingScore: gameState.matchingScore || 0,
                    matchedPairs: gameState.matchedPairs || 0,
                    
                    // Game metadata
                    currentStep: gameState.currentStep,
                    startTime: gameState.startTime,
                    completedAt: new Date().toISOString(),
                    totalScore: calculateCurrentScore(),
                    
                    // Mission info
                    missionId: 'MISSION_01',
                    missionTitle: 'โคลงสี่สุภาพ - พระราชพงศาวดาร'
                };

                // Save to Firebase UserAnswer collection with unique document ID
                const answersDocId = `${gameState.userId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                await db.collection('UserAnswer').doc(answersDocId).set(answersData);
                
                console.log('All user answers saved to Firebase UserAnswer collection:', answersDocId);
                refreshTeacherViewIfNeeded();
                return true;

            } catch (error) {
                console.error('Error saving user answers to UserAnswer collection:', error);
                return false;
            }
        }

        // Calculate current score
        function calculateCurrentScore() {
            let vocabularyScore = 0;
            Object.values(gameState.translatedWords).forEach(word => {
                vocabularyScore += word.points;
            });
            
            const comprehensionScore = gameState.comprehensionScore * 20;
            const timeElapsed = (Date.now() - gameState.startTime) / 1000 / 60;
            const timeBonus = Math.max(0, Math.floor(50 - timeElapsed * 2));
            
            return vocabularyScore + comprehensionScore + timeBonus;
        }

        async function loadGameSession(gameId) {
            try {
                if (db) {
                    const doc = await db.collection('gameSessions').doc(gameId).get();
                    if (doc.exists) {
                        return doc.data();
                    }
                }
                
                const localData = localStorage.getItem(`gameSession_${gameId}`);
                return localData ? JSON.parse(localData) : null;
            } catch (error) {
                console.error('Error loading game session:', error);
                const localData = localStorage.getItem(`gameSession_${gameId}`);
                return localData ? JSON.parse(localData) : null;
            }
        }

        // Authentication Functions
        async function signInWithGoogle() {
            try {
                if (auth) {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    const result = await auth.signInWithPopup(provider);
                    const user = result.user;
                    
                    gameState.userId = user.uid;
                    gameState.currentUser = {
                        name: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        isGoogle: true
                    };
                    
                    // Load or create user profile
                    let userData = await loadUserData(user.uid);
                    if (!userData) {
                        userData = {
                            name: user.displayName,
                            email: user.email,
                            photoURL: user.photoURL,
                            registeredAt: new Date().toISOString(),
                            exp: 0,
                            rank: 'มือใหม่',
                            level: 1,
                            totalGamesPlayed: 0,
                            bestScore: 0,
                            isGoogle: true
                        };
                        await saveUserData(userData);
                    }
                    
                    // Update player profile
                    playerProfile.exp = userData.exp || 0;
                    playerProfile.rank = userData.rank || 'มือใหม่';
                    playerProfile.level = userData.level || 1;
                    playerProfile.totalGamesPlayed = userData.totalGamesPlayed || 0;
                    playerProfile.bestScore = userData.bestScore || 0;
                    
                    updateLoginUI({
                        displayName: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        isGoogle: true,
                        userData: userData
                    });
                    
                    updateUserNameDisplay();
                    showNotification(`ยินดีต้อนรับ ${user.displayName}!`, 'success');
                } else {
                    showNotification('ระบบล็อกอิน Google ไม่พร้อมใช้งานในสภาพแวดล้อมนี้', 'error');
                }
            } catch (error) {
                console.error('Google sign-in error:', error);
                showNotification('เกิดข้อผิดพลาดในการเข้าสู่ระบบ', 'error');
            }
        }
        
        async function signOutUser() {
            try {
                // Save current game state before signing out
                if (gameState.gameId && gameState.userId) {
                    await saveCurrentGameState();
                    await saveAllUserAnswers();
                }
                
                // Clear user data
                gameState.userId = null;
                gameState.currentUser = null;
                localStorage.removeItem('lastStudentId');
                
                // Reset game state
                gameState.currentStep = 1;
                gameState.translatedWords = {};
                gameState.incorrectWords = {};
                gameState.imaginationText = '';
                gameState.interpretationText = '';
                gameState.comprehensionScore = 0;
                gameState.startTime = Date.now();
                gameState.selectedWord = null;
                gameState.stepHistory = [];
                gameState.comprehensionAnswers = [];
                gameState.gameId = null;
                
                // Update UI
                updateLoginUI(null);
                showNotification('ออกจากระบบเรียบร้อย', 'success');
                
            } catch (error) {
                console.error('Error signing out:', error);
                // Still proceed with sign out even if save fails
                gameState.userId = null;
                gameState.currentUser = null;
                localStorage.removeItem('lastStudentId');
                updateLoginUI(null);
                showNotification('ออกจากระบบเรียบร้อย', 'success');
            }
        }
        
        // Student Management Functions
        function showStudentForm() {
            document.getElementById('loginButtons').classList.add('hidden');
            document.getElementById('studentForm').classList.remove('hidden');
        }
        
        function hideStudentForm() {
            document.getElementById('loginButtons').classList.remove('hidden');
            document.getElementById('studentForm').classList.add('hidden');
            clearStudentForm();
        }
        
        function showLoginForm() {
            document.getElementById('loginButtons').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }
        
        function hideLoginForm() {
            document.getElementById('loginButtons').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
            clearLoginForm();
        }
        
        function clearStudentForm() {
            document.getElementById('studentName').value = '';
            document.getElementById('studentId').value = '';
            document.getElementById('studentGrade').value = '';
            document.getElementById('studentRoom').value = '';
            document.getElementById('studentNumber').value = '';
            document.getElementById('studentPhone').value = '';
        }
        
        function clearLoginForm() {
            document.getElementById('loginStudentId').value = '';
            document.getElementById('loginPhone').value = '';
        }
        
        async function registerStudent() {
            const name = document.getElementById('studentName').value.trim();
            const studentId = document.getElementById('studentId').value.trim();
            const grade = document.getElementById('studentGrade').value;
            const room = document.getElementById('studentRoom').value.trim();
            const number = document.getElementById('studentNumber').value.trim();
            const phone = document.getElementById('studentPhone').value.trim();
            
            // Validation
            if (!name || !studentId || !grade || !room || !number || !phone) {
                showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
                return;
            }
            
            if (phone.length < 10) {
                showNotification('กรุณากรอกเบอร์โทรศัพท์ให้ถูกต้อง', 'error');
                return;
            }
            
            const studentData = {
                name: name,
                studentId: studentId,
                grade: grade,
                room: room,
                number: number,
                phone: phone,
                registeredAt: new Date().toISOString(),
                exp: 0,
                rank: 'มือใหม่',
                level: 1,
                totalGamesPlayed: 0,
                bestScore: 0,
                isStudent: true
            };
            
            try {
                // Set current user
                gameState.userId = studentId;
                gameState.currentUser = studentData;
                
                // Save to database
                await saveUserData(studentData);
                
                // Save last student ID for auto-login
                localStorage.setItem('lastStudentId', studentId);
                
                // Update player profile
                playerProfile.exp = studentData.exp;
                playerProfile.rank = studentData.rank;
                playerProfile.level = studentData.level;
                playerProfile.totalGamesPlayed = studentData.totalGamesPlayed;
                playerProfile.bestScore = studentData.bestScore;
                
                // Update UI
                updateLoginUI({
                    displayName: name,
                    email: `${grade}/${room} เลขที่ ${number}`,
                    photoURL: '',
                    isStudent: true,
                    studentData: studentData
                });
                
                updateUserNameDisplay();
                showNotification('บันทึกข้อมูลเรียบร้อย!', 'success');
                hideStudentForm();
                
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
            }
        }
        
        async function loginStudent() {
            const studentId = document.getElementById('loginStudentId').value.trim();
            const phone = document.getElementById('loginPhone').value.trim();
            
            if (!studentId || !phone) {
                showNotification('กรุณากรอกรหัสนักเรียนและเบอร์โทรศัพท์', 'error');
                return;
            }
            
            try {
                // Try to load from database first
                let studentData = await loadUserData(studentId);
                
                if (!studentData) {
                    showNotification('ไม่พบข้อมูลนักเรียน', 'error');
                    return;
                }
                
                // Verify phone number
                if (studentData.phone !== phone) {
                    showNotification('เบอร์โทรศัพท์ไม่ถูกต้อง', 'error');
                    return;
                }
                
                // Set current user
                gameState.userId = studentId;
                gameState.currentUser = studentData;
                
                // Save last student ID for auto-login
                localStorage.setItem('lastStudentId', studentId);
                
                // Update player profile
                playerProfile.exp = studentData.exp || 0;
                playerProfile.rank = studentData.rank || 'มือใหม่';
                playerProfile.level = studentData.level || 1;
                playerProfile.totalGamesPlayed = studentData.totalGamesPlayed || 0;
                playerProfile.bestScore = studentData.bestScore || 0;
                
                // Update UI
                updateLoginUI({
                    displayName: studentData.name,
                    email: `${studentData.grade}/${studentData.room} เลขที่ ${studentData.number}`,
                    photoURL: '',
                    isStudent: true,
                    studentData: studentData
                });
                
                showNotification(`ยินดีต้อนรับ ${studentData.name}!`, 'success');
                hideLoginForm();
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification('เกิดข้อผิดพลาดในการเข้าสู่ระบบ', 'error');
            }
        }
        
        function updateLoginUI(user) {
            const loginButtons = document.getElementById('loginButtons');
            const studentForm = document.getElementById('studentForm');
            const loginForm = document.getElementById('loginForm');
            const userInfo = document.getElementById('userInfo');
            const startGameBtn = document.getElementById('startGameBtn');
            const landingPage = document.getElementById('landingPage');
            
            if (user) {
                // Hide all forms
                if (loginButtons) loginButtons.classList.add('hidden');
                if (studentForm) studentForm.classList.add('hidden');
                if (loginForm) loginForm.classList.add('hidden');
                if (userInfo) userInfo.classList.remove('hidden');
                if (startGameBtn) startGameBtn.disabled = false;
                
                // Add class to make background more transparent when logged in
                if (landingPage) landingPage.classList.add('user-logged-in');
                
                // Update user info
                const userName = document.getElementById('userName');
                const userDetails = document.getElementById('userDetails');
                const userStats = document.getElementById('userStats');
                const userPhoto = document.getElementById('userPhoto');
                
                if (userName) userName.textContent = user.displayName;
                if (userDetails) userDetails.textContent = user.email;
                if (userStats) userStats.textContent = `EXP: ${playerProfile.exp} | เกม: ${playerProfile.totalGamesPlayed}`;
                
                // Set student avatar
                if (userPhoto) {
                    userPhoto.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzYjgyZjYiLz4KPHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI4IiB5PSI4Ij4KPHBhdGggZD0iTTEyIDEyQzE0LjIwOTEgMTIgMTYgMTAuMjA5MSAxNiA4QzE2IDUuNzkwODYgMTQuMjA5MSA0IDEyIDRDOS43OTA4NiA0IDggNS43OTA4NiA4IDhDOCAxMC4yMDkxIDkuNzkwODYgMTIgMTIgMTJaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMTIgMTRDOC4xMzQwMSAxNCA1IDE3LjEzNDEgNSAyMUg5SDE1SDE5QzE5IDE3LjEzNDEgMTUuODY2IDE0IDEyIDE0WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cjwvc3ZnPgo=';
                }
                
                gameState.userId = gameState.userId;
            } else {
                // Show login options
                if (loginButtons) loginButtons.classList.remove('hidden');
                if (studentForm) studentForm.classList.add('hidden');
                if (loginForm) loginForm.classList.add('hidden');
                if (userInfo) userInfo.classList.add('hidden');
                if (startGameBtn) startGameBtn.disabled = true;
                
                // Remove class to show background clearly when not logged in
                if (landingPage) landingPage.classList.remove('user-logged-in');
                
                gameState.userId = null;
                gameState.currentUser = null;
            }
        }

        function openTeacherPortal() {
            const portal = document.getElementById('teacherPortal');
            const landing = document.getElementById('landingPage');
            if (!portal) return;

            portal.classList.remove('hidden');
            if (landing) landing.classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });

            const loginPanel = document.getElementById('teacherLoginPanel');
            const dashboard = document.getElementById('teacherDashboard');

            if (currentTeacher) {
                if (loginPanel) loginPanel.classList.add('hidden');
                if (dashboard) dashboard.classList.remove('hidden');
                renderTeacherDashboard();
            } else {
                if (loginPanel) loginPanel.classList.remove('hidden');
                if (dashboard) dashboard.classList.add('hidden');
                resetTeacherLoginForm();
            }
        }

        function closeTeacherPortal() {
            const portal = document.getElementById('teacherPortal');
            const landing = document.getElementById('landingPage');
            if (!portal) return;

            portal.classList.add('hidden');
            if (landing) landing.classList.remove('hidden');
        }

        function resetTeacherLoginForm() {
            const emailInput = document.getElementById('teacherEmail');
            const passwordInput = document.getElementById('teacherPassword');
            if (emailInput) emailInput.value = '';
            if (passwordInput) passwordInput.value = '';
        }

        async function submitTeacherLogin(event) {
            event.preventDefault();

            const emailInput = document.getElementById('teacherEmail');
            const passwordInput = document.getElementById('teacherPassword');

            const email = emailInput?.value.trim().toLowerCase();
            const password = passwordInput?.value.trim();

            if (!email || !password) {
                showNotification('กรุณากรอกอีเมลและรหัสผ่านของคุณครู', 'error');
                return;
            }

            const credential = teacherCredentials[email];
            if (!credential || credential.password !== password) {
                showNotification('อีเมลหรือรหัสผ่านไม่ถูกต้อง', 'error');
                if (passwordInput) passwordInput.value = '';
                return;
            }

            currentTeacher = {
                email,
                ...credential
            };

            const loginPanel = document.getElementById('teacherLoginPanel');
            const dashboard = document.getElementById('teacherDashboard');

            if (loginPanel) loginPanel.classList.add('hidden');
            if (dashboard) dashboard.classList.remove('hidden');

            showNotification(`ยินดีต้อนรับ ${credential.name}`, 'success');
            await renderTeacherDashboard();
        }

        function logoutTeacher() {
            currentTeacher = null;
            const loginPanel = document.getElementById('teacherLoginPanel');
            const dashboard = document.getElementById('teacherDashboard');
            if (loginPanel) loginPanel.classList.remove('hidden');
            if (dashboard) dashboard.classList.add('hidden');
            resetTeacherLoginForm();
            showNotification('ออกจากระบบครูเรียบร้อย', 'success');
        }

        async function renderTeacherDashboard() {
            const loading = document.getElementById('teacherDashboardLoading');
            const summary = document.getElementById('teacherSummaryCards');
            const tableBody = document.getElementById('teacherStudentTable');
            const timeline = document.getElementById('teacherActivityTimeline');
            const emptyState = document.getElementById('teacherEmptyState');
            const tableMeta = document.getElementById('teacherTableMeta');
            const timelineMeta = document.getElementById('teacherTimelineMeta');
            const quickAverage = document.getElementById('teacherQuickAverage');
            const quickStudents = document.getElementById('teacherQuickStudents');
            const quickCompleted = document.getElementById('teacherQuickCompleted');
            const quickActive = document.getElementById('teacherQuickActive');
            const greeting = document.getElementById('teacherGreeting');
            const classesEl = document.getElementById('teacherClasses');
            const emailEl = document.getElementById('teacherEmailDisplay');

            if (currentTeacher) {
                if (greeting) greeting.textContent = `ยินดีต้อนรับ ${currentTeacher.name}`;
                if (classesEl) classesEl.textContent = currentTeacher.classes?.length ? `ดูแล: ${currentTeacher.classes.join(', ')}` : 'บัญชีครูภาษาไทย';
                if (emailEl) emailEl.textContent = `${currentTeacher.role || 'ครูผู้สอน'} • ${currentTeacher.email}`;
            }

            if (summary) summary.innerHTML = '';
            if (tableBody) tableBody.innerHTML = '';
            if (timeline) timeline.innerHTML = '';
            if (tableMeta) tableMeta.textContent = '';
            if (timelineMeta) timelineMeta.textContent = '';
            if (emptyState) emptyState.classList.add('hidden');

            if (loading) loading.classList.remove('hidden');

            const { students, sessions } = await fetchTeacherData();

            if (loading) loading.classList.add('hidden');

            if (quickStudents) quickStudents.textContent = students.length.toString();

            const completedSessions = sessions.filter(session => session.completed);
            const averageScore = sessions.length ? Math.round(sessions.reduce((sum, item) => sum + (item.totalScore || item.comprehensionScore || 0), 0) / sessions.length) : 0;
            const activeToday = sessions.filter(session => {
                if (!session.lastUpdated && !session.timestamp) return false;
                const time = new Date(session.lastUpdated || session.timestamp);
                const now = new Date();
                return time.getDate() === now.getDate() && time.getMonth() === now.getMonth() && time.getFullYear() === now.getFullYear();
            });

            if (quickAverage) quickAverage.textContent = sessions.length ? `${averageScore}` : '-';
            if (quickCompleted) quickCompleted.textContent = completedSessions.length.toString();
            if (quickActive) quickActive.textContent = activeToday.length.toString();

            if (students.length === 0 && sessions.length === 0) {
                if (emptyState) emptyState.classList.remove('hidden');
                return;
            }

            const sessionsByStudent = {};
            sessions.forEach(session => {
                const key = session.userId || session.studentId || session.userEmail || session.userName;
                if (!key) return;
                if (!sessionsByStudent[key]) sessionsByStudent[key] = [];
                sessionsByStudent[key].push(session);
            });

            const studentRows = students.map(student => {
                const key = student.studentId || student.id || student.email || student.name;
                const studentSessions = sessionsByStudent[key] || [];
                const sortedSessions = studentSessions.sort((a, b) => new Date(b.lastUpdated || b.timestamp || 0) - new Date(a.lastUpdated || a.timestamp || 0));
                const latestSession = sortedSessions[0];
                const average = studentSessions.length ? Math.round(studentSessions.reduce((sum, item) => sum + (item.totalScore || item.comprehensionScore || 0), 0) / studentSessions.length) : 0;
                const completionCount = studentSessions.filter(item => item.completed).length;
                return {
                    ...student,
                    averageScore: average,
                    latestSession,
                    completionCount,
                    sessions: studentSessions
                };
            });

            const knownStudentIds = new Set(studentRows.map(row => row.studentId || row.id || row.email));
            sessions.forEach(session => {
                const key = session.userId || session.studentId || session.userEmail;
                if (!key || knownStudentIds.has(key)) return;
                const average = session.totalScore || session.comprehensionScore || 0;
                studentRows.push({
                    name: session.userName || 'นักเรียนไม่ระบุชื่อ',
                    grade: session.grade || '-',
                    room: session.room || '-',
                    number: session.number || '-',
                    studentId: key,
                    averageScore: average,
                    latestSession: session,
                    completionCount: session.completed ? 1 : 0,
                    sessions: [session]
                });
                knownStudentIds.add(key);
            });

            studentRows.sort((a, b) => {
                const scoreDiff = (b.averageScore || 0) - (a.averageScore || 0);
                if (scoreDiff !== 0) return scoreDiff;
                const aTime = new Date(a.latestSession?.lastUpdated || a.latestSession?.timestamp || 0).getTime();
                const bTime = new Date(b.latestSession?.lastUpdated || b.latestSession?.timestamp || 0).getTime();
                return bTime - aTime;
            });

            if (summary) {
                const inProgress = sessions.length - completedSessions.length;
                const summaryData = [
                    {
                        label: 'นักเรียนที่ลงทะเบียน',
                        value: students.length,
                        description: 'มีโปรไฟล์ในระบบ',
                        gradient: 'from-blue-500 to-indigo-500',
                        icon: '👨‍🎓'
                    },
                    {
                        label: 'ภารกิจที่เสร็จสมบูรณ์',
                        value: completedSessions.length,
                        description: 'ปิดจบครบทุกขั้น',
                        gradient: 'from-emerald-500 to-teal-500',
                        icon: '🏆'
                    },
                    {
                        label: 'กำลังทำอยู่',
                        value: inProgress,
                        description: 'อยู่ระหว่างภารกิจ',
                        gradient: 'from-amber-500 to-orange-500',
                        icon: '⏳'
                    },
                    {
                        label: 'คะแนนเฉลี่ยรวม',
                        value: sessions.length ? `${averageScore}` : '-',
                        description: 'จากทุกเกมที่บันทึก',
                        gradient: 'from-purple-500 to-pink-500',
                        icon: '📊'
                    }
                ];

                summary.innerHTML = summaryData.map(card => `
                    <div class="teacher-summary-card bg-white border border-slate-200 rounded-3xl p-5 flex flex-col gap-3 shadow-sm">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${card.icon}</span>
                            <div>
                                <p class="text-xs uppercase tracking-wide text-slate-500">${card.label}</p>
                                <p class="text-2xl font-bold text-slate-900">${card.value}</p>
                            </div>
                        </div>
                        <div class="mt-auto">
                            <div class="h-1.5 rounded-full bg-slate-200 overflow-hidden">
                                <div class="h-full bg-gradient-to-r ${card.gradient}"></div>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">${card.description}</p>
                        </div>
                    </div>
                `).join('');
            }

            if (tableBody) {
                tableBody.innerHTML = studentRows.map(row => {
                    const gradeRoom = row.grade ? `${row.grade}${row.room ? `/${row.room}` : ''}` : '-';
                    const progressPercent = Math.min(100, Math.round(((row.latestSession?.currentStep || 1) / 6) * 100));
                    const latestScore = row.latestSession ? Math.round(row.latestSession.totalScore || row.latestSession.comprehensionScore || 0) : 0;
                    const updatedAt = row.latestSession ? new Date(row.latestSession.lastUpdated || row.latestSession.timestamp || Date.now()).toLocaleString('th-TH', {
                        dateStyle: 'short',
                        timeStyle: 'short'
                    }) : '-';
                    const completionBadge = row.completionCount > 0 ? `<span class="px-2 py-1 rounded-full text-xs bg-emerald-100 text-emerald-700">เสร็จ ${row.completionCount} ครั้ง</span>` : `<span class="px-2 py-1 rounded-full text-xs bg-amber-100 text-amber-700">กำลังทำ</span>`;

                    return `
                        <tr class="hover:bg-slate-50 transition-colors">
                            <td class="px-4 py-3" data-label="นักเรียน">
                                <div class="flex flex-col">
                                    <span class="font-semibold text-slate-900">${row.name || 'ไม่ระบุชื่อ'}</span>
                                    <span class="text-xs text-slate-500">${row.studentId || '-'}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-slate-600" data-label="ชั้น/ห้อง">
                                <div class="flex flex-col gap-1">
                                    <span>${gradeRoom}</span>
                                    <span class="text-xs text-slate-500">เลขที่ ${row.number || '-'}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3" data-label="ความคืบหน้า">
                                <div class="flex flex-col gap-1">
                                    <div class="h-2.5 rounded-full bg-slate-200">
                                        <div class="h-full rounded-full bg-gradient-to-r from-blue-500 to-indigo-500" style="width: ${progressPercent}%"></div>
                                    </div>
                                    <div class="flex items-center justify-between text-xs text-slate-500">
                                        <span>${progressPercent}%</span>
                                        ${completionBadge}
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-slate-600" data-label="คะแนนเฉลี่ย">
                                <div class="flex flex-col gap-1">
                                    <span class="font-semibold text-slate-900">${row.averageScore || latestScore}</span>
                                    <span class="text-xs text-slate-500">ล่าสุด ${latestScore}</span>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-slate-600 text-sm" data-label="อัปเดตล่าสุด">${updatedAt}</td>
                        </tr>
                    `;
                }).join('');
            }

            if (tableMeta) {
                tableMeta.textContent = `${studentRows.length} รายการ • อัปเดต ${new Date().toLocaleString('th-TH', { timeStyle: 'short', dateStyle: 'short' })}`;
            }

            if (timeline) {
                const recentActivities = [...sessions]
                    .sort((a, b) => new Date(b.lastUpdated || b.timestamp || 0) - new Date(a.lastUpdated || a.timestamp || 0))
                    .slice(0, 6);

                if (recentActivities.length === 0) {
                    timeline.innerHTML = '<p class="text-sm text-slate-500 text-center">ยังไม่มีกิจกรรมล่าสุด</p>';
                } else {
                    timeline.innerHTML = recentActivities.map(activity => {
                        const activityTime = new Date(activity.lastUpdated || activity.timestamp || Date.now()).toLocaleString('th-TH', {
                            dateStyle: 'short',
                            timeStyle: 'short'
                        });
                        const status = activity.completed ? 'เสร็จสิ้นภารกิจ' : `อยู่ที่ขั้นตอน ${activity.currentStep || '-'}`;
                        const score = activity.totalScore || activity.comprehensionScore || 0;
                        return `
                            <div class="flex flex-col sm:flex-row gap-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-500 text-white flex items-center justify-center text-lg">
                                    📘
                                </div>
                                <div class="flex-1 border-b border-dashed border-slate-200 pb-3">
                                    <div class="flex items-center justify-between">
                                        <p class="font-semibold text-slate-900">${activity.userName || 'นักเรียนไม่ระบุชื่อ'}</p>
                                        <span class="text-xs text-slate-500">${activityTime}</span>
                                    </div>
                                    <p class="text-sm text-slate-600">${status} • คะแนน ${Math.round(score)}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }

            if (timelineMeta) {
                timelineMeta.textContent = `${sessions.length} บันทึกกิจกรรม`;
            }
        }

        async function fetchTeacherData() {
            let students = [];
            let sessions = [];

            try {
                if (db) {
                    const [studentSnapshot, sessionSnapshot] = await Promise.all([
                        db.collection('User').where('isStudent', '==', true).get().catch(() => null),
                        db.collection('gameSessions').get().catch(() => null)
                    ]);

                    if (studentSnapshot) {
                        studentSnapshot.forEach(doc => {
                            students.push({ id: doc.id, ...doc.data() });
                        });
                    }

                    if (sessionSnapshot) {
                        sessionSnapshot.forEach(doc => {
                            sessions.push({ id: doc.id, ...doc.data() });
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading data from Firebase for teacher portal:', error);
            }

            if (students.length === 0) {
                students = loadLocalStudents();
            }

            if (sessions.length === 0) {
                sessions = loadLocalSessions();
            }

            return { students, sessions };
        }

        function loadLocalStudents() {
            const result = [];
            if (typeof localStorage === 'undefined') return result;

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('student_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data) result.push(data);
                    } catch (error) {
                        console.error('Failed to parse local student data', error);
                    }
                }
            }
            return result;
        }

        function loadLocalSessions() {
            const result = [];
            if (typeof localStorage === 'undefined') return result;

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('gameSession_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        if (data) result.push(data);
                    } catch (error) {
                        console.error('Failed to parse local session data', error);
                    }
                }
            }
            return result;
        }

        // Check for existing student login on page load
        window.addEventListener('load', async () => {
            // Try to restore previous student session
            const lastStudentId = localStorage.getItem('lastStudentId');
            if (lastStudentId) {
                try {
                    // Try to load from database first
                    let userData = await loadUserData(lastStudentId);
                    
                    if (userData) {
                        gameState.userId = lastStudentId;
                        gameState.currentUser = userData;
                        
                        // Update player profile
                        playerProfile.exp = userData.exp || 0;
                        playerProfile.rank = userData.rank || 'มือใหม่';
                        playerProfile.level = userData.level || 1;
                        playerProfile.totalGamesPlayed = userData.totalGamesPlayed || 0;
                        playerProfile.bestScore = userData.bestScore || 0;
                        
                        // Update UI
                        if (userData.isGoogle) {
                            updateLoginUI({
                                displayName: userData.name,
                                email: userData.email,
                                photoURL: userData.photoURL,
                                isGoogle: true,
                                userData: userData
                            });
                        } else {
                            updateLoginUI({
                                displayName: userData.name,
                                email: `${userData.grade}/${userData.room} เลขที่ ${userData.number}`,
                                photoURL: '',
                                isStudent: true,
                                studentData: userData
                            });
                        }
                        
                        console.log('User session restored successfully');
                    }
                } catch (error) {
                    console.log('Error restoring user session:', error);
                    localStorage.removeItem('lastStudentId');
                }
            }
        });

        // Navigation Functions
        async function goBack() {
            try {
                // Save current state before going back
                await saveCurrentGameState();
                await saveAllUserAnswers();
                
                if (gameState.stepHistory.length > 0) {
                    const previousStep = gameState.stepHistory.pop();
                    await loadStepData(previousStep);
                    await renderStep(previousStep);
                } else if (gameState.currentStep > 1) {
                    const newStep = gameState.currentStep - 1;
                    await loadStepData(newStep);
                    await renderStep(newStep);
                }
                
                showNotification('ย้อนกลับเรียบร้อย', 'success');
            } catch (error) {
                console.error('Error going back:', error);
                showNotification('เกิดข้อผิดพลาดในการย้อนกลับ', 'error');
            }
        }

        async function goToHome() {
            if (confirm('คุณต้องการกลับไปหน้าหลักหรือไม่? ความคืบหน้าจะถูกบันทึกไว้')) {
                try {
                    // Save current game state with all user data
                    await saveCurrentGameState();
                    await saveAllUserAnswers();
                    
                    // Hide game UI and show landing page
                    showLandingPage();
                    
                    showNotification('กลับสู่หน้าหลักเรียบร้อย ความคืบหน้าถูกบันทึกไว้แล้ว', 'success');
                } catch (error) {
                    console.error('Error going to home:', error);
                    showNotification('เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
                }
            }
        }

        async function resetGame() {
            if (confirm('คุณต้องการเริ่มเกมใหม่หรือไม่? ความคืบหน้าปัจจุบันจะหายไป')) {
                try {
                    // Clear saved game data first
                    if (gameState.gameId) {
                        await clearGameSession(gameState.gameId);
                    }
                    
                    // Reset game state completely
                    gameState.currentStep = 1;
                    gameState.translatedWords = {};
                    gameState.incorrectWords = {};
                    gameState.wordAttempts = {};
                    gameState.imaginationText = '';
                    gameState.interpretationText = '';
                    gameState.comprehensionScore = 0;
                    gameState.startTime = Date.now();
                    gameState.selectedWord = null;
                    gameState.stepHistory = [];
                    gameState.comprehensionAnswers = [];
                    gameState.gameId = generateGameId();
                    
                    // Hide game UI and show landing page
                    showLandingPage();
                    
                    showNotification('เกมถูกรีเซ็ตแล้ว พร้อมเริ่มเกมใหม่!', 'success');
                } catch (error) {
                    console.error('Error resetting game:', error);
                    showNotification('เกิดข้อผิดพลาดในการรีเซ็ตเกม', 'error');
                }
            }
        }

        function showLandingPage() {
            const landingPage = document.getElementById('landingPage');
            const header = document.getElementById('header');
            const mainContent = document.getElementById('mainContent');
            
            if (landingPage) landingPage.classList.remove('hidden');
            if (header) header.classList.add('hidden');
            if (mainContent) mainContent.classList.add('hidden');
            
            // Update background transparency based on login status
            if (landingPage) {
                if (gameState.userId) {
                    landingPage.classList.add('user-logged-in');
                } else {
                    landingPage.classList.remove('user-logged-in');
                }
            }
            
            // Make sure start button is enabled if user is logged in
            const startGameBtn = document.getElementById('startGameBtn');
            if (startGameBtn && gameState.userId) {
                startGameBtn.disabled = false;
            }
        }

        function generateGameId() {
            return `game_${gameState.userId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        async function saveCurrentGameState() {
            const currentGameData = {
                currentStep: gameState.currentStep,
                translatedWords: gameState.translatedWords,
                incorrectWords: gameState.incorrectWords,
                wordAttempts: gameState.wordAttempts,
                imaginationText: gameState.imaginationText,
                interpretationText: gameState.interpretationText,
                comprehensionScore: gameState.comprehensionScore,
                startTime: gameState.startTime,
                stepHistory: gameState.stepHistory,
                comprehensionAnswers: gameState.comprehensionAnswers || [],
                matchingScore: gameState.matchingScore || 0,
                matchedPairs: gameState.matchedPairs || 0
            };
            
            await saveGameSession(currentGameData);
        }

        async function loadStepData(step) {
            try {
                if (gameState.gameId) {
                    const savedData = await loadGameSession(gameState.gameId);
                    if (savedData) {
                        // Restore data without changing current step
                        gameState.translatedWords = savedData.translatedWords || {};
                        gameState.incorrectWords = savedData.incorrectWords || {};
                        gameState.wordAttempts = savedData.wordAttempts || {};
                        gameState.imaginationText = savedData.imaginationText || '';
                        gameState.interpretationText = savedData.interpretationText || '';
                        gameState.comprehensionScore = savedData.comprehensionScore || 0;
                        gameState.comprehensionAnswers = savedData.comprehensionAnswers || [];
                        gameState.startTime = savedData.startTime || Date.now();
                        gameState.matchingScore = savedData.matchingScore || 0;
                        gameState.matchedPairs = savedData.matchedPairs || 0;
                        
                        // Update UI to reflect loaded data
                        setTimeout(() => {
                            updateWordStatesFromData();
                            updateWordCounts();
                            
                            // Update matching game UI if on matching step
                            if (step === 2.5 && gameState.matchingScore !== undefined) {
                                const scoreElement = document.getElementById('matchingScore');
                                if (scoreElement) {
                                    scoreElement.textContent = gameState.matchingScore;
                                }
                            }
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Error loading step data:', error);
            }
        }

        // Update word states from loaded data
        function updateWordStatesFromData() {
            // Update correct words
            Object.keys(gameState.translatedWords).forEach(word => {
                const wordElement = document.querySelector(`[data-word="${word}"]`);
                if (wordElement) {
                    wordElement.className = 'word-correct';
                }
            });
            
            // Update incorrect words and show hint images if needed
            Object.keys(gameState.incorrectWords).forEach(word => {
                const wordElement = document.querySelector(`[data-word="${word}"]`);
                if (wordElement) {
                    wordElement.className = 'word-incorrect';
                    
                    // Show hint image if attempted 2+ times
                    const attempts = gameState.wordAttempts[word] || 0;
                    if (attempts >= 2 && !wordElement.parentElement.querySelector('.hint-image')) {
                        const hintImageContainer = document.createElement('div');
                        hintImageContainer.className = 'absolute z-10 hint-image';
                        hintImageContainer.style.cssText = `
                            top: -80px;
                            left: 50%;
                            transform: translateX(-50%);
                            pointer-events: none;
                        `;
                        hintImageContainer.innerHTML = `
                            <div class="relative">
                                <img src="${getWordImage(word)}" alt="ใบ้สำหรับ ${word}" 
                                     class="w-16 h-16 md:w-20 md:h-20 rounded-xl border-4 border-yellow-400 object-cover shadow-2xl animate-pulse bg-white p-1">
                                <div class="absolute -top-2 -right-2 w-6 h-6 bg-yellow-400 rounded-full flex items-center justify-center text-xs font-bold text-yellow-900">💡</div>
                            </div>
                        `;
                        wordElement.parentElement.style.position = 'relative';
                        wordElement.parentElement.appendChild(hintImageContainer);
                    }
                }
            });
        }

        async function clearGameSession(gameId) {
            try {
                if (db) {
                    await db.collection('gameSessions').doc(gameId).delete();
                } else {
                    localStorage.removeItem(`gameSession_${gameId}`);
                }
            } catch (error) {
                console.error('Error clearing game session:', error);
                localStorage.removeItem(`gameSession_${gameId}`);
            }
        }

        // Start Game Function
        async function startGame() {
            // Check if user is logged in
            if (!gameState.userId || !gameState.currentUser) {
                showNotification('กรุณาลงทะเบียนหรือเข้าสู่ระบบก่อนเริ่มเกม', 'error');
                return;
            }
            
            // Try to load the most recent game session for this user
            try {
                // Look for existing game sessions
                let savedGame = null;
                
                if (db) {
                    // Query Firebase for the most recent game session
                    const gamesQuery = await db.collection('gameSessions')
                        .where('userId', '==', gameState.userId)
                        .orderBy('lastUpdated', 'desc')
                        .limit(1)
                        .get();
                    
                    if (!gamesQuery.empty) {
                        const gameDoc = gamesQuery.docs[0];
                        savedGame = gameDoc.data();
                        gameState.gameId = gameDoc.id;
                        console.log('Found saved game in Firebase:', gameDoc.id);
                    }
                } else {
                    // Fallback: check localStorage for saved games
                    const keys = Object.keys(localStorage);
                    const gameKeys = keys.filter(key => key.startsWith('gameSession_') && key.includes(gameState.userId));
                    
                    if (gameKeys.length > 0) {
                        // Get the most recent game
                        const mostRecentKey = gameKeys.sort().pop();
                        savedGame = JSON.parse(localStorage.getItem(mostRecentKey));
                        gameState.gameId = mostRecentKey.replace('gameSession_', '');
                        console.log('Found saved game in localStorage:', mostRecentKey);
                    }
                }
                
                if (savedGame && savedGame.currentStep > 1) {
                    // Restore saved game state
                    gameState.currentStep = savedGame.currentStep;
                    gameState.translatedWords = savedGame.translatedWords || {};
                    gameState.incorrectWords = savedGame.incorrectWords || {};
                    gameState.wordAttempts = savedGame.wordAttempts || {};
                    gameState.imaginationText = savedGame.imaginationText || '';
                    gameState.interpretationText = savedGame.interpretationText || '';
                    gameState.comprehensionScore = savedGame.comprehensionScore || 0;
                    gameState.comprehensionAnswers = savedGame.comprehensionAnswers || [];
                    gameState.startTime = savedGame.startTime || Date.now();
                    gameState.stepHistory = savedGame.stepHistory || [];
                    gameState.matchingScore = savedGame.matchingScore || 0;
                    gameState.matchedPairs = savedGame.matchedPairs || 0;
                    
                    showNotification(`โหลดเกมที่บันทึกไว้เรียบร้อย! (ขั้นตอนที่ ${savedGame.currentStep})`, 'success');
                } else {
                    // Start fresh game
                    gameState.gameId = generateGameId();
                    gameState.currentStep = 1;
                    gameState.startTime = Date.now();
                    showNotification('เริ่มเกมใหม่!', 'success');
                }
                
            } catch (error) {
                console.error('Error loading saved game:', error);
                // Start fresh if loading fails
                gameState.gameId = generateGameId();
                gameState.currentStep = 1;
                gameState.startTime = Date.now();
                showNotification('เริ่มเกมใหม่!', 'success');
            }
            
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('header').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            updatePlayerProfile();
            updateProgress();
            updateUserNameDisplay();
            await renderStep(gameState.currentStep);
        }

        // Update Progress
        function updateProgress() {
            const totalSteps = 6;
            const currentProgress = ((gameState.currentStep - 1) / (totalSteps - 1)) * 100;
            
            document.getElementById('mainProgressFill').style.width = currentProgress + '%';
            document.getElementById('progressText').textContent = Math.round(currentProgress) + '%';
        }

        // Calculate Level and EXP
        function calculateLevel(exp) {
            const level = Math.floor(exp / 100) + 1;
            const expInCurrentLevel = exp % 100;
            const expToNextLevel = 100 - expInCurrentLevel;
            
            return {
                level: level,
                expInCurrentLevel: expInCurrentLevel,
                expToNextLevel: expToNextLevel
            };
        }

        // Update Player Profile Display
        function updatePlayerProfile() {
            document.getElementById('playerExp').textContent = playerProfile.exp;
            document.getElementById('playerRank').textContent = playerProfile.rank;
            
            // Calculate level
            const levelInfo = calculateLevel(playerProfile.exp);
            playerProfile.level = levelInfo.level;
            playerProfile.expToNextLevel = levelInfo.expToNextLevel;
            
            // Update rank based on EXP and level
            if (playerProfile.level >= 10) playerProfile.rank = 'นักสืบเซียน';
            else if (playerProfile.level >= 5) playerProfile.rank = 'นักสืบชำนาญ';
            else if (playerProfile.level >= 2) playerProfile.rank = 'นักสืบฝึกหัด';
            else playerProfile.rank = 'มือใหม่';
            
            saveUserDataAsync();
        }

        // Save User Data (Async)
        async function saveUserDataAsync() {
            if (gameState.currentUser && gameState.userId) {
                const updatedUserData = {
                    ...gameState.currentUser,
                    exp: playerProfile.exp,
                    rank: playerProfile.rank,
                    level: playerProfile.level,
                    totalGamesPlayed: playerProfile.totalGamesPlayed,
                    bestScore: playerProfile.bestScore,
                    lastPlayed: new Date().toISOString()
                };
                
                await saveUserData(updatedUserData);
                gameState.currentUser = updatedUserData;
            }
        }

        // Render Step Content
        async function renderStep(step) {
            // Save current step to history (except when going back)
            if (step > gameState.currentStep) {
                gameState.stepHistory.push(gameState.currentStep);
            }
            
            gameState.currentStep = step;
            updateStepIndicators();
            updateProgress();
            updateBackButton();
            
            // Auto-save progress
            saveCurrentGameState();
            
            const mainContent = document.getElementById('mainContent');
            const mission = MISSION_DATA.MISSION_01;
            
            switch(step) {
                case 1:
                    mainContent.innerHTML = `
                        <div class="modern-card rounded-3xl p-6 md:p-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                    📚 ${mission.historicalBackground.title}
                                </h2>
                                <span class="badge-modern">หน้าที่ 1</span>
                            </div>
                            
                            <div class="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-200 p-4 rounded-xl mb-6">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xl">📚</span>
                                    <h4 class="text-lg font-bold text-amber-900">จุดประสงค์การเรียนรู้</h4>
                                </div>
                                <p class="text-amber-800">หน้านี้เป็นการศึกษาประวัติศาสตร์เบื้องหลังของโคลงสี่สุภาพ เพื่อให้เข้าใจบริบทและความสำคัญของเหตุการณ์ก่อนเข้าสู่การศึกษาโคลง</p>
                            </div>
                            
                            <div class="mb-8">
                                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-2xl p-6 mb-6">
                                    <div class="flex items-center gap-3 mb-4">
                                        <span class="text-3xl">📖</span>
                                        <h3 class="text-xl font-bold text-blue-900">ความรู้พื้นฐาน</h3>
                                    </div>
                                    <p class="text-blue-800 text-lg">อ่านประวัติศาสตร์เพื่อเตรียมความพร้อมก่อนศึกษาโคลง</p>
                                </div>
                                
                                ${mission.historicalBackground.content}
                            </div>
                            
                            <div class="text-center space-y-4">
                                <button id="proceedToPoem" class="modern-button px-8 py-4 text-xl rounded-2xl">
                                    ➡️ ไปดูโคลงสี่สุภาพ
                                </button>
                                
                                <!-- Quick Navigation -->
                                <div class="mt-6">
                                    <p class="text-gray-600 mb-4">หรือข้ามไปหน้าอื่น:</p>
                                    <div class="flex flex-wrap justify-center gap-3">
                                        <button onclick="goToStep(2)" class="modern-button px-4 py-2 text-sm rounded-xl bg-blue-500 hover:bg-blue-600">📖 โคลง</button>
                                        <button onclick="goToStep(3)" class="modern-button px-4 py-2 text-sm rounded-xl bg-purple-500 hover:bg-purple-600">✍️ เขียน</button>
                                        <button onclick="goToStep(4)" class="modern-button px-4 py-2 text-sm rounded-xl bg-green-500 hover:bg-green-600">🖼️ ภาพ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('proceedToPoem').addEventListener('click', async () => {
                        await renderStep(2);
                    });
                    break;
                    
                case 2.5:
                    // Matching Game Step
                    mainContent.innerHTML = `
                        <div class="modern-card rounded-3xl p-4 md:p-10 mt-4 md:mt-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 gap-4">
                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                    🎯 จับคู่คำศัพท์
                                </h2>
                                <span class="badge-modern">เกมพิเศษ</span>
                            </div>
                            
                            <div class="bg-gradient-to-r from-teal-50 to-cyan-50 border-2 border-teal-200 p-3 md:p-4 rounded-xl mb-6">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xl">🎯</span>
                                    <h4 class="text-base md:text-lg font-bold text-teal-900">จุดประสงค์การเรียนรู้</h4>
                                </div>
                                <p class="text-teal-800 text-sm md:text-base">เกมจับคู่คำศัพท์กับความหมาย เพื่อทบทวนและเสริมสร้างความจำ</p>
                            </div>
                            
                            <!-- Score Display -->
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-4 rounded-xl mb-6 text-center">
                                <h3 class="text-lg font-bold text-blue-900 mb-2">คะแนน</h3>
                                <div class="text-3xl font-bold text-blue-600" id="matchingScore">0</div>
                                <div class="text-sm text-blue-700">จาก ${Object.keys(MISSION_DATA.MISSION_01.hardWords).length} คู่</div>
                            </div>
                            
                            <!-- Matching Game -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                <!-- Words Column -->
                                <div class="bg-gradient-to-br from-red-50 to-pink-50 border-2 border-red-200 p-4 rounded-xl">
                                    <h3 class="text-lg font-bold text-red-900 mb-4 text-center">🔤 คำศัพท์</h3>
                                    <div id="wordsColumn" class="grid grid-cols-3 gap-3">
                                        ${Object.keys(MISSION_DATA.MISSION_01.hardWords).map((word, index) => `
                                            <div class="word-item bg-gradient-to-r from-red-400 to-red-500 text-white border-2 border-red-600 p-3 rounded-xl cursor-pointer hover:from-red-500 hover:to-red-600 transition-all duration-200 text-center font-bold shadow-lg" 
                                                 data-word="${word}" draggable="true">
                                                <div class="flex flex-col items-center justify-center gap-2">
                                                    <img src="${getWordImage(word)}" alt="${word}" class="w-16 h-16 md:w-20 md:h-20 rounded-lg border-2 border-white object-cover shadow-md">
                                                    <span class="text-sm">${word}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <!-- Meanings Column -->
                                <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 p-4 rounded-xl">
                                    <h3 class="text-lg font-bold text-green-900 mb-4 text-center">💭 ความหมาย</h3>
                                    <div id="meaningsColumn" class="grid grid-cols-3 gap-3">
                                        ${Object.entries(MISSION_DATA.MISSION_01.hardWords).sort(() => Math.random() - 0.5).map(([word, data]) => `
                                            <div class="meaning-item bg-white border-2 border-green-300 p-3 rounded-xl min-h-[80px] flex items-center justify-center text-center text-green-800 border-dashed hover:bg-green-50 transition-all duration-200" 
                                                 data-word="${word}">
                                                <span class="font-semibold text-sm">${data.meaning.split(',')[0].trim()}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Instructions -->
                            <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-200 p-4 rounded-xl mb-6">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xl">📋</span>
                                    <h4 class="font-bold text-yellow-900">วิธีเล่น</h4>
                                </div>
                                <p class="text-yellow-800">ลากคำศัพท์จากด้านซ้ายไปวางบนความหมายที่ถูกต้องด้านขวา หรือคลิกคำศัพท์แล้วคลิกความหมาย</p>
                            </div>
                            
                            <div class="flex flex-col md:flex-row justify-center gap-4 mt-6 md:mt-10">
                                <button onclick="goBack()" class="modern-button px-6 md:px-8 py-3 md:py-4 text-lg md:text-xl rounded-2xl bg-gray-500 hover:bg-gray-600 w-full md:w-auto">
                                    ← ย้อนกลับ
                                </button>
                                <button id="resetMatching" class="modern-button px-6 md:px-8 py-3 md:py-4 text-lg md:text-xl rounded-2xl bg-orange-500 hover:bg-orange-600 w-full md:w-auto">
                                    🔄 เริ่มใหม่
                                </button>
                                <button id="finishMatching" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl w-full md:w-auto" disabled>
                                    ➡️ ไปขั้นตอนถัดไป
                                </button>
                            </div>
                        </div>
                    `;
                    setupMatchingGame();
                    break;
                    
                case 2:
                    mainContent.innerHTML = `
                        <div class="modern-card rounded-3xl p-6 md:p-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                    📜 โคลงสี่สุภาพ - พระราชพงศาวดาร
                                </h2>
                                <span class="badge-modern">หน้าที่ 2</span>
                            </div>
                            
                            <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 p-4 rounded-xl mb-6">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xl">📖</span>
                                    <h4 class="text-lg font-bold text-purple-900">จุดประสงค์การเรียนรู้</h4>
                                </div>
                                <p class="text-purple-800">หน้านี้เป็นการศึกษาโคลงสี่สุภาพและค้นหาความหมายของคำศัพท์ยาก เพื่อฝึกทักษะการสืบค้นข้อมูลและเข้าใจความหมายของวรรณคดี</p>
                            </div>
                            
                            <div class="poem-container p-6 mb-6">
                                <div class="mb-4">
                                    <span class="badge-modern">โคลงสี่สุภาพ</span>
                                </div>
                                <div class="poem-text text-gray-800">
                                    ${mission.poem}
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-4 rounded-2xl mb-6">
                                <h3 class="text-lg font-bold text-blue-900 mb-3">🎯 คำสั่ง</h3>
                                <p class="text-blue-800 font-semibold">👆 คลิกคำศัพท์สีน้ำเงินในโคลง แล้วค้นหาความหมายให้ครบทั้ง ${Object.keys(mission.hardWords).length} คำ</p>
                            </div>
                            
                            <!-- Progress Cards -->
                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <div class="modern-card rounded-xl p-4 text-center">
                                    <p class="text-gray-600 text-sm mb-2">เป้าหมาย</p>
                                    <p class="text-xl font-bold text-blue-600">${Object.keys(mission.hardWords).length} คำ</p>
                                    <div class="progress-bar mt-3 bg-gray-200 h-3">
                                        <div id="wordProgress" class="progress-fill h-3" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="modern-card rounded-xl p-4 text-center">
                                    <p class="text-gray-600 text-sm mb-2">ค้นพบแล้ว</p>
                                    <p class="text-xl font-bold text-green-600"><span id="foundWords">0</span> คำ</p>
                                </div>
                                <div class="modern-card rounded-xl p-4 text-center">
                                    <p class="text-gray-600 text-sm mb-2">คำตอบผิด</p>
                                    <p class="text-xl font-bold text-red-600"><span id="incorrectWords">0</span> คำ</p>
                                </div>
                            </div>
                            
                            <!-- Dictionary Tools -->
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-2xl p-6 mb-6">
                                <div class="text-center">
                                    <div class="text-5xl mb-4">📚</div>
                                    <h3 class="text-xl font-bold text-blue-900 mb-4">เครื่องมือค้นหาความหมาย</h3>
                                    <p class="text-blue-800 text-center mb-6">เลือกเครื่องมือที่ต้องการใช้ค้นหาความหมายคำศัพท์</p>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <button onclick="openDictionaryNewTab()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center justify-center gap-3">
                                            <span class="text-2xl">📖</span>
                                            <span>พจนานุกรมราชบัณฑิตยสถาน</span>
                                        </button>
                                        <button onclick="showKloangInfo()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center justify-center gap-3">
                                            <span class="text-2xl">📋</span>
                                            <span>ฉันทลักษณ์โคลงสี่สุภาพ</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Next Button (Hidden initially) -->
                            <div class="text-center space-y-4">
                                <button id="nextToMatching" class="modern-button px-8 py-4 text-xl rounded-2xl hidden" onclick="showMatchingGame()">
                                    🎯 ไปจับคู่คำศัพท์
                                </button>
                                
                                <!-- Quick Navigation -->
                                <div class="mt-6">
                                    <p class="text-gray-600 mb-4">หรือข้ามไปหน้าอื่น:</p>
                                    <div class="flex flex-wrap justify-center gap-3">
                                        <button onclick="goToStep(1)" class="modern-button px-4 py-2 text-sm rounded-xl bg-amber-500 hover:bg-amber-600">📚 ประวัติ</button>
                                        <button onclick="goToStep(3)" class="modern-button px-4 py-2 text-sm rounded-xl bg-purple-500 hover:bg-purple-600">✍️ เขียน</button>
                                        <button onclick="goToStep(4)" class="modern-button px-4 py-2 text-sm rounded-xl bg-green-500 hover:bg-green-600">🖼️ ภาพ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    attachWordClickHandlers();
                    // Load saved data and update UI
                    setTimeout(() => {
                        updateWordStatesFromData();
                        updateWordCounts();
                        checkAllWordsFound();
                    }, 100);
                    break;
                    
                case 3:
                    mainContent.innerHTML = `
                        <!-- Poem Display -->
                        <div class="modern-card rounded-3xl p-4 md:p-6 mb-6">
                            <div class="poem-container p-4 md:p-6">
                                <div class="mb-4">
                                    <span class="badge-modern">โคลงสี่สุภาพ - อ้างอิง</span>
                                </div>
                                <div class="poem-text text-gray-800 max-w-4xl mx-auto text-base md:text-lg">
                                    ${mission.poem}
                                </div>
                            </div>
                        </div>
                        
                        <div class="modern-card rounded-3xl p-4 md:p-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                    📝 ถอดความและจินตนาการ
                                </h2>
                                <span class="badge-modern">หน้าที่ 3</span>
                            </div>
                            
                            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 border-2 border-indigo-200 p-4 rounded-xl mb-6">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xl">✍️</span>
                                    <h4 class="text-lg font-bold text-indigo-900">จุดประสงค์การเรียนรู้</h4>
                                </div>
                                <p class="text-indigo-800">หน้านี้เป็นการฝึกทักษะการถอดความและการใช้จินตนาการ เพื่อให้เข้าใจเนื้อหาของโคลงและสามารถสื่อสารด้วยภาษาของตนเอง</p>
                            </div>
                            
                            <!-- Interpretation Section -->
                            <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 p-6 rounded-2xl mb-6">
                                <h3 class="text-xl font-bold text-green-900 mb-4">📝 ถอดความ</h3>
                                <p class="text-green-800 mb-4">ถอดความโคลงเป็นร้อยแก้วด้วยภาษาของคุณเอง</p>
                                <textarea id="interpretationInput" class="w-full h-48 modern-input p-4 text-base resize-none" placeholder="ถอดความโคลงเป็นร้อยแก้วด้วยภาษาของคุณเอง...&#10;&#10;เช่น: สมเด็จพระสุริโยทัยทรงเป็นพระมเหสีที่งดงาม ทรงมีจิตใจที่กตัญญูต่อพระราชสามี..."></textarea>
                            </div>
                            
                            <!-- Imagination Section -->
                            <div class="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 p-6 rounded-2xl mb-6">
                                <h3 class="text-xl font-bold text-purple-900 mb-4">🎨 จินตนาการภาพ</h3>
                                <p class="text-purple-800 mb-4">บรรยายภาพที่เกิดขึ้นในจินตนาการของคุณจากโคลงนี้</p>
                                <textarea id="imaginationInput" class="w-full h-40 modern-input p-4 text-base resize-none" placeholder="🖼️ วาดภาพด้วยคำพูด... อธิบายสิ่งที่คุณเห็นในใจ&#10;&#10;เช่น: ฉันเห็นภาพสมเด็จพระสุริโยทัยทรงขี่ช้างสีขาวขนาดใหญ่ ในท่ามกลางสนามรบที่เต็มไปด้วยควัน..."></textarea>
                            </div>
                            
                            <div class="text-center space-y-4">
                                <div class="flex flex-col md:flex-row justify-center gap-4">
                                    <button onclick="goBack()" class="modern-button px-6 py-3 text-lg rounded-2xl bg-gray-500 hover:bg-gray-600 w-full md:w-auto">
                                        ← ย้อนกลับ
                                    </button>
                                    <button id="nextStep3" class="modern-button px-8 py-3 text-lg disabled:opacity-50 disabled:cursor-not-allowed rounded-2xl w-full md:w-auto" disabled>
                                        ➡️ ไปขั้นตอนถัดไป
                                    </button>
                                </div>
                                
                                <!-- Quick Navigation -->
                                <div class="mt-6">
                                    <p class="text-gray-600 mb-4">หรือข้ามไปหน้าอื่น:</p>
                                    <div class="flex flex-wrap justify-center gap-3">
                                        <button onclick="goToStep(1)" class="modern-button px-4 py-2 text-sm rounded-xl bg-amber-500 hover:bg-amber-600">📚 ประวัติ</button>
                                        <button onclick="goToStep(2)" class="modern-button px-4 py-2 text-sm rounded-xl bg-blue-500 hover:bg-blue-600">📖 โคลง</button>
                                        <button onclick="goToStep(4)" class="modern-button px-4 py-2 text-sm rounded-xl bg-green-500 hover:bg-green-600">🖼️ ภาพ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    setupStep3Handlers();
                    break;
                    
                case 4:
                    mainContent.innerHTML = `
                        <div class="modern-card rounded-3xl p-6 md:p-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                    🖼️ เปิดเผยภาพจริง
                                </h2>
                                <span class="badge-modern">หน้าที่ 4</span>
                            </div>
                            
                            <div class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200 p-4 rounded-xl mb-6">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xl">🖼️</span>
                                    <h4 class="text-lg font-bold text-orange-900">จุดประสงค์การเรียนรู้</h4>
                                </div>
                                <p class="text-orange-800">หน้านี้เป็นการเปรียบเทียบจินตนาการของผู้เรียนกับข้อมูลประวัติศาสตร์จริง เพื่อให้เห็นความแตกต่างและความเชื่อมโยงระหว่างวรรณคดีกับประวัติศาสตร์</p>
                            </div>
                            
                            <!-- Historical Image -->
                            <div class="text-center mb-8">
                                <h3 class="text-xl font-bold text-blue-900 mb-6">ภาพจริงจากประวัติศาสตร์</h3>
                                <div class="relative max-w-4xl mx-auto">
                                    <div class="relative cursor-pointer" id="imageContainer">
                                        <img id="historicalImage" src="${mission.officialImageURL}" alt="ภาพการต่อสู้ของสมเด็จพระสุริโยทัย" class="w-full aspect-video object-cover rounded-2xl border-2 border-gray-300 shadow-xl blur-lg transition-all duration-1000" onerror="this.src=''; this.alt='ไม่สามารถโหลดภาพได้'; this.style.display='none';">
                                        <div id="imageOverlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded-2xl transition-opacity duration-1000">
                                            <div class="text-white text-center">
                                                <div class="text-4xl mb-2 animate-bounce">👆</div>
                                                <p class="text-lg font-bold">คลิกหรือลูบเพื่อเปิดเผยภาพ</p>
                                                <p class="text-sm mt-2 opacity-75">ลากเมาส์หรือนิ้วบนภาพ</p>
                                            </div>
                                        </div>
                                        <canvas id="revealCanvas" class="absolute inset-0 w-full h-full rounded-2xl pointer-events-none opacity-0"></canvas>
                                    </div>
                                </div>
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 p-6 rounded-2xl mt-6 max-w-4xl mx-auto">
                                    <p class="text-blue-800 text-lg italic">${mission.officialImageDescription}</p>
                                </div>
                            </div>
                            
                            <!-- Comparison Button -->
                            <div class="text-center mb-8">
                                <button id="showComparison" class="modern-button px-8 py-4 text-xl rounded-2xl bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600">
                                    💡 ความจริงก็คือ...
                                </button>
                            </div>
                            
                            <!-- Comparison Section (Hidden initially) -->
                            <div id="comparisonSection" class="hidden mb-8">
                                <h3 class="text-xl font-bold text-purple-900 mb-6">เทียบภาพกับความจริง</h3>
                                
                                <div class="space-y-6">
                                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 p-6 rounded-2xl">
                                        <h4 class="font-bold text-purple-800 mb-4 text-lg">🎨 ที่คุณจินตนาการไว้:</h4>
                                        <p class="text-purple-700 text-lg leading-relaxed">${gameState.imaginationText}</p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 p-6 rounded-2xl">
                                        <h4 class="font-bold text-green-800 mb-4 text-lg">📝 ที่คุณถอดความได้:</h4>
                                        <p class="text-green-700 text-lg leading-relaxed">${gameState.interpretationText}</p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 p-6 rounded-2xl">
                                        <h4 class="font-bold text-blue-800 mb-4 text-lg">📚 ถอดความที่ถูกต้อง:</h4>
                                        <p class="text-blue-700 text-lg leading-relaxed">${mission.correctInterpretation}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center space-y-4">
                                <div class="flex flex-col md:flex-row justify-center gap-4">
                                    <button onclick="goBack()" class="modern-button px-6 py-3 text-lg rounded-2xl bg-gray-500 hover:bg-gray-600 w-full md:w-auto">
                                        ← ย้อนกลับ
                                    </button>
                                    <button id="nextStep4" class="modern-button px-8 py-3 text-lg rounded-2xl w-full md:w-auto">
                                        ➡️ ไปขั้นตอนทบทวน
                                    </button>
                                </div>
                                
                                <!-- Quick Navigation -->
                                <div class="mt-6">
                                    <p class="text-gray-600 mb-4">หรือข้ามไปหน้าอื่น:</p>
                                    <div class="flex flex-wrap justify-center gap-3">
                                        <button onclick="goToStep(1)" class="modern-button px-4 py-2 text-sm rounded-xl bg-amber-500 hover:bg-amber-600">📚 ประวัติ</button>
                                        <button onclick="goToStep(2)" class="modern-button px-4 py-2 text-sm rounded-xl bg-blue-500 hover:bg-blue-600">📖 โคลง</button>
                                        <button onclick="goToStep(3)" class="modern-button px-4 py-2 text-sm rounded-xl bg-purple-500 hover:bg-purple-600">✍️ เขียน</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    setupStep4Handlers();
                    // Setup image reveal effect
                    setTimeout(setupImageReveal, 100);
                    break;
                    
                case 5:
                    mainContent.innerHTML = `
                        <div class="modern-card rounded-3xl p-4 md:p-10 mt-4 md:mt-8">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 md:mb-8 gap-4">
                                <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
                                    📝 ทบทวนความรู้
                                </h2>
                                <span class="badge-modern">หน้าที่ 5</span>
                            </div>
                            
                            <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 p-3 md:p-4 rounded-xl mb-6">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xl">📝</span>
                                    <h4 class="text-base md:text-lg font-bold text-indigo-900">จุดประสงค์การเรียนรู้</h4>
                                </div>
                                <p class="text-indigo-800 text-sm md:text-base">ทดสอบความเข้าใจเกี่ยวกับคำศัพท์และเนื้อหาของโคลงสี่สุภาพ</p>
                            </div>
                            
                            <!-- Score Display -->
                            <div class="bg-gradient-to-r from-blue-50 to-green-50 border-2 border-blue-200 p-4 rounded-xl mb-6 text-center">
                                <h3 class="text-lg font-bold text-blue-900 mb-2">คะแนน</h3>
                                <div class="text-3xl font-bold text-blue-600" id="quizScore">0</div>
                                <div class="text-sm text-blue-700">จาก ${mission.comprehensionQuestions.length} ข้อ</div>
                            </div>
                            
                            <!-- Quiz Questions -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                ${mission.comprehensionQuestions.map((q, index) => `
                                    <div class="bg-gradient-to-br from-white to-gray-50 border-2 border-gray-200 p-4 rounded-xl">
                                        <h4 class="font-bold text-gray-900 mb-3">ข้อ ${index + 1}. ${q.question}</h4>
                                        <div class="space-y-2">
                                            ${q.options.map((option, optIndex) => `
                                                <label class="flex items-center p-2 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors duration-200">
                                                    <input type="radio" name="question_${index}" value="${optIndex}" class="mr-3 text-blue-600">
                                                    <span class="text-gray-700">${option}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                        <div id="result_${index}" class="mt-3 hidden"></div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="flex flex-col md:flex-row justify-center gap-4 mt-6 md:mt-10">
                                <button onclick="goBack()" class="modern-button px-6 md:px-8 py-3 md:py-4 text-lg md:text-xl rounded-2xl bg-gray-500 hover:bg-gray-600 w-full md:w-auto">
                                    ← ย้อนกลับ
                                </button>
                                <button id="checkAnswers" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl w-full md:w-auto" onclick="checkQuizAnswers()">
                                    ✅ ตรวจคำตอบ
                                </button>
                                <button id="retryQuiz" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl w-full md:w-auto bg-orange-500 hover:bg-orange-600 hidden" onclick="retryQuiz()">
                                    🔄 ทำใหม่
                                </button>
                                <button id="finishQuiz" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl w-full md:w-auto hidden" onclick="finishQuiz()">
                                    ➡️ เสร็จสิ้น
                                </button>
                            </div>
                        </div>
                    `;
                    setupQuiz();
                    break;
                    
                case 6:
                    const finalScore = await calculateFinalScore();
                    updatePlayerProfile();
                    mainContent.innerHTML = `
                        <div class="modern-card rounded-3xl p-4 md:p-10 mt-4 md:mt-8">
                            <div class="text-center mb-6 md:mb-10">
                                <div class="text-6xl md:text-8xl mb-4 md:mb-6">🎉</div>
                                <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">สรุปผลการเล่น</h2>
                                <p class="text-gray-600 text-lg md:text-xl">คุณได้เรียนรู้วรรณคดีไทยเรียบร้อยแล้ว!</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-10">
                                <div class="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200 p-4 md:p-8 rounded-2xl">
                                    <h3 class="text-xl md:text-2xl font-bold text-blue-900 mb-4 md:mb-6">📊 คะแนนรวม</h3>
                                    <div class="text-4xl md:text-5xl font-bold text-blue-600 mb-4 md:mb-6">${finalScore.total} คะแนน</div>
                                    <div class="space-y-2 md:space-y-3">
                                        <div class="flex justify-between text-base md:text-lg">
                                            <span>คำศัพท์:</span>
                                            <span class="text-green-600 font-bold">+${finalScore.vocabulary}</span>
                                        </div>
                                        <div class="flex justify-between text-base md:text-lg">
                                            <span>ความเข้าใจ:</span>
                                            <span class="text-green-600 font-bold">+${finalScore.comprehension}</span>
                                        </div>
                                        <div class="flex justify-between text-base md:text-lg">
                                            <span>โบนัสเวลา:</span>
                                            <span class="text-green-600 font-bold">+${finalScore.timeBonus}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-br from-green-50 to-yellow-50 border-2 border-green-200 p-4 md:p-8 rounded-2xl">
                                    <h3 class="text-xl md:text-2xl font-bold text-green-900 mb-4 md:mb-6">👤 ข้อมูลผู้เล่น</h3>
                                    <div class="space-y-3 md:space-y-4">
                                        <div class="flex justify-between items-center text-base md:text-lg">
                                            <span>EXP รวม:</span>
                                            <span class="text-2xl md:text-3xl font-bold text-yellow-600">${playerProfile.exp}</span>
                                        </div>
                                        <div class="flex justify-between items-center text-base md:text-lg">
                                            <span>เลเวล:</span>
                                            <span class="text-xl md:text-2xl font-bold text-blue-600">Lv.${playerProfile.level}</span>
                                        </div>
                                        <div class="flex justify-between items-center text-base md:text-lg">
                                            <span>อันดับ:</span>
                                            <span class="badge-modern">${playerProfile.rank}</span>
                                        </div>
                                        <div class="flex justify-between text-base md:text-lg">
                                            <span>เกมที่เล่น:</span>
                                            <span class="text-gray-600 font-semibold">${playerProfile.totalGamesPlayed}</span>
                                        </div>
                                        <div class="flex justify-between text-base md:text-lg">
                                            <span>คะแนนสูงสุด:</span>
                                            <span class="text-purple-600 font-semibold">${playerProfile.bestScore}</span>
                                        </div>
                                        <div class="mt-4">
                                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                                <span>ความคืบหน้าเลเวลถัดไป</span>
                                                <span>${100 - playerProfile.expToNextLevel}/100 EXP</span>
                                            </div>
                                            <div class="progress-bar bg-gray-200">
                                                <div class="progress-fill" style="width: ${((100 - playerProfile.expToNextLevel) / 100) * 100}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-6 md:mt-10 space-y-4">
                                <button onclick="showCertificate()" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 w-full md:w-auto">
                                    🏆 แสดงเกียรติบัตร
                                </button>
                            </div>
                            
                            <!-- Navigation Back to Sections -->
                            <div class="mt-8 md:mt-12">
                                <h3 class="text-xl md:text-2xl font-bold text-gray-900 mb-6 text-center">เลือกหน้าที่ต้องการดู</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <button onclick="goToStep(1)" class="modern-button px-4 py-3 text-sm md:text-base rounded-xl bg-amber-500 hover:bg-amber-600 flex flex-col items-center gap-2">
                                        <span class="text-2xl">📚</span>
                                        <span>ประวัติศาสตร์</span>
                                        <span class="text-xs opacity-75">คะแนน: -</span>
                                    </button>
                                    <button onclick="goToStep(2)" class="modern-button px-4 py-3 text-sm md:text-base rounded-xl bg-blue-500 hover:bg-blue-600 flex flex-col items-center gap-2">
                                        <span class="text-2xl">📖</span>
                                        <span>แสดงโคลง</span>
                                        <span class="text-xs opacity-75">คะแนน: ${finalScore.vocabulary}</span>
                                    </button>
                                    <button onclick="goToStep(3)" class="modern-button px-4 py-3 text-sm md:text-base rounded-xl bg-purple-500 hover:bg-purple-600 flex flex-col items-center gap-2">
                                        <span class="text-2xl">✍️</span>
                                        <span>จินตนาการ & ถอดความ</span>
                                        <span class="text-xs opacity-75">คะแนน: -</span>
                                    </button>
                                    <button onclick="goToStep(4)" class="modern-button px-4 py-3 text-sm md:text-base rounded-xl bg-green-500 hover:bg-green-600 flex flex-col items-center gap-2">
                                        <span class="text-2xl">🖼️</span>
                                        <span>เปิดภาพจริง</span>
                                        <span class="text-xs opacity-75">คะแนน: -</span>
                                    </button>
                                </div>
                                
                                <div class="mt-6 text-center">
                                    <button onclick="playAgain()" class="modern-button px-8 md:px-12 py-3 md:py-4 text-lg md:text-xl rounded-2xl bg-red-500 hover:bg-red-600 w-full md:w-auto">
                                        🔄 เล่นใหม่
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
        }

        // Update Back Button
        function updateBackButton() {
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                if (gameState.currentStep > 1 || gameState.stepHistory.length > 0) {
                    backBtn.classList.remove('hidden');
                } else {
                    backBtn.classList.add('hidden');
                }
            }
        }

        // Update Step Indicators
        function updateStepIndicators() {
            const stepTextMap = {
                1: '📚 ประวัติศาสตร์',
                2: '📖 แสดงโคลง',
                '2.5': '🎯 จับคู่คำศัพท์',
                3: '✍️ จินตนาการ & ถอดความ',
                4: '🖼️ เปิดภาพจริง',
                5: '📝 ทบทวน',
                6: '🏆 สรุปผล'
            };

            const rawStep = gameState.currentStep || 1;
            const isIntermediateStep = !Number.isInteger(rawStep);
            const activeStep = Math.min(6, Math.max(1, isIntermediateStep ? Math.floor(rawStep) : rawStep));
            const completedThreshold = Math.max(0, activeStep - 1);

            for (let i = 1; i <= 6; i++) {
                const stepElement = document.getElementById(`step-${i}`);
                if (!stepElement) continue;

                stepElement.classList.remove('step-active', 'step-completed', 'step-inactive');

                if (i <= completedThreshold) {
                    stepElement.classList.add('step-completed');
                } else if (i === activeStep) {
                    stepElement.classList.add('step-active');
                } else {
                    stepElement.classList.add('step-inactive');
                }
            }

            const currentStepText = document.getElementById('currentStepText');
            if (currentStepText) {
                const stepKey = stepTextMap[rawStep] ? rawStep : activeStep;
                currentStepText.textContent = stepTextMap[stepKey] || stepTextMap[1];
            }
        }

        // Attach Word Click Handlers
        function attachWordClickHandlers() {
            const words = document.querySelectorAll('.word-to-find');
            words.forEach(word => {
                word.addEventListener('click', (event) => handleWordClick(word.dataset.word, event));
            });
        }

        // Handle Word Click
        function handleWordClick(word, event) {
            gameState.selectedWord = word;
            const mission = MISSION_DATA.MISSION_01;
            
            // Remove any existing tooltips
            const existingTooltip = document.getElementById('wordTooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }
            
            // Get the clicked element position
            const clickedElement = event.target;
            const rect = clickedElement.getBoundingClientRect();
            
            // Create floating tooltip
            const tooltip = document.createElement('div');
            tooltip.id = 'wordTooltip';
            tooltip.className = 'fixed z-50 tooltip-modern p-4 md:p-8 max-w-sm md:max-w-lg animate-bounce-in';
            
            // Always position in center for better UX
            tooltip.style.cssText = `
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                max-width: 90vw;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            tooltip.innerHTML = `
                <div class="relative">
                    <button onclick="closeTooltip()" class="absolute -top-2 -right-2 w-8 h-8 md:w-10 md:h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold transition-all duration-200 shadow-lg text-sm md:text-base">
                        ×
                    </button>
                    
                    <div class="mb-4 md:mb-6">
                        <div class="flex items-center gap-3 mb-3 md:mb-4">
                            <span class="text-2xl md:text-3xl">🔍</span>
                            <h3 class="text-lg md:text-xl font-bold text-gray-900">ค้นหาความหมาย</h3>
                        </div>
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-3 md:p-4 rounded-xl text-center">
                            <p class="text-xl md:text-2xl font-bold text-blue-600">"${word}"</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4 md:space-y-6">
                        <div>
                            <label class="block text-gray-700 mb-2 md:mb-3 font-semibold text-sm md:text-base">💭 ความหมาย</label>
                            <input type="text" id="wordTranslation" class="w-full modern-input p-3 md:p-4 text-sm md:text-base" placeholder="กรอกความหมายที่คุณค้นพบ...">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2 md:mb-3 font-semibold text-sm md:text-base">📚 แหล่งอ้างอิง</label>
                            <select id="referenceType" class="w-full modern-input p-3 md:p-4 text-sm md:text-base mb-3" onchange="toggleReferenceInput()">
                                <option value="">เลือกแหล่งอ้างอิง</option>
                                <option value="รู้อยู่แล้ว">รู้อยู่แล้ว</option>
                                <option value="ค้นหามา">ค้นหามา</option>
                            </select>
                            <input type="text" id="wordReference" class="w-full modern-input p-3 md:p-4 text-sm md:text-base hidden" placeholder="ระบุแหล่งที่มา เช่น พจนานุกรม ราชบัณฑิตยสถาน, เว็บไซต์, หนังสือ">
                        </div>
                    </div>
                    
                    <div class="flex gap-3 md:gap-4 mt-6 md:mt-8">
                        <button onclick="closeTooltip()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-semibold transition-all duration-200 text-sm md:text-base">
                            ยกเลิก
                        </button>
                        <button onclick="validateWord()" class="flex-1 modern-button px-4 md:px-6 py-2 md:py-3 rounded-xl text-sm md:text-base">
                            ส่งคำตอบ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(tooltip);
            
            // Adjust position if tooltip goes off screen (desktop only)
            if (window.innerWidth > 768) {
                setTimeout(() => {
                    const tooltipRect = tooltip.getBoundingClientRect();
                    if (tooltipRect.right > window.innerWidth) {
                        tooltip.style.left = (rect.left - tooltipRect.width - 15) + 'px';
                    }
                    if (tooltipRect.bottom > window.innerHeight) {
                        tooltip.style.top = (rect.bottom - tooltipRect.height) + 'px';
                    }
                    if (tooltipRect.top < 0) {
                        tooltip.style.top = '10px';
                    }
                }, 10);
            }
        }

        // Toggle Reference Input
        function toggleReferenceInput() {
            const referenceType = document.getElementById('referenceType').value;
            const referenceInput = document.getElementById('wordReference');
            
            if (referenceType === 'ค้นหามา') {
                referenceInput.classList.remove('hidden');
                referenceInput.required = true;
            } else {
                referenceInput.classList.add('hidden');
                referenceInput.required = false;
                referenceInput.value = '';
            }
        }

        // Validate Word Translation
        async function validateWord() {
            try {
                const translation = document.getElementById('wordTranslation').value.trim();
                const referenceType = document.getElementById('referenceType').value;
                const referenceInput = document.getElementById('wordReference').value.trim();
                const mission = MISSION_DATA.MISSION_01;
                const correctMeaning = mission.hardWords[gameState.selectedWord].meaning;
                
                // Validation checks
                if (!translation || translation.length < 2) {
                    showNotification('กรุณากรอกความหมายของคำศัพท์', 'error');
                    return;
                }
                
                if (!referenceType) {
                    showNotification('กรุณาเลือกแหล่งอ้างอิง', 'error');
                    return;
                }
                
                if (referenceType === 'ค้นหามา' && (!referenceInput || referenceInput.trim() === '')) {
                    showNotification('กรุณาระบุแหล่งที่มาของการค้นหา', 'error');
                    return;
                }
                
                const finalReference = referenceType === 'รู้อยู่แล้ว' ? 'รู้อยู่แล้ว' : referenceInput;
                
                // Check if translation contains key concepts (more flexible matching)
                const correctMeanings = mission.hardWords[gameState.selectedWord].meaning.split(',').map(m => m.trim());
                const hasKeyword = correctMeanings.some(meaning => {
                    const keywords = meaning.split(' ');
                    return keywords.some(keyword => 
                        translation.toLowerCase().includes(keyword.toLowerCase()) ||
                        keyword.toLowerCase().includes(translation.toLowerCase()) ||
                        translation.toLowerCase() === meaning.toLowerCase()
                    );
                });
                
                const wordElement = document.querySelector(`[data-word="${gameState.selectedWord}"]`);
                
                if (!hasKeyword) {
                    // Track incorrect attempts
                    if (!gameState.wordAttempts[gameState.selectedWord]) {
                        gameState.wordAttempts[gameState.selectedWord] = 0;
                    }
                    gameState.wordAttempts[gameState.selectedWord]++;
                    
                    // Mark as incorrect
                    gameState.incorrectWords[gameState.selectedWord] = {
                        translation: translation,
                        reference: finalReference,
                        timestamp: new Date().toISOString(),
                        correctMeaning: correctMeaning,
                        attempts: gameState.wordAttempts[gameState.selectedWord]
                    };
                    
                    if (wordElement) {
                        wordElement.className = 'word-incorrect';
                    }
                    
                    // Save immediately to database
                    await saveCurrentGameState();
                    await saveAllUserAnswers();
                    
                    // Show hint image after 2 incorrect attempts
                    let hintMessage = `คำแปลยังไม่ถูกต้อง ลองดูใบ้ประกอบ`;
                    if (gameState.wordAttempts[gameState.selectedWord] >= 2) {
                        hintMessage += ` (ดูรูปภาพใบ้ที่ปรากฏ)`;
                        
                        // Add floating hint image to the word in the poem
                        const hintImageContainer = document.createElement('div');
                        hintImageContainer.className = 'absolute z-10 hint-image';
                        hintImageContainer.style.cssText = `
                            top: -80px;
                            left: 50%;
                            transform: translateX(-50%);
                            pointer-events: none;
                        `;
                        hintImageContainer.innerHTML = `
                            <div class="relative">
                                <img src="${getWordImage(gameState.selectedWord)}" alt="ใบ้สำหรับ ${gameState.selectedWord}" 
                                     class="w-16 h-16 md:w-20 md:h-20 rounded-xl border-4 border-yellow-400 object-cover shadow-2xl animate-pulse bg-white p-1">
                                <div class="absolute -top-2 -right-2 w-6 h-6 bg-yellow-400 rounded-full flex items-center justify-center text-xs font-bold text-yellow-900">💡</div>
                            </div>
                        `;
                        
                        // Insert hint image as floating element
                        if (wordElement && !wordElement.parentElement.querySelector('.hint-image')) {
                            wordElement.parentElement.style.position = 'relative';
                            wordElement.parentElement.appendChild(hintImageContainer);
                        }
                    }
                    
                    showNotification(hintMessage, 'error');
                    updateWordCounts();
                    closeTooltip();
                    return;
                }
                
                // Mark word as translated correctly
                gameState.translatedWords[gameState.selectedWord] = {
                    translation: translation,
                    reference: finalReference,
                    points: mission.hardWords[gameState.selectedWord].points,
                    timestamp: new Date().toISOString(),
                    correctMeaning: correctMeaning
                };
                
                // Remove from incorrect if it was there
                delete gameState.incorrectWords[gameState.selectedWord];
                
                // Update UI
                if (wordElement) {
                    wordElement.className = 'word-correct';
                }
                
                // Save immediately to database
                await saveCurrentGameState();
                await saveAllUserAnswers();
                
                updateWordCounts();
                showNotification(`🎉 ถูกต้อง! +${mission.hardWords[gameState.selectedWord].points} คะแนน`, 'success');
                closeTooltip();
                
                // Check if all words are translated
                const foundWordsCount = Object.keys(gameState.translatedWords).length;
                const totalWords = Object.keys(mission.hardWords).length;
                
                if (foundWordsCount === totalWords) {
                    setTimeout(() => {
                        showNotification('🚀 ค้นพบครบทุกคำแล้ว!', 'success');
                        checkAllWordsFound();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error validating word:', error);
                showNotification('เกิดข้อผิดพลาดในการตรวจสอบคำตอบ', 'error');
            }
        }

        // Update Word Counts
        function updateWordCounts() {
            const mission = MISSION_DATA.MISSION_01;
            const foundWordsCount = Object.keys(gameState.translatedWords).length;
            const incorrectWordsCount = Object.keys(gameState.incorrectWords).length;
            const totalWords = Object.keys(mission.hardWords).length;
            const progressPercent = (foundWordsCount / totalWords) * 100;
            
            const foundWordsElement = document.getElementById('foundWords');
            const incorrectWordsElement = document.getElementById('incorrectWords');
            const progressFill = document.getElementById('wordProgress');
            
            if (foundWordsElement) {
                foundWordsElement.textContent = foundWordsCount;
            }
            if (incorrectWordsElement) {
                incorrectWordsElement.textContent = incorrectWordsCount;
            }
            if (progressFill) {
                progressFill.style.width = progressPercent + '%';
            }
        }

        // Check if all words are found
        function checkAllWordsFound() {
            const mission = MISSION_DATA.MISSION_01;
            const foundWordsCount = Object.keys(gameState.translatedWords).length;
            const totalWords = Object.keys(mission.hardWords).length;
            
            const nextButton = document.getElementById('nextToMatching');
            if (nextButton && foundWordsCount === totalWords) {
                nextButton.classList.remove('hidden');
                showNotification('🎉 ค้นพบครบทุกคำแล้ว! พร้อมไปจับคู่คำศัพท์', 'success');
            }
        }

        // Show Matching Game
        async function showMatchingGame() {
            await renderStep(2.5); // New step for matching game
        }

        // Show User Menu
        function showUserMenu() {
            const modal = document.createElement('div');
            modal.id = 'userMenuModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 md:p-8 max-w-md w-full animate-bounce-in">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-4">👤</div>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-2">ข้อมูลผู้ใช้</h2>
                        <p class="text-gray-600">${gameState.currentUser?.name || 'ผู้ใช้'}</p>
                        ${gameState.currentUser?.studentId ? `<p class="text-sm text-gray-500">${gameState.currentUser.grade}/${gameState.currentUser.room} เลขที่ ${gameState.currentUser.number}</p>` : ''}
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-4 rounded-xl">
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <div class="text-2xl font-bold text-blue-600">${playerProfile.exp}</div>
                                    <div class="text-sm text-gray-600">คะแนนรวม</div>
                                </div>
                                <div>
                                    <div class="text-xl font-bold text-purple-600">${playerProfile.rank}</div>
                                    <div class="text-sm text-gray-600">อันดับ</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="userMenuGoHome()" class="flex-1 modern-button px-4 py-3 rounded-xl bg-blue-500 hover:bg-blue-600">
                                🏠 หน้าหลัก
                            </button>
                            <button onclick="userMenuSignOut()" class="flex-1 modern-button px-4 py-3 rounded-xl bg-red-500 hover:bg-red-600">
                                🚪 ออกจากระบบ
                            </button>
                        </div>
                        
                        <button onclick="closeUserMenu()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-xl font-semibold transition-all duration-200">
                            ปิด
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close User Menu
        function closeUserMenu() {
            const modal = document.getElementById('userMenuModal');
            if (modal) {
                modal.remove();
            }
        }

        // User Menu Functions
        async function userMenuGoHome() {
            closeUserMenu();
            await goToHome();
        }

        async function userMenuSignOut() {
            closeUserMenu();
            await signOutUser();
            showLandingPage();
        }

        // Evaluate Creative Writing with Real-time AI-like Scoring
        function evaluateCreativeWriting(text, type) {
            const keywords = {
                imagination: [
                    'ช้าง', 'สมเด็จพระสุริโยทัย', 'พระเจ้าแปร', 'ง้าว', 'สงคราม', 'รบ', 'ต่อสู้',
                    'อก', 'เลือด', 'ตาย', 'กล้าหาญ', 'เสียสละ', 'ปกป้อง', 'พระราชสามี',
                    'ศัตรู', 'พม่า', 'กรุงศรีอยุธยา', 'โอรส', 'พระศพ', 'ความรัก', 'ความภักดี',
                    'นงคราญ', 'กระษัตรีย์', 'มาน', 'กัตเวที', 'มลาย', 'คเชนทร', 'ดัสกร', 'แล่ง', 'อุระ', 'หรุบ', 'พจน์'
                ],
                interpretation: [
                    // Core semantic lexicon for interpretation evaluation
                    'สมเด็จ', 'พระสุริโยทัย', 'เกรง', 'พระสวามี', 'พระราชสามี', 'สิ้นพระชนม์', 'ตาย', 'สวรรคต',
                    'ขับ', 'ช้าง', 'คช', 'หัตถี', 'เข้า', 'ขวาง', 'พระเจ้าแปร', 'แปร', 'มอญ', 'พม่า', 'ต่อสู้', 'รบ',
                    'ง้าว', 'ฟัน', 'ผ่า', 'อก', 'อุระ', 'ทรวง', 'บน', 'คอ', 'โอรส', 'พระราชโอรส', 'บุตร',
                    'พระราเมศวร', 'มหินทรา', 'กัน', 'พระศพ', 'นำ', 'เมือง', 'นคร', 'สรรเสริญ', 'เยินยอ',
                    'กล้าหาญ', 'เสียสละ', 'ปกป้อง', 'วีรกรรม', 'ความรัก', 'ความภักดี'
                ]
            };
            
            const relevantKeywords = keywords[type] || [];
            const textLower = text.toLowerCase();
            let score = 0;
            let foundKeywords = 0;
            let keywordDetails = [];
            
            // Advanced keyword matching with context
            relevantKeywords.forEach(keyword => {
                if (textLower.includes(keyword.toLowerCase())) {
                    foundKeywords++;
                    let points = 5;
                    
                    // Bonus points for important keywords
                    if (['สมเด็จพระสุริโยทัย', 'พระเจ้าแปร', 'ง้าว', 'ช้าง'].includes(keyword)) {
                        points = 8;
                    }
                    
                    score += points;
                    keywordDetails.push({ keyword, points });
                }
            });
            
            // Length and structure analysis
            const wordCount = text.trim().split(/\s+/).length;
            const sentences = text.split(/[.!?]/).filter(s => s.trim().length > 0).length;
            
            // Length scoring with better scaling
            if (wordCount >= 100) score += 30;
            else if (wordCount >= 80) score += 25;
            else if (wordCount >= 60) score += 20;
            else if (wordCount >= 40) score += 15;
            else if (wordCount >= 20) score += 10;
            else if (wordCount >= 10) score += 5;
            
            // Structure bonus
            if (sentences >= 3) score += 10;
            else if (sentences >= 2) score += 5;
            
            // Content quality analysis
            const qualityWords = [
                'สวยงาม', 'น่าเกรงขาม', 'ยิ่งใหญ่', 'น่าสงสาร', 'น่าชื่นชม', 'เศร้าโศก', 'ภาคภูมิใจ',
                'วีรกรรม', 'เสียสละ', 'กล้าหาญ', 'ความรัก', 'ความภักดี', 'น่าประทับใจ', 'สะเทือนใจ',
                'ความงาม', 'ความแกร่ง', 'ความเข้มแข็ง', 'ความอ่อนโยน', 'ความรุนแรง', 'ความเศร้าโศก'
            ];
            
            let qualityScore = 0;
            qualityWords.forEach(word => {
                if (textLower.includes(word.toLowerCase())) {
                    qualityScore += 3;
                }
            });
            score += Math.min(qualityScore, 15); // Cap quality bonus
            
            // Creativity and originality bonus
            const creativeElements = [
                'เสียงดัง', 'แสงแวบ', 'ฝุ่นฟุ้ง', 'เลือดไหล', 'น้ำตา', 'เสียงร้อง',
                'ความมืด', 'แสงแดด', 'ลมแรง', 'ฟ้าร้อง', 'เมฆดำ', 'ดาวดวง'
            ];
            
            let creativityScore = 0;
            creativeElements.forEach(element => {
                if (textLower.includes(element.toLowerCase())) {
                    creativityScore += 2;
                }
            });
            score += Math.min(creativityScore, 10); // Cap creativity bonus
            
            // Penalty for too short content
            if (wordCount < 10) {
                score = Math.max(0, score - 20);
            }
            
            // Final score calculation with realistic scaling
            const finalScore = Math.min(Math.max(score, 0), 100);
            
            return {
                score: finalScore,
                foundKeywords: foundKeywords,
                wordCount: wordCount,
                sentences: sentences,
                keywordDetails: keywordDetails,
                feedback: generateAdvancedFeedback(finalScore, foundKeywords, wordCount, sentences, type)
            };
        }
        
        function generateAdvancedFeedback(score, keywords, wordCount, sentences, type) {
            let feedback = '';
            let suggestions = [];
            
            // Score-based feedback
            if (score >= 90) {
                feedback = '🌟 เยี่ยมยอด! ';
            } else if (score >= 80) {
                feedback = '🎉 ยอดเยี่ยม! ';
            } else if (score >= 70) {
                feedback = '👍 ดีมาก! ';
            } else if (score >= 60) {
                feedback = '😊 ดี! ';
            } else if (score >= 50) {
                feedback = '👌 พอใช้! ';
            } else {
                feedback = '💪 ต้องปรับปรุง! ';
            }
            
            // Content analysis
            if (type === 'imagination') {
                feedback += `คุณใช้คำสำคัญ ${keywords} คำ เขียน ${wordCount} คำ ใน ${sentences} ประโยค `;
                
                if (keywords >= 8) {
                    feedback += 'แสดงความเข้าใจเนื้อหาอย่างลึกซึ้ง ';
                } else if (keywords >= 5) {
                    feedback += 'แสดงความเข้าใจเนื้อหาดี ';
                    suggestions.push('ลองเพิ่มรายละเอียดเกี่ยวกับอารมณ์และความรู้สึก');
                } else if (keywords >= 3) {
                    feedback += 'เข้าใจเนื้อหาพอสมควร ';
                    suggestions.push('ลองเพิ่มคำศัพท์จากโคลงมากขึ้น');
                } else {
                    suggestions.push('ควรใช้คำศัพท์จากโคลงให้มากขึ้น');
                    suggestions.push('อธิบายตัวละครและเหตุการณ์ให้ชัดเจน');
                }
                
                if (wordCount < 30) {
                    suggestions.push('ลองขยายความคิดให้ยาวขึ้น อธิบายภาพที่เห็นในใจให้ละเอียด');
                }
                
            } else { // interpretation
                feedback += `คุณใช้คำสำคัญ ${keywords} คำ เขียน ${wordCount} คำ ใน ${sentences} ประโยค `;
                
                if (keywords >= 10) {
                    feedback += 'ถอดความได้ครบถ้วนและถูกต้อง ';
                } else if (keywords >= 7) {
                    feedback += 'ถอดความได้ดี ';
                    suggestions.push('ลองเพิ่มรายละเอียดเกี่ยวกับผลลัพธ์');
                } else if (keywords >= 5) {
                    feedback += 'ถอดความได้พอสมควร ';
                    suggestions.push('ลองเพิ่มเหตุการณ์สำคัญที่ยังขาด');
                } else {
                    suggestions.push('ควรใช้คำศัพท์จากโคลงมากขึ้น');
                    suggestions.push('อธิบายลำดับเหตุการณ์ให้ชัดเจน');
                }
                
                if (wordCount < 40) {
                    suggestions.push('ลองขยายความให้ยาวขึ้น เล่าเหตุการณ์ให้ครบถ้วน');
                }
            }
            
            // Add suggestions to feedback
            if (suggestions.length > 0) {
                feedback += '\n💡 คำแนะนำ: ' + suggestions.join(' • ');
            }
            
            return feedback;
        }

        // Setup Step 3 Handlers
        function setupStep3Handlers() {
            const imaginationInput = document.getElementById('imaginationInput');
            const interpretationInput = document.getElementById('interpretationInput');
            const nextBtn = document.getElementById('nextStep3');
            
            // Load saved data
            if (gameState.imaginationText) {
                imaginationInput.value = gameState.imaginationText;
            }
            if (gameState.interpretationText) {
                interpretationInput.value = gameState.interpretationText;
            }
            
            function updateButtonState() {
                const imaginationLength = imaginationInput.value.trim().length;
                const interpretationLength = interpretationInput.value.trim().length;
                
                nextBtn.disabled = imaginationLength < 10 || interpretationLength < 10;
            }
            
            // Initial button state check
            updateButtonState();
            
            imaginationInput.addEventListener('input', async () => {
                gameState.imaginationText = imaginationInput.value;
                updateButtonState();
                
                // ไม่ให้คะแนนจินตนาการแล้ว - เก็บข้อมูลเท่านั้น
                
                await saveCurrentGameState();
                await saveAllUserAnswers();
            });
            
            interpretationInput.addEventListener('input', async () => {
                gameState.interpretationText = interpretationInput.value;
                updateButtonState();
                
                // Real-time evaluation
                if (interpretationInput.value.trim().length > 20) {
                    const evaluation = evaluateCreativeWriting(interpretationInput.value, 'interpretation');
                    showWritingFeedback('interpretation', evaluation);
                }
                
                await saveCurrentGameState();
                await saveAllUserAnswers();
            });
            
            nextBtn.addEventListener('click', async () => {
                try {
                    gameState.imaginationText = imaginationInput.value;
                    gameState.interpretationText = interpretationInput.value;
                    
                    // Final evaluation - ไม่ให้คะแนนจินตนาการ
                    const interpretationEval = evaluateCreativeWriting(gameState.interpretationText, 'interpretation');
                    
                    gameState.imaginationScore = 0; // ไม่ให้คะแนน
                    gameState.interpretationScore = interpretationEval.score;
                    
                    await saveCurrentGameState();
                    await saveAllUserAnswers();
                    
                    showNotification(`บันทึกเรียบร้อย! คะแนนถอดความ: ${interpretationEval.score}`, 'success');
                    await renderStep(4);
                } catch (error) {
                    console.error('Error saving step 3 data:', error);
                    showNotification('เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
                }
            });
        }
        
        function showWritingFeedback(type, evaluation) {
            const containerId = type === 'imagination' ? 'imaginationFeedback' : 'interpretationFeedback';
            let container = document.getElementById(containerId);
            
            if (!container) {
                const inputElement = document.getElementById(type === 'imagination' ? 'imaginationInput' : 'interpretationInput');
                container = document.createElement('div');
                container.id = containerId;
                container.className = 'mt-3 p-4 bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 rounded-xl';
                inputElement.parentNode.appendChild(container);
            }
            
            // Determine color based on score
            let scoreColor = 'text-red-600';
            let barColor = 'bg-red-500';
            if (evaluation.score >= 80) {
                scoreColor = 'text-green-600';
                barColor = 'bg-green-500';
            } else if (evaluation.score >= 60) {
                scoreColor = 'text-blue-600';
                barColor = 'bg-blue-500';
            } else if (evaluation.score >= 40) {
                scoreColor = 'text-yellow-600';
                barColor = 'bg-yellow-500';
            }
            
            // Split feedback into main text and suggestions
            const feedbackParts = evaluation.feedback.split('\n💡 คำแนะนำ: ');
            const mainFeedback = feedbackParts[0];
            const suggestions = feedbackParts[1];
            
            container.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <span class="font-bold ${scoreColor} text-lg">คะแนน: ${evaluation.score}/100</span>
                    <div class="w-32 h-3 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full ${barColor} rounded-full transition-all duration-500 ease-out" style="width: ${evaluation.score}%"></div>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <p class="text-sm font-semibold text-blue-800">${mainFeedback}</p>
                    
                    ${evaluation.keywordDetails && evaluation.keywordDetails.length > 0 ? `
                        <div class="text-xs text-gray-600">
                            <span class="font-semibold">คำสำคัญที่พบ:</span> 
                            ${evaluation.keywordDetails.map(kw => `<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full mr-1">${kw.keyword} (+${kw.points})</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    ${suggestions ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mt-2">
                            <div class="flex items-start gap-2">
                                <span class="text-yellow-600 text-lg">💡</span>
                                <div class="text-xs text-yellow-800">
                                    <span class="font-semibold">คำแนะนำ:</span><br>
                                    ${suggestions.split(' • ').map(s => `• ${s}`).join('<br>')}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Reveal Image Function with Dust Wiping Effect
        function setupImageReveal() {
            const container = document.getElementById('imageContainer');
            const img = document.getElementById('historicalImage');
            const overlay = document.getElementById('imageOverlay');
            const canvas = document.getElementById('revealCanvas');
            
            if (!container || !img || !overlay || !canvas) return;
            
            const ctx = canvas.getContext('2d');
            let isRevealing = false;
            let revealProgress = 0;
            
            // Set canvas size
            function resizeCanvas() {
                const rect = img.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                
                // Create thicker dusty/foggy overlay effect (ทำให้หนาขึ้น)
                const gradient = ctx.createRadialGradient(
                    canvas.width / 2, canvas.height / 2, 0,
                    canvas.width / 2, canvas.height / 2, Math.max(canvas.width, canvas.height) / 2
                );
                gradient.addColorStop(0, 'rgba(160, 160, 160, 0.95)'); // เพิ่มความทึบ
                gradient.addColorStop(0.5, 'rgba(120, 120, 120, 0.9)'); // เพิ่มความทึบ
                gradient.addColorStop(1, 'rgba(80, 80, 80, 0.85)'); // เพิ่มความทึบ
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Add more dust particles effect (เพิ่มฝุ่นให้มากขึ้น)
                for (let i = 0; i < 200; i++) { // เพิ่มจาก 100 เป็น 200
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const size = Math.random() * 4 + 1; // เพิ่มขนาดฝุ่น
                    
                    ctx.fillStyle = `rgba(140, 140, 140, ${Math.random() * 0.7 + 0.4})`; // เพิ่มความทึบ
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // Add extra dust layer (เพิ่มชั้นฝุ่นพิเศษ)
                for (let i = 0; i < 50; i++) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const size = Math.random() * 8 + 3;
                    
                    ctx.fillStyle = `rgba(100, 100, 100, ${Math.random() * 0.4 + 0.2})`;
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // Initialize canvas
            img.onload = resizeCanvas;
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            // Update overlay text for dust wiping effect
            overlay.innerHTML = `
                <div class="text-white text-center">
                    <div class="text-4xl mb-2 animate-bounce">🧹</div>
                    <p class="text-lg font-bold">ปัดฝุ่นเพื่อเปิดเผยภาพ</p>
                    <p class="text-sm mt-2 opacity-75">ลากเมาส์หรือนิ้วเพื่อเช็ดฝุ่น</p>
                </div>
            `;
            
            function startRevealing(e) {
                isRevealing = true;
                canvas.style.opacity = '1';
                canvas.style.pointerEvents = 'auto';
                reveal(e);
                
                // Change cursor to indicate wiping
                container.style.cursor = 'grab';
            }
            
            function reveal(e) {
                if (!isRevealing) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                
                // Create wiping effect with smaller brush (ทำให้ยากขึ้น)
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(x, y, 25, 0, Math.PI * 2); // ลดขนาดจาก 40 เป็น 25
                ctx.fill();
                
                // Add wiping trail effect with smaller brush
                if (reveal.lastX !== undefined && reveal.lastY !== undefined) {
                    ctx.lineWidth = 50; // ลดขนาดจาก 80 เป็น 50
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(reveal.lastX, reveal.lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                }
                
                reveal.lastX = x;
                reveal.lastY = y;
                
                // Check reveal progress every 30 strokes (เพิ่มจาก 20 เป็น 30)
                revealProgress += 1;
                if (revealProgress % 30 === 0) {
                    // Check if enough area has been revealed
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const pixels = imageData.data;
                    let transparentPixels = 0;
                    
                    for (let i = 3; i < pixels.length; i += 4) {
                        if (pixels[i] < 128) { // Alpha channel less than 50%
                            transparentPixels++;
                        }
                    }
                    
                    const revealPercentage = (transparentPixels / (pixels.length / 4)) * 100;
                    
                    // เพิ่มเงื่อนไขให้ยากขึ้น - ต้องปัดให้ได้ 70% แทน 50%
                    if (revealPercentage >= 70) {
                        completeReveal();
                    }
                }
            }
            
            function stopRevealing() {
                isRevealing = false;
                reveal.lastX = undefined;
                reveal.lastY = undefined;
                container.style.cursor = 'pointer';
            }
            
            function completeReveal() {
                img.classList.remove('blur-lg');
                overlay.style.opacity = '0';
                canvas.style.opacity = '0';
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                    canvas.style.pointerEvents = 'none';
                }, 1000);
                
                showNotification('🖼️ ปัดฝุ่นเสร็จแล้ว! ภาพถูกเปิดเผย', 'success');
            }
            
            // Mouse events
            container.addEventListener('mousedown', startRevealing);
            container.addEventListener('mousemove', reveal);
            container.addEventListener('mouseup', stopRevealing);
            container.addEventListener('mouseleave', stopRevealing);
            
            // Touch events
            container.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startRevealing(e);
            });
            container.addEventListener('touchmove', (e) => {
                e.preventDefault();
                reveal(e);
            });
            container.addEventListener('touchend', stopRevealing);
            
            // Click to complete reveal
            container.addEventListener('click', completeReveal);
        }

        // Setup Step 4 Handlers
        function setupStep4Handlers() {
            // Check if user has completed step 3 (imagination and interpretation)
            const hasRequiredData = gameState.imaginationText && gameState.interpretationText && 
                                  gameState.imaginationText.trim().length >= 10 && 
                                  gameState.interpretationText.trim().length >= 10;
            
            if (!hasRequiredData) {
                // Disable image reveal if no step 3 data
                const imageContainer = document.getElementById('imageContainer');
                const overlay = document.getElementById('imageOverlay');
                
                if (imageContainer && overlay) {
                    imageContainer.style.pointerEvents = 'none';
                    overlay.innerHTML = `
                        <div class="text-white text-center">
                            <div class="text-4xl mb-2">🔒</div>
                            <p class="text-lg font-bold">ต้องทำหน้าจินตนาการ & ถอดความก่อน</p>
                            <p class="text-sm mt-2 opacity-75">กลับไปหน้าที่ 3 เพื่อเขียนจินตนาการและถอดความ</p>
                            <button onclick="goToStep(3)" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl">
                                ไปหน้าจินตนาการ & ถอดความ
                            </button>
                        </div>
                    `;
                }
                
                showNotification('กรุณาทำหน้าจินตนาการ & ถอดความให้เสร็จก่อน', 'error');
                return;
            }
            
            document.getElementById('showComparison').addEventListener('click', () => {
                const comparisonSection = document.getElementById('comparisonSection');
                const button = document.getElementById('showComparison');
                
                comparisonSection.classList.remove('hidden');
                comparisonSection.classList.add('animate-bounce-in');
                button.style.display = 'none';
                
                showNotification('เปรียบเทียบความคิดของคุณกับข้อมูลจริง!', 'success');
            });
            
            document.getElementById('nextStep4').addEventListener('click', async () => {
                await renderStep(5);
            });
        }

        // Get Word Emoji
        function getWordEmoji(word) {
            const emojiMap = {
                'นงคราญ': '👸',
                'มาน': '💖',
                'กัตเวที': '🙏',
                'มลาย': '💀',
                'คเชนทร': '🐘',
                'ดัสกร': '⚔️',
                'แล่ง': '🔪',
                'อุระ': '👤',
                'หรุบ': '⬇️',
                'ไป่': '❌',
                'พจน์': '💬'
            };
            return emojiMap[word] || '📝';
        }

        // Get Word Image
        function getWordImage(word) {
            const imageMap = {
                'นงคราญ': 'https://img2.pic.in.th/pic/Gemini_Generated_Image_obzx9bobzx9bobzx.png',
                'มาน': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_xvra5axvra5axvra.png',
                'กัตเวที': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_npiozbnpiozbnpioc4686b30823835e2.png',
                'มลาย': 'https://img2.pic.in.th/pic/Gemini_Generated_Image_5dg3t75dg3t75dg3084de5b3dbf1da5a.png',
                'คเชนทร': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_2w0xpa2w0xpa2w0x6d96eebaef1428c5.png',
                'ดัสกร': 'https://img2.pic.in.th/pic/Gemini_Generated_Image_m7s5sjm7s5sjm7s5.png',
                'ง้าว': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_wwh7v4wwh7v4wwh7.png',
                'แล่ง': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_nofldgnofldgnofl.png',
                'อุระ': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_1tpy7b1tpy7b1tpy.png',
                'หรุบ': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_n464d3n464d3n464.png',
                'ไป่': 'https://img2.pic.in.th/pic/Gemini_Generated_Image_jij2fajij2fajij2.png',
                'พจน์': 'https://img5.pic.in.th/file/secure-sv1/Gemini_Generated_Image_o6l06zo6l06zo6l0.png'
            };
            return imageMap[word] || '';
        }

        // Setup Quiz
        function setupQuiz() {
            // Load saved quiz answers if available
            if (gameState.comprehensionAnswers && gameState.comprehensionAnswers.length > 0) {
                gameState.comprehensionAnswers.forEach((answer, index) => {
                    const radio = document.querySelector(`input[name="question_${index}"][value="${answer}"]`);
                    if (radio) {
                        radio.checked = true;
                    }
                });
                
                // Show score if already checked
                if (gameState.comprehensionScore !== undefined) {
                    document.getElementById('quizScore').textContent = gameState.comprehensionScore;
                    document.getElementById('checkAnswers').classList.add('hidden');
                    document.getElementById('finishQuiz').classList.remove('hidden');
                }
            }
        }

        // Check Quiz Answers
        function checkQuizAnswers() {
            const mission = MISSION_DATA.MISSION_01;
            let score = 0;
            const answers = [];
            
            mission.comprehensionQuestions.forEach((q, index) => {
                const selectedRadio = document.querySelector(`input[name="question_${index}"]:checked`);
                const resultDiv = document.getElementById(`result_${index}`);
                
                if (selectedRadio) {
                    const selectedValue = parseInt(selectedRadio.value);
                    answers.push(selectedValue);
                    
                    if (selectedValue === q.correct) {
                        score++;
                        resultDiv.innerHTML = '<div class="text-green-600 font-semibold">✅ ถูกต้อง!</div>';
                        resultDiv.classList.remove('hidden');
                        selectedRadio.parentElement.classList.add('bg-green-100', 'border-green-300');
                    } else {
                        resultDiv.innerHTML = `<div class="text-red-600 font-semibold">❌ ผิด! คำตอบที่ถูก: ${q.options[q.correct]}</div>`;
                        resultDiv.classList.remove('hidden');
                        selectedRadio.parentElement.classList.add('bg-red-100', 'border-red-300');
                        
                        // Highlight correct answer
                        const correctRadio = document.querySelector(`input[name="question_${index}"][value="${q.correct}"]`);
                        if (correctRadio) {
                            correctRadio.parentElement.classList.add('bg-green-100', 'border-green-300');
                        }
                    }
                } else {
                    answers.push(-1);
                    resultDiv.innerHTML = '<div class="text-orange-600 font-semibold">⚠️ ไม่ได้เลือกคำตอบ</div>';
                    resultDiv.classList.remove('hidden');
                }
            });
            
            // Save answers and score
            gameState.comprehensionAnswers = answers;
            gameState.comprehensionScore = score;
            
            // Update UI
            document.getElementById('quizScore').textContent = score;
            document.getElementById('checkAnswers').classList.add('hidden');
            
            // Check if score is less than half
            const halfScore = Math.ceil(mission.comprehensionQuestions.length / 2);
            if (score < halfScore) {
                // Show retry button for low scores
                document.getElementById('retryQuiz').classList.remove('hidden');
                showNotification(`คะแนน: ${score}/${mission.comprehensionQuestions.length} ข้อ - คะแนนต่ำกว่าครึ่ง กรุณาทำใหม่หรือย้อนกลับไปทบทวน`, 'error');
            } else {
                // Show finish button for good scores
                document.getElementById('finishQuiz').classList.remove('hidden');
                showNotification(`คะแนน: ${score}/${mission.comprehensionQuestions.length} ข้อ - ผ่านเกณฑ์!`, 'success');
            }
            
            // Disable all radio buttons
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.disabled = true;
            });
            
            // Save to database
            saveCurrentGameState();
            saveAllUserAnswers();
        }

        // Retry Quiz
        function retryQuiz() {
            // Clear all selections and results
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
                radio.disabled = false;
                radio.parentElement.classList.remove('bg-green-100', 'border-green-300', 'bg-red-100', 'border-red-300');
            });
            
            // Hide all result divs
            document.querySelectorAll('[id^="result_"]').forEach(resultDiv => {
                resultDiv.classList.add('hidden');
                resultDiv.innerHTML = '';
            });
            
            // Reset UI buttons
            document.getElementById('checkAnswers').classList.remove('hidden');
            document.getElementById('retryQuiz').classList.add('hidden');
            document.getElementById('finishQuiz').classList.add('hidden');
            
            // Reset score display
            document.getElementById('quizScore').textContent = '0';
            
            // Clear saved answers
            gameState.comprehensionAnswers = [];
            gameState.comprehensionScore = 0;
            
            showNotification('เริ่มทำแบบทดสอบใหม่!', 'success');
        }

        // Finish Quiz
        async function finishQuiz() {
            await renderStep(6);
        }

        // Setup Matching Game
        function setupMatchingGame() {
            let selectedWord = null;
            let matchedPairs = 0;
            let score = 0;
            const mission = MISSION_DATA.MISSION_01;
            const totalPairs = Object.keys(mission.hardWords).length;
            
            // Load saved matching state if available
            if (gameState.matchingScore !== undefined) {
                score = gameState.matchingScore;
                matchedPairs = gameState.matchedPairs || 0;
                updateMatchingScore();
            }
            
            function updateMatchingScore() {
                document.getElementById('matchingScore').textContent = score;
                
                // Enable finish button when all pairs are matched
                const finishBtn = document.getElementById('finishMatching');
                if (matchedPairs >= totalPairs) {
                    finishBtn.disabled = false;
                    finishBtn.textContent = '➡️ ไปขั้นตอนถัดไป';
                    showNotification('🎉 จับคู่ครบทุกคำแล้ว!', 'success');
                }
            }
            
            // Word click handler
            document.querySelectorAll('.word-item').forEach(wordEl => {
                wordEl.addEventListener('click', () => {
                    // Remove previous selection
                    document.querySelectorAll('.word-item').forEach(el => {
                        el.classList.remove('bg-purple-200', 'border-purple-500');
                    });
                    
                    // Select current word
                    wordEl.classList.add('bg-purple-200', 'border-purple-500');
                    selectedWord = wordEl.dataset.word;
                });
            });
            
            // Meaning click handler
            document.querySelectorAll('.meaning-item').forEach(meaningEl => {
                meaningEl.addEventListener('click', () => {
                    if (!selectedWord) {
                        showNotification('กรุณาเลือกคำศัพท์ก่อน', 'error');
                        return;
                    }
                    
                    const correctWord = meaningEl.dataset.word;
                    
                    if (selectedWord === correctWord) {
                        // Correct match
                        const wordEl = document.querySelector(`[data-word="${selectedWord}"]`);
                        
                        // Update UI for correct match
                        meaningEl.classList.remove('border-dashed', 'border-green-300');
                        meaningEl.classList.add('bg-green-200', 'border-green-500', 'border-solid');
                        meaningEl.innerHTML = `
                            <div class="flex flex-col items-center justify-center gap-2">
                                <img src="${getWordImage(selectedWord)}" alt="${selectedWord}" class="w-16 h-16 md:w-20 md:h-20 rounded-lg border-2 border-green-600 object-cover shadow-md">
                                <span class="font-bold text-green-800 text-lg">${selectedWord}</span>
                                <span class="text-green-700 text-sm">${mission.hardWords[selectedWord].meaning}</span>
                            </div>
                        `;
                        
                        // Remove word from left column
                        wordEl.style.opacity = '0.3';
                        wordEl.style.pointerEvents = 'none';
                        wordEl.classList.remove('bg-gradient-to-r', 'from-red-400', 'to-red-500', 'hover:from-red-500', 'hover:to-red-600');
                        wordEl.classList.add('bg-gray-400', 'text-gray-600');
                        
                        matchedPairs++;
                        score += mission.hardWords[selectedWord].points;
                        
                        // Save progress
                        gameState.matchingScore = score;
                        gameState.matchedPairs = matchedPairs;
                        saveCurrentGameState();
                        
                        showNotification(`✅ ถูกต้อง! +${mission.hardWords[selectedWord].points} คะแนน`, 'success');
                        updateMatchingScore();
                        
                    } else {
                        // Incorrect match
                        meaningEl.classList.add('bg-red-100', 'border-red-400');
                        setTimeout(() => {
                            meaningEl.classList.remove('bg-red-100', 'border-red-400');
                        }, 1000);
                        
                        showNotification('❌ ไม่ถูกต้อง ลองใหม่อีกครั้ง', 'error');
                    }
                    
                    // Clear selection
                    selectedWord = null;
                    document.querySelectorAll('.word-item').forEach(el => {
                        el.classList.remove('bg-purple-200', 'border-purple-500');
                    });
                });
            });
            
            // Drag and drop handlers
            document.querySelectorAll('.word-item').forEach(wordEl => {
                wordEl.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', wordEl.dataset.word);
                    wordEl.classList.add('opacity-50');
                });
                
                wordEl.addEventListener('dragend', () => {
                    wordEl.classList.remove('opacity-50');
                });
            });
            
            document.querySelectorAll('.meaning-item').forEach(meaningEl => {
                meaningEl.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    meaningEl.classList.add('bg-green-100', 'border-green-400');
                });
                
                meaningEl.addEventListener('dragleave', () => {
                    meaningEl.classList.remove('bg-green-100', 'border-green-400');
                });
                
                meaningEl.addEventListener('drop', (e) => {
                    e.preventDefault();
                    meaningEl.classList.remove('bg-green-100', 'border-green-400');
                    
                    const draggedWord = e.dataTransfer.getData('text/plain');
                    const correctWord = meaningEl.dataset.word;
                    
                    if (draggedWord === correctWord) {
                        // Same logic as click handler for correct match
                        const wordEl = document.querySelector(`[data-word="${draggedWord}"]`);
                        
                        meaningEl.classList.remove('border-dashed', 'border-green-300');
                        meaningEl.classList.add('bg-green-200', 'border-green-500', 'border-solid');
                        meaningEl.innerHTML = `
                            <div class="flex flex-col items-center justify-center gap-2">
                                <img src="${getWordImage(draggedWord)}" alt="${draggedWord}" class="w-16 h-16 md:w-20 md:h-20 rounded-lg border-2 border-green-600 object-cover shadow-md">
                                <span class="font-bold text-green-800 text-lg">${draggedWord}</span>
                                <span class="text-green-700 text-sm">${mission.hardWords[draggedWord].meaning}</span>
                            </div>
                        `;
                        
                        wordEl.style.opacity = '0.3';
                        wordEl.style.pointerEvents = 'none';
                        wordEl.classList.remove('bg-gradient-to-r', 'from-red-400', 'to-red-500', 'hover:from-red-500', 'hover:to-red-600');
                        wordEl.classList.add('bg-gray-400', 'text-gray-600');
                        
                        matchedPairs++;
                        score += mission.hardWords[draggedWord].points;
                        
                        gameState.matchingScore = score;
                        gameState.matchedPairs = matchedPairs;
                        saveCurrentGameState();
                        
                        showNotification(`✅ ถูกต้อง! +${mission.hardWords[draggedWord].points} คะแนน`, 'success');
                        updateMatchingScore();
                        
                    } else {
                        meaningEl.classList.add('bg-red-100', 'border-red-400');
                        setTimeout(() => {
                            meaningEl.classList.remove('bg-red-100', 'border-red-400');
                        }, 1000);
                        
                        showNotification('❌ ไม่ถูกต้อง ลองใหม่อีกครั้ง', 'error');
                    }
                });
            });
            
            // Reset button
            document.getElementById('resetMatching').addEventListener('click', () => {
                if (confirm('คุณต้องการเริ่มเกมจับคู่ใหม่หรือไม่?')) {
                    location.reload(); // Simple reset by reloading
                }
            });
            
            // Finish button
            document.getElementById('finishMatching').addEventListener('click', async () => {
                gameState.matchingScore = score;
                await saveCurrentGameState();
                await saveAllUserAnswers();
                
                showNotification('เสร็จสิ้นการจับคู่คำศัพท์!', 'success');
                await renderStep(3); // Go to next step
            });
            
            // Initial score update
            updateMatchingScore();
        }

        // Go to specific step
        async function goToStep(step) {
            await renderStep(step);
        }

        // Update user name display
        function updateUserNameDisplay() {
            const headerUserName = document.getElementById('headerUserName');
            const currentUserName = document.getElementById('currentUserName');
            
            if (gameState.currentUser && headerUserName && currentUserName) {
                headerUserName.classList.remove('hidden');
                currentUserName.textContent = gameState.currentUser.name || 'ผู้ใช้';
            } else if (headerUserName) {
                headerUserName.classList.add('hidden');
            }
        }

        // Certificate Generation
        function generateCertificate() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = 1200;
            canvas.height = 800;
            
            // Background gradient
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(0.5, '#764ba2');
            gradient.addColorStop(1, '#f093fb');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Border
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 8;
            ctx.strokeRect(40, 40, canvas.width - 80, canvas.height - 80);
            
            // Inner border
            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 2;
            ctx.strokeRect(60, 60, canvas.width - 120, canvas.height - 120);
            
            // Title
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 48px Sarabun, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('เกียรติบัตร', canvas.width / 2, 150);
            
            ctx.font = 'bold 36px Sarabun, Arial, sans-serif';
            ctx.fillText('ไขรหัสวรรณคดี', canvas.width / 2, 200);
            
            // Decorative line
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(300, 220);
            ctx.lineTo(900, 220);
            ctx.stroke();
            
            // Certificate text
            ctx.font = '28px Sarabun, Arial, sans-serif';
            ctx.fillText('ขอแสดงความยินดีกับ', canvas.width / 2, 280);
            
            // Student name
            const studentName = gameState.currentUser?.name || 'ผู้เล่น';
            ctx.font = 'bold 42px Sarabun, Arial, sans-serif';
            ctx.fillStyle = '#ffeb3b';
            ctx.fillText(studentName, canvas.width / 2, 340);
            
            // Student details
            if (gameState.currentUser?.studentId) {
                ctx.font = '24px Sarabun, Arial, sans-serif';
                ctx.fillStyle = '#ffffff';
                const studentDetails = `รหัสนักเรียน: ${gameState.currentUser.studentId} | ชั้น: ${gameState.currentUser.grade}/${gameState.currentUser.room} เลขที่: ${gameState.currentUser.number}`;
                ctx.fillText(studentDetails, canvas.width / 2, 380);
            }
            
            // Achievement text
            ctx.font = '28px Sarabun, Arial, sans-serif';
            ctx.fillStyle = '#ffffff';
            ctx.fillText('ที่ได้ศึกษาวรรณคดีไทยและสำเร็จการเรียนรู้', canvas.width / 2, 440);
            ctx.fillText('โคลงสี่สุภาพ - พระราชพงศาวดาร', canvas.width / 2, 480);
            
            // Score details
            ctx.font = 'bold 32px Sarabun, Arial, sans-serif';
            ctx.fillStyle = '#4caf50';
            ctx.fillText(`คะแนนรวม: ${playerProfile.exp} แต้ม`, canvas.width / 2, 540);
            
            ctx.font = '24px Sarabun, Arial, sans-serif';
            ctx.fillStyle = '#ffffff';
            ctx.fillText(`อันดับ: ${playerProfile.rank} | เกมที่เล่น: ${playerProfile.totalGamesPlayed} ครั้ง`, canvas.width / 2, 580);
            
            // Date
            ctx.font = '20px Sarabun, Arial, sans-serif';
            const currentDate = new Date().toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            ctx.fillText(`วันที่: ${currentDate}`, canvas.width / 2, 640);
            
            // Signature area
            ctx.font = '18px Sarabun, Arial, sans-serif';
            ctx.fillText('ระบบการเรียนรู้วรรณคดีไทยแบบโต้ตอบ', canvas.width / 2, 720);
            
            // Add decorative elements
            ctx.fillStyle = '#ffeb3b';
            ctx.font = '60px Arial';
            ctx.fillText('🏆', 200, 350);
            ctx.fillText('🏆', 1000, 350);
            
            ctx.fillText('📚', 150, 500);
            ctx.fillText('📚', 1050, 500);
            
            return canvas;
        }

        // Play Again Function
        async function playAgain() {
            try {
                // Save final game data before resetting
                await saveAllUserAnswers();
                
                // Clear old game session
                if (gameState.gameId) {
                    await clearGameSession(gameState.gameId);
                }
                
                // Reset game state completely
                gameState.currentStep = 1;
                gameState.translatedWords = {};
                gameState.incorrectWords = {};
                gameState.wordAttempts = {};
                gameState.imaginationText = '';
                gameState.interpretationText = '';
                gameState.comprehensionScore = 0;
                gameState.startTime = Date.now();
                gameState.selectedWord = null;
                gameState.stepHistory = [];
                gameState.comprehensionAnswers = [];
                gameState.gameId = generateGameId();
                
                // Show landing page with start button
                showLandingPage();
                showNotification('พร้อมเล่นใหม่แล้ว! กดปุ่มเริ่มเกมเพื่อเริ่มต้น', 'success');
                
            } catch (error) {
                console.error('Error in play again:', error);
                showNotification('เกิดข้อผิดพลาดในการเริ่มเกมใหม่', 'error');
            }
        }

        // Show Certificate Modal
        function showCertificate() {
            const modal = document.createElement('div');
            modal.id = 'certificateModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            
            const studentName = gameState.currentUser?.name || 'ผู้เล่น';
            const studentDetails = gameState.currentUser?.studentId ? 
                `รหัสนักเรียน: ${gameState.currentUser.studentId} | ชั้น: ${gameState.currentUser.grade}/${gameState.currentUser.room} เลขที่: ${gameState.currentUser.number}` : 
                'ผู้เรียนออนไลน์';
            
            const currentDate = new Date().toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 md:p-10 max-w-4xl w-full max-h-90vh overflow-y-auto animate-bounce-in relative">
                    <button onclick="closeCertificateModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold transition-all duration-200 shadow-lg text-lg z-10">
                        ×
                    </button>
                    
                    <!-- Certificate Design -->
                    <div class="bg-gradient-to-br from-blue-100 via-purple-50 to-pink-100 border-8 border-yellow-400 rounded-3xl p-8 md:p-12 text-center relative overflow-hidden">
                        <!-- Decorative corners -->
                        <div class="absolute top-4 left-4 text-4xl">🏆</div>
                        <div class="absolute top-4 right-4 text-4xl">🏆</div>
                        <div class="absolute bottom-4 left-4 text-4xl">📚</div>
                        <div class="absolute bottom-4 right-4 text-4xl">📚</div>
                        
                        <!-- Header -->
                        <div class="mb-8">
                            <div class="text-6xl mb-4">🎓</div>
                            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-2">เกียรติบัตร</h1>
                            <h2 class="text-2xl md:text-3xl font-bold text-blue-600">ไขรหัสวรรณคดี</h2>
                            <div class="w-32 h-1 bg-gradient-to-r from-blue-500 to-purple-500 mx-auto mt-4 rounded-full"></div>
                        </div>
                        
                        <!-- Content -->
                        <div class="space-y-6">
                            <p class="text-xl md:text-2xl text-gray-700">ขอแสดงความยินดีกับ</p>
                            
                            <div class="bg-white bg-opacity-80 rounded-2xl p-6 border-2 border-yellow-300">
                                <h3 class="text-3xl md:text-4xl font-bold text-purple-600 mb-2">${studentName}</h3>
                                <p class="text-lg text-gray-600">${studentDetails}</p>
                            </div>
                            
                            <div class="space-y-4">
                                <p class="text-xl text-gray-700">ที่ได้ศึกษาวรรณคดีไทยและสำเร็จการเรียนรู้</p>
                                <p class="text-2xl font-bold text-blue-600">โคลงสี่สุภาพ - พระราชพงศาวดาร</p>
                                <p class="text-xl text-gray-700">เรื่องสมเด็จพระสุริโยทัย</p>
                            </div>
                            
                            <!-- Score Section -->
                            <div class="bg-gradient-to-r from-green-100 to-blue-100 rounded-2xl p-6 border-2 border-green-300">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                                    <div>
                                        <div class="text-3xl font-bold text-green-600">${playerProfile.exp}</div>
                                        <div class="text-sm text-gray-600">คะแนนรวม</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-blue-600">${playerProfile.rank}</div>
                                        <div class="text-sm text-gray-600">อันดับ</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-bold text-purple-600">Lv.${playerProfile.level}</div>
                                        <div class="text-sm text-gray-600">เลเวล</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Date and Signature -->
                            <div class="space-y-4 mt-8">
                                <p class="text-lg text-gray-600">วันที่: ${currentDate}</p>
                                <div class="border-t-2 border-gray-300 pt-4">
                                    <p class="text-base text-gray-500">ระบบการเรียนรู้วรรณคดีไทยแบบโต้ตอบ</p>
                                    <p class="text-sm text-gray-400">The Literature Detective</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-col md:flex-row gap-4 mt-6 justify-center">
                        <button onclick="downloadCertificateImage()" class="modern-button px-6 py-3 text-lg rounded-2xl bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600">
                            💾 บันทึกเป็นรูปภาพ
                        </button>
                        <button onclick="closeCertificateModal()" class="modern-button px-6 py-3 text-lg rounded-2xl bg-gray-500 hover:bg-gray-600">
                            ปิด
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close Certificate Modal
        function closeCertificateModal() {
            const modal = document.getElementById('certificateModal');
            if (modal) {
                modal.remove();
            }
        }

        // Download Certificate as Image
        function downloadCertificateImage() {
            try {
                const canvas = generateCertificate();
                
                // Convert to blob and download
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    const studentName = gameState.currentUser?.name || 'ผู้เล่น';
                    const studentId = gameState.currentUser?.studentId || 'unknown';
                    const date = new Date().toLocaleDateString('th-TH').replace(/\//g, '-');
                    
                    a.download = `เกียรติบัตร_${studentName}_${studentId}_${date}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showNotification('ดาวน์โหลดเกียรติบัตรเรียบร้อย! 🎉', 'success');
                }, 'image/png', 0.95);
                
            } catch (error) {
                console.error('Error generating certificate:', error);
                showNotification('เกิดข้อผิดพลาดในการสร้างเกียรติบัตร', 'error');
            }
        }

        // Calculate Final Score
        async function calculateFinalScore() {
            try {
                const mission = MISSION_DATA.MISSION_01;
                let vocabularyScore = 0;
                
                // Calculate vocabulary points
                Object.values(gameState.translatedWords).forEach(word => {
                    vocabularyScore += word.points;
                });
                
                // Comprehension bonus
                const comprehensionScore = gameState.comprehensionScore * 20;
                
                // Time bonus (max 50 points, decreases over time)
                const timeElapsed = (Date.now() - gameState.startTime) / 1000 / 60; // minutes
                const timeBonus = Math.max(0, Math.floor(50 - timeElapsed * 2));
                
                const total = vocabularyScore + comprehensionScore + timeBonus;
                
                // Update player profile
                playerProfile.exp += total;
                playerProfile.totalGamesPlayed += 1;
                if (total > playerProfile.bestScore) {
                    playerProfile.bestScore = total;
                }
                
                // Save updated player profile
                await saveUserDataAsync();
                
                // Save final game completion data
                await saveAllUserAnswers();
                
                const finalScore = {
                    vocabulary: vocabularyScore,
                    comprehension: comprehensionScore,
                    timeBonus: timeBonus,
                    total: total
                };
                
                return finalScore;
                
            } catch (error) {
                console.error('Error calculating final score:', error);
                return {
                    vocabulary: 0,
                    comprehension: 0,
                    timeBonus: 0,
                    total: 0
                };
            }
        }



        // Handle iframe load
        function handleIframeLoad() {
            const iframe = document.getElementById('dictionaryIframe');
            const fallback = document.getElementById('dictionaryFallback');
            
            if (iframe && fallback) {
                try {
                    // Try to access iframe content to check if it loaded properly
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc && iframeDoc.body && iframeDoc.body.innerHTML.trim() !== '') {
                        // iframe loaded successfully, hide fallback
                        fallback.style.display = 'none';
                        iframe.style.display = 'block';
                    } else {
                        // iframe didn't load properly, show fallback
                        showDictionaryFallback();
                    }
                } catch (e) {
                    // Cross-origin error means the site is blocking iframe
                    showDictionaryFallback();
                }
            }
        }

        // Show dictionary fallback
        function showDictionaryFallback() {
            const iframe = document.getElementById('dictionaryIframe');
            const fallback = document.getElementById('dictionaryFallback');
            
            if (iframe && fallback) {
                iframe.style.display = 'none';
                fallback.style.display = 'flex';
            }
        }

        // Auto-detect iframe blocking after 3 seconds
        setTimeout(() => {
            const iframe = document.getElementById('dictionaryIframe');
            if (iframe) {
                try {
                    // Try to access iframe content
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (!iframeDoc || !iframeDoc.body || iframeDoc.body.innerHTML.trim() === '') {
                        showDictionaryFallback();
                    }
                } catch (e) {
                    showDictionaryFallback();
                }
            }
        }, 3000);

        // Open Dictionary in New Tab
        function openDictionaryNewTab() {
            window.open('https://dictionary.orst.go.th/index.php', '_blank', 'noopener,noreferrer');
            showNotification('เปิดพจนานุกรมในแท็บใหม่แล้ว! 📖', 'success');
        }

        // Show Quick Search Modal
        function showQuickSearch() {
            const modal = document.createElement('div');
            modal.id = 'quickSearchModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 max-w-2xl w-full animate-bounce-in relative">
                    <button onclick="closeQuickSearchModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold">×</button>
                    
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">🔍 ค้นหาด่วน</h2>
                        <p class="text-gray-600">ค้นหาความหมายคำศัพท์จากแหล่งต่างๆ</p>
                    </div>
                    
                    <div class="mb-6">
                        <input type="text" id="quickSearchInput" class="w-full modern-input p-4 text-lg" placeholder="พิมพ์คำที่ต้องการค้นหา..." autofocus>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="searchInDictionary()" class="bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-3">
                            <span class="text-2xl">📖</span>
                            <div class="text-left">
                                <div class="font-bold">พจนานุกรมราชบัณฑิตยสถาน</div>
                                <div class="text-sm opacity-90">ค้นหาในพจนานุกรมอย่างเป็นทางการ</div>
                            </div>
                        </button>
                        
                        <button onclick="searchInGoogle()" class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-3">
                            <span class="text-2xl">🔍</span>
                            <div class="text-left">
                                <div class="font-bold">Google Search</div>
                                <div class="text-sm opacity-90">ค้นหาความหมายใน Google</div>
                            </div>
                        </button>
                        
                        <button onclick="searchInWikipedia()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-3">
                            <span class="text-2xl">🌐</span>
                            <div class="text-left">
                                <div class="font-bold">วิกิพีเดีย</div>
                                <div class="text-sm opacity-90">ค้นหาในสารานุกรมออนไลน์</div>
                            </div>
                        </button>
                        
                        <button onclick="searchInSanook()" class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-3">
                            <span class="text-2xl">📚</span>
                            <div class="text-left">
                                <div class="font-bold">พจนานุกรมสนุก</div>
                                <div class="text-sm opacity-90">ค้นหาในพจนานุกรมออนไลน์</div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="closeQuickSearchModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">
                            ปิด
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add enter key listener
            document.getElementById('quickSearchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchInDictionary();
                }
            });
        }

        // Close Quick Search Modal
        function closeQuickSearchModal() {
            const modal = document.getElementById('quickSearchModal');
            if (modal) {
                modal.remove();
            }
        }

        // Search functions
        function searchInDictionary() {
            const searchTerm = document.getElementById('quickSearchInput').value.trim();
            if (searchTerm) {
                window.open(`https://dictionary.orst.go.th/search.php?search=${encodeURIComponent(searchTerm)}`, '_blank', 'noopener,noreferrer');
                closeQuickSearchModal();
                showNotification(`ค้นหา "${searchTerm}" ในพจนานุกรมราชบัณฑิตยสถาน`, 'success');
            } else {
                showNotification('กรุณาพิมพ์คำที่ต้องการค้นหา', 'error');
            }
        }

        function searchInGoogle() {
            const searchTerm = document.getElementById('quickSearchInput').value.trim();
            if (searchTerm) {
                window.open(`https://www.google.com/search?q=${encodeURIComponent(searchTerm + ' ความหมาย')}`, '_blank', 'noopener,noreferrer');
                closeQuickSearchModal();
                showNotification(`ค้นหา "${searchTerm}" ใน Google`, 'success');
            } else {
                showNotification('กรุณาพิมพ์คำที่ต้องการค้นหา', 'error');
            }
        }

        function searchInWikipedia() {
            const searchTerm = document.getElementById('quickSearchInput').value.trim();
            if (searchTerm) {
                window.open(`https://th.wikipedia.org/wiki/${encodeURIComponent(searchTerm)}`, '_blank', 'noopener,noreferrer');
                closeQuickSearchModal();
                showNotification(`ค้นหา "${searchTerm}" ในวิกิพีเดีย`, 'success');
            } else {
                showNotification('กรุณาพิมพ์คำที่ต้องการค้นหา', 'error');
            }
        }

        function searchInSanook() {
            const searchTerm = document.getElementById('quickSearchInput').value.trim();
            if (searchTerm) {
                window.open(`https://www.sanook.com/dict/search/${encodeURIComponent(searchTerm)}`, '_blank', 'noopener,noreferrer');
                closeQuickSearchModal();
                showNotification(`ค้นหา "${searchTerm}" ในพจนานุกรมสนุก`, 'success');
            } else {
                showNotification('กรุณาพิมพ์คำที่ต้องการค้นหา', 'error');
            }
        }

        // Show Alternative Dictionaries
        function showAlternativeDictionaries() {
            const modal = document.createElement('div');
            modal.id = 'alternativeDictionariesModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 max-w-2xl w-full animate-bounce-in relative">
                    <button onclick="closeAlternativeDictionariesModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold">×</button>
                    
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">📚 พจนานุกรมและแหล่งข้อมูล</h2>
                        <p class="text-gray-600">เลือกแหล่งข้อมูลที่ต้องการใช้ค้นหาความหมายคำศัพท์</p>
                    </div>
                    
                    <div class="space-y-4">
                        <button onclick="openLink('https://dictionary.orst.go.th/')" class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-4">
                            <span class="text-2xl">📖</span>
                            <div class="text-left">
                                <div class="font-bold">พจนานุกรมราชบัณฑิตยสถาน</div>
                                <div class="text-sm opacity-90">พจนานุกรมภาษาไทยอย่างเป็นทางการ</div>
                            </div>
                        </button>
                        
                        <button onclick="openLink('https://th.wikipedia.org/')" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-4">
                            <span class="text-2xl">🌐</span>
                            <div class="text-left">
                                <div class="font-bold">วิกิพีเดียภาษาไทย</div>
                                <div class="text-sm opacity-90">สารานุกรมออนไลน์</div>
                            </div>
                        </button>
                        
                        <button onclick="openLink('https://www.google.com/search?q=')" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-4">
                            <span class="text-2xl">🔍</span>
                            <div class="text-left">
                                <div class="font-bold">Google Search</div>
                                <div class="text-sm opacity-90">ค้นหาข้อมูลทั่วไป</div>
                            </div>
                        </button>
                        
                        <button onclick="openLink('https://www.sanook.com/dict/')" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center gap-4">
                            <span class="text-2xl">📚</span>
                            <div class="text-left">
                                <div class="font-bold">พจนานุกรมสนุก</div>
                                <div class="text-sm opacity-90">พจนานุกรมออนไลน์</div>
                            </div>
                        </button>
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="closeAlternativeDictionariesModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">
                            ปิด
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close Alternative Dictionaries Modal
        function closeAlternativeDictionariesModal() {
            const modal = document.getElementById('alternativeDictionariesModal');
            if (modal) {
                modal.remove();
            }
        }

        // Open Link in New Tab
        function openLink(url) {
            window.open(url, '_blank', 'noopener,noreferrer');
            closeAlternativeDictionariesModal();
            showNotification('เปิดลิงก์ในแท็บใหม่แล้ว! 🔗', 'success');
        }

        // Show Word Hints
        function showWordHints() {
            const modal = document.createElement('div');
            modal.id = 'wordHintsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            const mission = MISSION_DATA.MISSION_01;
            const wordsArray = Object.entries(mission.hardWords);
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 max-w-4xl w-full max-h-90vh overflow-y-auto animate-bounce-in relative">
                    <button onclick="closeWordHintsModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold">×</button>
                    
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">💡 ใบ้คำศัพท์</h2>
                        <p class="text-gray-600">ดูภาพใบ้เพื่อช่วยในการค้นหาความหมาย</p>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        ${wordsArray.map(([word, data]) => `
                            <div class="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200 p-4 rounded-xl text-center hover:shadow-lg transition-all duration-200">
                                <img src="${getWordImage(word)}" alt="ใบ้สำหรับ ${word}" class="w-20 h-20 mx-auto rounded-lg border-2 border-blue-300 object-cover mb-3 shadow-md">
                                <div class="font-bold text-blue-900 text-lg mb-1">${word}</div>
                                <div class="text-xs text-blue-700">${data.points} คะแนน</div>
                                <div class="text-xs text-gray-600 mt-2">คลิกคำในโคลงเพื่อตอบ</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-6 text-center">
                        <button onclick="closeWordHintsModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-200">
                            ปิด
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Close Word Hints Modal
        function closeWordHintsModal() {
            const modal = document.getElementById('wordHintsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Open Dictionary (Legacy function - now redirects to new tab)
        function openDictionary() {
            openDictionaryNewTab();
        }

        // Close Dictionary Modal
        function closeDictionaryModal() {
            const modal = document.getElementById('dictionaryModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show Kloang Info
        function showKloangInfo() {
            const modal = document.createElement('div');
            modal.id = 'kloangModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            modal.innerHTML = `
                <div class="bg-white rounded-3xl p-6 max-w-4xl w-full max-h-90vh overflow-y-auto animate-bounce-in relative">
                    <button onclick="closeKloangModal()" class="absolute top-4 right-4 w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold">×</button>
                    
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">📋 ฉันทลักษณ์โคลงสี่สุภาพ</h2>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-200 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-blue-900 mb-4">คณะ</h3>
                            <div class="space-y-2 text-blue-800">
                                <p>• โคลงสี่สุภาพ 1 บทมี 4 บาท โดย 1 บรรทัดคือ 1 บาท แต่ละบาทมี 2 วรรค</p>
                                <p>• บาทที่ 1 บาทที่ 2 และบาทที่ 3 มีจำนวนคำเท่ากัน คือ วรรคหน้ามี 5 คำ ส่วนวรรคหลังมี 2 คำ</p>
                                <p>• บาทที่ 4 วรรคหน้ามี 5 คำเช่นกัน แต่วรรคหลังจะมี 4 คำ</p>
                                <p>• รวมทั้งสิ้น 1 บทจะมี 30 คำ</p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-200 p-6 rounded-xl">
                            <h3 class="text-xl font-bold text-orange-900 mb-4 text-center">รูปฉันทลักษณ์โคลงสี่สุภาพ</h3>
                            <div class="text-center">
                                <img src="https://img5.pic.in.th/file/secure-sv1/--04.png" alt="รูปฉันทลักษณ์โคลงสี่สุภาพ" class="w-full max-w-3xl mx-auto rounded-xl border-2 border-orange-300 shadow-lg" onerror="this.src=''; this.alt='ไม่สามารถโหลดภาพได้'; this.style.display='none';">
                                <p class="text-orange-700 text-sm mt-3">รูปแบบฉันทลักษณ์โคลงสี่สุภาพ แสดงตำแหน่งวรรณยุกต์เอก (●) โท (●) และตำแหน่งอิสระ (○)</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="closeKloangModal()" class="modern-button px-6 py-3 rounded-xl bg-gray-500 hover:bg-gray-600">ปิด</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }



        // Close Kloang Modal
        function closeKloangModal() {
            const modal = document.getElementById('kloangModal');
            if (modal) {
                modal.remove();
            }
        }

        // Close Tooltip
        function closeTooltip() {
            const tooltip = document.getElementById('wordTooltip');
            if (tooltip) {
                tooltip.remove();
            }
        }

        // Show Notification
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
    </script>
</body>
</html>
