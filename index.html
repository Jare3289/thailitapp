<script>
/* --- Cleaned / fixed handlers for step chips and floating actions --- */

function initializeStepChipEvents() {
    const container = document.getElementById('stepIndicatorContainer');
    if (!container) return;

    container.querySelectorAll('.step-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            const stepValue = parseFloat(chip.dataset.step || '0');
            if (!Number.isFinite(stepValue)) return;

            // Some steps use 2.5 as special UI marker, normalize for logic
            const logicalStep = stepValue === 2.5 ? 2 : stepValue;
            const currentLogical = gameState.currentStep === 2.5 ? 2 : gameState.currentStep;

            // Prevent jumping ahead
            if (logicalStep > (gameState.maxStepReached || 1)) return;
            if (logicalStep === currentLogical) return;

            // Navigate to the clicked step (use the real stepValue so special 2.5 works)
            renderStep(stepValue).catch(err => console.error('renderStep error:', err));
        });
    });
}

function initializeFloatingActions() {
    const floatingActions = document.getElementById('floatingActionButtons');
    if (!floatingActions) return;

    const toggle = document.getElementById('floatingActionsToggle');
    const panel = floatingActions.querySelector('.floating-panel');

    function closePanel() {
        floatingActions.classList.remove('show');
        floatingActions.setAttribute('aria-hidden', 'true');
    }
    function openPanel() {
        floatingActions.classList.add('show');
        floatingActions.setAttribute('aria-hidden', 'false');
    }

    // Toggle button
    if (toggle) {
        toggle.addEventListener('click', (e) => {
            e.stopPropagation(); // prevent document click immediately closing it
            if (floatingActions.classList.contains('show')) {
                closePanel();
            } else {
                openPanel();
            }
        });
    }

    // Buttons inside the panel: allow their action and then close the panel
    const panelButtons = floatingActions.querySelectorAll('.floating-action-button');
    panelButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            // Let the button's onclick/run happen, then close panel after a short delay
            setTimeout(closePanel, 150);
        });
    });

    // Close the panel when clicking outside
    document.addEventListener('click', (event) => {
        if (!floatingActions.contains(event.target)) {
            closePanel();
        }
    });

    // Make sure mouseleave on panel closes it if needed (optional friendly UX)
    if (panel) {
        panel.addEventListener('mouseleave', () => {
            // small delay so accidental mouseouts don't close too aggressively
            setTimeout(() => {
                if (floatingActions.classList.contains('show')) closePanel();
            }, 200);
        });
    }
}

/* --- Initialize these when DOM is ready --- */
window.addEventListener('DOMContentLoaded', () => {
    try {
        initializeStepChipEvents();
        initializeFloatingActions();
    } catch (err) {
        console.error('Initialization error:', err);
    }
});
</script>